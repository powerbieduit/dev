{
  "updatedAt": "2025-11-03T16:50:18.000Z",
  "createdAt": "2025-08-19T17:52:50.272Z",
  "id": "AdorfGfiq50Ph1tg",
  "name": "criacao_leads_soead V2",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2544,
        480
      ],
      "id": "3b1e7f6c-e8d5-4e9c-bda7-8aab1f8fc805",
      "name": "Wait",
      "webhookId": "ee560901-a2ea-40d9-9e7f-f28f287bc6d7"
    },
    {
      "parameters": {
        "resource": "contacts",
        "operation": "createContacts",
        "collection": {
          "contact": [
            {
              "name": "={{$items(\"dados\")[0].json[\"Nome\"]}}",
              "responsible_user_id": "={{ $json.id_usuario }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":650708,\"type\":\"multitext\"}",
                    "value": "=+55{{$items(\"dados\")[0].json[\"Telefone\"]}}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -304,
        192
      ],
      "id": "c0b3fd2f-1983-4147-9f3f-b675f1e22314",
      "name": "cria contato",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5f1e3be6-2b81-4421-a45c-75af595cea49",
              "leftValue": "={{ $json.quantidade_encontrada }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1872,
        480
      ],
      "id": "65baab7c-9697-40fd-a2b3-c38d38045ada",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "const leads = $json._embedded?.leads || [];\n\n// Define campos fixos\nconst camposFixos = ['id', 'name', 'telefone', 'email', 'curso'];\n\n// Conta quantos leads foram encontrados\nconst quantidade_encontrada = leads.length;\n\nif (quantidade_encontrada === 0) {\n  // Se nenhum lead for encontrado, retorna campos vazios\n  const vazio = {\n    quantidade_encontrada,\n    id: \"\",\n    name: \"\",\n    telefone: \"\",\n    email: \"\",\n    curso: \"\"\n  };\n  return [{ json: vazio }];\n}\n\n// Seleciona o lead com menor ID\nconst leadEscolhido = leads.reduce((min, atual) => {\n  return atual.id < min.id ? atual : min;\n});\n\n// Extrai valores dos campos customizados\nconst fields = leadEscolhido.custom_fields_values || [];\nconst getCampo = (nome) => {\n  return fields.find(f => f.field_name?.toLowerCase().includes(nome.toLowerCase()))\n         ?.values?.[0]?.value ?? \"\";\n};\n\nconst resultado = {\n  quantidade_encontrada,\n  id: leadEscolhido.id,\n  name: leadEscolhido.name ?? \"\",\n  telefone: getCampo(\"telefone\"),\n  email: getCampo(\"email\"),\n  curso: getCampo(\"curso\")\n};\n\nreturn [{ json: resultado }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2096,
        480
      ],
      "id": "5246b1ba-753a-47d4-9aac-d627db6369e8",
      "name": "Code"
    },
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "=+55{{ $json.Telefone }}",
          "pipelines": [
            9095532
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -2320,
        480
      ],
      "id": "8f971fb7-f5ab-4a67-b337-6495a1322f63",
      "name": "procura lead1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1648,
        592
      ],
      "id": "c743e481-8bf2-4b1a-9416-cf9af7ed91e4",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Entrada: items (cada item.json √© um consultor ativo vindo do Supabase)\n\n// Sorteio em todos os ativos (duplicatas contam como chances extras)\nconst escolhido = items[Math.floor(Math.random() * items.length)];\n\nreturn [{\n  json: escolhido.json,\n  pairedItem: { item: items.indexOf(escolhido) }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1200,
        192
      ],
      "id": "8083bd0c-e9cc-472d-8b12-378f616b1974",
      "name": "Code1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "690a8140-ee68-4ba8-ad5a-32d1c8bd01c6",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2992,
        480
      ],
      "id": "f0f478e8-4c51-431f-9b1a-af7eae92d37f",
      "name": "Webhook",
      "webhookId": "690a8140-ee68-4ba8-ad5a-32d1c8bd01c6"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "distrib_anhanguera",
        "filters": {
          "conditions": [
            {
              "keyName": "status",
              "condition": "eq",
              "keyValue": "Ativo"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1424,
        192
      ],
      "id": "7750307b-1655-47ab-ab20-241413cda967",
      "name": "Get many rows",
      "credentials": {
        "supabaseApi": {
          "id": "6o0bjFpYGr8jfz1r",
          "name": "Supabase_BU"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "distrib_anhanguera",
        "filters": {
          "conditions": [
            {
              "keyName": "id_usuario",
              "condition": "eq",
              "keyValue": "={{ $json.id_usuario }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "ultimo_lead",
              "fieldValue": "={{ new Date(new Date().getTime() - (3 * 60 * 60 * 1000)).toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -976,
        192
      ],
      "id": "6e539ee8-84e1-42a1-bc37-bc0fac5481f0",
      "name": "Update a row",
      "credentials": {
        "supabaseApi": {
          "id": "6o0bjFpYGr8jfz1r",
          "name": "Supabase_BU"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1fb352e3-e510-430a-b2c3-66cc7c011aa4",
              "name": "id_usuario",
              "value": "={{ $json.id_usuario }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -528,
        192
      ],
      "id": "54834d6f-89f1-4b20-bde2-283bbfe6a4ad",
      "name": "Edit Fields1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1648,
        192
      ],
      "id": "51c4c015-80b9-431f-80b1-258a8ccca94f",
      "name": "Merge1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9c9eb4b1-ec44-4fac-82b1-232006b7872e",
              "name": "Nome",
              "value": "={{ $json.body.nome }}",
              "type": "string"
            },
            {
              "id": "6c48dde8-316e-4f35-b881-8bb13510d468",
              "name": "Telefone",
              "value": "={{ $json.body.celular }}",
              "type": "string"
            },
            {
              "id": "1ddb0708-1df2-428d-bc0c-bb58e1637e51",
              "name": "Tipo",
              "value": "={{ $json.body.tipo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2768,
        480
      ],
      "id": "fdd9ecf1-a148-4c4d-88f5-5b6caa2a63c1",
      "name": "dados"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "createLeads",
        "collection": {
          "lead": [
            {
              "name": "={{$items(\"dados\")[0].json.Nome}}",
              "pipeline_id": 9095532,
              "status_id": 70788396,
              "responsible_user_id": "={{ $('Edit Fields1').item.json.id_usuario }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":662138,\"type\":\"text\"}",
                    "value": "={{$items(\"dados\")[0].json.Nome}}"
                  },
                  {
                    "data": "{\"id\":689125,\"type\":\"text\"}",
                    "value": "=+55{{$items(\"dados\")[0].json.Telefone}}"
                  },
                  {
                    "data": "{\"id\":672274,\"type\":\"text\"}",
                    "value": "={{$items(\"Get many rows\")[0].json.nome}}"
                  },
                  {
                    "data": "{\"id\":688279,\"type\":\"select\"}",
                    "value": "Site - Anhanguera"
                  },
                  {
                    "data": "{\"id\":673258,\"type\":\"text\"}",
                    "value": "={{$items(\"dados\")[0].json.Tipo}}"
                  }
                ]
              },
              "_embedded": {
                "contacts": [
                  {
                    "id": {
                      "contact": [
                        {
                          "id": "={{ $json._embedded.contacts[0].id }}"
                        }
                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -80,
        192
      ],
      "id": "26802c80-3e58-41b8-a50a-11b362b69c4e",
      "name": "cria lead",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Entrada: items (podem ter duplicatas do mesmo id_usuario)\n\n// Vamos guardar o primeiro de cada id_usuario\nconst vistos = new Set();\nconst unicos = [];\n\nfor (const it of items) {\n  const j = it.json;\n  const id = j.id_usuario;\n\n  if (!vistos.has(id)) {\n    vistos.add(id);\n    unicos.push(it); // mant√©m s√≥ o primeiro que aparecer\n  }\n}\n\n// Retorna apenas 1 por id_usuario\nreturn unicos;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        192
      ],
      "id": "0fcbf526-3bf7-47b6-b915-495d2a94acf4",
      "name": "Code3"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $json.id }}",
              "pipeline_id": 9095532,
              "status_id": 0,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":693635,\"type\":\"select\"}",
                    "value": "Recebida"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1200,
        688
      ],
      "id": "2ef92f75-28d0-4cd4-9bb0-d42d5c53d688",
      "name": "Update leads",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $json._embedded.leads[0].id }}",
              "text": "Aluno teve uma nova intera√ß√£o no site, fala que ELE QUER MATRICULAR!!!!"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -976,
        688
      ],
      "id": "03c6b51c-788e-4d73-9795-7f657ba79e10",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "sem_curso",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "27ae7d4f-f4b0-4337-883c-3dc3db4e9743"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "curso n√£o preenchido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3f3ab88a-82a0-4a4a-8d0d-5e3db93fb39d",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "=com_curso",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "curso preenchido"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        976,
        1920
      ],
      "id": "19dc8ccc-794b-44dc-a66c-d7776998f690",
      "name": "Switch3"
    },
    {
      "parameters": {
        "phoneNumberId": "789007424302460",
        "recipientPhoneNumber": "={{ '55' + $('dados').item.json.Telefone }}",
        "template": "recadastro_semcurso_kfe6xi|pt_BR"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1200,
        1824
      ],
      "id": "5d7663eb-a3db-44d3-b72d-e4cda2fe8a1f",
      "name": "Send template2",
      "webhookId": "92ffd4d4-2332-467e-9881-f089f43e9370",
      "credentials": {
        "whatsAppApi": {
          "id": "ZYIePjycu0XbxiBl",
          "name": "WHATSAPP - CONTAS BU"
        }
      }
    },
    {
      "parameters": {
        "phoneNumberId": "789007424302460",
        "recipientPhoneNumber": "={{ '55' + $('dados').item.json.Telefone }}",
        "template": "recadastro_com_curso_3p4v97|pt_BR",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $json.curso }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1200,
        2016
      ],
      "id": "907f39db-4ab2-4c1a-8254-d57026cecdc9",
      "name": "Send template3",
      "webhookId": "92ffd4d4-2332-467e-9881-f089f43e9370",
      "credentials": {
        "whatsAppApi": {
          "id": "ZYIePjycu0XbxiBl",
          "name": "WHATSAPP - CONTAS BU"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente_anh",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Send template2').item.json.contacts[0].wa_id + '@s.whatsapp.net' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1936,
        1856
      ],
      "id": "755095cb-5cc8-499b-ab7b-e7261443d2f0",
      "name": "Get a row2",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b710a8dd-f668-441a-b2bb-914ac4d854db",
              "leftValue": "={{ $('Get a row2').item.json.atendimento_ia }}",
              "rightValue": "pause",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "0ae221ab-e5f2-4c77-85fd-b738bdcda704",
              "leftValue": "={{ $json.session_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2384,
        1952
      ],
      "id": "17ff87e9-b13c-4e09-aa73-d4a76714bb02",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente_anh",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2608,
        1856
      ],
      "id": "3d0e0875-9434-4e23-b4bc-e54d4f601e69",
      "name": "Update a row2",
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $json._embedded.leads[0].id }}",
              "text": "=Ol√°! Vi que voc√™ voltou a pesquisar sobre os pr√≥ximos passos para sua carreira.   Como da √∫ltima vez conversamos *sobre o curso de *{{ $('Code in JavaScript').item.json.curso }}*, queria saber: este parece ser um *bom momento para voc√™ investir no seu desenvolvimento*? ‚ú®"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1712,
        2048
      ],
      "id": "099f28a9-472b-413e-9e32-a9ee66c4f2d9",
      "name": "Create new notes3",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Code').item.json.id }}",
              "pipeline_id": 11873040,
              "status_id": 93544156,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":689125,\"type\":\"text\"}",
                    "value": "=+{{ $json.contacts[0].input }}"
                  }
                ]
              },
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      196281
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1488,
        2048
      ],
      "id": "6cf4a9ec-5dd1-4c38-9948-16224a330eed",
      "name": "recadastro",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $json._embedded.leads[0].id }}",
              "text": "=Oi! Tudo bem? Vi que voc√™ deu uma olhada em nossos pre√ßos hoje. \n\nQue tal a gente conversar *5 minutinhos* sobre como *podemos te ajudar a alcan√ßar seus objetivos*? üòâ"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1712,
        1856
      ],
      "id": "d18e9b2b-1624-4015-b79d-0ac32947e18b",
      "name": "Create new notes4",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente_anh",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Send template3').item.json.contacts[0].wa_id + '@s.whatsapp.net' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1936,
        2048
      ],
      "id": "dd7d7b38-4cda-4aab-8036-393238eef2d2",
      "name": "Get a row3",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "tableId": "dados_cliente_anh",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toLocaleString(\"sv-SE\", { timeZone: \"America/Sao_Paulo\" }).replace(\" \", \"T\") }}"
            },
            {
              "fieldId": "telefone",
              "fieldValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2608,
        2048
      ],
      "id": "15c58a79-6cf9-427e-910a-af77e4895820",
      "name": "Criar Cliente1",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Code').item.json.id }}",
              "pipeline_id": 11873040,
              "status_id": 93544156,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":689125,\"type\":\"text\"}",
                    "value": "=+{{ $json.contacts[0].input }}"
                  }
                ]
              },
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      157694
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1488,
        1856
      ],
      "id": "6f2819be-0e46-4830-8a3d-b3ccb86db4f7",
      "name": "recadastro3",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('procura lead1').item.json._embedded.leads[0].status_id }}",
                    "rightValue": 143,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "6c92131b-9059-450c-b2f1-9047bf5f0be9"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d6c527d5-38b4-4e00-88bb-bab5dfd6413d",
                    "leftValue": "={{ $('procura lead1').item.json._embedded.leads[0].status_id }}",
                    "rightValue": 70793928,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1424,
        576
      ],
      "id": "05c7d122-3a5f-4cd9-911f-05e1b5a80f58",
      "name": "Switch1"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $json.id }}",
              "pipeline_id": 11003376,
              "status_id": 84631600,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":662138,\"type\":\"text\"}",
                    "value": "={{ $json.name }}"
                  },
                  {
                    "data": "{\"id\":689125,\"type\":\"text\"}",
                    "value": "={{ $json.telefone }}"
                  }
                ]
              },
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      157694
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1200,
        512
      ],
      "id": "468865fd-bd23-4da1-905e-f14c1349454f",
      "name": "recadastro1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega todos os itens de entrada\nconst items = $input.all();\n\n// Mapeia cada item\nreturn items.map(item => {\n  const curso = (item.json.curso || \"\").trim().toLowerCase();\n\n  // Se for vazio ou \"n√£o informado\", marca como sem curso\n  const status = (curso === \"\" || curso === \"n√£o informado\")\n    ? \"sem_curso\"\n    : \"com_curso\";\n\n  return {\n    json: {\n      ...item.json,\n      status\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        1920
      ],
      "id": "48bd0b04-e840-4e30-8919-c09d6e91c812",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "tableId": "chats_anh",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toLocaleString(\"sv-SE\", { timeZone: \"America/Sao_Paulo\" }).replace(\" \", \"T\") }}"
            },
            {
              "fieldId": "phone",
              "fieldValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2832,
        2048
      ],
      "id": "e74fa565-e007-4bc8-9937-6b9989c6e5a5",
      "name": "Criar Cliente",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chats_anh",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toLocaleString(\"sv-SE\", { timeZone: \"America/Sao_Paulo\" }).replace(\" \", \"T\") }}"
            },
            {
              "fieldId": "phone",
              "fieldValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2832,
        1856
      ],
      "id": "77c99fd6-558d-4ff0-9a3d-f05a563d0c34",
      "name": "Criar Cliente2",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "tableId": "n8n_chat_histories",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "message",
              "fieldValue": "{   \"type\": \"ai\",   \"content\": \"```Oi! Tudo bem? Vi que voc√™ deu uma olhada em nossos pre√ßos hoje.   Que tal a gente conversar *5 minutinhos* sobre como *podemos te ajudar a alcan√ßar seus objetivos*? üòâ```\",   \"tool_calls\": [],   \"additional_kwargs\": {},   \"response_metadata\": {},   \"invalid_tool_calls\": [] }"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2160,
        1856
      ],
      "id": "a3dd2d35-eea4-4300-b2ce-ff573121ba00",
      "name": "Criar Cliente3",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "tableId": "n8n_chat_histories",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "message",
              "fieldValue": "=Ol√°! Vi que voc√™ voltou a pesquisar sobre os pr√≥ximos passos para sua carreira.   Como da √∫ltima vez conversamos *sobre o curso de *{{ $('Code in JavaScript').item.json.curso }}*, queria saber: este parece ser um *bom momento para voc√™ investir no seu desenvolvimento*? ‚ú®"
            },
            {
              "fieldId": "session_id",
              "fieldValue": "={{ \"55\" + $('Webhook').item.json.body.celular + \"@s.whatsapp.net\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2160,
        2048
      ],
      "id": "95dcc88d-b289-466d-a8d9-c8840610d265",
      "name": "Criar Cliente4",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    }
  ],
  "connections": {
    "Wait": {
      "main": [
        [
          {
            "node": "procura lead1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria contato": {
      "main": [
        [
          {
            "node": "cria lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "procura lead1": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Update a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "cria contato",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Get many rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads": {
      "main": [
        [
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Send template2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send template3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send template2": {
      "main": [
        [
          {
            "node": "recadastro3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send template3": {
      "main": [
        [
          {
            "node": "recadastro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row2": {
      "main": [
        [
          {
            "node": "Criar Cliente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Update a row2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Cliente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes3": {
      "main": [
        [
          {
            "node": "Get a row3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recadastro": {
      "main": [
        [
          {
            "node": "Create new notes3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes4": {
      "main": [
        [
          {
            "node": "Get a row2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row3": {
      "main": [
        [
          {
            "node": "Criar Cliente4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recadastro3": {
      "main": [
        [
          {
            "node": "Create new notes4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "recadastro1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "recadastro1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente1": {
      "main": [
        [
          {
            "node": "Criar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row2": {
      "main": [
        [
          {
            "node": "Criar Cliente2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        []
      ]
    },
    "Criar Cliente2": {
      "main": [
        []
      ]
    },
    "Criar Cliente3": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente4": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "timezone": "America/Sao_Paulo"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Mobile Safari/537.36",
            "content-length": "83",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
            "content-type": "application/json",
            "origin": "https://www.soead.com.br",
            "priority": "u=1, i",
            "referer": "https://www.soead.com.br/",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "152.249.104.25",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "152.249.104.25"
          },
          "params": {},
          "query": {},
          "body": {
            "nome": "Maria Jos√© Alves de Carvalho",
            "celular": "11930182828",
            "tipo": "graduacao"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/690a8140-ee68-4ba8-ad5a-32d1c8bd01c6",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "5a656ed9-5b8f-432f-950f-f29e712c9360",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-08-19T17:52:50.276Z",
      "createdAt": "2025-08-19T17:52:50.276Z",
      "role": "workflow:owner",
      "workflowId": "AdorfGfiq50Ph1tg",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": []
}