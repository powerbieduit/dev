{
  "createdAt": "2025-07-31T15:28:35.105Z",
  "updatedAt": "2025-08-05T14:28:30.000Z",
  "id": "GyFhwlLIleRxISfq",
  "name": "ANH - VERIFICAR CPF",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "={{ $('array dados').item.json.Pesquisa }}"
        },
        "options": {}
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -176,
        304
      ],
      "id": "88894f3f-9be3-4ce3-a545-a03d089ba134",
      "name": "query",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "0RLQwTFNZKVcXRY1",
          "name": "Kommo acad√™mico BU"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrai dados do JSON recebido do Kommo\nconst leads = $json._embedded?.leads || [];\n\nreturn leads.map(lead => {\n  // Cria um objeto auxiliar para facilitar acesso aos campos customizados\n  const campos = {};\n  for (const campo of lead.custom_fields_values || []) {\n    campos[campo.field_name] = campo.values?.[0]?.value || null;\n  }\n\n  // Extrai o ID do contato principal\n  const contact_id = lead._embedded?.contacts?.[0]?.id || null;\n\n  return {\n    id: lead.id,\n    contact_id,\n    nome: campos[\"Nome\"] || null,\n    Pesquisa: campos[\"Pesquisa\"] || null,\n    ra: campos[\"RA\"] || null,\n    curso: campos[\"Curso\"] || null,\n    telefone: campos[\"Telefone_Pesquisa\"] || null, // substitu√≠do aqui\n    status_id: lead.status_id\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1408,
        128
      ],
      "id": "a432828a-4547-4e29-acd7-fe31162f5606",
      "name": "array dados"
    },
    {
      "parameters": {
        "jsCode": "// üìå Mapeamento real conforme seu JSON Kommo\nconst camposDesejados = {\n  412928: \"RA\",\n  412930: \"CPF\",\n  412932: \"Curso\",\n  412934: \"Polo\",\n  413910: \"√öltima fase\",\n  413906: \"Respons√°vel\",\n  1469689: \"PTC\",\n  1473849: \"Nome\",\n  1473851: \"Telefone\"\n};\n\n// ‚úÖ Leads retornados\nconst leads = $json._embedded?.leads || [];\nconst quantidade_encontrada = leads.length;\n\n// ‚ùå Se nenhum lead, retorna campos com strings vazias\nif (quantidade_encontrada === 0) {\n  const camposVazios = {};\n  for (const nomeCampo of Object.values(camposDesejados)) {\n    camposVazios[nomeCampo] = \"\";\n  }\n\n  return [{\n    json: {\n      quantidade_encontrada,\n      id_mais_antigo: \"\",\n      id_mais_recente: \"\",\n      campos_extraidos: camposVazios\n    }\n  }];\n}\n\n// ‚úÖ Ordena os leads por ID crescente (mais antigo primeiro)\nconst leadsOrdenados = leads\n  .filter(l => typeof l.id === 'number')\n  .sort((a, b) => a.id - b.id);\n\nconst leadMaisAntigo = leadsOrdenados[0];\nconst leadMaisRecente = leadsOrdenados[leadsOrdenados.length - 1];\n\n// ‚úÖ Extrai campos do mais antigo\nconst camposMapeados = {};\nfor (const [fieldId, nomeCampo] of Object.entries(camposDesejados)) {\n  const valor = leadMaisAntigo.custom_fields_values?.find(f => f.field_id === Number(fieldId))?.values?.[0]?.value ?? \"\";\n  camposMapeados[nomeCampo] = valor;\n}\n\n// ‚úÖ Retorna tudo\nreturn [{\n  json: {\n    quantidade_encontrada,\n    id_mais_antigo: leadMaisAntigo.id,\n    id_mais_recente: leadMaisRecente.id,\n    campos_extraidos: camposMapeados\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        224
      ],
      "id": "a5eba8d1-8271-45b0-90d0-081cd0058686",
      "name": "Code1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5d53c0cf-0004-4996-8ead-1bcdf9153b37",
              "leftValue": "={{ $json.quantidade_encontrada }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            },
            {
              "id": "c8cce089-b308-4ff3-8731-7eed2cfa57c0",
              "leftValue": "={{ $json.quantidade_encontrada }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        432,
        224
      ],
      "id": "2f180a54-a0fb-4246-b240-c7fe6fb1a004",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        656,
        352
      ],
      "id": "475abf32-ee1e-4f9f-a839-afd2c36b648d",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -512,
        304
      ],
      "id": "7f8a76c9-fe5a-4a89-a59e-3cb0efa6d747",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "const leads = $json._embedded?.leads || [];\n\nreturn [\n  {\n    json: {\n      quantidade: leads.length\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -896,
        128
      ],
      "id": "6c0908a8-3cdd-494a-97d4-5b9bcf1cd07f",
      "name": "Code3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e44d96c3-81cd-4c89-bdae-dfce8890761e",
              "leftValue": "={{ $json._embedded.leads[0].id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        32,
        304
      ],
      "id": "6013c0f9-1369-4627-8e9b-afa4bed339a9",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        208,
        416
      ],
      "id": "a4913d4c-2bf2-4b23-b92f-3e263794a778",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "={{ $json.Pesquisa }}"
        },
        "options": {}
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1168,
        128
      ],
      "id": "3a890ebb-e3b4-48ca-84ac-35f7d1187dca",
      "name": "Get list of leads2",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nVF4jy6NK0rf5oed",
          "name": "Kommo BU"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "={{ $json.body['leads[add][0][id]'] }}"
        },
        "options": {
          "with": [
            "contacts"
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1616,
        128
      ],
      "id": "44a95ff9-23f5-4a3f-ac72-4cfeef247b40",
      "name": "Pesquisa no Acad√™mico",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "0RLQwTFNZKVcXRY1",
          "name": "Kommo acad√™mico BU"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚öôÔ∏è Mapeamento de ID de campo para nome leg√≠vel\n\n\n// üéØ Acessa o JSON de entrada\nconst input = $json;\n\n// üß© Constr√≥i o resultado final a partir dos dados j√° extra√≠dos\nconst resultado = {\n  id_mais_antigo: input.id_mais_antigo,\n  id_mais_recente: input.id_mais_recente,\n  quantidade_encontrada: input.quantidade_encontrada\n};\n\n\nreturn [{ json: resultado }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        128
      ],
      "id": "3f17051a-b584-43e7-8cd8-13ec1db5f91f",
      "name": "Code4"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "a687347b-6449-4bf6-9888-c1da0413ceb6",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1840,
        128
      ],
      "id": "7c283921-10b4-4f97-bdaf-25d144f0c39c",
      "name": "Webhook",
      "webhookId": "a687347b-6449-4bf6-9888-c1da0413ceb6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -512,
        -80
      ],
      "id": "5a70b8cf-5d3e-4be1-898e-bc8f023c0b78",
      "name": "Merge2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3a86fec0-eaef-46f7-a442-ded40af19ba4",
              "leftValue": "={{ $('Get list of leads2').item.json._embedded.leads[0].pipeline_id }}",
              "rightValue": 9095532,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -720,
        128
      ],
      "id": "62713452-8097-4916-8d77-2082cbbda887",
      "name": "If3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "677d31de-f5d4-4648-8f83-eeb99416e66d",
              "leftValue": "={{ $('Get list of leads2').item.json._embedded.leads[0].id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        -80
      ],
      "id": "4792661d-0b12-4a32-85dc-cee23db9e2a5",
      "name": "If4"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Webhook').item.json.body['leads[add][0][id]'] }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":1473849,\"type\":\"text\"}",
                    "value": "={{ $json.Nome }}"
                  },
                  {
                    "data": "{\"id\":412932,\"type\":\"text\"}",
                    "value": "={{ $json.Curso }}"
                  },
                  {
                    "data": "{\"id\":412930,\"type\":\"text\"}",
                    "value": "={{ $('array dados').item.json.Pesquisa }}"
                  },
                  {
                    "data": "{\"id\":412928,\"type\":\"text\"}",
                    "value": "={{ $json.RA }}"
                  },
                  {
                    "data": "{\"id\":412934,\"type\":\"text\"}",
                    "value": "={{ $json.Polo }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        592,
        -96
      ],
      "id": "cea0a9ec-45ce-4a76-be49-b05e16e8f4b9",
      "name": "update lead (info comercial)",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "0RLQwTFNZKVcXRY1",
          "name": "Kommo acad√™mico BU"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Lista fixa com os nomes dos campos esperados no resultado\nconst nomesFixos = [\n  \"Curso\",\n  \"Nome\",\n  \"CPF\",\n  \"RA\",\n  \"Polo\",\n\n];\n\nconst campos = $json._embedded?.leads?.[0]?.custom_fields_values || [];\n\nconst resultado = {};\n\n// Inicializa todos os campos com string vazia\nfor (let i = 0; i < nomesFixos.length; i++) {\n  resultado[nomesFixos[i]] = \"\";\n}\n\n// Preenche os campos encontrados\nfor (let i = 0; i < campos.length; i++) {\n  const campo = campos[i];\n  const nome = campo.field_name;\n  const valor = campo.values && campo.values[0] ? campo.values[0].value : \"\";\n\n  if (nomesFixos.includes(nome)) {\n    resultado[nome] = valor;\n  }\n}\n\n// Agora retorna dentro de um array, como o n8n espera\nreturn [\n  {\n    json: resultado\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -96
      ],
      "id": "4d888275-ba5b-4d1b-b7ec-6613bc5829a2",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -80,
        -96
      ],
      "id": "3acbe0cd-e5c8-4342-92ce-0e24289e686e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "={{ $('array dados').item.json.Pesquisa }}"
        },
        "options": {}
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        128,
        -96
      ],
      "id": "ceca6c6c-4fea-4c17-a414-e3e403824851",
      "name": "Get list of leads",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nVF4jy6NK0rf5oed",
          "name": "Kommo BU"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $json.id_mais_antigo }}",
              "pipeline_id": 7355323,
              "status_id": 143,
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      72614
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        880,
        128
      ],
      "id": "fca4e374-3750-43ed-bad8-233b93ede6fc",
      "name": "apagar lead",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "0RLQwTFNZKVcXRY1",
          "name": "Kommo acad√™mico BU"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Code1').item.json.id_mais_recente }}",
              "pipeline_id": 7355323,
              "status_id": 60510447,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":412928,\"type\":\"text\"}",
                    "value": "={{ $('Code1').item.json.campos_extraidos.RA }}"
                  },
                  {
                    "data": "{\"id\":412930,\"type\":\"text\"}",
                    "value": "={{ $('array dados').item.json.Pesquisa }}"
                  },
                  {
                    "data": "{\"id\":412932,\"type\":\"text\"}",
                    "value": "={{ $('Code1').item.json.campos_extraidos.Curso }}"
                  },
                  {
                    "data": "{\"id\":412934,\"type\":\"text\"}",
                    "value": "={{ $('Code1').item.json.campos_extraidos.Polo }}"
                  },
                  {
                    "data": "{\"id\":1473851,\"type\":\"text\"}",
                    "value": "={{ $('Code1').item.json.campos_extraidos.Telefone }}"
                  },
                  {
                    "data": "{\"id\":1473849,\"type\":\"text\"}",
                    "value": "={{ $('Code1').item.json.campos_extraidos.Nome }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1120,
        128
      ],
      "id": "6508fa7d-a88e-451a-a596-bdf81a20a8e7",
      "name": "update lead",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "0RLQwTFNZKVcXRY1",
          "name": "Kommo acad√™mico BU"
        }
      }
    }
  ],
  "connections": {
    "query": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "array dados": {
      "main": [
        [
          {
            "node": "Get list of leads2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of leads2": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pesquisa no Acad√™mico": {
      "main": [
        [
          {
            "node": "array dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "apagar lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Pesquisa no Acad√™mico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "update lead (info comercial)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Get list of leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of leads": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "apagar lead": {
      "main": [
        [
          {
            "node": "update lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "amoCRM-Webhooks/3.0",
            "content-length": "194",
            "accept-encoding": "gzip",
            "content-type": "application/x-www-form-urlencoded",
            "x-amocrm-requestid": "8bf88892-50c1-4ae9-979f-b5599ae3702e",
            "x-forwarded-for": "169.150.216.79",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "169.150.216.79"
          },
          "params": {},
          "query": {},
          "body": {
            "leads[add][0][id]": "22249093",
            "leads[add][0][status_id]": "60510443",
            "leads[add][0][pipeline_id]": "7355323",
            "account[id]": "31697347",
            "account[subdomain]": "academicosoead"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/a687347b-6449-4bf6-9888-c1da0413ceb6",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "701f4a6b-dc97-4166-b173-8d32e1cca684",
  "triggerCount": 1,
  "tags": []
}