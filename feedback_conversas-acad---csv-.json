{
  "createdAt": "2025-09-08T15:14:31.379Z",
  "updatedAt": "2025-09-15T14:17:21.000Z",
  "id": "IgOWFfW4ekpHKPrA",
  "name": "feedback_conversas acad - csv",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH param AS (\n  SELECT regexp_replace(trim('{{$json.data.custom_fields_values[0].values[0].value}}'), '\\D', '', 'g') AS phone_digits\n)\nSELECT *\nFROM crm_messages m\nCROSS JOIN param p\nWHERE regexp_replace(m.whatsapp_to, '\\D', '', 'g') = p.phone_digits\n  AND (m.message_ts AT TIME ZONE 'America/Sao_Paulo')::date = (now() AT TIME ZONE 'America/Sao_Paulo')::date;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -832,
        176
      ],
      "id": "5818cc5d-4440-49b1-851f-4e30d9bf44a5",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "9HdbVgjDeNXGxrxq",
          "name": "Log_Conversa"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node\n// Entrada: v√°rios itens (cada item = 1 mensagem)\n// Sa√≠da: 1 item por whatsapp_to, com m√©tricas de tempo e estruturas para IA\nconst tz = 'America/Sao_Paulo';\n\nfunction fmtBR(tsStr) {\n  const d = new Date(tsStr);\n  return d.toLocaleString('pt-BR', { timeZone: tz, hour12: false });\n}\nfunction toBRDate(tsStr) {\n  return new Date(tsStr);\n}\nfunction toHHMMSS(totalSeconds) {\n  if (totalSeconds == null || !isFinite(totalSeconds)) return null;\n  const s = Math.max(0, Math.round(totalSeconds));\n  const h = Math.floor(s / 3600);\n  const m = Math.floor((s % 3600) / 60);\n  const sec = s % 60;\n  const pad = (n) => n.toString().padStart(2, '0');\n  return `${pad(h)}:${pad(m)}:${pad(sec)}`;\n}\n\n// Formata para TIME do Postgres: 'HH:MM:SS.mmm' (at√© 6 casas se quiser)\nfunction toPgTime(totalSeconds, fractionDigits = 3) {\n  if (totalSeconds == null || !isFinite(totalSeconds)) return null;\n  if (totalSeconds < 0) totalSeconds = 0;\n\n  // TIME n√£o comporta >= 24h ‚Äì retorne null para evitar erro\n  const maxSecs = 24 * 3600 - 1e-6; // um tiquinho abaixo de 24h\n  if (totalSeconds >= maxSecs) return null;\n\n  const pad2 = (n) => n.toString().padStart(2, '0');\n\n  const whole = Math.floor(totalSeconds);\n  const frac = Math.max(0, totalSeconds - whole);\n\n  const h = Math.floor(whole / 3600);\n  const m = Math.floor((whole % 3600) / 60);\n  const s = whole % 60;\n\n  if (fractionDigits <= 0) {\n    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;\n  }\n  const fracStr = (Math.round(frac * Math.pow(10, fractionDigits))).toString().padStart(fractionDigits, '0');\n  return `${pad2(h)}:${pad2(m)}:${pad2(s)}.${fracStr}`;\n}\n\nfunction avg(arr) {\n  if (!arr.length) return null;\n  return arr.reduce((a,b)=>a+b,0) / arr.length;\n}\n\n// 1) Agrupar por whatsapp_to\nconst porNumero = new Map();\nfor (const item of items) {\n  const r = item.json;\n  const w = r.whatsapp_to || 'desconhecido';\n  if (!porNumero.has(w)) porNumero.set(w, []);\n  porNumero.get(w).push(r);\n}\n\nconst saida = [];\n\nfor (const [whats, listaRaw] of porNumero.entries()) {\n  // 2) Ordenar por timestamp\n  const lista = [...listaRaw].sort((a, b) => new Date(a.message_ts) - new Date(b.message_ts));\n\n  // 3) Transcript + estrutura messages\n  const linhas = [];\n  const msgs = [];\n  for (const r of lista) {\n    const quem = (r.direction === 'IN') ? 'Cliente' : (r.agent_id || 'Agente');\n    const quando = fmtBR(r.message_ts);\n    const texto = (r.message_text ?? '').toString().trim();\n\n    linhas.push(`[${quando}] ${quem}: ${texto}`);\n    msgs.push({\n      ts: quando,\n      sender: (r.direction === 'IN') ? 'Cliente' : (r.agent_id || 'Agente'),\n      role: r.direction === 'IN' ? 'user' : 'assistant',\n      text: texto,\n      // <<< NOVO: preservar agent_id bruto por mensagem (null para IN)\n      agent_id: r.agent_id ?? null,\n    });\n  }\n\n  // 4) M√©tricas de tempo\n  const firstTs = lista.length ? toBRDate(lista[0].message_ts).getTime() : null;\n  const lastTs  = lista.length ? toBRDate(lista[lista.length - 1].message_ts).getTime() : null;\n  const duracaoTotalSec = (firstTs != null && lastTs != null) ? (lastTs - firstTs) / 1000 : null;\n\n  // tempos de resposta IN -> pr√≥ximo OUT\n  const diffsSec = [];\n  let primeiraRespostaSec = null;\n\n  const outs = lista.filter(m => m.direction === 'OUT');\n  for (const msg of lista) {\n    if (msg.direction !== 'IN') continue;\n    const tIN = toBRDate(msg.message_ts).getTime();\n    const proxOUT = outs.find(o => toBRDate(o.message_ts).getTime() > tIN);\n    if (proxOUT) {\n      const tOUT = toBRDate(proxOUT.message_ts).getTime();\n      const delta = (tOUT - tIN) / 1000;\n      diffsSec.push(delta);\n      if (primeiraRespostaSec == null) primeiraRespostaSec = delta;\n    }\n  }\n\n  const mediaRespostaSec = avg(diffsSec);\n\n  // 5) Contadores √∫teis\n  const totalIN = lista.filter(m => m.direction === 'IN').length;\n  const totalOUT = lista.filter(m => m.direction === 'OUT').length;\n\n  // 6) Agentes envolvidos na conversa\n  const outsComAgente = lista.filter(m => m.direction === 'OUT' && m.agent_id);\n  const agentesUnicos = [...new Set(outsComAgente.map(m => m.agent_id))];\n  const primeiroAgenteId = outsComAgente.length ? outsComAgente[0].agent_id : null;\n  const ultimoAgenteId   = outsComAgente.length ? outsComAgente[outsComAgente.length - 1].agent_id : null;\n\n  saida.push({\n    json: {\n      whatsapp_to: whats,\n      total_mensagens: lista.length,\n      total_cliente_IN: totalIN,\n      total_agente_OUT: totalOUT,\n\n      // <<< NOVOS CAMPOS DE AGENTE\n      agentes_ids: agentesUnicos,          // ex.: [\"Camila\"]\n      primeiro_agente_id: primeiroAgenteId, // ex.: \"Camila\"\n      ultimo_agente_id: ultimoAgenteId,     // ex.: \"Camila\"\n\n      // timestamps (texto)\n      primeira_mensagem_ts: lista.length ? fmtBR(lista[0].message_ts) : null,\n      ultima_mensagem_ts:   lista.length ? fmtBR(lista[lista.length - 1].message_ts) : null,\n\n      // dura√ß√£o total (n√∫mero e formatos)\n      duracao_total_segundos: duracaoTotalSec,                    // use NUMERIC/DOUBLE no Supabase\n      duracao_total_hhmmss: toHHMMSS(duracaoTotalSec),            // string simples\n      duracao_total_time:   toPgTime(duracaoTotalSec, 3),         // **campo compat√≠vel com TIME 'HH:MM:SS.mmm'**\n\n      // primeira resposta do agente ap√≥s o primeiro IN\n      primeira_resposta_segundos: primeiraRespostaSec,            // NUMERIC/DOUBLE\n      primeira_resposta_hhmmss: toHHMMSS(primeiraRespostaSec),\n      primeira_resposta_time:   toPgTime(primeiraRespostaSec, 3), // **TIME**\n\n      // tempo m√©dio de resposta (IN -> pr√≥ximo OUT)\n      tempo_medio_resposta_segundos: mediaRespostaSec,            // NUMERIC/DOUBLE\n      tempo_medio_resposta_hhmmss: toHHMMSS(mediaRespostaSec),\n      tempo_medio_resposta_time:   toPgTime(mediaRespostaSec, 3), // **TIME**\n\n      // transcript para IA + messages estruturado\n      transcript: linhas.join('\\n'),\n      messages: msgs\n    }\n  });\n}\n\nreturn saida;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        176
      ],
      "id": "9be224b9-ae54-4933-a4da-93c96d763821",
      "name": "Code"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "conversas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1952,
        176
      ],
      "id": "ccbb14bc-d219-44d0-9e20-9980538c51ee",
      "name": "Webhook",
      "webhookId": "2e463232-decb-4722-a77e-6f4f4fea2be2"
    },
    {
      "parameters": {
        "url": "https://csvatendimento.kommo.com/api/v4/leads",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "with",
              "value": "contacts"
            },
            {
              "name": "query",
              "value": "={{ $json.body[\"leads[add][0][id]\"] }}"
            },
            {
              "name": "filter[statuses][0][pipeline_id]",
              "value": "6961711"
            },
            {
              "name": "filter[statuses][0][status_id]",
              "value": "61685383"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjRhMTQyMjYwYWE5YmY2MTU2YTkwMjg5ZDFiZTEzYjE5NDc2NmJmNjkxZTZlYTUzNzY2NmFjYTU2ODJkYzViMGM5NTdjMDMzZTg3ODkyYzg0In0.eyJhdWQiOiI1MzQyMjFiYy1mM2ZmLTQ2YjYtYWRlYi02N2I5NGRmNWEzYzEiLCJqdGkiOiI0YTE0MjI2MGFhOWJmNjE1NmE5MDI4OWQxYmUxM2IxOTQ3NjZiZjY5MWU2ZWE1Mzc2NjZhY2E1NjgyZGM1YjBjOTU3YzAzM2U4Nzg5MmM4NCIsImlhdCI6MTc1NzM1MDc3MiwibmJmIjoxNzU3MzUwNzcyLCJleHAiOjE3NzI3NTUyMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzEzNzA1MTEsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJ1c2VyX2ZsYWdzIjowLCJoYXNoX3V1aWQiOiJjNTNmM2RlZi05NDkxLTRjODMtYWUyZS0zNTliYjMzODc1YTUiLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.rBJalBWuV7EEgkqaEeVz7EzDQ5BZb1o-F25MXIl-bgFmDGQG23EHQTl_Em79I4Uc5wO7rxv5hf8YUEX7SxVHy--MUPe0XI6uvYAGFJDbnXHeJ3Z3v31c-Tb0MIbG4u6zxsIxHp5Uy1tuFgSpya08FWGloImcFQ86_ivq_VvQc-TiMmOwDH7BxwMn9DHI9itY_dAtjxPSDEjodMz827I2fVXPxC-csYNrtcpvcKB2G0gGn9EPhcOyUd9oxnyVOWrLl9k6uxWvR8j5uWkj7LvENlaT3_DekX-O_6nS_PbAXxdZ7FuYWYMshKaxa2FBEAXuu7LHxDXkcKTiRv8GgBTIGQ"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1728,
        176
      ],
      "id": "02a27597-a4e4-4630-be6b-ed40dd7bdda6",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6f3596e1-283b-4b60-bb07-7eefdaf14ea7",
              "name": "data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1504,
        176
      ],
      "id": "f3ffba76-56d4-4cfa-beb5-d1cb0c9397b4",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "=https://csvatendimento.kommo.com/api/v4/contacts/{{ $json.data._embedded.leads[0]._embedded.contacts[0].id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjRhMTQyMjYwYWE5YmY2MTU2YTkwMjg5ZDFiZTEzYjE5NDc2NmJmNjkxZTZlYTUzNzY2NmFjYTU2ODJkYzViMGM5NTdjMDMzZTg3ODkyYzg0In0.eyJhdWQiOiI1MzQyMjFiYy1mM2ZmLTQ2YjYtYWRlYi02N2I5NGRmNWEzYzEiLCJqdGkiOiI0YTE0MjI2MGFhOWJmNjE1NmE5MDI4OWQxYmUxM2IxOTQ3NjZiZjY5MWU2ZWE1Mzc2NjZhY2E1NjgyZGM1YjBjOTU3YzAzM2U4Nzg5MmM4NCIsImlhdCI6MTc1NzM1MDc3MiwibmJmIjoxNzU3MzUwNzcyLCJleHAiOjE3NzI3NTUyMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzEzNzA1MTEsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJ1c2VyX2ZsYWdzIjowLCJoYXNoX3V1aWQiOiJjNTNmM2RlZi05NDkxLTRjODMtYWUyZS0zNTliYjMzODc1YTUiLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.rBJalBWuV7EEgkqaEeVz7EzDQ5BZb1o-F25MXIl-bgFmDGQG23EHQTl_Em79I4Uc5wO7rxv5hf8YUEX7SxVHy--MUPe0XI6uvYAGFJDbnXHeJ3Z3v31c-Tb0MIbG4u6zxsIxHp5Uy1tuFgSpya08FWGloImcFQ86_ivq_VvQc-TiMmOwDH7BxwMn9DHI9itY_dAtjxPSDEjodMz827I2fVXPxC-csYNrtcpvcKB2G0gGn9EPhcOyUd9oxnyVOWrLl9k6uxWvR8j5uWkj7LvENlaT3_DekX-O_6nS_PbAXxdZ7FuYWYMshKaxa2FBEAXuu7LHxDXkcKTiRv8GgBTIGQ"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        176
      ],
      "id": "2efc3ec8-ef2d-4c5f-9134-3cee37732b69",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "91c3defb-bf2e-4395-9db5-4b71ee51e221",
              "name": "data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1056,
        176
      ],
      "id": "5a753613-33cd-4a42-8eb2-d816396ebe85",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Aqui est√° a conversa de hoje com o cliente:\n:\n{{ $json.transcript }}",
        "options": {
          "systemMessage": "=# Prompt Otimizado - An√°lise de Qualidade de Atendimento\n\n## IDENTIDADE E CONTEXTO\nVoc√™ √© um **Analista S√™nior de Qualidade de Atendimento** da Universidade Cruzeiro do Sul Virtual, especializado em avalia√ß√£o objetiva de intera√ß√µes de p√≥s-venda.\n\n## PROCESSO OBRIGAT√ìRIO\n### PASSO 1: CLASSIFICA√á√ÉO T√âCNICA\n- **EXECUTE OBRIGATORIAMENTE** a ferramenta `rerank` para recuperar os n√≠veis de classifica√ß√£o\n- **AGUARDE** o retorno completo dos campos: `nivel_1`, `nivel_2`, `nivel_3`\n- **N√ÉO PROSSIGA** sem estes dados estruturados\n\n### PASSO 2: AN√ÅLISE FACTUAL\nAnalise **EXCLUSIVAMENTE OS FATOS EXPL√çCITOS** da conversa:\n- Identifique o consultor respons√°vel: `{{ $json.messages[4].sender }}`\n- Cronometre a dura√ß√£o do atendimento (marque se >2h para quest√µes simples)\n- Documente a√ß√µes concretas realizadas pelo consultor\n- Registre manifesta√ß√µes textuais do cliente (elogios/reclama√ß√µes)\n\n### PASSO 3: AVALIA√á√ÉO CRITERIOSA\n**CRIT√âRIOS DE AN√ÅLISE:**\n- ‚úÖ **Resolu√ß√£o Efetiva**: Demanda foi completamente atendida?\n- ‚è±Ô∏è **Tempo de Resposta**: Dentro do padr√£o institucional?\n- üìã **Ader√™ncia a Procedimentos**: Seguiu protocolos estabelecidos?\n- üòä **Satisfa√ß√£o do Cliente**: Evid√™ncias expl√≠citas de contentamento/descontentamento\n\n## ESTRUTURA DE OUTPUT OBRIGAT√ìRIA\n\n**RETORNE EXCLUSIVAMENTE EM FORMATO JSON:**\n\n```json\n{\n  \"consultor_responsavel\": \"{{ $json.messages[4].sender }}\",\n  \"duracao_atendimento\": \"[tempo em minutos/horas]\",\n  \"ponto_positivo\": \"[A√ß√£o espec√≠fica bem executada pelo consultor - m√°ximo 80 caracteres]\",\n  \"ponto_negativo\": \"[Problema concreto identificado ou 'Nenhum identificado' - m√°ximo 80 caracteres]\",\n  \"feedback\": {\n    \"demanda\": \"[Descri√ß√£o exata do que o cliente solicitou - m√°ximo 120 caracteres]\",\n    \"resolucao\": \"[Status: Resolvido/Parcialmente Resolvido/N√£o Resolvido + a√ß√µes tomadas - m√°ximo 120 caracteres]\",\n    \"problemas_identificados\": \"[Fatos objetivos ou 'Nenhum problema identificado' - m√°ximo 120 caracteres]\",\n    \"resultado\": \"[Desfecho baseado em evid√™ncias da conversa - m√°ximo 120 caracteres]\"\n  },\n  \"tabela_niveis\": {\n    \"nivel_1\": \"[valor_exato_retornado_pelo_rerank]\",\n    \"nivel_2\": \"[valor_exato_retornado_pelo_rerank]\",\n    \"nivel_3\": \"[valor_exato_retornado_pelo_rerank]\"\n  },\n  \"metricas_qualidade\": {\n    \"tempo_resposta_adequado\": true/false,\n    \"procedimento_seguido\": true/false,\n    \"cliente_satisfeito\": true/false/null\n  }\n}\n```\n\n## DIRETRIZES CR√çTICAS\nüö´ **PROIBIDO:**\n- Fazer infer√™ncias sobre sentimentos n√£o expressos\n- Supor inten√ß√µes do cliente ou consultor\n- Criar informa√ß√µes n√£o presentes na conversa\n- Retornar formato diferente do JSON especificado\n\n‚úÖ **OBRIGAT√ìRIO:**\n- Usar apenas informa√ß√µes expl√≠citas\n- Citar textualmente elogios/reclama√ß√µes quando existirem\n- Identificar o consultor respons√°vel\n- Aguardar dados completos do `rerank` antes de prosseguir\n- Manter objetividade e precis√£o factual\n\n## VALIDA√á√ÉO FINAL\nAntes de retornar, verifique:\n- [ ] JSON v√°lido e bem formatado\n- [ ] Todos os campos preenchidos\n- [ ] Consultor identificado corretamente\n- [ ] Dados do `rerank` inclu√≠dos\n- [ ] An√°lise baseada apenas em fatos expl√≠citos"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -352,
        176
      ],
      "id": "b2307f02-d02e-4ac4-b76e-d24445a7eac7",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -384,
        400
      ],
      "id": "49c9c167-7bc9-44cd-b5e4-0a2152224d14",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "feedback",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "consultor",
              "fieldValue": "={{ $('Code').item.json.agentes_ids[0] }}"
            },
            {
              "fieldId": "feedback",
              "fieldValue": "={{ $json.feedback_texto }}"
            },
            {
              "fieldId": "ponto_positivo",
              "fieldValue": "={{ $json.ponto_positivo }}"
            },
            {
              "fieldId": "ponto_negativo",
              "fieldValue": "={{ $json.ponto_negativo }}"
            },
            {
              "fieldId": "tempo_atendimento",
              "fieldValue": "={{ $('Code').item.json.duracao_total_hhmmss }}"
            },
            {
              "fieldId": "tempo_medio_resposta",
              "fieldValue": "={{ $('Code').item.json.tempo_medio_resposta_hhmmss }}"
            },
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "nv1",
              "fieldValue": "={{ $json.nivel_1 }}"
            },
            {
              "fieldId": "nv2",
              "fieldValue": "={{ $json.nivel_2 }}"
            },
            {
              "fieldId": "nv3",
              "fieldValue": "={{ $json.nivel_3 }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        368,
        176
      ],
      "id": "d0115b4a-d3cb-4b7d-842f-293d4ed4f4f0",
      "name": "Create a row",
      "credentials": {
        "supabaseApi": {
          "id": "71OBWtC8t38iEtPO",
          "name": "Supabase Academico"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (JavaScript)\n// Modo: Run Once for All Items\n\nfunction safeParse(jsonStr) {\n  if (typeof jsonStr !== 'string') return null;\n  try {\n    return JSON.parse(jsonStr);\n  } catch (e) {\n    // tenta extrair apenas o objeto {...} se vier com prefixo/sufixo\n    const s = jsonStr.indexOf('{');\n    const e2 = jsonStr.lastIndexOf('}');\n    if (s >= 0 && e2 >= 0) {\n      try { \n        return JSON.parse(jsonStr.slice(s, e2 + 1)); \n      } catch (_) {\n        console.log('Erro no parsing do JSON:', _);\n      }\n    }\n    return null;\n  }\n}\n\n// Processamento principal\nconst results = items.map(item => {\n  const raw = item.json?.output ?? \"\";\n  console.log(\"Raw output recebido:\", raw);\n  \n  const parsed = safeParse(raw);\n  console.log(\"Parsed JSON:\", parsed);\n  \n  if (!parsed) {\n    console.log(\"Erro: n√£o foi poss√≠vel fazer parse do JSON\");\n    return {\n      json: {\n        consultor_responsavel: null,\n        duracao_atendimento: null,\n        ponto_positivo: null,\n        ponto_negativo: null,\n        feedback_texto: null,\n        demanda: null,\n        resolucao: null,\n        problemas_identificados: null,\n        resultado: null,\n        nivel_1: null,\n        nivel_2: null,\n        nivel_3: null,\n        tempo_resposta_adequado: null,\n        procedimento_seguido: null,\n        cliente_satisfeito: null\n      }\n    };\n  }\n\n  // Extra√ß√£o direta dos dados\n  const consultor = parsed.consultor_responsavel || null;\n  const duracao = parsed.duracao_atendimento || null;\n  const pontoPositivo = parsed.ponto_positivo || null;\n  const pontoNegativo = parsed.ponto_negativo || null;\n  \n  // Extrai feedback (objeto aninhado)\n  const feedback = parsed.feedback || {};\n  const demanda = feedback.demanda || null;\n  const resolucao = feedback.resolucao || null;\n  const problemas = feedback.problemas_identificados || null;\n  const resultado = feedback.resultado || null;\n  \n  // Extrai n√≠veis (objeto aninhado)\n  const niveis = parsed.tabela_niveis || {};\n  const nivel1 = niveis.nivel_1 || null;\n  const nivel2 = niveis.nivel_2 || null;\n  const nivel3 = niveis.nivel_3 || null;\n  \n  // Extrai m√©tricas (objeto aninhado)\n  const metricas = parsed.metricas_qualidade || {};\n  const tempoAdequado = metricas.tempo_resposta_adequado;\n  const procedimentoSeguido = metricas.procedimento_seguido;\n  const clienteSatisfeito = metricas.cliente_satisfeito;\n  \n  // RECONSTR√ìI O FEEDBACK_TEXTO (CAMPO ESSENCIAL PARA TABULA√á√ÉO)\n  let feedbackTexto = null;\n  if (demanda || resolucao || problemas || resultado) {\n    const partes = [];\n    if (demanda) partes.push(`Demanda: ${demanda}`);\n    if (resolucao) partes.push(`Resolu√ß√£o: ${resolucao}`);\n    if (problemas) partes.push(`Problemas Identificados: ${problemas}`);\n    if (resultado) partes.push(`Resultado: ${resultado}`);\n    feedbackTexto = partes.join('\\n');\n  }\n  \n  console.log(\"Feedback texto reconstru√≠do:\", feedbackTexto);\n  \n  const resultado_final = {\n    consultor_responsavel: consultor,\n    duracao_atendimento: duracao,\n    ponto_positivo: pontoPositivo,\n    ponto_negativo: pontoNegativo,\n    feedback_texto: feedbackTexto, // CAMPO CR√çTICO PARA TABULA√á√ÉO\n    demanda: demanda,\n    resolucao: resolucao,\n    problemas_identificados: problemas,\n    resultado: resultado,\n    nivel_1: nivel1,\n    nivel_2: nivel2,\n    nivel_3: nivel3,\n    tempo_resposta_adequado: tempoAdequado,\n    procedimento_seguido: procedimentoSeguido,\n    cliente_satisfeito: clienteSatisfeito\n  };\n  \n  console.log(\"Resultado final para este item:\", resultado_final);\n  \n  return {\n    json: resultado_final\n  };\n});\n\nconsole.log(\"Array de resultados completo:\", results);\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        176
      ],
      "id": "96167c90-3abc-4517-a811-06146c365a52",
      "name": "Code1"
    },
    {
      "parameters": {
        "name": "rerank",
        "topK": 1
      },
      "id": "8474e5a1-febb-4bfb-9ed1-26eb3f9a2976",
      "name": "rerank",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        -256,
        400
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -80,
        608
      ],
      "id": "50041389-619c-4d6b-ab39-6cb38d23839f",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "rerank",
          "mode": "list",
          "cachedResultName": "rerank"
        },
        "options": {
          "queryName": "rerank_fn"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -368,
        608
      ],
      "id": "bde526fb-518f-48f2-a164-3328a50bd55c",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -288,
        816
      ],
      "id": "2fd1c990-6aa5-48ff-86e4-e1a10a70ce1c",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "connections": {
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rerank": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "rerank",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "rerank",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "amoCRM-Webhooks/3.0",
            "content-length": "194",
            "accept-encoding": "gzip",
            "content-type": "application/x-www-form-urlencoded",
            "x-amocrm-requestid": "bf9f334d-3957-4597-a7f8-7951250adc66",
            "x-forwarded-for": "169.150.216.79",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "169.150.216.79"
          },
          "params": {},
          "query": {},
          "body": {
            "leads[add][0][id]": "17686653",
            "leads[add][0][status_id]": "61685383",
            "leads[add][0][pipeline_id]": "6961711",
            "account[id]": "31370511",
            "account[subdomain]": "csvatendimento"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/conversas",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "606dfcb8-b24a-47d0-8e1c-981f2fee4927",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-09-08T15:14:31.382Z",
      "updatedAt": "2025-09-08T15:14:31.382Z",
      "role": "workflow:owner",
      "workflowId": "IgOWFfW4ekpHKPrA",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": []
}