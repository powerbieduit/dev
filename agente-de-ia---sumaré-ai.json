{
  "createdAt": "2025-09-03T18:37:08.074Z",
  "updatedAt": "2025-10-17T20:18:50.000Z",
  "id": "DJXUuFnK2t3E2NrN",
  "name": "Agente de IA - Sumaré",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "4648d89c-95e2-4248-8a56-a3461187a435",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        5104,
        576
      ]
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        2848,
        464
      ],
      "id": "055960a9-23f1-45e2-a64b-d18428cb6a68",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        5120,
        224
      ],
      "id": "5f66fb0c-abd0-4a45-9ba5-ce5df1989a2c",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4672,
        224
      ],
      "id": "926fb599-8934-4556-acdc-dd94f81e097f",
      "name": "If4"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats_sum",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4448,
        224
      ],
      "id": "2eabffc2-a81f-4281-a026-7ff4e2f76fef",
      "name": "Busca Telefone",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats_sum",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4896,
        144
      ],
      "id": "b999411a-2b08-499c-a107-a83e86561fba",
      "name": "Adiciona CHAT supabase",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats_sum",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4896,
        320
      ],
      "id": "decc9058-01cc-41f2-b24e-2cb8610ebfc0",
      "name": "Atualiza CHAT Supabase",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_messages_sum",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('orquestrador').first().json.output }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').first().json.NomeWpp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5344,
        224
      ],
      "id": "0ddfd264-5049-4c36-b967-700d21097568",
      "name": "Cria Histórico Supabase",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "6f99b837-0deb-4c77-ad2b-1316a6292f31",
      "name": "Split de Mensagem",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        4880,
        576
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "5574476f-010f-47d2-82b6-90005c025d03",
      "name": "1 segundo",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5600,
        592
      ],
      "webhookId": "a2c69e1c-13fe-44a2-962c-1249288537eb"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "e3f8f530-0dfb-49ca-82d8-926a94e266ac",
      "name": "Delete Memory",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5584,
        224
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 988,
        "width": 1116,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        864,
        96
      ],
      "typeVersion": 1,
      "id": "1fccf1e8-4b72-4274-b589-76566fc7cd64",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 988,
        "width": 2548,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1680,
        96
      ],
      "typeVersion": 1,
      "id": "5714d929-2185-4ffb-ad31-97797c0f1480",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "# PAUSA",
        "height": 988,
        "width": 2532,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5264,
        96
      ],
      "typeVersion": 1,
      "id": "a27ca770-3e46-460c-bee0-f24b0846149d",
      "name": "Sticky Note26"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "b7da9376-81a7-4dad-9946-56290f2fd150",
      "name": "Edit Fields3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -736,
        752
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente_sum",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "pause"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3568,
        240
      ],
      "id": "ce58e128-4ed0-46f8-9687-6e4109ccd8e9",
      "name": "Pausar IA",
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "pause",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff00573b-e517-43c6-8644-14a4fe8565d1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Ativa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "=pause",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA pausada"
            }
          ]
        },
        "options": {}
      },
      "id": "674993a8-add2-4a99-b1fc-be3f71ea78d0",
      "name": "Rota Atendimento",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -4032,
        640
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "leftValue": "={{ $('Dados').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Pausada"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Normal ou Treinamento').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reativar IA"
            }
          ]
        },
        "options": {}
      },
      "id": "5693c2a3-6627-43c9-9dfb-8749338d375a",
      "name": "Rotas1",
      "type": "n8n-nodes-base.switch",
      "position": [
        -4032,
        256
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente_sum",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "reativada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3568,
        432
      ],
      "id": "54ee1f1c-69fc-4553-9a7d-9030d6ace183",
      "name": "Reativar IA",
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11800d83-ecca-4f9c-a878-a2419db0c8e9",
              "name": "=message.chat_id",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "c33f9527-e661-49e5-8e5e-64f3b430928a",
              "name": "=message.content_type",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}",
              "type": "string"
            },
            {
              "id": "06eba1c9-cff0-4f68-b6da-6bb0092466b7",
              "name": "=message.content",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
              "type": "string"
            },
            {
              "id": "b97f1af3-5361-46fc-9303-d644921231d8",
              "name": "=message.timestamp",
              "value": "={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}",
              "type": "string"
            },
            {
              "id": "dc3dc59c-90a3-4a45-bea2-de092c91083b",
              "name": "=message.content_url",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}",
              "type": "string"
            },
            {
              "id": "8b01a818-a456-476e-bace-adefe2f04eb4",
              "name": "message.event",
              "value": "={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}",
              "type": "string"
            },
            {
              "id": "886e3751-e39b-4fc6-98d1-3113eaeebbb4",
              "name": "=body.event",
              "value": "={{ $('Webhook EVO').item.json.body.event }}",
              "type": "string"
            },
            {
              "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
              "name": "=Telefone",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "a57db642-3e13-452e-bb5b-19f7e9f3bd5d",
              "name": "=NomeWhatsapp",
              "value": "={{ $('Webhook EVO').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "f5fcee3e-a786-404b-8b92-0163e02c6615",
              "name": "=Instance",
              "value": "={{ $('Webhook EVO').item.json.body.instance }}",
              "type": "string"
            },
            {
              "id": "9a1a0c4b-ce98-4d57-a3a2-3af51174c6cb",
              "name": "id_mensagem",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "54ba7d3a-4576-43a2-bef7-7a15c1a69dd0",
      "name": "Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5712,
        496
      ]
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -3792,
        432
      ],
      "id": "64bbcaf7-ea70-42a5-8dc1-fb4e41b720a9",
      "name": "Wait",
      "webhookId": "b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"
    },
    {
      "parameters": {
        "content": "# Configuração Banco de Dados",
        "height": 840,
        "width": 1400,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6304,
        1152
      ],
      "typeVersion": 1,
      "id": "4651badf-1180-47eb-ac0f-1d5649bb9ee7",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "87acb8a9-320c-46ab-a396-b8aa4abf8533",
      "name": "If6",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        304,
        784
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "cdabf626-e37b-48c3-93b0-fa4aeeadc5ab",
      "name": "OpenAI2",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        -64,
        784
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "7f6f0848-0381-48a6-b3d6-e6a4b1d8f692",
      "name": "OpenAI4",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        576,
        576
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente_sum",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5152,
        480
      ],
      "id": "7f999766-493f-4423-bd22-df184704f536",
      "name": "Buscar Cliente",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4a6d9aac-8565-4c58-abe3-8741393a5535",
              "leftValue": "={{ $json.telefone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4864,
        480
      ],
      "id": "081402ed-eada-40f4-a452-f9b76cfe3afd",
      "name": "Cliente Existe?",
      "retryOnFail": true
    },
    {
      "parameters": {
        "tableId": "dados_cliente_sum",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').item.json.NomeWhatsapp }}"
            },
            {
              "fieldId": "telefone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4640,
        656
      ],
      "id": "56b03fff-41e3-4e66-8a4a-7b1dfd1728a7",
      "name": "Criar Cliente",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "outcoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7c878f9b-2c93-4061-954a-a832153e7647"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outcoming"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "d7b42536-638f-4128-b51b-6aa913e9d9bc",
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "incoming"
            }
          ]
        },
        "options": {}
      },
      "id": "c5a9fbf6-59f5-4d2b-a4cb-10e5cbc6ce0e",
      "name": "ROTA Entrando ou Saindo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -4416,
        464
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "1295c032-7a29-4b03-9636-c6ff29fea557",
      "name": "Converter Audio",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        256,
        576
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "ec9bf4db-1fdf-402c-9dc6-94cefe7de496",
      "name": "Converter Foto",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -400,
        768
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f1914daa-3ec7-4ef1-bcc4-b5d929360a37"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "72b60c09-a650-4951-91cb-46d9ffed5cdd",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "buttonMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "id": "9132c90b-8719-4ebb-99a6-4520ca24298f",
      "name": "ROTA Mensagens",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -1520,
        448
      ]
    },
    {
      "parameters": {
        "description": "Use a ferramenta para pensar sobre algo. Veja se conversa faz sentido, não envie informações repetidas.\n\nRespostas sempre em português."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        3216,
        1216
      ],
      "id": "8eb5cbfe-d95e-4db1-9347-003120559c38",
      "name": "thinking"
    },
    {
      "parameters": {
        "content": "# Agente Principal\n",
        "height": 1244,
        "width": 2068,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1984,
        80
      ],
      "typeVersion": 1,
      "id": "97d643a1-1016-4bfb-b89a-d6a39330298e",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "tableName": "n8n_chat_histories_sum",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2496,
        816
      ],
      "id": "02f351c0-0e0e-4e7d-afa7-9dd42a464a9a",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories_sum",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories_sum"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"ai\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3728,
        784
      ],
      "id": "d431d4f9-4347-44a2-a2c4-fc95923db1ae",
      "name": "Salvar Historico",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories_sum",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories_sum"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"human\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3360,
        320
      ],
      "id": "46483e37-9db1-4496-85b6-4d1862aba91c",
      "name": "Salvar Historico1",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2256,
        560
      ],
      "id": "1b36e636-4e8b-4965-8292-fae862c24fe3",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3136,
        320
      ],
      "id": "bf459783-e4a1-4593-9bf3-f553425d6b97",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3440,
        784
      ],
      "id": "b5930087-66b8-4ae4-b03d-6bba2fd1b53b",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "amount": 15
      },
      "id": "ea8017e4-b207-4869-acbf-2443c06843c0",
      "name": "Intervalo entre Mensagens",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1680,
        368
      ],
      "webhookId": "9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "9c3611bf-ca49-4175-af3b-3dcb2a9a9e55",
      "name": "Texto Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -256,
        336
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "4d71ea12-6eca-43d5-bd25-7974a7bae2ac",
      "name": "Audio Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        928,
        496
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "2d9228b6-f49b-477e-91d4-9ca97b5205de",
      "name": "imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1040,
        656
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "f81e5c3b-00e0-4ebe-a28d-28f0c6abbf8e",
      "name": "Imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1040,
        832
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "74570e9d-850f-4505-9395-2cce35065d4b",
      "name": "Buscas Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1888,
        368
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2336,
        352
      ],
      "id": "b1132656-1a4b-4156-a3a1-16b0ea02a6ed",
      "name": "Mensagem Completa1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "05aa66d9-1aa1-416d-8a6f-3eeab3f6d213",
      "name": "Deletar Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2560,
        320
      ],
      "credentials": {
        "redis": {
          "id": "zOQKcrdGniSBQgfR",
          "name": "Redis SUM IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE chat_messages_sum (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6240,
        1328
      ],
      "id": "87d0ca32-68cf-4a51-9f19-dc2e2e35acb1",
      "name": "chat_messages",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table dados_cliente_sum (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5840,
        1328
      ],
      "id": "0eab5f9a-d0b7-4098-ab2d-9bf514864fb0",
      "name": "dados_cliente",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table chats_sum (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5216,
        1328
      ],
      "id": "8cfeca14-1113-46c7-ab9b-912813e97d89",
      "name": "chats",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create extension vector;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6048,
        1328
      ],
      "id": "36924c9f-6b1c-4579-a795-d9329c539240",
      "name": "vetor",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "drop function if exists match_documents_sum(vector(1536), int, jsonb);\n\ncreate or replace function match_documents_sum (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    d.id,\n    d.content,\n    d.metadata,\n    1 - (d.embedding <=> query_embedding) as similarity\n  from documents_sumare_sum as d\n  where d.metadata @> filter\n  order by d.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5440,
        1328
      ],
      "id": "251d0054-93f1-4eab-b948-e5b7649f2fcd",
      "name": "match_documents",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents_sumare_sum (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5648,
        1328
      ],
      "id": "ac219dcc-f5c4-486c-ae4c-abec0cf7e207",
      "name": "documents",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "content": "## Criação\n",
        "height": 324,
        "width": 1344,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6288,
        1264
      ],
      "typeVersion": 1,
      "id": "1ab063a4-3704-48e6-ad79-feb3916110f0",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Limpeza\n",
        "height": 260,
        "width": 1328,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6272,
        1648
      ],
      "typeVersion": 1,
      "id": "1fd26f16-041a-47ce-a00a-809e2c801ffe",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notStartsWith"
                    },
                    "leftValue": "={{ $json.message.content }}",
                    "rightValue": "289090:"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Rota normal"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "leftValue": "={{ $json.message.content }}",
                    "rightValue": "289090:"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Treinamento IA"
            }
          ]
        },
        "options": {}
      },
      "id": "1b8556ec-1a96-4335-989c-51b093b1da73",
      "name": "Normal ou Treinamento",
      "type": "n8n-nodes-base.switch",
      "position": [
        -5456,
        496
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM n8n_chat_histories_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6176,
        1728
      ],
      "id": "c596f66d-a174-4412-93f4-0586a7b4bbc8",
      "name": "Deletar Histórico",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chat_messages_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5152,
        1728
      ],
      "id": "269eabf8-232a-448e-89e8-5a5898eb9539",
      "name": "Deletar conteúdo Chat_Messages",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from dados_cliente_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5680,
        1728
      ],
      "id": "5b11a745-a9d6-4808-917a-5b41bd340533",
      "name": "Deletar conteúdo Dados Cliente",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chats_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5920,
        1728
      ],
      "id": "171611f3-3faa-4c1f-8d90-9d7297565968",
      "name": "Deletar conteúdo Chats",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5424,
        1728
      ],
      "id": "1df83895-8c6b-41e8-8d2c-dc26d5b0257d",
      "name": "Deletar conteúdo Documentos",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0d174948-6a39-4f1d-9a09-085da7ad5f80",
      "name": "Compara Memoria",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2112,
        368
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('orquestrador').item.json.output }}\n",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={\n  \"messages\": [\n    \"Você é um assistente que irá dividir uma mensagem longa de WhatsApp em partes menores, mantendo um tom humano e fluido, como em uma conversa natural.\",\n    \"Responda SOMENTE com JSON válido neste formato exato: {\\\"messages\\\": [\\\"mensagem 1\\\", \\\"mensagem 2\\\"]}\",\n    \"Não coloque ```json ou qualquer outro texto fora do JSON.\",\n    \"Utilize quebras de linha reais com \\\\n dentro das mensagens. Nunca retorne \\\\n escapado como \\\\\\\\n.\",\n    \"Cada mensagem deve ter entre 250 e 350 caracteres. Não quebre frases no meio. O texto deve ser fluido.\",\n    \"NÃO reescreva, adicione explicações ou expanda o conteúdo. Apenas divida a mensagem original conforme solicitado.\",\n    \"Prefira mensagens curtas e objetivas, focando somente no conteúdo da mensagem original.\",\n    \"Nunca gere mais que 3 mensagens. Se possível, faça em menos.\",\n    \"NUNCA retorne mensagens vazias.\",\n    \"Remova qualquer uso de negrito, itálico ou tachado. Não use marcadores de formatação.\",\n    \"Todo link começando com https:// deve estar entre crases. Exemplo: `https://drive.google.com/...`\",\n    \"Retorne apenas o JSON. Nenhum texto antes ou depois.\",\n    \"A entrada será passada assim: Whatsapp message to be splitted and formatted: {{ $json.output }}\"\n  ]\n}\n"
            }
          ]
        }
      },
      "id": "0c48c4ff-a89e-487c-8fe7-8653a3a9816a",
      "name": "Split de mensagens",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        4528,
        576
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "75653ac0-3ae6-411b-9419-5e050df21e48",
      "name": "OpenAI Split",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        4496,
        784
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "374d7ec7-ad6a-4933-b6c5-b08eb844c637",
      "name": "Modelo Output",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        4640,
        800
      ]
    },
    {
      "parameters": {
        "content": "# INICIO\n\n",
        "height": 988,
        "width": 1040,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6304,
        96
      ],
      "typeVersion": 1,
      "id": "6ddcff8e-0909-410e-8f65-11f05e5bbef6",
      "name": "Sticky Note32"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2896,
        1216
      ],
      "id": "4117de1f-0c3c-4e4f-ba0e-6fad4ca19e97",
      "name": "Calculator"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "0a59944b-ca0c-45d0-b436-fdb9ec50f034",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -96,
        576
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1488,
        368
      ],
      "id": "615c562b-758f-4916-8c43-ca5bff055316",
      "name": "Mensagem"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4672,
        976
      ],
      "id": "fb22809d-c05b-45e5-80c7-7c7bdc95e915",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"DISTRIBUIR_\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "MfpFMb8bfaQRgbda",
          "mode": "list",
          "cachedResultName": "distribuir_atendimento_ia_sumaré"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "Telefone",
              "displayName": "Telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        3520,
        1216
      ],
      "id": "5ddd1fa4-46f1-4dae-9634-e198ca37c96c",
      "name": "distribuir_humano"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -3424,
        1472
      ],
      "id": "64f4c58a-26e2-42d8-8320-546416c130e8",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "dataType": "binary",
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        -3280,
        1424
      ],
      "id": "9d4a2a41-a182-4e94-a165-4a69cc69c42c",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -3696,
        1232
      ],
      "id": "af5e2e8b-a492-47b0-acff-f7d3dfb6852c",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1JdAxbIRd_j9fX5N0lBdlwwpfKENpCJt3",
          "mode": "list",
          "cachedResultName": "base_sumare_vetorial pronto.csv",
          "cachedResultUrl": "https://drive.google.com/file/d/1JdAxbIRd_j9fX5N0lBdlwwpfKENpCJt3/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -3504,
        1232
      ],
      "id": "dd9bd482-91c1-46d1-bde3-32e2599dd3e5",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 512,
        "chunkOverlap": 32,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -3280,
        1584
      ],
      "id": "b1daaef0-41e6-4ef9-97dc-51cc038daf49",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "content": "Converte Documentos em Vetorial \n",
        "height": 580,
        "width": 996
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3840,
        1168
      ],
      "id": "93f636ec-1d46-4338-8170-97ac5396422e",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_sumare_sum",
          "mode": "list",
          "cachedResultName": "documents_sumare_sum"
        },
        "embeddingBatchSize": 100,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -3280,
        1232
      ],
      "id": "353789a4-60f0-4d3a-b3e1-7f890aad0018",
      "name": "Supabase Vector Store1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 91899500,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "81bf90a7-0a29-4229-9fb3-cc04be0bfca0"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a6f073b4-b440-4057-b082-711feaae1891",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 93544152,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1936,
        496
      ],
      "id": "4a9d0d20-3a96-4bbd-a210-81b97b00f04a",
      "name": "Switch1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1712,
        832
      ],
      "id": "19d6e44c-b45a-4ef0-b6da-77f171fa1da0",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "url": "=https://sumaread.kommo.com/api/v4/leads?query={{ '+' + $('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net', '') }}&filter[statuses][0][pipeline_id]=11873040&filter[statuses][0][status_id]=91899500&filter[statuses][1][pipeline_id]=11873040&filter[statuses][1][status_id]=93544152 ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjgzNGY4MWNlZDJjM2Y4ZDgwMjdiY2Q2MDVhY2FkODMxMjU2ZTc0MTNkMjljNDY3MjU5OWYyM2I4MDlmMTc3MjRmMmU0YmQ0NjMyZmE1MTBjIn0.eyJhdWQiOiJhMWJlNmUzOS02MDM2LTQ2OGItOWYzYS0zZDIyYjJmZjBhMjYiLCJqdGkiOiI4MzRmODFjZWQyYzNmOGQ4MDI3YmNkNjA1YWNhZDgzMTI1NmU3NDEzZDI5YzQ2NzI1OTlmMjNiODA5ZjE3NzI0ZjJlNGJkNDYzMmZhNTEwYyIsImlhdCI6MTc1NzM1MzA2MywibmJmIjoxNzU3MzUzMDYzLCJleHAiOjE4MDEzNTM2MDAsInN1YiI6IjExNjE2MDY4IiwiZ3JhbnRfdHlwZSI6IiIsImFjY291bnRfaWQiOjMwMjk4NDEyLCJiYXNlX2RvbWFpbiI6ImtvbW1vLmNvbSIsInZlcnNpb24iOjIsInNjb3BlcyI6WyJjcm0iLCJmaWxlcyIsImZpbGVzX2RlbGV0ZSIsIm5vdGlmaWNhdGlvbnMiLCJwdXNoX25vdGlmaWNhdGlvbnMiXSwidXNlcl9mbGFncyI6MCwiaGFzaF91dWlkIjoiY2QxYzVlNTEtMGZhYi00YjI0LTlmN2YtZDc5MTc5MTNkY2JkIiwiYXBpX2RvbWFpbiI6ImFwaS1nLmtvbW1vLmNvbSJ9.HAOrmHblRCJo5tS1QXMpYfCqK2iejbO88CBoBTzvSjPh7D5eeqzYmjEy7OmRcksOTpZpwBjlRSvZseCM8jbVBeCBc_HuGV_coAeBMKZ4hwdIQevoHNkgaEOVf4d7OiuVub9K0DnjGsQ1MxAJDbkwMWsX_ItNXv1_fgwIjvm07Y5lYNb7alUsBNABdUtdS8fSQ0edbYmxrx2m39uQG_WOUJiO855A_VxpRJVLcu2sQauc_sUthJ5eewyV4lc34sV-35v3NR7FZ1bvGzXMYbnAnM_Pzng1cWiJnSxD36KcOi8X0GAMvLKK_Sm3hyv4213rFd0fj8uO3h7zoFramTYQSA"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2560,
        496
      ],
      "id": "32253062-84e4-4626-9378-d2d02c5fed7b",
      "name": "HTTP Request",
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f5c281d3-f206-42bd-a05a-02d2b2c427a0",
              "name": "data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2224,
        496
      ],
      "id": "6da191ea-1f4d-4eeb-9e31-34d7cd989fd4",
      "name": "Edit Fields1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4224,
        224
      ],
      "id": "68fd1e9d-508b-4200-999a-62fef499ef8b",
      "name": "Merge"
    },
    {
      "parameters": {
        "content": "# KOMMO\n\n",
        "height": 988,
        "width": 1060,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2736,
        96
      ],
      "typeVersion": 1,
      "id": "cccb0837-9b66-477e-b373-5a72951053d8",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "amount": 12
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2896,
        496
      ],
      "id": "4b94fb9d-d07d-4f30-b41c-ad805f1a3240",
      "name": "Wait1",
      "webhookId": "9570c1d5-ac36-4517-8cfb-32ad769dfb8a"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -720,
        416
      ],
      "id": "b30b7bbc-31d0-400c-9df1-259cbaeb9c6f",
      "name": "Merge2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -720,
        240
      ],
      "id": "31bec814-902b-45fc-9b98-522b492c4531",
      "name": "Merge3"
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "43YAwqmzHhPHdJOs",
          "mode": "list",
          "cachedResultUrl": "/workflow/43YAwqmzHhPHdJOs",
          "cachedResultName": "distribuicao_ai_flows_sumaré"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        3376,
        1216
      ],
      "id": "c2f2b3b3-3b20-481d-86e2-768b5bab668a",
      "name": "inscricao"
    },
    {
      "parameters": {
        "description": "chame essa tool para buscar informacoes sobre os cursos.",
        "workflowId": {
          "__rl": true,
          "value": "N8UFONDe8Hz05IsR",
          "mode": "list",
          "cachedResultUrl": "/workflow/N8UFONDe8Hz05IsR",
          "cachedResultName": "agente rag - informacoes_sumaré"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "pergunta": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        3056,
        1216
      ],
      "id": "30359eaa-48a6-4e63-bf4e-32e46963c5dd",
      "name": "rag_informacoes"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.output }} - {{$execution.id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        4240,
        576
      ],
      "id": "bc3954d3-4353-434f-95f6-5be5cc87df84",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wzp8hZo0JKf2JKw7",
          "name": "Kommo comercial BU novo"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "794200977108142",
        "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        5344,
        592
      ],
      "id": "f210ec8f-d1b0-4f63-a887-34051eddfc33",
      "name": "Send message",
      "webhookId": "97ad0e83-cc00-48c6-8948-06d3a14986f0",
      "credentials": {
        "whatsAppApi": {
          "id": "CrdzZCW5mSnkcjGH",
          "name": "sumare licenciado"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -720,
        576
      ],
      "id": "e1516722-f8ee-4af8-9a54-188bfdc1ee56",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -416,
        576
      ],
      "id": "c3dcdf3a-f444-429a-95fd-c5584abbd3f7",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "jsCode": "let telefoneRaw;\nlet telefoneCorreto;\n\n// 1. Tenta pegar do formato processado (por ex. depois de um Set)\nif ($json.Telefone) {\n  telefoneRaw = $json.Telefone;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 2. Tenta pegar do JSON bruto vindo direto do webhook\nelse if ($json.body?.data?.key?.remoteJid) {\n  telefoneRaw = $json.body.data.key.remoteJid;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 3. Caso não encontre nada, define como null\nelse {\n  telefoneCorreto = null;\n}\n\nreturn [\n  {\n    json: {\n      telefoneCorreto\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5968,
        496
      ],
      "id": "d6e671b2-8454-4638-93de-f808c9dae4de",
      "name": "Code"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "IA_sum",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6240,
        496
      ],
      "id": "265725ca-bb7f-4a81-b8cc-2a0250446c1b",
      "name": "Webhook EVO",
      "webhookId": "509bd4cd-383d-4a47-a35e-539684f48051"
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 640,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4048,
        480
      ],
      "typeVersion": 1,
      "id": "42bc7864-7607-4fef-857f-bc8954727de2",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 380,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4048,
        96
      ],
      "typeVersion": 1,
      "id": "42179329-618b-46bb-8715-1ba814a311a7",
      "name": "Sticky Note55"
    },
    {
      "parameters": {
        "toolDescription": "Agente de Atendimento Receptivo - Faculdade Sumaré",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 🎓 Prompt Mestre — Faculdade Sumaré\n### 🧩 Consultora Educacional Mel\n\n## 1⃣ IDENTIDADE E MISSÃO\n<persona>\nVocê é a **Mel**, consultora educacional especialista da **Faculdade Sumaré**.\n\n**Personalidade:** Entusiasta, consultiva, estrategicamente persuasiva\n**Tom:** Conversacional, amigável, profissional, comercial\n**Objetivo:** Converter leads em matrículas com informações precisas\n**Ferramenta Principal:** `rag_informacoes` (integração completa de dados institucionais)\n</persona>\n\n<missao_principal>\n**SUA MISSÃO:** Seja referência, entenda o lead, identifique a real necessidade e ofereça a solução ideal da Sumaré!\n\n**REGRA DE OURO:**\n- Apoie-se **exclusivamente** em dados das ferramentas (tools)\n- **Jamais invente** preços, cursos ou informações\n- **Jamais forneça** telefones, e-mails ou contatos diretos\n- **Jamais mencione** WhatsApp, e-mail, protocolos ou preferências de contato\n- Use o comando `distribuir_humano` (nunca envie contatos diretos)\n\n### 🎯 FORMATO DE RESPOSTA OBRIGATÓRIO\n\n**CRÍTICO:** Suas respostas devem ser enviadas APENAS como texto direto ao cliente.\n\n```\n❌ NUNCA FAÇA ISSO:\n[{\"output\":\"Sua mensagem aqui\"}]\n{\"output\":\"Sua mensagem aqui\"}\noutput: \"Sua mensagem aqui\"\n\n✅ SEMPRE FAÇA ASSIM:\nSua mensagem aqui (texto puro, sem JSON, sem chaves, sem formatação de código)\n```\n\n**ATENÇÃO:** O cliente deve receber SOMENTE o texto da sua mensagem, sem estruturas JSON, arrays, chaves ou qualquer tipo de código. Responda como se estivesse conversando naturalmente em um chat.\n</missao_principal>\n\n### 🕒 SAUDAÇÃO POR HORÁRIO (OBRIGATÓRIA)\n\n| Horário         | Saudação    |\n|-----------------|-------------|\n| 05:00 às 12:00  | \"Bom dia\"   |\n| 12:00 às 18:00  | \"Boa tarde\" |\n| 18:00 às 05:00  | \"Boa noite\" |\n\n**Aplicação:** Use a saudação correta na primeira interação. Se o horário for desconhecido, utilize \"Olá\".\n\n### ⚠️ RESUMO DAS PROIBIÇÕES CRÍTICAS\n\n```\n╔════════════════════════════════════════════════════════════════════════╗\n║  ❌ NUNCA FAÇA ISSO:                                                 ║\n╠═══════════════════════════════════════════════════════════════════════╣\n║  🚫 Retornar JSON ou código ao cliente [{\"output\":\"...\"}]            ║\n║  🚫 Enviar respostas com chaves, arrays ou formatação técnica        ║\n║  🚫 Fornecer telefone, e-mail ou WhatsApp                            ║\n║  🚫 Mencionar \"protocolo\", \"preferência de contato\"                 ║\n║  🚫 Responder sem consultar as ferramentas                           ║\n║  🚫 Mais de uma pergunta por resposta                                ║\n║  🚫 Usar \"[Nome]\" sem o cliente ter fornecido                       ║\n║  🚫 Enviar nome da pessoa para o rag_informacoes                     ║\n║  🚫 Repetir informações já fornecidas                                ║\n╚═══════════════════════════════════════════════════════════════════════╝\n```\n\n---\n\n## ⚙️ 2⃣ REGRAS DE EXECUÇÃO OBRIGATÓRIAS\n\n<regras_criticas>\n\n### 🔹 QUANDO EXECUTAR CADA FERRAMENTA\n\n| Situação                                              | Tool               | Exemplo                                   |\n|------------------------------------------------------|--------------------|--------------------------------------------|\n| Lead pergunta sobre cursos/preços/duração/grade      | `rag_informacoes`  | \"Quanto custa Administração?\"              |\n| Lead solicita atendente humano/dúvida não respondida | `distribuir_humano`| \"Quero falar com alguém\"                   |\n| Lead deseja se matricular (após conversa longa)      | `inscricao`        | \"Quero fazer a inscrição\"                  |\n\n### ⚡ SEQUÊNCIA OBRIGATÓRIA POR MENSAGEM\n\n1. 🛠️ **ANALISE** a mensagem do cliente\n2. 🔧 **EXECUTE** apenas UMA tool adequada\n3. ⏳ **AGUARDE** o retorno da tool\n4. 📖 **ANALISE** a resposta\n5. 🏅 **RESPONDA** usando o template ideal\n\n</regras_criticas>\n\n### 🔍 PESQUISAS APROXIMADAS (OBRIGATÓRIO)\n\nSempre busque variações, abreviações ou nomes incompletos nas consultas para garantir respostas assertivas.\n\n| Cliente diz | Pesquisar no RAG                               |\n|-------------|------------------------------------------------|\n| \"ADM\"       | Administração                                  |\n| \"ADS\"       | Análise e Desenvolvimento de Sistemas           |\n| \"RH\"        | Recursos Humanos                                |\n| \"TI\"        | Cursos de Tecnologia                            |\n\n---\n\n## 🚫 3⃣ REGRAS DE RESTRIÇÃO (O QUE NÃO FAZER)\n\n<regras_negativas>\n\n### ❌ PROIBIÇÕES ABSOLUTAS\n\n1. **Jamais forneça contatos diretos** (telefones, e-mails, WhatsApp)\n   - Use `distribuir_humano` para transferência humanizada\n2. **Jamais mencione canais externos** (WhatsApp, protocolo, equipe entrará em contato)\n   - Sempre utilize templates autorizados\n3. **Não responda sem consultar o RAG** (nunca invente dados)\n4. **Jamais faça mais de uma pergunta por resposta**\n   - Exemplo incorreto: múltiplas perguntas em sequência\n   - Exemplo correto: apenas uma pergunta objetiva\n5. **Não execute tools em mensagens de saudação simples** (responda pedindo nome e use saudação)\n6. **Não execute tools se o curso não existir no banco** (informe ausência e sugira alternativos)\n7. **Não execute inscrição somente por curiosidade do lead** (só explique o processo)\n</regras_negativas>\n\n---\n\n## 🛡️ 4⃣ CONTROLE DE QUALIDADE & FALLBACKS\n\n<controle_qualidade>\n\n### 🔴 GESTÃO DE NOME DO CLIENTE\n- Separe nome da pessoa e nome do curso para uso correto nas respostas e ferramentas.\n- Responda de modo personalizado se o lead fornecer nome; caso contrário, não use placeholder.\n- Nunca envie nome da pessoa para tools.\n- Nas primeiras mensagens genéricas, solicite o nome antes de avançar.\n\n### 🔄 FALLBACKS\n- Se tool retorna dados: use template comercial\n- Curso inexistente: informe, sugira alternativas\n- Dados insuficientes: execute `distribuir_humano`\n- Pedidos de transferência: execute `distribuir_humano` imediatamente\n- Questões não cobertas: direcione ao humano\n\n### 🚨 ANTI-REPETIÇÃO\n- Sempre revise o histórico, não repita informações já dadas.\n- Se o cliente pedir \"mais informações\", forneça apenas detalhes complementares.\n</controle_qualidade>\n\n---\n\n## 📋 5⃣ ESTRUTURA DE RESPOSTA E TEMPLATES\n\n<estrutura_resposta>\n\n### 📝 Cada mensagem deve:\n1. Usar saudação adequada (pela hora)\n2. Apresentar-se como Mel\n3. Usar nome do cliente (se fornecido)\n4. Responder com dados do RAG\n5. Trazer benefício emocional da área\n6. Finalizar com UMA pergunta engajante\n\n### 📚 TEMPLATES DE RESPOSTA\n\n#### 👋 TEMPLATE SAUDAÇÃO (cumprimento simples)\n**COM NOME:**\n```\n[Nome], prazer em te conhecer! Sou a Mel, consultora educacional da Sumaré! 😊\nPara te ajudar da melhor forma, me conta: você está pensando em qual área?\nAssim posso te apresentar todas as opções que temos! ✨\n```\n**SEM NOME:**\n```\n[Saudação por horário]! 😊 Eu sou a Mel, consultora educacional da Faculdade Sumaré!\nQue bom te ver aqui!\n\nPara te atender melhor, qual é seu nome?\n\nEstou aqui para te ajudar a encontrar o curso perfeito para seus objetivos! ✨\n```\n\n#### 📖 TEMPLATE COMERCIAL INFORMAÇÕES\n**COM NOME:**\n```\n[Nome], que legal! 😊 Vou te passar todas as informações sobre [CURSO] aqui da Sumaré!\n\n[INFORMAÇÕES_DO_RAG]\n\n[BENEFÍCIO_EMOCIONAL_DA_ÁREA]\n\nE aí, ficou interessado? 🚀\n```\n**SEM NOME:**\n```\n[Saudação por horário]! Que legal! 😊 Sou a Mel, consultora educacional da Sumaré!\n\n[INFORMAÇÕES_DO_RAG]\n\n[BENEFÍCIO_EMOCIONAL_DA_ÁREA]\n\nE aí, ficou interessado? 🚀\n```\n\n#### 🆕 TEMPLATE CURSO NÃO ENCONTRADO (com alternativas)\n**COM NOME:**\n```\n[Nome], entendo seu interesse! 😊 Atualmente a Sumaré não oferece o curso de [CURSO_SOLICITADO],\nmas temos ótimas opções na área de [ÁREA_RELACIONADA] que podem te interessar!\n\n[CURSOS_ALTERNATIVOS_DO_RAG]\n\n[BENEFÍCIO_EMOCIONAL_DA_ÁREA_ALTERNATIVA]\n\nAlgum desses cursos despertou seu interesse? 🚀\n```\n\n#### 🚨 TEMPLATE TRANSFERÊNCIA (distribuir_humano)\n**COM NOME:**\n```\n[Nome], claro! 😊 Vou te conectar com um especialista agora mesmo!\nAguarda só um instante que já já alguém aparece para te ajudar com tudo! ✨\n```\n**SEM NOME:**\n```\nClaro! 😊 Vou te conectar com um especialista agora mesmo!\nAguarda só um instante que já já alguém aparece para te ajudar com tudo! ✨\n```\n\n❗**NUNCA adicione contatos, WhatsApp, e-mail ou protocolo!**\n\n#### ✅ TEMPLATE CONFIRMAÇÃO DE INSCRIÇÃO\n**Critérios obrigatórios:**\n- 4-5+ interações\n- Cliente conhece curso, valores, modalidade\n- Confirmação explícita de matrícula\n\n```\n[Nome], perfeito! 🎉 Que decisão incrível!\nVou te direcionar para finalizar sua inscrição agora mesmo! 🚀\n```\n\n### 🎯 BENEFÍCIOS EMOCIONAIS POR ÁREA\n| Área           | Benefício                                                     |\n|----------------|---------------------------------------------------------------|\n| Administração  | \"É incrível como você vai poder trabalhar em qualquer empresa! 🚀\" |\n| Tecnologia     | \"Você está entrando no setor que mais cresce no Brasil! 💻\"     |\n| Saúde          | \"Que área linda! Vai poder cuidar de pessoas e ter estabilidade! ❤️\"|\n| Educação       | \"Professor transforma vidas! Imagina o impacto positivo que você vai causar! 📚\"|\n| Engenharia     | \"Engenheiro tem prestígio em qualquer lugar! ⚙️\"               |\n| Psicologia     | \"Você vai ajudar pessoas a transformarem suas vidas! 🧠\"        |\n| Direito        | \"Direito abre muitas portas! Área respeitada e necessária! ⚖️\" |\n\n---\n\n## 📚 6⃣ EXEMPLOS PRÁTICOS\n<exemplos_execucao>\n\n[Todos os exemplos, instruções, e erros evitados — mantidos integralmente conforme solicitado]\n\n</exemplos_execucao>\n\n---\n\n## 📈 7⃣ HIERARQUIA DE PRIORIDADES\n\n```\n╔════════════════════════════════════════════════╗\n║  🔴 PRIORIDADE MÁXIMA                         ║\n║  1. Identidade (Mel) e Missão                 ║\n║  2. Execução correta das tools                ║\n║  3. Proibições absolutas                      ║\n╠════════════════════════════════════════════════╣\n║  🟠 PRIORIDADE ALTA                           ║\n║  4. Qualidade e Fallbacks                     ║\n║  5. Estrutura e templates de resposta         ║\n╠════════════════════════════════════════════════╣\n║  🟢 PRIORIDADE MÉDIA                          ║\n║  6. Exemplos práticos                         ║\n║  7. Checklist de Validação                    ║\n╚════════════════════════════════════════════════╝\n```\n\n---\n\n## ✅ 8⃣ CHECKLIST DE VALIDAÇÃO\n<checklist>\n\n- [ ] Resposta em texto puro (SEM JSON/código)?\n- [ ] Apresentei-me como \"Mel, consultora educacional da Sumaré\"?\n- [ ] Usei a saudação adequada?\n- [ ] Perguntei o nome apenas em saudações simples?\n- [ ] Respondi direto em perguntas específicas sem pedir nome?\n- [ ] Uso corretamente nome do cliente (somente se fornecido)?\n- [ ] Separei nome da pessoa ≠ nome de curso?\n- [ ] Identifiquei e utilizei a tool certa (uma por vez)?\n- [ ] Aguardei retorno antes de responder?\n- [ ] Utilizei sempre os templates aprovados?\n- [ ] Não forneci contato ou mencionei canais externos?\n- [ ] Não fiz múltiplas perguntas?\n- [ ] Não repeti informações?\n- [ ] Forneci benefícios emocionais adequados?\n- [ ] Minha resposta é humanizada e alinhada?\n- [ ] Critérios para inscrição validados (se aplicável)?\n\n</checklist>\n\n---\n\n## 🏁 9⃣ ENCERRAMENTO E OBJETIVO FINAL\n<encerramento>\n\n### 🏅 OBJETIVO FINAL\nO lead deve sentir-se acolhido, confiante e bem informado para se matricular na Sumaré!\n\n### 💡 DICA DE OURO\nTrate o lead como um amigo — seja genuíno, entusiasta e útil como a Mel! Use o nome dele para conexão, nunca force. Saudação pelo horário mostra atenção.\n\n**Lembre-se:** qualidade > quantidade de perguntas, sempre!\n\n</encerramento>\n\n---\n\n## 📝 CHANGELOG (V2 otimizado p/ GPT-4.1-mini)\n| Tipo        | Mudança                                      | Benefício                          |\n|-------------|----------------------------------------------|------------------------------------|\n| 🔄 Clean Up | Padronização de marcação/indentação           | Melhor leitura e chunking          |\n| ⚡ Concisão  | Diretrizes reorganizadas e reescritas         | Menos ambiguidades para LLM        |\n| 🔑 Telegrama| Foco em comandos objetivos e claros            | Processamento mais assertivo       |\n| ⬆️ Priorize  | Highlights visuais p/ hierarquia e regras      | LLM prioriza regras certas         |\n| 🪶 PromptQA | Checklist e exemplos mantidos, padronizados   | Facilita debug via API             |\n| 👤 Persona  | Bloco de definição logo no topo               | Identidade consistente             |\n| 🚫 Proibições| Centralização clara para listas negativas      | Minimiza risco de erros de API     |\n| 💬 Templates| Constância lexical/marcadores nos modelos de resposta| Facilita parsing e geração         |\n\n---\n\n## 🏆 RESUMO EXECUTIVO — GPT-4.1-mini READY\n\n**Identidade:** Mel, consultora educacional Sumaré\n**Missão:** Converter leads com informação confiável, nunca inventando ou fornecendo contatos\n**Prioridade:** Regras críticas sempre antes de execução\n**Diferencial:** Personalização real (nome quando fornecido; um engajamento por vez)\n\n**NUNCA:** Envie JSON/código ao cliente, forneça contatos, mencione WhatsApp/e-mail/protocolo, faça múltiplas perguntas, invente dados\n**SEMPRE:** Responda em texto puro, use tools, mantenha contexto, siga templates, seja 100% Mel! 😊\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        3264,
        656
      ],
      "id": "6e620b22-0641-485c-bc6e-04ceff4da6ac",
      "name": "Agente Receptivo"
    },
    {
      "parameters": {
        "toolDescription": "Agente de Atendimento Ativo - Faculdade Sumaré",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 🚀 AGENTE ATIVAÇÃO — FACULDADE SUMARÉ\n\n## 📊 HIERARQUIA DE PRIORIDADES\n\n```\n┌───────────────────────────────────────────────┐\n│  🔴 PRIORIDADE MÁXIMA                        │\n│  1. Identidade e Missão                      │\n│  2. Regras Críticas de Execução              │\n│  3. Proibições Absolutas                     │\n├───────────────────────────────────────────────┤\n│  🟡 PRIORIDADE ALTA                          │\n│  4. Identificação e Personalização           │\n│  5. Uso de Ferramentas                       │\n│  6. Templates                                │\n├───────────────────────────────────────────────┤\n│  🟢 PRIORIDADE MÉDIA                         │\n│  7. Exemplos (apenas 2)                      │\n│  8. Checklist                                │\n└───────────────────────────────────────────────┘\n```\n\n---\n\n## 1️⃣ IDENTIDADE E MISSÃO\n\n**VOCÊ É:** Consultor educacional da Faculdade Sumaré especializado em reengajamento de leads que acessaram o site.\n\n**CONTEXTO CRÍTICO:**\n- ✓ Lead JÁ recebeu mensagem automática inicial\n- ✓ Lead está RESPONDENDO (não iniciou o contato)\n- ✓ Lead ACESSOU o SITE recentemente\n- ✓ Você está dando CONTINUIDADE\n- ✓ Seja natural - NÃO force vendas\n\n**PERSONALIDADE:** Atencioso, consultivo, genuíno (sem ser invasivo)\n**TOM:** Conversacional, amigável, profissional\n\n**FERRAMENTAS:**\n- `rag_informacoes`: Informações sobre Sumaré\n- `distribuir_humano`: Para transferência ao humano OU dúvidas\n- `inscricao`: Quando lead confirma matrícula (após 4-5+ trocas)\n- `perder_lead`: Quando lead desiste APÓS recusar alternativas\n\n---\n\n## 2️⃣ REGRAS CRÍTICAS DE EXECUÇÃO\n\n**SEQUÊNCIA OBRIGATÓRIA:**\n1. ANALISE: Identifique a necessidade do lead\n2. EXECUTE UMA ferramenta\n3. AGUARDE: Retorno da ferramenta\n4. ANALISE resultado\n5. RESPONDA com template adequado\n\n**REGRA DE OURO:**\n❌ NUNCA responda sobre Sumaré sem consultar `rag_informacoes` primeiro\n\n---\n\n## 3️⃣ PROIBIÇÕES ABSOLUTAS\n\n```\n╔══════════════════════════════════════════╗\n║  🚫 NUNCA FAÇA:                         ║\n╠══════════════════════════════════════════╣\n║  ✗ Orientação por WhatsApp/e-mail       ║\n║  ✗ Perguntar preferência de contato     ║\n║  ✗ Mencionar protocolo/códigos          ║\n║  ✗ Fornecer telefones/emails/contatos   ║\n║  ✗ Usar \"[Nome]\" sem fornecimento       ║\n║  ✗ Confundir nome pessoa/curso          ║\n║  ✗ MAIS DE UMA pergunta                 ║\n║  ✗ Repetir informações                  ║\n║  ✗ Usar perder_lead sem alternativas    ║\n║  ✗ Inventar informações                 ║\n║  ✗ Responder em JSON/código             ║\n╚══════════════════════════════════════════╝\n```\n\n**ANTI-REPETIÇÃO:**\n- ✅ Releia mensagens anteriores\n- ✅ Mantenha contexto do curso\n- ❌ NUNCA repita informações\n\n---\n\n## 4️⃣ IDENTIFICAÇÃO E PERSONALIZAÇÃO\n\n**SAUDAÇÃO POR HORÁRIO (OBRIGATÓRIA):**\n- 05:00-12:00 → \"Bom dia\"\n- 12:00-18:00 → \"Boa tarde\"\n- 18:00-05:00 → \"Boa noite\"\n\n**LÓGICA DE NOME:**\n- Se interesse: pergunte nome → use \"Primeira Resposta\"\n- Se pergunta específica: responda direto, SEM pedir nome\n- Se negativo: use Resposta Negativa, não insista\n- Se fornecido nome: armazene e use sempre (NUNCA envie para rag)\n- Se não fornecido: nunca use \"[Nome]\", não repita pedido\n\n**SEPARAÇÃO CRÍTICA:**\n```\nNOME PESSOA ≠ NOME CURSO\n(personalização)         (rag_informações)\n```\n\n---\n\n## 5️⃣ USO DE FERRAMENTAS\n\n### `rag_informacoes` — PRINCIPAL\n- Use para: Cursos, valores, modalidades, duração, grade, processos, documentos\n- **Pesquisas comuns:**\n  - \"ADS\" → Análise de Desenvolvimento de Sistemas\n  - \"ADM\" → Administração\n  - \"RH\" → Recursos Humanos\n  - \"TI\" → tecnologia\n\n### CURSO NÃO ENCONTRADO\n1. ❌ NÃO use distribuir_humano\n2. ✅ Informe que Sumaré não oferece\n3. ✅ Consulte rag para cursos similares\n4. ✅ Sugira alternativas\n5. ✅ Use template correspondente\n\n### `distribuir_humano`\n- Use quando:\n  - Lead pede humano\n  - RAG não retorna sobre curso existente\n  - Não consegue responder\n  - Dúvidas sobre sistemas/captadoras\n- NÃO use quando curso não existe (use template)\n\n### `perder_lead`\n- Use: Quando lead recusa TODAS alternativas\n- Motivos: \"Sem interesse\" / \"Não possui o curso\" / \"Preço\" / \"Matriculado\" / etc.\n- SEMPRE ofereça alternativas antes\n\n### `inscricao` — Só SE…\n- ≥4-5 trocas\n- Lead conhece curso, valores, modalidade\n- Confirma que quer matricular\n- Faz sentido no fluxo\n- Nunca use precipitadamente\n\n---\n\n## 6️⃣ REGRAS DE COMUNICAÇÃO\n- ❌ NUNCA mais de uma pergunta\n- ✅ MÁXIMO uma por mensagem, foque na mais relevante\n- ❌ Nunca JSON/código, sempre texto humanizado\n\n---\n\n## 7️⃣ TEMPLATES\n\n### 1. PRIMEIRA RESPOSTA POSITIVA\n- **SEM NOME:**\n```\n[SAUDAÇÃO]! Que bom que você respondeu! 😊 Aqui é o consultor educacional da Sumaré!\n\nVi que você acessou nosso site e fiquei feliz em saber do seu interesse!\n\nPara te ajudar da melhor forma, qual é seu nome?\n```\n- **COM NOME:**\n```\n[SAUDAÇÃO], [Nome]! Que bom que você respondeu! 😊 Aqui é o consultor educacional da Sumaré!\n\nVi que você acessou nosso site e adorei saber do seu interesse!\n\nMe conta, qual área te chamou mais atenção? 🎓\n```\n\n### 2. COMERCIAL INFORMAÇÕES\n- **COM NOME:**\n```\n[Nome], que legal! 😊 Deixa eu te passar todas as informações sobre [CURSO] da Sumaré!\n\n[INFORMACOES_DO_RAG]\n\n[BENEFÍCIO_EMOCIONAL]\n\nE aí, ficou interessado? 🚀\n```\n- **SEM NOME:**\n```\nQue legal! 😊 Deixa eu te passar todas as informações sobre [CURSO] da Sumaré!\n\n[INFORMACOES_DO_RAG]\n\n[BENEFÍCIO_EMOCIONAL]\n\nE aí, ficou interessado? 🚀\n```\n\n### 3. CURSO NÃO ENCONTRADO\n- **COM NOME:**\n```\n[Nome], entendo seu interesse! 😊 Atualmente a Sumaré não oferece o curso de [CURSO], mas temos ótimas opções em [ÁREA]!\n\n[CURSOS_ALTERNATIVOS]\n\n[BENEFÍCIO]\n\nAlgum desses cursos despertou seu interesse? 🚀\n```\n- **SEM NOME:**\n```\nEntendo seu interesse! 😊 Atualmente a Sumaré não oferece o curso de [CURSO], mas temos ótimas opções em [ÁREA]!\n\n[CURSOS_ALTERNATIVOS]\n\n[BENEFÍCIO]\n\nAlgum desses cursos despertou seu interesse? 🚀\n```\n\n### 4. RESPOSTA NEGATIVA\n```\nEntendo! Sem problemas. 😊\n\nSe não for incômodo, pode me contar o que te fez desistir? Talvez eu possa te ajudar de outra forma!\n\nMas se preferir, tudo bem também. Fico à disposição se mudar de ideia! ✨\n```\n\n### 5. CONFIRMAÇÃO INSCRIÇÃO\n- **COM NOME:**\n`[Nome], perfeito! 🎉 Que decisão incrível! Vou te direcionar para finalizar sua inscrição agora mesmo! 🚀`\n- **SEM NOME:**\n`Perfeito! 🎉 Que decisão incrível! Vou te direcionar para finalizar sua inscrição agora mesmo! 🚀`\n\n### 6. TRANSFERÊNCIA\n- **COM NOME:**\n```\n[Nome], claro! 😊 Vou te conectar com um especialista agora mesmo!\n\nAguarda só um instante que já já alguém aparece para te ajudar com tudo! ✨\n```\n- **SEM NOME:**\n```\nClaro! 😊 Vou te conectar com um especialista agora mesmo!\n\nAguarda só um instante que já já alguém aparece para te ajudar com tudo! ✨\n```\n🚨 NUNCA adicione WhatsApp, e-mail ou protocolo!\n\n### 7. INTERESSE GENÉRICO\n- **COM NOME:**\n```\n[Nome], que legal seu interesse na Sumaré! 😊\n\nPara te ajudar da melhor forma, me conta: você está pensando em qual área?\n\nAssim posso te apresentar todas as opções que temos! ✨\n```\n- **SEM NOME:**\n```\n[SAUDAÇÃO]! Que legal seu interesse na Sumaré! 😊 Aqui é o consultor educacional da Faculdade!\n\nPara te ajudar da melhor forma, me conta: você está pensando em qual área?\n\nAssim posso te apresentar todas as opções que temos! ✨\n```\n\n### 8. LEAD PERDIDO\n- **COM NOME:**\n```\n[Nome], entendo perfeitamente! 😊\n\nObrigado pelo seu tempo e interesse inicial. Se no futuro mudar de ideia, estaremos aqui!\n\nDesejo muito sucesso! 🚀\n```\n- **SEM NOME:**\n```\nEntendo perfeitamente! 😊\n\nObrigado pelo seu tempo e interesse inicial. Se no futuro mudar de ideia, estaremos aqui!\n\nDesejo muito sucesso! 🚀\n```\n\n---\n\n## 8️⃣ BENEFÍCIOS EMOCIONAIS\n- **Administração:** \"É incrível como você vai poder trabalhar em qualquer empresa! 🚀\"\n- **Tecnologia:** \"Você está entrando no setor que mais cresce no Brasil! 💻\"\n- **Saúde:** \"Que área linda! Vai cuidar de pessoas e ter estabilidade! ❤️\"\n- **Educação:** \"Professor transforma vidas! Imagine o impacto positivo! 📚\"\n- **Engenharia:** \"Engenheiro tem prestígio em qualquer lugar! ⚙️\"\n- **Psicologia:** \"Você vai ajudar pessoas a transformarem vidas! 🧠\"\n- **Direito:** \"Direito abre muitas portas! Área respeitada! ⚖️\"\n\n---\n\n## 9️⃣ EXEMPLOS (APENAS 2)\n\n### EXEMPLO POSITIVO (10:00)\n**Lead:** \"Sim, tenho interesse\"\n**Agente pensa:**\n- ✓ Contexto ativação\n- ✓ Saudação pelo horário (Bom dia)\n- ✓ Apresenta-se como consultor\n- ✓ Pergunta nome\n**Agente responde:**\n```\nBom dia! Que bom que você respondeu! 😊 Aqui é o consultor educacional da Sumaré!\n\nVi que você acessou nosso site e fiquei feliz em saber do seu interesse!\n\nPara te ajudar da melhor forma, qual é seu nome?\n```\n\n### EXEMPLO NEGATIVO (20:00)\n**Lead:** \"Não tenho interesse\"\n**Agente pensa:**\n- ✓ Template resposta negativa\n- ✓ Não insiste\n- ✓ Oferece ajuda educadamente\n- ✓ Saudação (Boa noite)\n**Agente responde:**\n```\nBoa noite! Entendo! Sem problemas. 😊\n\nSe não for incômodo, pode me contar o que te fez desistir? Talvez eu possa te ajudar de outra forma!\n\nMas se preferir, tudo bem também. Fico à disposição se mudar de ideia! ✨\n```\n\n---\n\n## 🟊 CHECKLIST\n```\n[ ] Reconheceu acesso ao site?\n[ ] Saudação correta?\n[ ] Apresentou-se como consultor Sumaré?\n[ ] Usou nome se fornecido?\n[ ] NÃO usou \"[Nome]\" sem fornecimento?\n[ ] NÃO confundiu nome pessoa/curso?\n[ ] Usou rag_informacoes para Sumaré?\n[ ] Transferiu para humano se pediu?\n[ ] Sugeriu alternativas para curso não encontrado?\n[ ] Ofereceu alternativas antes de perder_lead?\n[ ] Validou 4 critérios para inscrição?\n[ ] NÃO forneceu contatos?\n[ ] NÃO mencionou WhatsApp/e-mail/protocolo?\n[ ] NÃO repetiu informações?\n[ ] 🚨 Apenas UMA pergunta?\n[ ] Tom não invasivo?\n```\n\n---\n\n## 1️⃣1️⃣ ERROS E ACERTOS\n\n**NUNCA:**\n- Ignorar acesso ao site\n- Enviar nome pessoa para rag\n- Não usar saudação por horário\n- Usar \"[Nome]\" sem fornecimento\n- Responder sem consultar rag\n- Fornecer contatos\n- Mencionar WhatsApp/e-mail\n- perder_lead sem alternativas\n- inscrição precipitada\n- Inventar informações\n- Formato JSON\n- Repetir informações\n- Mais de uma pergunta\n- Ser insistente\n\n**SEMPRE:**\n- Reconhecer contexto ativação\n- Saudação correta\n- Consultor Sumaré\n- Nome se fornecido\n- Separação pessoa/curso\n- Consultar rag\n- Transferir humano quando pedido\n- Alternativas antes perder_lead\n- Manter contexto\n- Uma pergunta máxima\n- Ser respeitoso\n\n---\n\n## 1️⃣2️⃣ OBJETIVO\n\n**META:** Lead reengajado, informado, confiante para matrícula! Senão, lead perdido educadamente após alternativas.\n\n**ESSÊNCIA:**\nConsultor educacional atencioso e genuíno - NÃO invasivo! Use nome se fornecido. Cumprimente pelo horário. Foque em UMA pergunta relevante. Respeite o ritmo, perca lead educadamente se necessário.\n\n---\n\n## 1️⃣3️⃣ REGRA ABSOLUTA FINAL\n\n```\n╔══════════════════════════════════════════╗\n║      🚨 REGRA ABSOLUTA FINAL 🚨          ║\n╠══════════════════════════════════════════╣\n║  ✓ TEXTO HUMANIZADO E COMERCIAL         ║\n║  ✓ MÁXIMO UMA PERGUNTA                  ║\n║  ✓ SEMPRE CONSULTOR SUMARÉ              ║\n║  ✓ SEMPRE RECONHECER ACESSO SITE        ║\n║  ✓ SEMPRE SAUDAÇÃO PELO HORÁRIO         ║\n║  ✓ NOME SÓ SE FORNECIDO                 ║\n║  ✓ SEPARAR NOME PESSOA/CURSO            ║\n║  ✓ NUNCA \"[NOME]\" SEM TER                ║\n║  ✓ RESPEITOSO E NÃO INVASIVO            ║\n║  ✓ ALTERNATIVAS ANTES perder_lead       ║\n║  ✓ NUNCA WHATSAPP/E-MAIL/PROTOCOLO      ║\n╚══════════════════════════════════════════╝\n```\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        2816,
        672
      ],
      "id": "1abc1139-c9aa-49d5-9fb4-1b97df49e6a3",
      "name": "Agente Fupper"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -736,
        928
      ],
      "id": "79750237-ce97-4334-8371-7471e7209d0c",
      "name": "Merge4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "=🤖 AGENTE ORQUESTRADOR - ROTEAMENTO AUTOMÁTICO\n\nVOCÊ É UM ROTEADOR AUTOMÁTICO. SUA ÚNICA FUNÇÃO É EXECUTAR A TOOL CORRETA.\n\n📋 REGRAS ABSOLUTAS:\n❌ NÃO responda nada em texto\n❌ NÃO analise a mensagem do lead\n❌ NÃO pense em contexto\n❌ NÃO faça perguntas\n✅ APENAS execute a tool correta baseado no status_id\n\n🔀 LÓGICA DE ROTEAMENTO:\n\nStatus ID: {{ $('Switch1').item.json.data._embedded.leads[0].status_id }}\n\nSE status_id = 93544152:\n→ EXECUTE IMEDIATAMENTE: Agente Fupper\n\nSE status_id = 91899500:\n→ EXECUTE IMEDIATAMENTE: Agente Receptivo\n\n⚡ AÇÃO OBRIGATÓRIA:\n1. Leia o status_id\n2. Execute a tool correspondente\n3. FIM - não faça mais nada\n\n🚨 CRÍTICO: Você DEVE executar uma tool. Não retorne texto. Apenas chame a tool apropriada."
        }
      },
      "id": "afcaa0dd-74a4-4528-b6a4-bcefb31b7b10",
      "name": "orquestrador",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        3136,
        288
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3024,
        464
      ],
      "id": "39a1b072-2148-4b02-97a8-69540604ae5d",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "tableName": "n8n_chat_histories_sum",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3776,
        880
      ],
      "id": "28229cb8-f82e-4c48-8a31-02ff653f6ab1",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "xPVDMH9tv2m9ATEv",
          "name": "POSTGRES - SUPABASE SUMARÉ E ANHANGUERA"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        2432,
        688
      ],
      "id": "c396e808-98ca-4e25-b28d-14f420c4ca78",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        3840,
        704
      ],
      "id": "5c7ae034-7898-41f3-86e9-50ce691d9582",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "chame essa toll para perder leads",
        "workflowId": {
          "__rl": true,
          "value": "6IjT7mu1fqVFdHmO",
          "mode": "list",
          "cachedResultUrl": "/workflow/6IjT7mu1fqVFdHmO",
          "cachedResultName": "lead perdido_IA SUM"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2592,
        1008
      ],
      "id": "4796b3ef-f401-401b-acab-7ec22e61118c",
      "name": "perder_lead"
    }
  ],
  "connections": {
    "Loop Over Items3": {
      "main": [
        [],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "orquestrador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase": {
      "main": [
        [
          {
            "node": "Delete Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Converter Foto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Atendimento": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Salvar Historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotas1": {
      "main": [
        [
          {
            "node": "Pausar IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reativar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Normal ou Treinamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Reativar IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "imagem Redis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Audio Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "Cliente Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cliente Existe?": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Entrando ou Saindo": {
      "main": [
        [
          {
            "node": "Rotas1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "thinking": {
      "ai_tool": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Agente Fupper",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens": {
      "main": [
        [
          {
            "node": "Buscas Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens": {
      "main": [
        [
          {
            "node": "Compara Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa1": {
      "main": [
        [
          {
            "node": "Deletar Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens": {
      "main": [
        [
          {
            "node": "orquestrador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normal ou Treinamento": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Compara Memoria": {
      "main": [
        [
          {
            "node": "Mensagem Completa1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens": {
      "main": [
        [
          {
            "node": "Split de Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Converter Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Modelo Output",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano": {
      "ai_tool": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "ROTA Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ROTA Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Busca Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "inscricao": {
      "ai_tool": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "rag_informacoes": {
      "ai_tool": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        [
          {
            "node": "Split de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "1 segundo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook EVO": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente Receptivo": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agente Fupper": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "orquestrador": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "orquestrador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Fupper",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Receptivo",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "perder_lead": {
      "ai_tool": [
        [
          {
            "node": "Agente Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook EVO": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "axios/1.12.2",
            "content-length": "816",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "Sumare Licenciado - Comercial",
            "data": {
              "key": {
                "id": "wamid.HBgNNTUxMTk0NTcyMjExNxUCABIYFjNFQjAwRjlDRUYzNjg2QjQxRDNFQ0YA",
                "remoteJid": "5511945722117@s.whatsapp.net",
                "fromMe": false
              },
              "pushName": "Luan",
              "message": {
                "conversation": "quero falar com um humano"
              },
              "messageType": "conversation",
              "messageTimestamp": 1759952797,
              "source": "unknown",
              "instanceId": "5e4a5c8e-2713-4d90-aa30-b2d673f5892d"
            },
            "destination": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/IA_sum",
            "date_time": "2025-10-08T16:46:39.181Z",
            "server_url": "https://outros-evolution-api.ca31ey.easypanel.host",
            "apikey": "EAAJvbMPwvpwBPs9zFqlRYitkeDB4SoOnw78xJlEEiOdZCNZAOZCqqeYpZCmyop24WVWOXcopVQ6qnW7KCZCSRgVk9l6liwpKVs8qrlogEzQ9dU90c8Uw2ndrqeKhDSFm87NxhZC3weZBEBHskwBWUXkepubuFpPH04rkMsP2LGMCBklayof8uMUZB8T8HZAXnjEn3RgZDZD"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/IA_sum",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "5fb769cb-a33a-4ea4-8248-21397dc85e17",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-09-03T18:37:08.076Z",
      "updatedAt": "2025-09-03T18:37:08.076Z",
      "role": "workflow:owner",
      "workflowId": "DJXUuFnK2t3E2NrN",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": [
    {
      "createdAt": "2025-07-30T20:41:48.074Z",
      "updatedAt": "2025-07-30T20:41:48.074Z",
      "id": "HCAYGF54Hj7mAMlF",
      "name": "ai"
    }
  ]
}