{
  "updatedAt": "2025-07-30T16:56:37.000Z",
  "createdAt": "2025-07-25T19:55:41.114Z",
  "id": "Ah2PKrm4A3SnIdTJ",
  "name": "Teste_Arquivo.json",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "hour": 15
            }
          ]
        },
        "triggerOn": "specificFile",
        "fileToWatch": {
          "__rl": true,
          "value": "10woj2cmj8Pm8eAPveCPuZeIGAEtsQnjl",
          "mode": "list",
          "cachedResultName": "Precos_N8N",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/10woj2cmj8Pm8eAPveCPuZeIGAEtsQnjl/edit?usp=drivesdk&ouid=117609515354191177103&rtpof=true&sd=true"
        }
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -1456,
        64
      ],
      "id": "90dcbb86-1169-4cac-b387-e2721326fac7",
      "name": "Create File"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "10woj2cmj8Pm8eAPveCPuZeIGAEtsQnjl",
          "mode": "list",
          "cachedResultName": "Precos_N8N",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/10woj2cmj8Pm8eAPveCPuZeIGAEtsQnjl/edit?usp=drivesdk&ouid=117609515354191177103&rtpof=true&sd=true"
        },
        "options": {}
      },
      "id": "e785890e-34e2-4547-b42a-9d2d6e77d2cc",
      "name": "Download Excel",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 1,
      "position": [
        -1248,
        64
      ]
    },
    {
      "parameters": {
        "jsCode": "const xlsx = require('xlsx');\n\nconst binaryData = $input.item.binary?.data;\nif (!binaryData || !binaryData.data) {\n  throw new Error('⚠️ Arquivo binário não encontrado em \"binary.data\". Verifique o nó Download Excel.');\n}\n\nconst buffer = Buffer.from(binaryData.data, 'base64');\nconst workbook = xlsx.read(buffer, { type: 'buffer' });\nconst sheet = workbook.Sheets[workbook.SheetNames[0]];\nconst rows = xlsx.utils.sheet_to_json(sheet, { header: 1 });\n\n// CAPTURA os dois primeiros cabeçalhos (linha 0 e 1)\nconst header1 = rows[0];\nconst header2 = rows[1];\n\n// Constrói os nomes compostos: ex: \"Mar Aberto|% Desc\"\nconst columnKeys = header1.map((main, idx) => {\n  const sub = header2[idx];\n  if (!main && !sub) return null;\n  return `${(main || '').trim()}|${(sub || '').trim()}`;\n});\n\n// Remove cabeçalhos\nconst dataRows = rows.slice(2);\n\n// Processa cada linha\nconst result = dataRows.map(row => {\n  const item = {};\n\n  columnKeys.forEach((colName, idx) => {\n    if (!colName) return;\n    \n    const [categoria, subcoluna] = colName.split('|');\n\n    // Exemplo: MarAberto_Percentual, MarAberto_Valor\n    const keyName = categoria.replace(/\\s/g, '') + '_' + (subcoluna.toLowerCase().includes('%') ? 'Percentual' : 'Valor');\n\n    let valor = row[idx];\n\n    if (typeof valor === 'string' && valor.includes('R$')) {\n      valor = valor.replace(/[R$\\s]/g, '').replace(',', '.');\n    }\n\n    if (valor && !isNaN(valor)) {\n      valor = parseFloat(valor);\n    }\n\n    item[keyName] = valor ?? null;\n  });\n\n  // Campos fixos\n  item[\"Curso\"] = row[0] ?? null;\n  item[\"Modalidade\"] = row[1] ?? null;\n  item[\"chave\"] = `${row[0] || ''} ${row[1] || ''}`.trim();\n\n  return { json: item };\n});\n\nreturn result;\n"
      },
      "id": "eb01e8c3-c13c-457b-b5b6-747472c33044",
      "name": "Extrair Dados Planilha",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -928,
        144
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "chave",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -608,
        160
      ],
      "id": "0ff325e5-2442-4456-b872-7ca26a14a487",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM precos_atuais;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -768,
        400
      ],
      "id": "36f6c9ab-bbb3-41ee-960e-3132820588fa",
      "name": "Buscar precos_atuais"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d92e5967-81c4-4814-809b-c24c463e3a5b",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -368,
        160
      ],
      "id": "327c2b1c-b5d5-4078-9bb1-3ded8b80bb3b",
      "name": "If"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "value": "precos_historico",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chave": "={{$json[\"chave\"]}}",
            "curso": "={{$json[\"curso_2\"]}}",
            "modalidade": "={{$json[\"modalidade_2\"]}}",
            "grau": "={{$json[\"grau_2\"]}}",
            "area": "={{$json[\"area_2\"]}}",
            "duracao": "={{$json[\"duracao_2\"]}}",
            "preco_site": "={{$json[\"preco_site_2\"]}}",
            "maraberto": "={{$json[\"maraberto_2\"]}}",
            "maraberto_percentual": "={{$json[\"maraberto_percentual_2\"]}}",
            "segundagrad": "={{$json[\"segundagrad_2\"]}}",
            "segundagrad_percentual": "={{$json[\"segundagrad_percentual_2\"]}}",
            "balcao": "={{$json[\"balcao_2\"]}}",
            "balcao_percentual": "={{$json[\"balcao_percentual_2\"]}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chave",
              "displayName": "chave",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "curso",
              "displayName": "curso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "modalidade",
              "displayName": "modalidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "grau",
              "displayName": "grau",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "area",
              "displayName": "area",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "duracao",
              "displayName": "duracao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "preco_site",
              "displayName": "preco_site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "maraberto",
              "displayName": "maraberto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "maraberto_percentual",
              "displayName": "maraberto_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "segundagrad",
              "displayName": "segundagrad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "segundagrad_percentual",
              "displayName": "segundagrad_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "balcao",
              "displayName": "balcao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "balcao_percentual",
              "displayName": "balcao_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "data_registro",
              "displayName": "data_registro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "1d36c22a-c0d6-4f5b-84a0-6459a54964e3",
      "name": "Atualizar Histórico",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "value": "precos_atuais",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chave": "={{$json[\"chave\"]}}",
            "curso": "={{$json[\"Curso\"]}}",
            "modalidade": "={{$json[\"Modalidade\"]}}",
            "grau": "={{$json[\"Grau\"]}}",
            "area": "={{$json[\"Área\"]}}",
            "duracao": "={{$json[\"Duração\"]}}",
            "preco_site": "={{$json[\"Preço Site\"]}}",
            "maraberto": "={{$json[\"MarAberto\"]}}",
            "maraberto_percentual": "={{$json[\"MarAberto_Percentual\"]}}",
            "segundagrad": "={{$json[\"2Grad\"]}}",
            "segundagrad_percentual": "={{$json[\"2Grad_Percentual\"]}}",
            "balcao": "={{$json[\"Balcao\"]}}",
            "balcao_percentual": "={{$json[\"Balcao_Percentual\"]}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chave",
              "displayName": "chave",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "curso",
              "displayName": "curso",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "modalidade",
              "displayName": "modalidade",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "grau",
              "displayName": "grau",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "area",
              "displayName": "area",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "preco_site",
              "displayName": "preco_site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "duracao",
              "displayName": "duracao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "maraberto_percentual",
              "displayName": "maraberto_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "maraberto",
              "displayName": "maraberto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "segundagrad_percentual",
              "displayName": "segundagrad_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "segundagrad",
              "displayName": "segundagrad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "balcao_percentual",
              "displayName": "balcao_percentual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "balcao",
              "displayName": "balcao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "atualizado_em",
              "displayName": "atualizado_em",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "10a42337-4d38-4076-97d6-944333cbb411",
      "name": "Atualizar Preços Atuais (Replace)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        288,
        0
      ]
    }
  ],
  "connections": {
    "Create File": {
      "main": [
        [
          {
            "node": "Download Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Excel": {
      "main": [
        [
          {
            "node": "Extrair Dados Planilha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados Planilha": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar precos_atuais": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Histórico": {
      "main": [
        [
          {
            "node": "Atualizar Preços Atuais (Replace)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Atualizar Histórico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "d19aa78a-266b-40b9-922d-fbe6ebc7513e",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-07-25T19:55:41.117Z",
      "createdAt": "2025-07-25T19:55:41.117Z",
      "role": "workflow:owner",
      "workflowId": "Ah2PKrm4A3SnIdTJ",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "activeVersion": null,
  "tags": [
    {
      "updatedAt": "2025-07-25T19:55:40.113Z",
      "createdAt": "2025-07-25T19:55:40.113Z",
      "id": "GZ4slaURcxWfF0kU",
      "name": "TESTE"
    }
  ]
}