{
  "updatedAt": "2026-01-30T19:28:29.246Z",
  "createdAt": "2025-07-25T20:01:53.086Z",
  "id": "afID0dTfsm0vtXUX",
  "name": "agente_ai_csv",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "00f79506-a02c-467a-9ff3-0974e9cf02af",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        12608,
        464
      ]
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 640,
        "width": 2396,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10848,
        368
      ],
      "typeVersion": 1,
      "id": "c739e568-565d-4553-a87b-21ea8b5ee063",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "maxTokens": 1200,
          "temperature": 0.4,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9200,
        -384
      ],
      "id": "d9367a27-bb20-4242-bad4-82b9ad866dcc",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        12192,
        144
      ],
      "id": "072f0f59-58ca-42a3-838f-cc8aefdf3904",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11696,
        128
      ],
      "id": "035f9184-36af-44bb-9f73-9a1b63889764",
      "name": "If4"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 364,
        "width": 2028,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10832,
        0
      ],
      "typeVersion": 1,
      "id": "20730bf1-a440-4873-8731-d672945fc1ce",
      "name": "Sticky Note54"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11536,
        128
      ],
      "id": "b87960ec-b936-405b-8dcc-e0b61e518df3",
      "name": "Busca Telefone",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11920,
        48
      ],
      "id": "80d57a51-82e3-4ef8-b618-437736f18880",
      "name": "Adiciona CHAT supabase",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11904,
        192
      ],
      "id": "00c3824b-47e7-483a-a032-46e7b3786c13",
      "name": "Atualiza CHAT Supabase",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('Basic LLM Chain2').item.json.text }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "id_lead",
              "fieldValue": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12400,
        144
      ],
      "id": "1b7bbcd6-871c-44a7-b44e-c11d0a5b8e74",
      "name": "Cria Histórico Supabase",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "c52c47d3-7b80-4dd3-a1cb-acfbf1283ab9",
      "name": "Split de Mensagem",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        12400,
        432
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "90b80d3c-ae16-44b3-af33-d377563acf54",
      "name": "1 segundo",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        13120,
        464
      ],
      "webhookId": "a2c69e1c-13fe-44a2-962c-1249288537eb"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "5af64095-e1bc-4b70-b015-a454ea2839d6",
      "name": "Delete Memory",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        12592,
        144
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 780,
        "width": 1916,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6960,
        96
      ],
      "typeVersion": 1,
      "id": "8c0acb8f-ff19-4a1d-a32f-fca2ae47747b",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 780,
        "width": 2516,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4464,
        80
      ],
      "typeVersion": 1,
      "id": "1248d193-005f-4974-906d-edb9859945ec",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "# PAUSA",
        "height": 780,
        "width": 2308,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        896,
        0
      ],
      "typeVersion": 1,
      "id": "3a139bd5-534d-451e-8d74-46ae7a72bbff",
      "name": "Sticky Note26"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "comercial_cruzeiro",
        "options": {}
      },
      "id": "602d8256-7107-4d57-9d13-c62f674ee219",
      "name": "Webhook EVO",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -128,
        464
      ],
      "webhookId": "7ecd43ed-123c-4fef-b86d-f9ce39e55d64"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a4377234-9405-48ea-a843-e903443fe310",
      "name": "Edit Fields3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5840,
        544
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "pause"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2176,
        32
      ],
      "id": "c68aa7b4-0e03-46fb-b15b-6002f8da7687",
      "name": "Pausar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "pause",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff00573b-e517-43c6-8644-14a4fe8565d1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Ativa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "=pause",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA pausada"
            }
          ]
        },
        "options": {}
      },
      "id": "571380e1-dc30-4174-b66d-0ec91924edc1",
      "name": "Rota Atendimento",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        2288,
        432
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "leftValue": "={{ $('Dados').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Pausada"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Normal ou Treinamento').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reativar IA"
            }
          ]
        },
        "options": {}
      },
      "id": "ed6cbfda-687e-4400-a78b-5df9d31d1452",
      "name": "Rotas1",
      "type": "n8n-nodes-base.switch",
      "position": [
        1920,
        128
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "reativada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2416,
        240
      ],
      "id": "a2afec9c-ecc3-40a5-afae-0519d3693633",
      "name": "Reativar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11800d83-ecca-4f9c-a878-a2419db0c8e9",
              "name": "=message.chat_id",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "c33f9527-e661-49e5-8e5e-64f3b430928a",
              "name": "=message.content_type",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}",
              "type": "string"
            },
            {
              "id": "06eba1c9-cff0-4f68-b6da-6bb0092466b7",
              "name": "=message.content",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
              "type": "string"
            },
            {
              "id": "b97f1af3-5361-46fc-9303-d644921231d8",
              "name": "=message.timestamp",
              "value": "={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}",
              "type": "string"
            },
            {
              "id": "dc3dc59c-90a3-4a45-bea2-de092c91083b",
              "name": "=message.content_url",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}",
              "type": "string"
            },
            {
              "id": "8b01a818-a456-476e-bace-adefe2f04eb4",
              "name": "message.event",
              "value": "={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}",
              "type": "string"
            },
            {
              "id": "886e3751-e39b-4fc6-98d1-3113eaeebbb4",
              "name": "=body.event",
              "value": "={{ $('Webhook EVO').item.json.body.event }}",
              "type": "string"
            },
            {
              "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
              "name": "=Telefone",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "a57db642-3e13-452e-bb5b-19f7e9f3bd5d",
              "name": "=NomeWhatsapp",
              "value": "={{ $('Webhook EVO').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "f5fcee3e-a786-404b-8b92-0163e02c6615",
              "name": "=Instance",
              "value": "={{ $('Webhook EVO').item.json.body.instance }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "776aff2e-f1c5-4975-a5f6-2d3997bc766f",
      "name": "Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        528,
        480
      ]
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2240,
        240
      ],
      "id": "0f7cc57a-c6e3-47d3-9166-311b206ca86e",
      "name": "Wait",
      "webhookId": "b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"
    },
    {
      "parameters": {
        "content": "# Configuração Banco de Dados",
        "height": 840,
        "width": 2312,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2880,
        3232
      ],
      "typeVersion": 1,
      "id": "cafd46e4-89a3-45c4-b09c-592b6ec43954",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6a3ec36a-220e-4470-a7cf-546b66422e23",
      "name": "If6",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        6848,
        592
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "6bcb7bb1-06e3-4e14-8e66-7c483d362036",
      "name": "OpenAI2",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        6544,
        592
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "682e3656-f4ce-4e90-bab7-ddc74a275834",
      "name": "OpenAI4",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        6656,
        416
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        752,
        480
      ],
      "id": "3eb313d1-d49b-47fe-9141-a861cfc5eaa3",
      "name": "Buscar Cliente",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4a6d9aac-8565-4c58-abe3-8741393a5535",
              "leftValue": "={{ $json.telefone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1056,
        480
      ],
      "id": "4a77a658-a49a-4d25-afe7-71e4c5a9dd00",
      "name": "Cliente Existe?",
      "retryOnFail": true
    },
    {
      "parameters": {
        "tableId": "dados_cliente",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').item.json.NomeWhatsapp }}"
            },
            {
              "fieldId": "telefone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1280,
        576
      ],
      "id": "e9a2521c-2670-415f-a01c-4825c4644b6d",
      "name": "Criar Cliente",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "outcoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7c878f9b-2c93-4061-954a-a832153e7647"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outcoming"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "d7b42536-638f-4128-b51b-6aa913e9d9bc",
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "incoming"
            }
          ]
        },
        "options": {}
      },
      "id": "af5f2298-bea5-499a-863c-034a10becec6",
      "name": "ROTA Entrando ou Saindo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1584,
        448
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "7b206cd0-bed3-4121-84e4-d7ee7ec22f56",
      "name": "Converter Audio",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6384,
        416
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "5a436850-6711-41df-abb0-d7aa02ffbe96",
      "name": "Converter Foto",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6144,
        608
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8e717a3a-742c-4dd1-883a-42833cf813e9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "38594d27-4ce1-4b6e-9dfc-ce5f2edca486",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "buttonMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "9b24c7e1-a0d6-4ccb-9c9e-d08d553cce48",
      "name": "ROTA Mensagens",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        5456,
        352
      ]
    },
    {
      "parameters": {
        "content": "# Agente FUPPER\n",
        "height": 1228,
        "width": 1924,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8944,
        1040
      ],
      "typeVersion": 1,
      "id": "7b005708-8712-408c-9dd4-12c6542a1961",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        10032,
        -400
      ],
      "id": "e91938cf-ab01-4343-b3cc-3fd7e362338a",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={{ JSON.stringify({ \n      type: \"ai\",\n      content: $('Dados').item.json.message.content || '', \n      additional_kwargs: {}, \n      response_metadata: {} \n   }) }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2544,
        640
      ],
      "id": "9cc64a6b-4676-489a-a8ca-61e2a0b8ed7b",
      "name": "Salvar Historico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"human\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2640,
        128
      ],
      "id": "db888d90-dc9d-4e8e-9d34-920428442dc3",
      "name": "Salvar Historico1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8912,
        608
      ],
      "id": "b698989c-6ea4-4432-982e-980928ddb7c6",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2800,
        112
      ],
      "id": "e176a487-085f-431d-8ead-9a710cbf787d",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "amount": 15
      },
      "id": "01633671-792f-4dbc-9bd6-ad8026ea8576",
      "name": "Intervalo entre Mensagens",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7776,
        384
      ],
      "webhookId": "9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "41c1e92f-1523-4d29-bdc5-f7ffebeab0a0",
      "name": "Texto Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6288,
        144
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "20357602-c607-49a4-a13a-49e6983dd24f",
      "name": "Audio Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6880,
        432
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "db975a2b-d4f1-4b9b-b9ad-61d312141f9c",
      "name": "imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7312,
        480
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "e7f58a93-e164-45f1-b716-594520b279e4",
      "name": "Imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7328,
        624
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "60cb757b-b9d3-497e-8438-a19fbf13d36f",
      "name": "Buscas Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7952,
        384
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8304,
        320
      ],
      "id": "3d4e3fdf-b6e8-4e0d-a0c9-39a419c6223a",
      "name": "Mensagem Completa1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "919b688c-93df-43d8-b072-c2043af478b9",
      "name": "Deletar Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        8448,
        304
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2800,
        3392
      ],
      "id": "cd60fdff-566d-472b-87c4-455b6fdf9adb",
      "name": "chat_messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table dados_cliente (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2400,
        3392
      ],
      "id": "df63e760-f356-4e2e-9575-e5d8415533fa",
      "name": "dados_cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1776,
        3392
      ],
      "id": "b763abad-b368-4911-a822-6b8d420f6143",
      "name": "chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create extension vector;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2608,
        3392
      ],
      "id": "34bc1642-0494-4f35-9fce-fc1dc64650d6",
      "name": "vetor",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create function match_documents (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    id,\n    content,\n    metadata,\n    1 - (documents.embedding <=> query_embedding) as similarity\n  from documents\n  where metadata @> filter\n  order by documents.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2000,
        3392
      ],
      "id": "063250e4-d7bc-4e9a-a990-cdece81965bc",
      "name": "match_documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2208,
        3392
      ],
      "id": "df2373cf-1419-436a-9f31-b8283b710158",
      "name": "documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "content": "## Criação\n",
        "height": 324,
        "width": 2224,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2832,
        3312
      ],
      "typeVersion": 1,
      "id": "7f1d437e-2570-424d-b079-d2c9427e2dfa",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Limpeza\n",
        "height": 260,
        "width": 1616,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2832,
        3712
      ],
      "typeVersion": 1,
      "id": "dd3e5ce6-7a6b-4267-89ee-95ba1d7f43d9",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM n8n_chat_histories",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2736,
        3792
      ],
      "id": "03c27b4f-e2d7-4e12-b33a-a6786c981a08",
      "name": "Deletar Histórico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chat_messages",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1712,
        3792
      ],
      "id": "01e1effd-8827-4935-ad1d-f668206becec",
      "name": "Deletar conteúdo Chat_Messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from dados_cliente",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2240,
        3792
      ],
      "id": "7c373d55-c3c8-4156-a2d5-8e06751402d1",
      "name": "Deletar conteúdo Dados Cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chats",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2480,
        3792
      ],
      "id": "fbf9bc82-b22a-4d4b-9891-e29e57e72f67",
      "name": "Deletar conteúdo Chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1968,
        3792
      ],
      "id": "9aaadc7e-a21d-439f-b0ba-c0daae26e4fc",
      "name": "Deletar conteúdo Documentos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "22c78d64-bd4f-4136-abb4-4a0a03ce46e9",
      "name": "Compara Memoria",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8096,
        384
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('Basic LLM Chain2').item.json.text }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={\n  \"messages\": [\n    \"Você é um assistente que divide mensagens longas de WhatsApp em partes menores, mantendo tom natural e fluido.\",\n    \"CRÍTICO: Responda APENAS com JSON puro. Formato obrigatório: {\\\"messages\\\": [\\\"mensagem 1\\\", \\\"mensagem 2\\\"]}\",\n    \"NÃO use markdown, NÃO use ```json, NÃO adicione texto explicativo. SOMENTE o objeto JSON.\",\n    \"Use quebras de linha reais (\\\\n) dentro das strings. Nunca escape como \\\\\\\\n.\",\n    \"Cada mensagem: 250-350 caracteres. Não quebre frases no meio.\",\n    \"NÃO reescreva. NÃO expanda. NÃO adicione conteúdo. Apenas divida o texto original.\",\n    \"Máximo 4 mensagens. Prefira menos se possível.\",\n    \"NUNCA gere mensagens vazias.\",\n    \"Remova toda formatação: negrito, itálico, tachado.\",\n    \"Links https:// devem ficar entre crases: `https://exemplo.com`\",\n    \"NÃO adicione códigos, identificadores ou qualquer texto extra além das mensagens divididas.\",\n    \"A entrada virá assim: Whatsapp message to be splitted and formatted: [TEXTO]\"\n  ]\n}"
            }
          ]
        }
      },
      "id": "2ddcf8f7-ed70-4a00-bad5-96b321c0b110",
      "name": "Split de mensagens",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        11904,
        416
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7a1830f8-fca5-4b10-b824-dce7b74b344d",
      "name": "OpenAI Split",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        11872,
        624
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "# INICIO\n\n",
        "height": 780,
        "width": 1040,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -176,
        32
      ],
      "typeVersion": 1,
      "id": "a2b40d9d-4e8c-4278-bf24-1ed35ff2239c",
      "name": "Sticky Note32"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "69a59373-8ee0-4d1b-bb60-2dc4b86df588",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6080,
        448
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7600,
        352
      ],
      "id": "2fb04853-a3c8-42af-8414-60266a8c1f5d",
      "name": "Mensagem"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        64,
        3696
      ],
      "id": "8e3608dd-7863-4861-b850-a13196be7760",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json['﻿Curso'] }} {{ $json[' Preço '] }} {{ $json.Modalidade }}",
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "tipo",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n\n    // Insere a vírgula que está faltando entre \"valor\" e \"grau\"\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n\n    const obj = JSON.parse(fixed);\n    return obj.tipo;\n  })()\n}}"
              },
              {
                "name": "curso",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.curso;\n  })()\n}}"
              },
              {
                "name": "area",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.area;\n  })()\n}}"
              },
              {
                "name": "grau",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.grau;\n  })()\n}}"
              },
              {
                "name": "modalidade",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.modalidade;\n  })()\n}}"
              },
              {
                "name": "valor",
                "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.valor;\n  })()\n}}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        240,
        3680
      ],
      "id": "4289d36e-aae0-46aa-ada7-cfbd8fba5b86",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -400,
        3472
      ],
      "id": "63ff7cca-3f26-459f-ae80-4944ce93744d",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1uuSFEfXVNfsG1cYDvE4OSKD7ST5ym6bK",
          "mode": "list",
          "cachedResultName": "precos_grad_IA_2601.csv",
          "cachedResultUrl": "https://drive.google.com/file/d/1uuSFEfXVNfsG1cYDvE4OSKD7ST5ym6bK/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -208,
        3472
      ],
      "id": "dda4e7de-7bef-4c0b-a0db-c6493b14d55f",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 512,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        256,
        3840
      ],
      "id": "28f00a23-ad47-417f-8f6b-834dde54d7c8",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "content": "Converte Documentos em Vetorial \n",
        "height": 580,
        "width": 996
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -416,
        3392
      ],
      "id": "b3ab877e-43a1-4c93-bc6a-11af5a0c5356",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_precos",
          "mode": "list",
          "cachedResultName": "documents_precos"
        },
        "embeddingBatchSize": 135,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        176,
        3472
      ],
      "id": "ab6df33b-8f15-4db6-aae4-03a160098e5b",
      "name": "Supabase Vector Store1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 89820300,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "81bf90a7-0a29-4229-9fb3-cc04be0bfca0"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RECEPTIVO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a11dec04-2f57-42bf-a6fc-2add3efe8afd",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 89820304,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "FOLLOW UP "
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "27bccebf-da1a-4af0-8f3f-5d1d362dd733",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 53917599,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SALESBOT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "08f20f5b-a9b8-49f4-a766-b2364f777b0e",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 99045180,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agente inscricao"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "680b674d-8f0f-407e-8656-e876d770146f",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 48566207,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ACEITE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b0049c1-ee21-4a6c-ac95-836fc5d77877",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 74941508,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Aguardando resposta"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3808,
        416
      ],
      "id": "1a381b09-f91c-46c7-a600-1caabe96bf6e",
      "name": "Switch1"
    },
    {
      "parameters": {
        "url": "https://admamoeduitcombr.kommo.com/api/v4/leads",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "with",
              "value": "contacts"
            },
            {
              "name": "query",
              "value": "={{ ' ' + $('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net', '') }}"
            },
            {
              "name": "filter[statuses][0][pipeline_id]",
              "value": "11685120"
            },
            {
              "name": "filter[statuses][0][status_id]",
              "value": "89820300"
            },
            {
              "name": "filter[statuses][1][pipeline_id]",
              "value": "11685120"
            },
            {
              "name": "filter[statuses][1][status_id]",
              "value": "89820304"
            },
            {
              "name": "filter[statuses][2][pipeline_id]",
              "value": "5481944"
            },
            {
              "name": "filter[statuses][2][status_id]",
              "value": "99045180"
            },
            {
              "name": "filter[statuses][3][pipeline_id]",
              "value": "5481944"
            },
            {
              "name": "filter[statuses][3][status_id]",
              "value": "48566207"
            },
            {
              "name": "filter[statuses][4][pipeline_id]",
              "value": "5481944"
            },
            {
              "name": "filter[statuses][4][status_id]",
              "value": "74941508"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjFlMmU2MTQ1ZGIxNDliZTk0MmI1MDEwZDU5NDVmNzNiNDljOWNiNTVjZjQ5MjQyNWQ3ZTAzY2M5NWNhYWJkNmUzZDI2NDA4MzA1OGZlYWY1In0.eyJhdWQiOiI3MGFhNjUzZS04NmI5LTQ4ZjgtOTZhNy1kMjc4YzJiMTA4ZWEiLCJqdGkiOiIxZTJlNjE0NWRiMTQ5YmU5NDJiNTAxMGQ1OTQ1ZjczYjQ5YzljYjU1Y2Y0OTI0MjVkN2UwM2NjOTVjYWFiZDZlM2QyNjQwODMwNThmZWFmNSIsImlhdCI6MTc2NjE0OTIwMCwibmJmIjoxNzY2MTQ5MjAwLCJleHAiOjE4MTE4MDgwMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzAyMTQ1NjgsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJoYXNoX3V1aWQiOiJhOWIzZTRjNC01NmU0LTRhNDktYWEyYS1jMzI3ZjJiODcwZmYiLCJ1c2VyX2ZsYWdzIjowLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.bGhuPREV7xSfbw-SZissYXy22s3j86kBfQg1os2gE1WlVbU5D1-P4vwOJZ1pi3OvQTL8HG4RtnfjTmMns5CzAy7lcoixG8x4iE-DBi5zjXq6cE2HJxBmwvqbdzKc6CsDUoMBM23nXbchZkOxOu5hfN4cDvdMj7Xg7MH8H1g6Wj-rmsw3H1dtgCqOqMEGUAs4uzToXWqh5YtBi1E16B48-RlJH3Q0oxf5unkJPbBTm-GxaT_i72uk-nHri1fdS52lzDaQ60xA0CFbkm0rmWIGv_-YCeRjvLXh6EMbD908WD5zIWZ8tA4lQBLB43QToiuFcfzWb8UaxS05Gpl_h5Yf9A"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3328,
        400
      ],
      "id": "3355c2b9-f52e-43c9-ad29-acca22c81e01",
      "name": "HTTP Request",
      "retryOnFail": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f5c281d3-f206-42bd-a05a-02d2b2c427a0",
              "name": "=data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3536,
        400
      ],
      "id": "58c07f42-e9e2-46b1-921e-4e1dde98f4c1",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "let telefoneRaw;\nlet telefoneCorreto;\n\n// 1. Tenta pegar do formato processado (por ex. depois de um Set)\nif ($json.Telefone) {\n  telefoneRaw = $json.Telefone;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 2. Tenta pegar do JSON bruto vindo direto do webhook\nelse if ($json.body?.data?.key?.remoteJid) {\n  telefoneRaw = $json.body.data.key.remoteJid;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 3. Caso não encontre nada, define como null\nelse {\n  telefoneCorreto = null;\n}\n\nreturn [\n  {\n    json: {\n      telefoneCorreto\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        304,
        480
      ],
      "id": "6e510c74-aad1-4540-9a79-4520edf712c0",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        11328,
        128
      ],
      "id": "c22955d4-4321-43d0-9167-4d0633871840",
      "name": "Merge"
    },
    {
      "parameters": {
        "content": "# KOMMO\n\n",
        "height": 780,
        "width": 1236,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3184,
        64
      ],
      "typeVersion": 1,
      "id": "d735445a-c32e-4751-9a49-1d8422c8ee12",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3072,
        400
      ],
      "id": "aeeb12d4-c628-4931-b84e-5304103a9c59",
      "name": "Wait1",
      "webhookId": "9570c1d5-ac36-4517-8cfb-32ad769dfb8a"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6096,
        272
      ],
      "id": "400e7a2e-bf02-4495-afd2-5036b573ce40",
      "name": "Merge2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5904,
        112
      ],
      "id": "ed287bc7-4b86-4304-a18b-91422e3ba8d9",
      "name": "Merge3"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.text }} - {{ $execution.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        11408,
        448
      ],
      "id": "df75a852-d089-4656-a3ab-95b360a9556b",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents_precos (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1312,
        3392
      ],
      "id": "40c98457-87a3-467c-9262-59385bd291ed",
      "name": "documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents_precos",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1440,
        3792
      ],
      "id": "f6cfdc2a-5be1-4e4e-97b3-08d7e74e8d58",
      "name": "Deletar conteúdo documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE FUNCTION match_documents_precos (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    documents_precos.id,\n    documents_precos.content,\n    documents_precos.metadata,\n    1 - (documents_precos.embedding <=> query_embedding) as similarity\n  FROM documents_precos  -- ✅ CORRIGIDO: Agora busca na tabela certa\n  WHERE documents_precos.metadata @> filter\n  ORDER BY documents_precos.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1552,
        3392
      ],
      "id": "b135fcc5-79d5-4ce1-b525-342a7e26af93",
      "name": "match_documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "440327379171310",
        "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        12848,
        448
      ],
      "id": "e5ad1fd8-5bf3-4778-bd39-6b0e4f4e0d97",
      "name": "Send message",
      "webhookId": "97ad0e83-cc00-48c6-8948-06d3a14986f0",
      "credentials": {
        "whatsAppApi": {
          "id": "uKAVEc80et1CTr0c",
          "name": "WACA CSV Comercial"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table rerank (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1056,
        3392
      ],
      "id": "68d8e18a-8187-444a-807f-682a4257ef91",
      "name": "rerank",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DROP FUNCTION IF EXISTS rerank(vector, integer, jsonb);\n\nCREATE FUNCTION rerank(\n  query_embedding vector(1536),\n  match_count int DEFAULT NULL,\n  filter jsonb DEFAULT '{}'::jsonb\n)\nRETURNS TABLE (\n  id uuid,\n  content text,\n  metadata jsonb,\n  similarity double precision\n)\nLANGUAGE plpgsql\nSTABLE\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT\n    d.id,\n    d.content,\n    d.metadata,\n    1 - (d.embedding <=> query_embedding) AS similarity   -- cosine similarity\n  FROM documents_precos AS d\n  WHERE (filter IS NULL OR filter = '{}'::jsonb OR d.metadata @> filter)\n  ORDER BY d.embedding <=> query_embedding                 -- menor distância primeiro\n  LIMIT match_count;                                       -- NULL = sem limite\nEND;\n$$;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -848,
        3408
      ],
      "id": "4d5cf367-83ab-44dc-bda9-a295609dd3d6",
      "name": "match_rerank",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "289b3516-051b-4605-9478-38fecd86aa17",
              "leftValue": "={{ $json.id_lead }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8816,
        288
      ],
      "id": "f9c67ba5-d701-493c-a5b3-12ee0ad18577",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3808,
        880
      ],
      "id": "21138c3c-27bd-4a07-b00c-6fcf18f1bf5d",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "intercambio_bu",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ '+'.concat($('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net','')) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        8624,
        288
      ],
      "id": "f81f0750-eb56-440b-bfde-1c508254a474",
      "name": "VERIFICA INTERCAMBIO",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5840,
        704
      ],
      "id": "600048b3-8d4b-47a4-85ca-dcf177d57b3e",
      "name": "Merge9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "942f92f3-349c-4cb2-9a0c-e94ce223017e",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "rightValue": "Quero mais informações",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "7f34371a-d6ca-4701-bddf-d992722b86ba",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "rightValue": "👨‍🎓 Quero mais informações",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        12800,
        144
      ],
      "id": "ddb74841-1a9e-43ea-bd89-e49fd68e1fad",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        13008,
        240
      ],
      "id": "125a1342-9c71-4bcd-a7cf-5d744ae93983",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "face-insta",
          "mode": "list",
          "cachedResultName": "face-insta"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
            "created_at": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        13008,
        48
      ],
      "id": "746b1b21-d768-461a-8df4-bc43e6197201",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "chame esse agente para procurar preços",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "# Agente Preços - Consulta de Valores\n\n## Identidade\nEspecialista em consultar preços de cursos da Cruzeiro do Sul Virtual.\n**Tom:** Profissional e objetivo.\n**Ferramenta:** buscar_documentos3\n\n---\n\n## Query da Ferramenta\n\n### REGRA CRÍTICA:\nUse **APENAS o nome limpo do curso** na query.\n\n**❌ NÃO inclua:**\n- \"curso de\", \"graduação\", \"pós-graduação\", \"tecnólogo\", \"MBA\"\n- \"EAD\", \"semipresencial\", \"presencial\"\n- \"preço\", \"valor\", \"mensalidade\"\n- \"bacharelado\", \"licenciatura\"\n\n**✅ Exemplos corretos:**\n- Usuário: \"Quanto custa Psicologia EAD?\" → Query: `\"Psicologia\"`\n- Usuário: \"Valor de MBA em RH\" → Query: `\"Recursos Humanos\"`\n- Usuário: \"Mensalidade de Gestão de Projetos\" → Query: `\"Gestão de Projetos\"`\n\n---\n\n## Processo\n\n1. **Extrair** o nome limpo do curso\n2. **Buscar** com 2-3 variações do nome\n3. **Identificar** o nível do curso (graduação ou pós-graduação)\n4. **Coletar** todos os preços disponíveis\n5. **Enviar** resultado estruturado\n\n---\n\n## Regras por Nível\n\n### 📘 GRADUAÇÃO\n- Retorne **TODAS** as modalidades (EAD, Semipresencial)\n- Valores **EXATOS** (nunca use \"aproximadamente\")\n- **Ignore** completamente pós-graduação se existir\n\n### 📕 PÓS-GRADUAÇÃO\n- Retorne **SEMPRE 2 PREÇOS** quando disponível\n- **Preço menor** = curso de **menor duração**\n- **Preço maior** = curso de **maior duração**\n- Informe as durações correspondentes\n\n---\n\n## Regras Críticas\n\n### ❌ NUNCA:\n- Inventar ou arredondar preços\n- Responder sem usar buscar_documentos3\n- Misturar graduação com pós-graduação\n- Usar \"aproximadamente\", \"cerca de\", \"a partir de\"\n\n### ✅ SEMPRE:\n- Buscar com 2-3 variações do nome\n- Apresentar valores EXATOS\n- Informar \"sem_resultado\" se não encontrar\n- Para pós: coletar AMBOS os preços (curta e longa duração)\n\n---\n\n## Templates de Resposta\n\n### ✅ Graduação Encontrada:\n```xml\n<graduacao>\n  <curso>[Nome]</curso>\n  <modalidades>\n    <ead>\n      <mensalidade>R$ [valor exato]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </ead>\n    <semipresencial>\n      <mensalidade>R$ [valor exato]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </semipresencial>\n  </modalidades>\n</graduacao>\n```\n\n### ✅ Pós-Graduação Encontrada:\n```xml\n<pos_graduacao>\n  <curso>[Nome]</curso>\n  <opcoes>\n    <curta_duracao>\n      <duracao>[X meses]</duracao>\n      <mensalidade>R$ [valor menor]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </curta_duracao>\n    <longa_duracao>\n      <duracao>[Y meses]</duracao>\n      <mensalidade>R$ [valor maior]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </longa_duracao>\n  </opcoes>\n</pos_graduacao>\n```\n\n### ❌ Não Encontrado:\n```xml\n<sem_resultado>\n  <buscas_realizadas>\n    - [termo 1]\n    - [termo 2]\n  </buscas_realizadas>\n  <mensagem>Curso não encontrado</mensagem>\n</sem_resultado>\n```\n\n---\n\n## Checklist Antes de Enviar\n\n- [ ] Query com nome LIMPO?\n- [ ] Busquei 2-3 variações?\n- [ ] Identifiquei o nível correto?\n- [ ] Coletei TODOS os preços?\n- [ ] Pós-graduação: peguei AMBAS durações?\n- [ ] Valores EXATOS (sem \"aproximadamente\")?\n- [ ] Não inventei dados?\n\n---\n\n## Exemplos de Variações\n\n- **RH:** \"Recursos Humanos\" + \"Gestão de Recursos Humanos\"\n- **Marketing:** \"Marketing\" + \"Gestão de Marketing\"  \n- **Administração:** \"Administração\" + \"Administração de Empresas\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9408,
        -320
      ],
      "id": "943a481b-dd91-448b-a7b8-335ed81cf4bf",
      "name": "agente preços"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "=# PROMPT DO ORQUESTRADOR\n\nVocê é um orquestrador inteligente de atendimento educacional. Sua função é analisar mensagens, decidir qual ferramenta usar e fornecer contexto completo aos agentes DE FORMA INTERNA.\n\n## ⚠️ REGRA CRÍTICA: CONTEXTO É INTERNO\n\n**NUNCA exponha o contexto interno ao cliente. O contexto serve apenas para:**\n- Você entender a situação completa\n- Passar informações relevantes aos agentes via parâmetros das tools\n- Tomar decisões inteligentes\n\n**O cliente NUNCA deve ver:**\n- ❌ \"CONTEXTO DA CONVERSA:\"\n- ❌ \"Curso mencionado: [nome]\"\n- ❌ \"Informações do lead: [dados]\"\n- ❌ \"Histórico relevante: [resumo]\"\n\n---\n\n## REGRAS DE ANÁLISE DE CONTEXTO (USO INTERNO)\n\n### 1. SEMPRE ANALISE O HISTÓRICO COMPLETO (INTERNAMENTE)\nAntes de executar qualquer tool, você DEVE (internamente):\n- ✅ Verificar TODO o histórico da conversa\n- ✅ Identificar qual curso foi mencionado anteriormente\n- ✅ Capturar informações já fornecidas pelo lead (nome, cidade, CEP, etc.)\n- ✅ Entender o contexto completo da solicitação\n\n### 2. USE O CONTEXTO PARA TOMAR DECISÕES\n- Use o histórico para entender o que o lead quer\n- Identifique informações já fornecidas para não pedir novamente\n- Tome decisões inteligentes baseadas no contexto completo\n\n### 3. PASSE INFORMAÇÕES DIRETAMENTE AOS AGENTES\nAo chamar uma tool, construa uma mensagem completa e natural que inclua as informações necessárias de forma direta.\n\n---\n\n## FERRAMENTAS (5 Tools)\n\n### 🔧 `receptivo_informacoes`\n**Quando usar:** Perguntas sobre cursos (duração, grade, modalidade, matérias, etc.)\n\n**Como usar:**\n- SEMPRE execute esta tool para qualquer pergunta sobre cursos\n- NUNCA responda sobre cursos sem executá-la\n- Construa uma mensagem clara especificando o curso se ele já foi mencionado\n\n---\n\n### 🔧 `agente_precos`\n**Quando usar:** Perguntas sobre valores, mensalidades, preços, taxas, bolsas ou descontos.\n\n**Processo de decisão INTERNO:**\n1. Verificar o histórico: qual curso o lead mencionou?\n2. Se NÃO houver curso mencionado: pergunte ao lead\n3. Se HOUVER curso no histórico: construa a chamada incluindo o nome do curso\n\n**Regras de apresentação:**\n- SEMPRE execute esta tool para qualquer pergunta sobre preços\n- NUNCA invente, estime ou arredonde valores\n- Use EXATAMENTE os valores retornados pela tool\n- Se a tool retornar múltiplas modalidades (EAD, Semipresencial), apresente TODAS as opções\n- Apresente cada modalidade com seu respectivo valor\n- Ao mencionar EAD, use apenas \"EAD\" sem adicionar \"100% online\" ou similares\n\n---\n\n### 🔧 `agente_localizacao`\n**Quando usar:** \n\n**EXECUTAR IMEDIATAMENTE quando a mensagem contém:**\n1. **CEP** - 8 dígitos com ou sem hífen (ex: 01310-100 ou 01310100)\n2. **Nome de cidade** (ex: São Paulo, Campinas, Curitiba)\n3. **Nome de bairro** (ex: Centro, Vila Mariana)\n4. **Endereço** (ex: Rua XV de Novembro, Av. Paulista)\n5. **Pergunta sobre localização de polo ou unidade**\n\n**🚨 REGRA ABSOLUTA:**\n- Se detectar CEP ou localização na mensagem → EXECUTAR `agente_localizacao` AUTOMATICAMENTE\n- Não pergunte nada, apenas execute a tool com a informação fornecida\n- Se não houver CEP/localização E o lead perguntou sobre polo → Pergunte o CEP ou endereço\n\n**Como chamar:**\n- \"Localizar polo mais próximo do CEP [CEP]\"\n- \"Localizar polo mais próximo de [cidade/bairro/endereço]\"\n\n---\n\n### 🔧 `distribuir_humano`\n**Quando usar:**\n- Lead pede para falar com atendente humano\n- `receptivo_informacoes` não encontra o curso e não há sugestões\n- Pergunta sobre assunto que você não sabe responder\n- Mensagem confusa ou incompreensível após 2 tentativas de esclarecimento\n- Dúvidas complexas sobre documentação ou processos\n\n---\n\n### 🔧 `inscricao`\n**Quando usar:** Lead confirma que quer se matricular (apenas na confirmação final)\n\n**Processo INTERNO:**\n1. Verificar se você tem: curso, modalidade, polo\n2. Se falta algo, pergunte ao lead\n3. Se tem tudo, execute a tool\n\n**⚠️ OBRIGATÓRIO:** \n- Só execute após o lead confirmar explicitamente o interesse em se matricular\n\n---\n\n## FLUXO DE DECISÃO INTERNO\n\n### ANÁLISE PRIORITÁRIA A CADA MENSAGEM:\n\n**1. PRIMEIRA VERIFICAÇÃO (PRIORIDADE MÁXIMA):**\n- [ ] A mensagem contém CEP (8 dígitos)?\n- [ ] A mensagem contém nome de cidade?\n- [ ] A mensagem contém endereço/bairro?\n- **SE SIM → EXECUTAR `agente_localizacao` IMEDIATAMENTE**\n\n**2. SEGUNDA VERIFICAÇÃO:**\n- [ ] Pergunta sobre curso? → `receptivo_informacoes`\n- [ ] Pergunta sobre preço? → `agente_precos`\n- [ ] Quer se matricular? → `inscricao`\n- [ ] Quer atendente humano? → `distribuir_humano`\n\n---\n\n## VERIFICAÇÃO ANTES DE AGIR\n\nAntes de qualquer ação, pergunte-se (INTERNAMENTE):\n\n1. ✅ **A mensagem contém CEP ou localização?** (VERIFICAR PRIMEIRO)\n2. ✅ Analisei o histórico?\n3. ✅ Sei qual curso o lead está falando (se relevante)?\n4. ✅ Tenho os dados necessários para executar a tool?\n5. ✅ Vou expor contexto interno ao cliente? (DEVE SER NÃO!)\n\n---\n\n## TOM DE COMUNICAÇÃO COM O CLIENTE\n\n- 🎯 Profissional e acolhedor\n- 💬 Linguagem clara e acessível\n- ⚡ Respostas diretas e objetivas\n- 🤝 Empático e prestativo\n- 🚫 Nunca use tom robótico\n- 🚫 Nunca exponha sua análise interna\n- ✅ Seja natural e conversacional\n\n---\n\n## RESUMO: O QUE O CLIENTE VÊ vs O QUE É INTERNO\n\n### ❌ Cliente NUNCA vê:\n- Sua análise do histórico\n- \"CONTEXTO DA CONVERSA\"\n- \"Informações identificadas\"\n- Seus processos de decisão\n- Referências ao orquestrador ou agentes\n\n### ✅ Cliente vê apenas:\n- Respostas naturais e diretas\n- Perguntas quando você precisa de mais informações\n- Resultados das consultas aos agentes\n- Comunicação fluida e profissional\n\n---\n\n## IMPORTANTE: DETECÇÃO AUTOMÁTICA DE LOCALIZAÇÃO\n\n**A detecção de CEP e localização tem PRIORIDADE ABSOLUTA sobre todas as outras análises.**\n\nSe a mensagem do lead contém qualquer informação de localização (CEP, cidade, bairro, endereço), você DEVE executar `agente_localizacao` imediatamente, sem perguntar nada ao lead."
        }
      },
      "id": "33b8ada0-2ca4-4530-a7a6-fa5869e11216",
      "name": "orquestrador",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        9664,
        -640
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        9440,
        32
      ],
      "id": "67918d65-084b-4f79-a504-f71cd6e52d68",
      "name": "Calculator"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        10576,
        64
      ],
      "id": "88916fab-40b9-4573-87c0-84192a2fd89e",
      "name": "Think"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        9808,
        -416
      ],
      "id": "fb0708b5-1bec-4574-91fa-25702b5101dd",
      "name": "reflexao"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "maxTokens": 600,
          "temperature": 0,
          "topP": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9296,
        -32
      ],
      "id": "ae40995a-bbf6-4ba0-8436-f244e22a2046",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "maxTokens": 1200,
          "temperature": 0.4,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9936,
        192
      ],
      "id": "cc447526-f61c-459e-86f8-eb3cd9bafd03",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9360,
        96
      ],
      "id": "462c96d8-14f1-4492-b46c-c63b5c59b3f2",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        10080,
        144
      ],
      "id": "80c8ec31-f990-4703-b9ab-fc6a8cac0662",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "FgPYiDXMl6Ita0We",
          "mode": "list",
          "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
          "cachedResultName": "distribuicao_ai_flows_csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9920,
        -400
      ],
      "id": "5cf3bb63-07bd-4373-8e53-26ec022a938b",
      "name": "inscricao"
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "pWLVh6dNNqX0DfAl",
          "mode": "list",
          "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
          "cachedResultName": "distribuir_atendimento_ia csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9744,
        -448
      ],
      "id": "d530b836-d5d5-4de1-acb7-6b768325a26c",
      "name": "distribuir_humano"
    },
    {
      "parameters": {
        "jsCode": "// Pega todos os items do node \"Edit Fields1\"\nconst items = $items(\"Edit Fields1\");\n\n// mapeia cada item\nreturn items.map(item => {\n    const leads = item.json?.data?._embedded?.leads || [];\n    if (leads.length === 0) {\n        return { json: { curso: \"Não encontrado\" } };\n    }\n\n    const lead = leads[0]; // pega o primeiro lead, ajusta se quiser todos\n    const customFields = lead.custom_fields_values || [];\n    const cursoField = customFields.find(f => f.field_name === \"Curso\");\n    const cursoValue = cursoField?.values?.[0]?.value || \"Não informado\";\n\n    return {\n        json: {\n            curso: cursoValue\n        }\n    };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9024,
        1312
      ],
      "id": "816cc285-81ed-4eb6-b28d-ee302f1e8ed6",
      "name": "Code2"
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 780,
        "width": 1772,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7104,
        896
      ],
      "typeVersion": 1,
      "id": "15d1a072-3ee1-4cf9-8a10-509a914421ef",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 796,
        "width": 2644,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4416,
        912
      ],
      "typeVersion": 1,
      "id": "9dd9c929-f52a-40b0-81ae-f5c3ba7e281a",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "db546aee-9112-4db5-b963-eefe8a9e5eec",
      "name": "Edit Fields4",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5712,
        1472
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "7da74512-8f7f-4a78-83be-e10ab82d356f",
      "name": "OpenAI",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        6416,
        1472
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "4d9808ff-85b9-47cf-871a-8fbaab287067",
      "name": "OpenAI5",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        7008,
        1248
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "77b926e1-240d-443d-8b24-ab3abe3d3882",
      "name": "Converter Audio1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6800,
        1280
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "655f15f7-e299-4371-9f3d-26b2953a50ea",
      "name": "Converter Foto1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6048,
        1472
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "id": "382fc605-a52d-4c03-a83a-0b72a6bce813",
      "name": "ROTA Mensagens1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        4992,
        1024
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8528,
        1488
      ],
      "id": "aec9ba46-6833-47f2-9730-a6579d82ac5f",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "amount": 15
      },
      "id": "60f80560-d99d-4663-877e-c5e3bd414399",
      "name": "Intervalo entre Mensagens1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7920,
        1328
      ],
      "webhookId": "173b6f50-2e8b-43b2-af16-3741780b23af"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "486fc1d7-2e26-4745-9d93-ea48190a2b88",
      "name": "Texto Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6128,
        1040
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "74c7ce86-b129-4675-b619-e48b64ad63a4",
      "name": "Audio Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7280,
        1232
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "a910c7f9-506f-42fc-8362-c89ffd8017cb",
      "name": "imagem Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7120,
        1408
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "38c9f97f-713c-4a23-8203-794eeaa00ddb",
      "name": "Imagem Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7120,
        1536
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "0ab30702-6043-4114-aebf-8312125f3249",
      "name": "Buscas Mensagens1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        8112,
        1328
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8528,
        1312
      ],
      "id": "6aba4bff-c4e0-4125-b0c1-4a20fff2bade",
      "name": "Mensagem Completa"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "54a55e77-6d4e-4169-afe7-1311ad0ab7b5",
      "name": "Deletar Mensagens1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        8816,
        1312
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem1').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "2e07e68b-5dd9-4d88-bb30-b68c4c9f2e69",
      "name": "Compara Memoria1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8304,
        1328
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "60094283-b5c1-4171-a2b3-268e4b561ee5",
      "name": "Edit Fields5",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6544,
        1280
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7728,
        1328
      ],
      "id": "04d07a17-9665-4386-9992-28b23cabfe81",
      "name": "Mensagem1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5712,
        1120
      ],
      "id": "a7cad5bf-9b65-4e11-b0ea-e0da27893874",
      "name": "Merge4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5712,
        944
      ],
      "id": "beca2be0-3d91-475e-9427-af773bc44e90",
      "name": "Merge5"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5872,
        1264
      ],
      "id": "b6b45bf6-b848-4c29-bc09-acd3fe23a33a",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bf2f01bb-bee7-4238-becf-b3afbb17b07a",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5504,
        1248
      ],
      "id": "a27dbd7d-3711-4134-a796-b45682ea4e71",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d2c6a14d-f1fa-4314-84f7-05498c71efba",
      "name": "If2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        6768,
        1472
      ]
    },
    {
      "parameters": {
        "content": "# Agente Principal\n",
        "height": 1660,
        "width": 1924,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8912,
        -672
      ],
      "typeVersion": 1,
      "id": "d92a15d3-7bc5-44bd-a09a-045834559fc8",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "frequencyPenalty": 0.2,
          "maxTokens": 1000,
          "responseFormat": "text",
          "presencePenalty": 0.1,
          "temperature": 0.4,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9440,
        2016
      ],
      "id": "01bef887-49b8-4fd3-abd3-2407692f2a62",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9616,
        2096
      ],
      "id": "c63e01e2-831d-42fb-bace-7bbc3706aff4",
      "name": "Postgres Chat Memory5",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "FgPYiDXMl6Ita0We",
          "mode": "list",
          "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
          "cachedResultName": "distribuicao_ai_flows"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9856,
        2224
      ],
      "id": "d96898f3-9344-4e31-8e25-8aa652bd882d",
      "name": "inscricao1"
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "pWLVh6dNNqX0DfAl",
          "mode": "list",
          "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
          "cachedResultName": "distribuir_atendimento_ia csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9968,
        2192
      ],
      "id": "c5e82e02-2ec1-44f9-b6a9-60e9c813b19a",
      "name": "distribuir_humano1"
    },
    {
      "parameters": {
        "jsCode": "// Code node (JS) — \"Run Once for All Items\"\nconst seen = new Map();\n\nfor (const item of items) {\n  const key = item.json.id_lead;\n  const prev = seen.get(key);\n\n  // Mantém o de maior \"id\"\n  if (!prev || Number(item.json.id ?? -Infinity) > Number(prev.json.id ?? -Infinity)) {\n    seen.set(key, item);\n  }\n}\n\n// Retorna no formato correto do n8n\nreturn Array.from(seen.values());\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9168,
        992
      ],
      "id": "87dc64fe-895e-4b89-879d-875f3cae9e28",
      "name": "Code1"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "pipeline_id": 11685120,
              "status_id": 89820304
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        9328,
        992
      ],
      "id": "c67ce46d-4e13-42fd-81e2-ab1d59728599",
      "name": "Update leads",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "c4346f8f-a6fc-45ac-8da3-07d0eb348816",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        12960,
        1584
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        12992,
        1264
      ],
      "id": "742e4e9a-11e7-4452-92de-0953a7025484",
      "name": "Merge6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone1').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        12496,
        1248
      ],
      "id": "837e6284-8750-4cbc-bd45-1c825592be84",
      "name": "If5"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 380,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11712,
        1040
      ],
      "typeVersion": 1,
      "id": "961c8065-7e7c-48e7-b45e-f33785060f4a",
      "name": "Sticky Note55"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12336,
        1248
      ],
      "id": "ac76ddf6-4678-4ddc-a1a8-1b635b8cc240",
      "name": "Busca Telefone1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12736,
        1152
      ],
      "id": "728b92c6-ef61-435d-86c9-1f468c308e52",
      "name": "Adiciona CHAT supabase1",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        12736,
        1328
      ],
      "id": "443f984c-3d3b-44a3-860e-d21d6c7e261c",
      "name": "Atualiza CHAT Supabase1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "tableId": "chat_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('Fupper').first().json.output }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').first().json.NomeWpp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        13200,
        1264
      ],
      "id": "dbff5cee-415b-45e2-aa36-ed192022e994",
      "name": "Cria Histórico Supabase1",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "4f81b3f3-431d-4416-91a5-7d3baed6f251",
      "name": "Split de Mensagem1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        12704,
        1584
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "a89df470-32dd-44fc-af8d-1518b0251b6f",
      "name": "1 segundo1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        13472,
        1600
      ],
      "webhookId": "656d4433-3777-4ec4-b434-5ac72f1987cd"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "8ea943d1-b6c9-4cad-9108-ca8780ccb363",
      "name": "Delete Memory1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        13392,
        1264
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('Fupper').item.json.output }}\n",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=System: # 📝 Agente Resumidor de Conversas IA\n### Especialista em Síntese Precisa de Atendimentos\n\n---\n\n## 1️⃣ OBJETIVO E MISSÃO\n\n<objetivo_principal>\n\n**VOCÊ É:** Agente Resumidor de Conversas da IA da **Universidade Cruzeiro do Sul**.\n\n**SUA MISSÃO:** Criar resumos claros e precisos das conversas entre IA e leads, extraindo **apenas informações explicitamente mencionadas**.\n\n**REGRA DE OURO:**\n- Resuma **SOMENTE** o que está explícito na conversa\n- **NUNCA invente** ou infira informações não mencionadas\n- **NUNCA adicione** interpretações ou suposições\n- Quando algo não foi discutido, indique: **\"Não especificado\"**\n\n### ⚠️ PROIBIÇÕES:\n\n```\n╔════════════════════════════════════════════╗\n║  ❌ NUNCA:                               ║\n╠════════════════════════════════════════════╣\n║  🚫 Inventar informações não mencionadas   ║\n║  🚫 Inferir intenções não explícitas       ║\n║  🚫 Fazer suposições ou interpretações     ║\n║  🚫 Exagerar nível de interesse do lead    ║\n╚════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## 2️⃣ PROCESSO OBRIGATÓRIO (4 ETAPAS)\n\n<processo>\n\n```xml\n<etapa_1_leitura>\n✅ Ler toda a conversa completa\n✅ Identificar mensagens do lead e respostas da IA\n</etapa_1_leitura>\n\n<etapa_2_extracao>\n✅ Extrair curso(s) mencionados explicitamente\n✅ Extrair dúvidas específicas\n✅ Extrair informações fornecidas (duração, modalidade, preço, etc.)\n✅ Identificar tools executadas e resultados\n</etapa_2_extracao>\n\n<etapa_3_validacao>\n✅ Verificar: toda informação tem fonte na conversa?\n✅ Verificar: não estou inferindo nada?\n</etapa_3_validacao>\n\n<etapa_4_sintese>\n✅ Organizar em estrutura clara\n✅ Incluir apenas fatos verificáveis\n</etapa_4_sintese>\n```\n\n</processo>\n\n---\n\n## 3️⃣ ESTRUTURA DE RESUMO (TEMPLATE)\n\n<estrutura_resumo>\n\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** [Nome do curso ou \"Não especificado\"]\n- **Tipo:** [Graduação/Pós-graduação ou \"Não especificado\"]\n\n### 💬 Principais Dúvidas\n- [Listar dúvidas ou \"Sem dúvidas específicas\"]\n\n### ✅ Informações Fornecidas\n- **Duração:** [info ou \"Não fornecida\"]\n- **Modalidades:** [info ou \"Não fornecidas\"]\n- **Preço:** [info ou \"Não fornecido\"]\n- **Grade Curricular:** [Enviada/Não enviada]\n- **Outros:** [listar ou \"Nenhum\"]\n\n### 🔧 Tools Executadas\n- [Tool - Resultado ou \"Não especificado\"]\n\n### 📊 Status Final\n[Em andamento / Transferido / Inscrição realizada / Sem resposta / Outro]\n\n### 🎯 Próximos Passos\n[Ações acordadas ou \"Não definidos\"]\n```\n\n**DIRETRIZES:**\n- Use **negrito** para dados importantes\n- Linguagem objetiva e profissional\n- Se não sabe, escreva \"Não especificado\"\n\n</estrutura_resumo>\n\n---\n\n## 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\n### ✅ FAZER:\n- Citar apenas informações explicitamente mencionadas\n- Indicar claramente quando algo não foi discutido\n- Manter neutralidade total\n\n### ❌ NUNCA FAZER:\n- Assumir interesse não declarado\n- Inferir próximos passos não combinados\n- Interpretar silêncios ou mensagens ambíguas\n- Supor que o lead vai fazer algo não acordado\n\n### 🔄 FALLBACKS:\n\n| Situação                        | Ação                               |\n|---------------------------------|------------------------------------|\n| Lead não mencionou curso        | \"Curso não especificado\"           |\n| Conversa interrompida           | \"Conversa incompleta\"              |\n| Tool sem resultado explícito    | \"Tool executada - resultado não detalhado\" |\n| Lead não respondeu              | \"Aguardando resposta\"              |\n\n</controle_qualidade>\n\n---\n\n## 5️⃣ EXEMPLOS PRÁTICOS\n\n<exemplos>\n\n### ✅ EXEMPLO CORRETO:\n\n**Conversa:**\n```\nLead: \"Quero saber sobre Administração\"\nIA: [rag_informacoes] \"Duração: 4 anos, EAD ou Semipresencial\"\nLead: \"Quanto custa?\"\nIA: [rag_precos] \"R$ 299,90/mês no EAD\"\nLead: \"Vou pensar\"\n```\n\n**Resumo:**\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** Administração\n- **Tipo:** Graduação\n\n### 💬 Principais Dúvidas\n- Informações gerais sobre o curso\n- Valor da mensalidade\n\n### ✅ Informações Fornecidas\n- **Duração:** 4 anos\n- **Modalidades:** EAD e Semipresencial\n- **Preço:** R$ 299,90/mês (EAD)\n- **Grade Curricular:** Não enviada\n- **Outros:** Nenhum\n\n### 🔧 Tools Executadas\n- rag_informacoes - Sucesso\n- rag_precos - Sucesso\n\n### 📊 Status Final\nEm andamento (lead vai pensar)\n\n### 🎯 Próximos Passos\nAguardando decisão do lead\n```\n\n---\n\n### ❌ EXEMPLO ERRADO:\n\n**Conversa:**\n```\nLead: \"Oi\"\nIA: \"Olá! Qual curso te interessa?\"\nLead: \"Administração\"\n[Conversa para]\n```\n\n**Resumo ERRADO:**\n```\n❌ \"Lead demonstrou forte interesse em Administração e provavelmente vai se matricular em breve\"\n```\n\n**Por que está errado:**\n- \"forte interesse\" → não há evidência\n- \"provavelmente vai se matricular\" → suposição\n\n**Resumo CORRETO:**\n```\n✅ \"Lead mencionou interesse em Administração. Conversa interrompida antes de detalhes serem fornecidos. Status: Aguardando retorno do lead\"\n```\n\n</exemplos>\n\n---\n\n## ✅ CHECKLIST RÁPIDO\n\n<checklist>\n\nAntes de finalizar, verifique:\n\n- [ ] Todas as informações estão explícitas na conversa?\n- [ ] Não fiz suposições ou inferências?\n- [ ] Status reflete exatamente o que aconteceu?\n- [ ] Usei o template padrão?\n- [ ] Indiquei \"Não especificado\" quando necessário?\n\n**TESTE FINAL:** Se alguém ler apenas meu resumo, terá visão precisa do que aconteceu?\n- ✅ SIM → Enviar\n- ❌ NÃO → Revisar\n\n</checklist>\n\n---\n\n## 🎯 PRINCÍPIO FUNDAMENTAL\n\n```\n╔════════════════════════════════════════════╗\n║                                            ║\n║  \"SE NÃO ESTÁ NA CONVERSA,                 ║\n║   NÃO ESTÁ NO RESUMO\"                      ║\n║                                            ║\n║  Precisão > Completude                     ║\n║  Fatos > Interpretações                    ║\n║  Clareza > Ambiguidade                     ║\n║                                            ║\n╚════════════════════════════════════════════╝\n```\n\n---\n\n**Tools disponíveis:** `rag_informacoes`, `rag_precos`, `distribuir_humano`, `inscricao`\n\n**Modalidades:** EAD (gravado/ao vivo) ou Semipresencial  \n**Tipos:** Graduação ou Pós-graduação\n"
            }
          ]
        }
      },
      "id": "dc300736-0578-411d-9b70-7209635675c4",
      "name": "Split de mensagens1",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        12320,
        1584
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "b482f89c-55ef-4f01-82e1-b1ea0a237f6a",
      "name": "OpenAI Split1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        12224,
        1792
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "df7ac6ab-f6ad-4d9c-8e6b-45196c5672a8",
      "name": "Modelo Output1",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        12416,
        1792
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        12096,
        1248
      ],
      "id": "31bfb7c6-7c35-4645-833f-8507d0f3654c",
      "name": "Merge7"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.output }} - {{$execution.id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        12080,
        1584
      ],
      "id": "7af56ef6-e959-4b02-8a7f-a326520d6dcf",
      "name": "Create new notes1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "440327379171310",
        "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        13216,
        1600
      ],
      "id": "c8a07f25-8726-47c7-b316-ae3aae98a2a8",
      "name": "Send message1",
      "webhookId": "a5d64814-1494-4ac8-9740-c5839767f8c8",
      "credentials": {
        "whatsAppApi": {
          "id": "uKAVEc80et1CTr0c",
          "name": "WACA CSV Comercial"
        }
      }
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 640,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11680,
        1424
      ],
      "typeVersion": 1,
      "id": "1a6f8b05-4973-4cfa-8569-d2b5ac8575ae",
      "name": "Sticky Note24"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        12416,
        1952
      ],
      "id": "e548590a-2905-4570-9a77-aef27803f07b",
      "name": "OpenAI Chat Model6",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "=## IDENTIDADE\nVocê é **Fupper**, assistente da **Universidade Cruzeiro do Sul**.\n**Tom:** Natural, acolhedor, conversacional - como um consultor humano.\n**Contexto:** Você atende leads que já demonstraram interesse anteriormente.\n\n---\n\n## 🎬 MENSAGEM INICIAL (PRIMEIRA INTERAÇÃO)\n\n### ✅ Se `{{ $json.curso }}` estiver VAZIO (null):\n```\n\"Que bom que você retornou o contato! 😊\n\nPara que eu possa te ajudar da melhor forma, me diga, qual dos nossos cursos despertou o seu interesse?\"\n```\n\n### ✅ Se `{{ $json.curso }}` tiver um CURSO:\n```\n\"Que ótimo falar com você! 😊\n\nPercebi que antes você tinha demonstrado interesse no curso **[nome do curso]**. Gostaria de saber se a sua intenção é prosseguir as informações sobre ele ou se está procurando algo diferente?\"\n```\n\n**⚠️ IMPORTANTE:** # 🎯 Orquestrador - Fupper\n\n## IDENTIDADE\nVocê é **Fupper**, assistente da **Universidade Cruzeiro do Sul**.\n**Tom:** Natural, acolhedor, conversacional - como um consultor humano.\n\n---\n\n## ⚙️ FERRAMENTAS (5 TOOLS)\n\n### 🔧 `informacoes`\n**Usar quando:** Perguntas sobre curso (duração, grade, modalidade, etc.)\n\n### 🔧 `precos`\n**Usar quando:** Perguntas sobre valores, mensalidades, formas de pagamento\n\n### 🔧 `distribuir_humano1`\n**Usar quando:**\n- Lead pede para falar com humano\n- `informacoes` retorna SEM_RESULTADO e NÃO há cursos similares para recomendar\n- **Pergunta sobre qualquer assunto que NÃO seja curso ou preço e você não sabe responder**\n- Dúvidas sobre processo, documentação, matrícula que você não consegue responder\n\n### 🔧 `inscricao1`\n**Usar quando:** Lead confirma que quer se matricular/inscrever (APENAS confirmação final)\n\n### 🔧 `perder_lead`\n**Usar quando:** `informacoes` recomendou cursos alternativos + lead recusa TODOS\n\n---\n\n## 🚨 REGRAS CRÍTICAS\n\n```\n✅ SEMPRE responda em LINGUAGEM NATURAL (NUNCA JSON)\n✅ Curso mencionado → EXECUTAR informacoes\n✅ Preço mencionado → EXECUTAR precos\n✅ \"Quero falar com atendente\" → EXECUTAR distribuir_humano1\n✅ \"Quero me matricular\" (decisão final) → EXECUTAR inscricao1\n✅ Recusou todos cursos alternativos → EXECUTAR perder_lead\n✅ **Pergunta sobre assunto que você NÃO sabe responder → EXECUTAR distribuir_humano1**\n\n❌ NUNCA mencione outras universidades\n❌ NUNCA forneça contatos (telefone/email/WhatsApp)\n❌ NUNCA invente informações\n```\n\n---\n\n## 🔄 FLUXO DE DECISÃO\n\n```\nMENSAGEM RECEBIDA\n     ↓\nApenas saudação? → Responder diretamente\n     ↓\nPede falar com humano? → distribuir_humano1\n     ↓\nConfirma matrícula final? → inscricao1\n     ↓\nRecusou todos cursos alternativos? → perder_lead\n     ↓\nMenciona PREÇO? → precos\n     ↓\nMenciona CURSO? → informacoes\n     ↓\nPergunta sobre OUTRO ASSUNTO (processo, docs, etc.)? → Tenta responder\n     ↓\nNÃO consegue responder? → distribuir_humano1\n```\n\n---\n\n## 🔧 TRATAMENTO DE RESPOSTAS\n\n### `informacoes` retorna ENCONTRADO:\n```\nApresentar info naturalmente + CTA\n```\n\n### `informacoes` retorna SEM_RESULTADO COM sugestões:\n```\n\"Não encontrei esse curso, mas temos:\n1. [Curso A]\n2. [Curso B]\n3. [Curso C]\n\nAlgum te interessa?\"\n```\n\n### `informacoes` retorna SEM_RESULTADO SEM sugestões:\n```\nEXECUTAR distribuir_humano1\n```\n\n### `precos` retorna ENCONTRADO:\n```\nApresentar valores naturalmente + CTA\n```\n\n### `precos` retorna SEM_RESULTADO:\n```\n\"Para valores específicos, vou conectar você com o atendimento!\nEnquanto isso, quer saber sobre o curso?\"\n```\n\n---\n\n## 📋 EXEMPLOS RÁPIDOS\n\n### Ex 1: Pergunta sobre curso\n**IN:** \"quanto tempo dura ADM\"\n**AÇÃO:** `informacoes(\"quanto tempo dura ADM\")`\n**OUT:** \"O curso de Administração tem [duração]! [info natural]. Quer saber mais?\"\n\n### Ex 2: Pergunta sobre preço\n**IN:** \"e o preço\"\n**AÇÃO:** `precos(\"preço administração\")`\n**OUT:** \"Os valores são: [apresentar naturalmente]. Alguma dúvida?\"\n\n### Ex 5: Pedir humano\n**IN:** \"quero falar com atendente\"\n**AÇÃO:** `distribuir_humano1()`\n\n### Ex 6: Confirmar matrícula\n**IN:** \"quero me matricular\"\n**AÇÃO:** `inscricao1()`\n\n### Ex 7: Recusar alternativas\n**IN:** \"não me interessa nenhum desses\"\n(Após informacoes ter sugerido cursos)\n**AÇÃO:** `perder_lead()`\n\n### Ex 8: Pergunta que não sabe responder\n**IN:** \"como funciona o reconhecimento de diploma estrangeiro?\"\n**ANÁLISE:** Pergunta específica fora do escopo (não é curso nem preço)\n**AÇÃO:** `distribuir_humano1()`\n**OUT:** \"Vou conectar você com um especialista que pode te ajudar com essa questão específica!\"\n\n### Ex 9: Dúvida sobre processo complexo\n**IN:** \"preciso de quais documentos para transferência externa?\"\n**ANÁLISE:** Dúvida específica sobre processo que você não domina\n**AÇÃO:** `distribuir_humano1()`\n**OUT:** \"Para te dar as informações corretas sobre documentação, vou te conectar com nosso atendimento especializado!\"\n\n---\n\n## ✅ CHECKLIST PRÉ-RESPOSTA\n\n- [ ] Resposta em linguagem NATURAL (não JSON)?\n- [ ] Executei tool correta se necessário?\n- [ ] Tom acolhedor e conversacional?\n- [ ] Máx 2 emojis?\n- [ ] Terminei com CTA?\n\n---\n\n## 🎯 RESUMO\n\n```\n🤖 VOCÊ: Fupper - Consultor Cruzeiro do Sul\n📋 FORMATO: Sempre linguagem natural\n🔧 5 TOOLS: informacoes, precos, distribuir_humano1, inscricao1, perder_lead\n⚡ REGRA: Curso = informacoes | Preço = precos | Humano = distribuir_humano1\n```\n\n**Seja natural e acolhedor como um consultor humano!** ✨"
        }
      },
      "id": "44b87c22-d882-4fa2-8959-51b2e33b3b83",
      "name": "Fupper",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        9920,
        1600
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        10144,
        2160
      ],
      "id": "dfec8d0a-5d28-4e46-b596-38515b9789cd",
      "name": "Think2"
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: 💰 Agente Preços - Consulta de Valores\nIDENTIDADE\nVocê é o Agente Preços, especialista em consultar preços de cursos da Cruzeiro do Sul Virtual.\n\nTom: Profissional, objetivo e técnico.\nFerramenta: buscar_documentos\n\nMISSÃO\nConsulte a base de dados e encaminhe TODAS as informações encontradas ao orquestrador, sem filtros ou resumos.\n\n⚠️ REGRAS CRÍTICAS\n❌ NUNCA:\n- Inventar ou aproximar preços\n- Responder sem consultar buscar_documentos\n- Filtrar ou resumir informações\n- Omitir dados retornados pela ferramenta\n\n✅ SEMPRE:\n- Use buscar_documentos antes de responder\n- Repasse TODO o conteúdo retornado\n- Execute buscas com 2-3 variações por termo\n- Informe \"sem_resultado\" caso nada seja encontrado\n\nOTIMIZAÇÃO DE BUSCA\n1. REALIZE BUSCAS MÚLTIPLAS\nPara cada consulta, busque usando 2-3 variações do termo. Exemplos:\n- RH: \"RH\", \"recursos humanos\", \"gestão recursos humanos\"\n- Marketing: \"marketing\", \"gestão marketing\"\n- Logística: \"logística\", \"gestão logística\"\n- Administração: \"administração\", \"gestão empresarial\"\n\nMAPEAMENTO COMUM\nTermo\t→ Variações\nRH\t\"recursos humanos\", \"gestão pessoas\"\nVendas\t\"comercial\", \"gestão comercial\"\nTI\t\"tecnologia\", \"sistemas\", \"gestão tecnologia\"\nFinanceiro\t\"finanças\", \"gestão financeira\"\nSaúde Pública\t\"gestão saúde\", \"saúde coletiva\"\nEd. Física\t\"esportes\", \"gestão esportiva\"\n\nFLUXO DE EXECUÇÃO\n1. Receba a solicitação do orquestrador\n2. Execute buscar_documentos (com 2-3 variações)\n3. Aguarde o retorno completo\n4. Envie todos os dados obtidos OU \"sem_resultado\"\n\nTEMPLATES DE RESPOSTA\n✅ DADOS ENCONTRADOS\nxml\n<resultado_encontrado>\n  <status>ENCONTRADO</status>\n  <dados_completos>\n    [COLE AQUI TODO O CONTEÚDO RETORNADO PELA FERRAMENTA buscar_documentos]\n  </dados_completos>\n  <buscas_realizadas>\n    - Termo 1: [termo]\n    - Termo 2: [termo]\n    - Termo 3: [termo]\n  </buscas_realizadas>\n</resultado_encontrado>\n\n❌ NADA ENCONTRADO\nxml\n<resultado_nao_encontrado>\n  <status>sem_resultado</status>\n  <buscas_realizadas>\n    - Termo 1: [termo]\n    - Termo 2: [termo]\n    - Termo 3: [termo]\n  </buscas_realizadas>\n  <mensagem>Nenhuma informação encontrada após múltiplas tentativas.</mensagem>\n</resultado_nao_encontrado>\n\nREGRAS ESPECÍFICAS\nModalidades obrigatórias:\n- Licenciaturas: APENAS Semipresencial\n- Cursos da Saúde: APENAS Semipresencial\n- Engenharias: APENAS Semipresencial\n- Pós-graduação: Taxa de matrícula R$ 99,00\n\nCURSOS TÉCNICOS\nxml\n<curso_tecnico>\n  <status>sem_resultado</status>\n  <mensagem>Não oferecemos cursos técnicos. Apenas graduação e pós-graduação.</mensagem>\n</curso_tecnico>\n\nCHECKLIST PRÉ-RESPOSTA\n- Executei 2-3 buscas com variações?\n- Repassei TODO o conteúdo da ferramenta?\n- Usei \"sem_resultado\" se nada foi encontrado?\n- Não filtrei nem resumi informações?\n- Não inventei dados?\n\nRESUMO EXECUTIVO\n🏆 FUNÇÃO: Buscar e repassar informações de preços\n🔧 FERRAMENTA: buscar_documentos\n📋 OUTPUT: Dados completos OU \"sem_resultado\"\n⚡ AÇÃO: Múltiplas buscas + repasse integral\nVocê é a ponte entre a base de dados e o orquestrador. Repasse tudo. Não filtre nada.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9312,
        2160
      ],
      "id": "5c92fdfe-2f33-4877-a736-ca39c8b38f20",
      "name": "precos"
    },
    {
      "parameters": {
        "toolDescription": "agente chamado para pesquisar sobre informacoes",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: 📚 Agente Informações Acadêmicas - Cruzeiro do Sul\n\nIDENTIDADE:\nVocê é o Agente Informações, consultor educacional especializado da Universidade Cruzeiro do Sul.\n\nTom: Consultivo, empático, entusiasta e profissional.\nFerramenta principal: buscar_informacoes\n\nMISSÃO:\nBuscar e repassar todas as informações acadêmicas encontradas ao orquestrador, sem filtros ou interpretações.\n\n🔒 REGRAS CRÍTICAS\n❌ NUNCA:\n- Inventar informações sobre cursos\n- Responder sem consultar buscar_informacoes\n- Filtrar ou resumir dados retornados\n- Mencionar preços ou valores\n- Citar outras universidades\n- Compartilhar contatos (telefone, email, WhatsApp)\n\n✅ SEMPRE:\n- Usar buscar_informacoes antes de responder\n- Repassar todo o conteúdo retornado\n- Realizar múltiplas buscas com variações\n- Informar \"sem_resultado\" se nada for encontrado\n- Sugerir 3 cursos similares quando não encontrar resultados\n\nESCOPO DE INFORMAÇÕES:\nVocê fornece informações sobre:\n⏱ Duração do curso\n📚 Modalidades (EAD Digital, EAD ao vivo, Semipresencial)\n🎓 Tipo de formação (Graduação, Pós-graduação, Tecnólogo)\n📖 Grade curricular\n🏅 Diferenciais do curso\n👨‍🏫 Metodologia de ensino\n🎯 Áreas de atuação profissional\n💼 Mercado de trabalho\n🎖 Certificações e reconhecimentos\n🚫 NÃO fornece: Preços, valores, bolsas, descontos, contatos\n\nESTRATÉGIA DE BUSCA:\n1. Execute Múltiplas Buscas:\n- Para cada consulta, busque com 2-3 variações do termo.\nEx: Pedagogia → \"pedagogia\", \"licenciatura pedagogia\";\nRH → \"recursos humanos\", \"gestão pessoas\", \"RH\".\n2. Mapeie a área do curso e busque cursos correlacionados.\n3. Observe as regras de modalidade específicas:\n- Licenciaturas, Saúde, Engenharias: APENAS Semipresencial\n- Pós-graduações: APENAS EAD (matrícula R$ 99)\n\nPROCESSO DE EXECUÇÃO:\n1. RECEBA a solicitação do orquestrador\n2. EXECUTE buscar_informacoes (2-3 variações)\n3. AGUARDE retorno completo\n4. ANALISE o resultado:\n   ├─ Encontrou? → REPASSE todos os dados\n   └─ Não encontrou? → BUSQUE cursos similares na área\n5. RETORNE resposta estruturada\n\nTEMPLATES DE RESPOSTA:\n✅ CURSO ENCONTRADO\n<resultado_encontrado>\n  <status>ENCONTRADO</status>\n  <tipo>[GRADUAÇÃO/PÓS-GRADUAÇÃO]</tipo>\n  <curso>[Nome do Curso]</curso>\n  <dados_completos> [TODO O CONTEÚDO RETORNADO] </dados_completos>\n  <buscas_realizadas>\n    - [variação 1]\n    - [variação 2]\n    - [variação 3]\n  </buscas_realizadas>\n</resultado_encontrado>\n❌ CURSO NÃO ENCONTRADO\n<resultado_nao_encontrado>\n  <status>sem_resultado</status>\n  <curso_buscado>[Nome do curso]</curso_buscado>\n  <buscas_realizadas>\n    - [variação 1]\n    - [variação 2]\n    - [variação 3]\n  </buscas_realizadas>\n  <cursos_similares>\n    <area>[Área]</area>\n    <sugestoes>\n      1. [Curso similar 1]\n      2. [Curso similar 2]\n      3. [Curso similar 3]\n    </sugestoes>\n  </cursos_similares>\n  <mensagem>Não encontramos o curso solicitado. Sugerimos cursos da área de [área].</mensagem>\n</resultado_nao_encontrado>\n🚫 PERGUNTA SOBRE PREÇOS\n<pergunta_preco>\n  <status>REDIRECIONAMENTO</status>\n  <mensagem>Informações sobre preços e valores devem ser consultadas com o setor de atendimento. Posso fornecer informações acadêmicas sobre o curso.</mensagem>\n</pergunta_preco>\n🚫 CURSO TÉCNICO\n<curso_tecnico>\n  <status>NAO_OFERECIDO</status>\n  <mensagem>Não oferecemos cursos técnicos. Apenas graduação e pós-graduação. Posso sugerir a graduação equivalente?</mensagem>\n</curso_tecnico>\n\nSUGESTÕES DE CURSOS SIMILARES:\n- Use caso não encontre após múltiplas buscas ou se obtiver \"sem_resultado\".\n- Identifique a área do curso buscado, busque cursos da mesma área com buscar_informacoes(\"cursos área [nome da área]\"), e selecione 3 cursos mais relevantes (preferencialmente mesma modalidade e conteúdo similar).\n\nREGRAS ESPECÍFICAS:\n📚 GRADUAÇÃO\n- Sempre informar duração, modalidades, tipo de formação\n- Destacar diferenciais e áreas de atuação\n- Para licenciatura e cursos da saúde: mencionar \"APENAS Semipresencial\"\n🎓 PÓS-GRADUAÇÃO\n- Modalidade: EXCLUSIVAMENTE EAD\n- Taxa de matrícula: R$ 99,00\n- Sem processo seletivo\n- Início imediato (se formado)\n🔄 CURSOS TÉCNICOS\n<resposta_padrao> Não oferecemos cursos técnicos na Cruzeiro do Sul. Trabalhamos com: Graduação (Bacharelado/Licenciatura/Tecnólogo) e Pós-graduação (MBA/Especialização). Posso sugerir a graduação equivalente? </resposta_padrao>\n\nCHECKLIST PRÉ-RESPOSTA:\n[ ] 2-3 buscas com variações\n[ ] Repassei TODO o conteúdo encontrado\n[ ] Busquei cursos similares em caso negativo\n[ ] Listei 3 sugestões de cursos da mesma área\n[ ] NÃO mencionei preços/valores\n[ ] NÃO inventei informações\n[ ] NÃO citei outras universidades\n[ ] Usei \"sem_resultado\" quando necessário\n\nMATRIZ DE SUGESTÕES POR ÁREA:\nÁrea Buscada | Sugestões Prioritárias\nVeterinária | Agronomia, Zootecnia, Gestão Ambiental\nPsicologia | Pedagogia, Serviço Social, RH\nDireito | Administração, Gestão Pública, Ciências Contábeis\nMedicina | Enfermagem, Fisioterapia, Biomedicina\nArquitetura | Engenharia Civil, Design, Gestão Ambiental\n\nRESUMO EXECUTIVO:\n🎯 FUNÇÃO: Buscar e repassar informações acadêmicas\n🔧 TOOL: buscar_informacoes\n📋 OUTPUT: Dados completos ou sugestões de cursos similares\n⚡ AÇÃO: Múltiplas buscas + repasse integral + sugestões\n🚫 NUNCA: Preços, contatos, outras universidades\n\nVocê é a ponte entre a base acadêmica e o orquestrador. Repasse tudo. Sugira alternativas quando necessário."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        10896,
        2512
      ],
      "id": "42a66fca-d65b-4beb-948b-baf412c207a4",
      "name": "informacoes"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {
          "frequencyPenalty": 0,
          "maxTokens": 512,
          "responseFormat": "text",
          "temperature": 0,
          "topP": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        9232,
        2304
      ],
      "id": "24261ccd-8148-417f-9de0-060d9bbf0509",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9216,
        2480
      ],
      "id": "3df04d1d-7fe7-4cbe-9e5e-9ea4bc291066",
      "name": "Postgres Chat Memory3",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {
          "frequencyPenalty": 0,
          "maxTokens": 800,
          "responseFormat": "text",
          "temperature": 0.3,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        10848,
        2704
      ],
      "id": "4fdeb452-c27b-438d-b800-e8fb8331f1e9",
      "name": "OpenAI Chat Model7",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        10912,
        2864
      ],
      "id": "17dc6073-0c9c-46e6-87a1-95a58a8e491b",
      "name": "Postgres Chat Memory6",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        9408,
        2496
      ],
      "id": "37395373-9d93-43c6-b31f-b176ab4fb13d",
      "name": "Calculator1"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        11024,
        2912
      ],
      "id": "aa953372-f434-4207-af54-65699c89df3d",
      "name": "Calculator2"
    },
    {
      "parameters": {
        "description": "chame essa tool para perder lead",
        "workflowId": {
          "__rl": true,
          "value": "h5DCJ6blUHWNcT2x",
          "mode": "list",
          "cachedResultUrl": "/workflow/h5DCJ6blUHWNcT2x",
          "cachedResultName": "lead perdido_ai"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9760,
        2176
      ],
      "id": "8a5ac9ef-2aa3-4700-9a47-5387414c9d38",
      "name": "perder_lead"
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents_precos",
          "mode": "list",
          "cachedResultName": "documents_precos"
        },
        "options": {
          "queryName": "match_documents_precos"
        }
      },
      "id": "d9e42008-7962-4058-86a7-b2cf5e443289",
      "name": "Supabase Vector Store",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        9664,
        3120
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "name": "documents_precos",
        "description": "Base de dados vetorial contendo valores dos cursos. ",
        "topK": 3
      },
      "id": "6d87d53d-fb03-4969-a52e-e0c5040fd3e8",
      "name": "buscar_documentos",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        9920,
        2928
      ]
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "774aec22-9c6c-473c-ac41-14f55092dc00",
      "name": "Embeddings OpenAI Vector",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        9568,
        3328
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "id": "b35b4034-e5de-46f5-bb4a-c0d374725e09",
      "name": "Supabase Vector Store2",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        11136,
        3248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0,
          "topP": 0
        }
      },
      "id": "42cc7d4e-38cf-484a-853a-3eceb6d4b6d7",
      "name": "OpenAI Chat Docs1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        11456,
        3328
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "4da13a4b-c450-4561-8d60-c7f0d32941cc",
      "name": "Embeddings OpenAI Vector1",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        10992,
        3440
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "name": "documents",
        "description": "Base de dados vetorial contendo informações sobre:\n- **CURSOS**: graduação e pós-graduação (grades, valores, durações)\n- **PROCESSOS**: matrícula, ingresso, funcionamento das modalidades, documentos\n\nTermos aceitos:\n- Cursos: \"Administração\", \"Pedagogia\", \"valor\", \"grade\"\n- Processos: \"como funciona\", \"matrícula\", \"documentos\", \"ingresso\", \"semipresencial\", \"EAD\"",
        "topK": 33
      },
      "id": "4d2c5c43-b95d-4098-b91b-047b3fc8d448",
      "name": "buscar_informacoes",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        11312,
        3024
      ]
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0,
          "topP": 0
        }
      },
      "id": "e6416645-f893-4805-9570-cf7b182f1b27",
      "name": "OpenAI Chat Docs",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        10064,
        3200
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents_precos",
          "mode": "list",
          "cachedResultName": "documents_precos"
        },
        "options": {
          "queryName": "match_documents_precos"
        }
      },
      "id": "eaa1f951-bad4-4250-985d-2ec62e16450b",
      "name": "Supabase Vector Store5",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        9472,
        368
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "name": "documents_precos",
        "description": "Base de dados vetorial contendo valores dos cursos. ",
        "topK": 6
      },
      "id": "34df6533-98c7-45cb-af8d-9b15df431382",
      "name": "buscar_documentos3",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        9536,
        96
      ]
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0,
          "topP": 0
        }
      },
      "id": "5a7da6c3-f5b7-454e-9556-c2d6d6824dfd",
      "name": "OpenAI Chat Docs4",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9760,
        464
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "e6989873-7254-4372-b7f2-095b7b8f1ad6",
      "name": "Embeddings OpenAI Vector4",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        9424,
        592
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "id": "0570b9ab-c670-4dcc-9569-50fca9238f9c",
      "name": "Supabase Vector Store3",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        10000,
        432
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "name": "documents",
        "description": "Base de dados vetorial contendo informações sobre:\n- **CURSOS**: graduação e pós-graduação (grades, valores, durações)\n- **PROCESSOS**: matrícula, ingresso, funcionamento das modalidades, documentos\n\nTermos aceitos:\n- Cursos: \"Administração\", \"Pedagogia\", \"valor\", \"grade\"\n- Processos: \"como funciona\", \"matrícula\", \"documentos\", \"ingresso\", \"semipresencial\", \"EAD\"",
        "topK": 15
      },
      "id": "947cb6d6-e3f5-4df8-913e-4d664bda6127",
      "name": "buscar_documentos1",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        10080,
        240
      ]
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {
          "temperature": 0,
          "topP": 0
        }
      },
      "id": "e9aba690-af09-42e0-9e9d-4afb0d5fe09b",
      "name": "OpenAI Chat Docs2",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        10224,
        608
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "282edeaa-1622-4c43-8c47-d337edd3a60d",
      "name": "Embeddings OpenAI Vector2",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        10016,
        640
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "chame esse agente para buscar informações",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "# Agente Informações - Cruzeiro do Sul\n\n## Identidade\nVocê é o Agente Informações, consultor educacional da Universidade Cruzeiro do Sul.\n**Tom:** Consultivo, empático e profissional.\n\n---\n\n## 🚨 REGRA PRIMÁRIA INEGOCIÁVEL\n\n**VOCÊ ESTÁ PROIBIDO DE RESPONDER SEM EXECUTAR AS FERRAMENTAS.**\n\n### Gatilhos de Execução Obrigatória:\n\nVocê DEVE executar as ferramentas quando detectar:\n- ✅ Nome de curso mencionado (explícito ou implícito)\n- ✅ Perguntas sobre duração, grade, modalidade, áreas de atuação\n- ✅ Palavras-chave: \"curso\", \"graduação\", \"pós\", \"MBA\", \"especialização\", \"tecnólogo\", \"bacharelado\", \"licenciatura\"\n- ✅ Temas educacionais: \"Psicologia\", \"Administração\", \"Engenharia\", \"Marketing\", etc.\n- ✅ Dúvidas sobre requisitos, diferenciais, mercado de trabalho\n- ✅ Respostas curtas ou ambíguas que requerem análise do histórico\n\n**Exemplos que EXIGEM busca:**\n- \"Fale sobre Psicologia\" → BUSCAR\n- \"Quanto tempo dura?\" → BUSCAR no contexto\n- \"Quero fazer um curso de gestão\" → BUSCAR \"Gestão\"\n- \"Tem graduação em TI?\" → BUSCAR \"Tecnologia da Informação\"\n- \"O que vou estudar?\" → BUSCAR curso do contexto\n- \"ead\" → ANALISAR HISTÓRICO + BUSCAR curso mencionado anteriormente\n\n---\n\n## 🧠 ANÁLISE DE CONTEXTO OBRIGATÓRIA\n\n### ANTES de qualquer resposta, você DEVE:\n\n1. **Verificar o histórico completo da conversa**\n2. **Identificar qual curso foi mencionado anteriormente**\n3. **Identificar qual modalidade foi mencionada (se houver)**\n4. **Executar as ferramentas com base no contexto identificado**\n\n### Exemplos de Análise de Contexto:\n\n**Situação 1:**\n```\nUsuário (mensagem anterior): \"gestão de rh\"\nVocê: [Apresentou informações do curso]\nUsuário (mensagem atual): \"ead\"\n\nANÁLISE OBRIGATÓRIA:\n- Curso no contexto: \"Gestão de Recursos Humanos\"\n- Modalidade solicitada: \"EAD\"\n- AÇÃO: Confirmar que o curso tem modalidade EAD e fornecer informações específicas\n```\n\n**Situação 2:**\n```\nUsuário: \"Quanto tempo dura?\"\n\nANÁLISE OBRIGATÓRIA:\n- Verificar última menção de curso no histórico\n- AÇÃO: EXECUTAR ferramentas para o curso identificado\n- Responder especificamente sobre duração\n```\n\n**Situação 3:**\n```\nUsuário: \"tem semipresencial?\"\n\nANÁLISE OBRIGATÓRIA:\n- Verificar curso no contexto\n- AÇÃO: EXECUTAR ferramentas e confirmar se há modalidade semipresencial\n- Responder: \"Sim, o curso de [Nome] está disponível na modalidade Semipresencial\" OU \"O curso de [Nome] está disponível apenas em EAD\"\n```\n\n---\n\n## ⚡ PROTOCOLO DE EXECUÇÃO AUTOMÁTICA\n\n### PASSO 1: Detectar Intenção + Analisar Contexto (0.5 segundos)\n```\nPergunta recebida\n    ↓\nÉ uma resposta curta/ambígua? (ex: \"ead\", \"sim\", \"quero saber mais\")\n    ↓\nSIM → ANALISAR HISTÓRICO COMPLETO\n    ↓\nIdentificar curso mencionado anteriormente\n    ↓\nPASSO 2 (OBRIGATÓRIO)\n    ↓\nNÃO → Contém curso/tema educacional explícito?\n    ↓\nSIM → PASSO 2 (OBRIGATÓRIO)\nNÃO → Resposta genérica (raro)\n```\n\n### PASSO 2: Execução Simultânea (SEMPRE)\n```python\n# Pseudocódigo do comportamento esperado\n\ndef processar_mensagem(mensagem_atual, historico):\n    # Primeiro, tentar extrair curso da mensagem atual\n    curso_nome = extrair_nome_completo_curso(mensagem_atual)\n    \n    # Se não encontrar, analisar histórico\n    if not curso_nome:\n        curso_nome = extrair_curso_do_historico(historico)\n    \n    # Extrair preferência de modalidade (se houver)\n    modalidade_preferida = extrair_modalidade(mensagem_atual, historico)\n    \n    if curso_nome:\n        # EXECUÇÃO PARALELA OBRIGATÓRIA\n        resultados_grad = buscar_informacoes1(curso_nome)\n        resultados_pos = docs_pos(curso_nome)\n        \n        # Fazer múltiplas tentativas automaticamente\n        if not resultados_grad:\n            resultados_grad = tentar_variações_graduacao(curso_nome)\n        \n        if not resultados_pos:\n            resultados_pos = tentar_variações_pos(curso_nome)\n        \n        return processar_resultados(\n            resultados_grad, \n            resultados_pos, \n            modalidade_preferida\n        )\n    else:\n        return resposta_generica()\n```\n\n### PASSO 3: Variações Automáticas\nPara CADA ferramenta, tente automaticamente:\n\n**Variação 1:** Nome completo exato\n- `\"Banco de Dados E Business Intelligence\"`\n\n**Variação 2:** Nome simplificado\n- `\"Banco de Dados\"`\n\n**Variação 3:** Sinônimos/termos relacionados\n- `\"Business Intelligence\"`\n\n**Variação 4:** Siglas e abreviações\n- `\"RH\"` → `\"Recursos Humanos\"`\n- `\"TI\"` → `\"Tecnologia da Informação\"`\n\n---\n\n## 🔧 Ferramentas\n\n### `buscar_informacoes1` - Base de Graduação\n- **Escopo:** Bacharelado, Licenciatura, Tecnólogo\n- **Execução:** Obrigatória para QUALQUER pergunta sobre curso\n- **Variações:** 2-3 tentativas automáticas\n\n### `docs_pos` - Base de Pós-Graduação\n- **Escopo:** Especializações, MBAs\n- **Execução:** Obrigatória SIMULTANEAMENTE com graduação\n- **Variações:** 2-3 tentativas automáticas\n\n---\n\n## 🎯 FORMATAÇÃO DA QUERY\n\n### Regra de Ouro:\n**Query = Nome COMPLETO do curso (sem adjetivos ou contexto)**\n\n### Limpeza Automática:\n```\nEntrada: \"Quero saber sobre o curso de Psicologia EAD\"\n    ↓\nLimpeza: Remove \"Quero saber sobre o\", \"curso de\", \"EAD\"\n    ↓\nQuery Final: \"Psicologia\"\n```\n\n### ⛔ NUNCA SEPARAR o nome do curso:\n- **Curso:** \"Banco de Dados E Business Intelligence\"\n  - ❌ ERRADO: Buscar \"Banco de Dados\" + \"Business Intelligence\" separadamente\n  - ✅ CORRETO: `\"Banco de Dados E Business Intelligence\"` como uma única query\n\n### Tabela de Transformação:\n\n| Entrada do Usuário | Query Limpa |\n|-------------------|-------------|\n| \"Curso de Psicologia EAD\" | `\"Psicologia\"` |\n| \"Duração de Administração?\" | `\"Administração\"` |\n| \"MBA em Marketing Digital\" | `\"Marketing Digital\"` |\n| \"Tecnólogo de Recursos Humanos\" | `\"Recursos Humanos\"` |\n| \"gestão de rh\" | `\"Gestão de Recursos Humanos\"` |\n| \"Banco de Dados E Business Intelligence\" | `\"Banco de Dados E Business Intelligence\"` |\n| \"Quero fazer Engenharia\" | `\"Engenharia\"` |\n| \"ead\" (contexto: Gestão RH) | `\"Gestão de Recursos Humanos\"` |\n\n---\n\n## 📊 MATRIZ DE DECISÃO PÓS-BUSCA\n\n### 🚫 NUNCA PERGUNTE SOBRE MODALIDADE\n\nQuando o usuário mencionar uma modalidade específica (EAD ou Semipresencial):\n- ✅ Confirme diretamente se está disponível\n- ✅ Forneça as informações completas dessa modalidade\n- ❌ NÃO pergunte \"Qual modalidade você prefere?\"\n\n### Cenário A: Encontrado APENAS em Graduação\n```\n✅ Resposta Completa:\n- Apresentar TODOS os dados retornados\n- Incluir: duração, modalidades, grade, diferenciais, mercado\n- Mencionar TODAS as modalidades disponíveis (EAD/Semipresencial)\n- Se usuário especificou modalidade, confirmar: \"Sim, [Curso] está disponível na modalidade [EAD/Semipresencial]\"\n```\n\n### Cenário B: Encontrado APENAS em Pós\n```\n✅ Resposta Completa + Requisito:\n- Apresentar TODOS os dados retornados\n- ⚠️ ADICIONAR SEMPRE: \"Para matrícula em pós-graduação é necessário ter graduação completa em qualquer área\"\n- Destacar que é especialização/MBA\n- Modalidade: Sempre EAD para pós-graduação\n```\n\n### Cenário C: Encontrado em AMBAS as bases\n```\n⚠️ Pergunta de Clarificação OBRIGATÓRIA (APENAS sobre nível, NÃO sobre modalidade):\n\n\"Encontrei [Nome do Curso] disponível como:\n\n📚 **Graduação** ([Tipo] - Modalidades: [EAD/Semipresencial])\n🎓 **Pós-Graduação** ([Tipo] - Modalidade: EAD - Requisito: graduação completa)\n\nVocê busca informações sobre a graduação ou pós-graduação?\"\n\n[AGUARDAR resposta antes de detalhar]\n\n⚠️ IMPORTANTE: Se o usuário já especificou modalidade (ex: \"ead\"), assuma automaticamente:\n- Se disse \"EAD\" → Pode ser graduação EAD ou pós\n- Se disse \"Semipresencial\" → Automaticamente é graduação\n```\n\n### Cenário D: Múltiplos cursos similares\n```\n⚠️ Listagem + Pergunta:\n\n\"Encontrei estes cursos relacionados:\n\n**Graduações:**\n1. [Curso A] - [Tipo] - Modalidades: [EAD/Semipresencial]\n2. [Curso B] - [Tipo] - Modalidades: [EAD/Semipresencial]\n\n**Pós-Graduações:**\n1. [Curso X] - [Tipo] - Modalidade: EAD (Requisito: graduação completa)\n2. [Curso Y] - [Tipo] - Modalidade: EAD (Requisito: graduação completa)\n\nQual você gostaria de conhecer?\"\n```\n\n### Cenário E: NÃO encontrado\n```\n❌ Sugestões Proativas:\n\n\"Não encontrei '[Nome Buscado]' em nosso catálogo.\n\n**Cursos de Graduação similares:**\n• [Sugestão 1] - [Tipo] - Modalidades: [EAD/Semipresencial]\n• [Sugestão 2] - [Tipo] - Modalidades: [EAD/Semipresencial]\n• [Sugestão 3] - [Tipo] - Modalidades: [EAD/Semipresencial]\n\n**Pós-Graduações relacionadas:**\n• [Sugestão A] - Modalidade: EAD (Requisito: graduação completa)\n• [Sugestão B] - Modalidade: EAD (Requisito: graduação completa)\n• [Sugestão C] - Modalidade: EAD (Requisito: graduação completa)\n\nQual você gostaria de conhecer?\"\n```\n\n---\n\n## 🎯 TRATAMENTO ESPECÍFICO DE MODALIDADES\n\n### Quando o usuário diz apenas \"ead\" ou \"semipresencial\":\n\n**FLUXO OBRIGATÓRIO:**\n\n1. **Analisar histórico** para identificar curso mencionado\n2. **Executar ferramentas** para esse curso\n3. **Confirmar disponibilidade** da modalidade solicitada\n4. **Fornecer informações completas** sem perguntar nada adicional\n\n**Exemplo Correto:**\n```\nUsuário (anterior): \"gestão de rh\"\n[Você apresenta informações]\nUsuário: \"ead\"\n\nSUA RESPOSTA:\n\"✅ Sim! O curso de Gestão de Recursos Humanos está disponível na modalidade EAD.\n\n📚 **Gestão de Recursos Humanos** - Tecnólogo\n\n**Modalidade EAD:**\n- Duração: 4 semestres (2 anos)\n- 100% online\n- Aulas disponíveis 24h no ambiente virtual\n\n**Grade Curricular:**\n[Listar disciplinas]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\"\n```\n\n**Exemplo INCORRETO (NÃO FAÇA ISSO):**\n```\n❌ \"Olá! Para te ajudar com informações sobre EAD, poderia me dizer qual curso ou área de interesse você deseja conhecer?\"\n```\n\n---\n\n## ✅ CHECKLIST AUTOMÁTICO (Mental)\n\nAntes de enviar QUALQUER resposta, verificar:\n\n- [ ] **Analisei o histórico da conversa?** (Obrigatório para respostas ambíguas)\n- [ ] **Identifiquei o curso no contexto?** (Se aplicável)\n- [ ] **Identifiquei a modalidade preferida?** (Se mencionada)\n- [ ] **Executei `buscar_informacoes1`?** (Obrigatório)\n- [ ] **Executei `docs_pos`?** (Obrigatório)\n- [ ] Fiz pelo menos 2 tentativas em cada base?\n- [ ] Mantive o nome do curso completo na query?\n- [ ] Se encontrei em ambas, perguntei qual NÍVEL (não modalidade)?\n- [ ] Se é pós, incluí o requisito de graduação?\n- [ ] Repassei TODO o conteúdo retornado (sem resumir)?\n- [ ] Não perguntei sobre modalidade quando o usuário já especificou?\n- [ ] Não mencionei valores, preços ou contatos?\n- [ ] Corrigi \"Presencial/Ao Vivo\" para as modalidades oficiais?\n\n**Se algum item = NÃO, você FALHOU. Refaça.**\n\n---\n\n## 🏢 Modalidades Oficiais\n\nA Cruzeiro do Sul oferece APENAS:\n\n1. **EAD** (Educação a Distância - 100% online)\n2. **Semipresencial** (Híbrido: aulas online + encontros presenciais)\n\n### ⚠️ Correção Automática de Nomenclatura:\nSe a base de dados retornar:\n- \"Presencial\" → Corrigir para **\"Semipresencial\"**\n- \"Ao Vivo\" → Corrigir para **\"EAD\"** ou **\"Semipresencial\"**\n- \"Híbrido\" → Corrigir para **\"Semipresencial\"**\n\n### 📋 Regras de Apresentação de Modalidades:\n\n**Para Graduação:**\n- Se tem EAD e Semipresencial → Mencionar ambas: \"Modalidades: EAD e Semipresencial\"\n- Se tem apenas EAD → \"Modalidade: EAD\"\n- Se tem apenas Semipresencial → \"Modalidade: Semipresencial\"\n\n**Para Pós-Graduação:**\n- Sempre EAD → \"Modalidade: EAD\"\n\n**Quando usuário especifica:**\n- Usuário diz \"ead\" → Confirmar: \"Sim, disponível em EAD\" + fornecer informações\n- Usuário diz \"semipresencial\" → Confirmar: \"Sim, disponível em Semipresencial\" + fornecer informações\n- Se a modalidade solicitada não existe → Informar: \"O curso de [Nome] está disponível em [modalidades existentes]\"\n\n---\n\n## 📋 Escopo de Informações\n\n### ✅ O QUE VOCÊ FORNECE:\n- Duração do curso (em semestres/meses)\n- Modalidades disponíveis (EAD/Semipresencial)\n- Tipo de formação (Bacharelado/Licenciatura/Tecnólogo/Especialização/MBA)\n- Grade curricular (disciplinas)\n- Diferenciais acadêmicos\n- Áreas de atuação profissional\n- Mercado de trabalho e perspectivas\n- Perfil do egresso\n- Requisitos de ingresso (para pós)\n\n### ❌ O QUE VOCÊ NÃO FORNECE:\n- ❌ Valores, mensalidades, preços\n- ❌ Bolsas, descontos, financiamentos\n- ❌ Formas de pagamento\n- ❌ Contatos telefônicos/WhatsApp/e-mails\n- ❌ Prazos de matrícula específicos\n- ❌ Datas de vestibular\n\n**Resposta padrão para perguntas proibidas:**\n\"Para informações sobre valores, matrícula e contato, recomendo acessar o site oficial da Cruzeiro do Sul ou falar com nossa equipe de atendimento. Posso ajudar com informações sobre a grade curricular, duração e áreas de atuação!\"\n\n---\n\n## 🤖 Fluxo de Processamento Interno\n\n```mermaid\ngraph TD\n    A[Mensagem do Usuário] --> B{É ambígua?}\n    B -->|SIM| C[ANALISAR HISTÓRICO]\n    B -->|NÃO| D{Detecta curso/tema?}\n    C --> E[Identificar curso no contexto]\n    E --> F[EXECUTAR buscar_informacoes1]\n    D -->|SIM| F\n    D -->|NÃO| Z[Resposta genérica]\n    F --> G[EXECUTAR docs_pos]\n    G --> H{Modalidade especificada?}\n    H -->|SIM| I[Confirmar disponibilidade]\n    H -->|NÃO| J{Resultados?}\n    I --> K[Fornecer info completa]\n    J -->|Só Graduação| L[Apresentar dados completos]\n    J -->|Só Pós| M[Apresentar + Requisito]\n    J -->|Ambas| N[Listar opções + Perguntar NÍVEL]\n    J -->|Múltiplos| O[Listar todos + Perguntar]\n    J -->|Nenhum| P[Sugerir similares]\n```\n\n---\n\n## 💡 Exemplos de Execução Correta\n\n### Exemplo 1: Resposta Curta com Contexto\n```\n👤 Usuário (mensagem anterior): \"gestão de rh\"\n\n🤖 Você: [Apresenta informações completas do curso]\n\n👤 Usuário (mensagem atual): \"ead\"\n\n🤖 Ação Interna:\n1. Detecta: resposta curta ambígua\n2. ANALISA HISTÓRICO: identifica \"Gestão de RH\" como curso do contexto\n3. EXECUTA: buscar_informacoes1(\"Gestão de Recursos Humanos\")\n4. EXECUTA: docs_pos(\"Gestão de Recursos Humanos\")\n5. Identifica: usuário quer modalidade EAD\n6. Confirma disponibilidade de EAD\n7. Responde: \"Sim! O curso de Gestão de Recursos Humanos está disponível na modalidade EAD. [informações completas]\"\n```\n\n### Exemplo 2: Pergunta sobre Duração\n```\n👤 Usuário (anterior): \"Quero saber sobre Administração\"\n🤖 Você: [Apresenta informações]\n👤 Usuário: \"Quanto tempo dura?\"\n\n🤖 Ação Interna:\n1. Detecta: pergunta sobre duração (contexto necessário)\n2. ANALISA HISTÓRICO: identifica \"Administração\"\n3. EXECUTA: buscar_informacoes1(\"Administração\")\n4. EXECUTA: docs_pos(\"Administração\")\n5. Localiza informação de duração nos resultados\n6. Responde: \"O curso de Administração tem duração de X semestres...\"\n```\n\n### Exemplo 3: Confirmação de Modalidade Semipresencial\n```\n👤 Usuário: \"gestão de rh\"\n🤖 Você: [Apresenta informações]\n👤 Usuário: \"tem semipresencial?\"\n\n🤖 Ação Interna:\n1. ANALISA HISTÓRICO: identifica \"Gestão de RH\"\n2. EXECUTA: buscar_informacoes1(\"Gestão de Recursos Humanos\")\n3. EXECUTA: docs_pos(\"Gestão de Recursos Humanos\")\n4. Verifica modalidades disponíveis\n5. Responde: \"Sim, o curso de Gestão de Recursos Humanos está disponível na modalidade Semipresencial. [informações completas]\"\n   OU\n   \"O curso de Gestão de Recursos Humanos está disponível na modalidade EAD. Atualmente não oferecemos modalidade Semipresencial para este curso.\"\n```\n\n---\n\n## 🎯 Templates de Resposta\n\n### Template 1: Curso Encontrado (Graduação) - Com Modalidade Especificada\n```\n✅ Sim! O curso de **[Nome do Curso]** está disponível na modalidade [EAD/Semipresencial].\n\n📚 **[Nome do Curso]** - [Tipo de Formação]\n\n**Modalidade [EAD/Semipresencial]:**\n**Duração:** [X semestres/anos]\n\n**Grade Curricular:**\n[Listar disciplinas principais]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\n\n**Mercado de Trabalho:**\n[Perspectivas e oportunidades]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 2: Curso Encontrado (Graduação) - Sem Modalidade Especificada\n```\n📚 **[Nome do Curso]** - [Tipo de Formação]\n\n**Modalidades:** [EAD/Semipresencial/EAD e Semipresencial]\n**Duração:** [X semestres/anos]\n\n**Grade Curricular:**\n[Listar disciplinas principais]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\n\n**Mercado de Trabalho:**\n[Perspectivas e oportunidades]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 3: Curso Encontrado (Pós-Graduação)\n```\n🎓 **[Nome do Curso]** - [Especialização/MBA]\n\n⚠️ **Requisito:** Graduação completa em qualquer área\n\n**Modalidade:** EAD\n**Duração:** [X meses]\n\n**Grade Curricular:**\n[Listar módulos/disciplinas]\n\n**Público-Alvo:**\n[Perfil do aluno ideal]\n\n**Objetivos:**\n[O que o curso desenvolve]\n\n**Diferenciais:**\n[Pontos fortes]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 4: Ambas as Opções (Pergunta APENAS sobre Nível)\n```\nEncontrei **[Nome do Curso]** disponível como:\n\n📚 **Graduação**\n- Tipo: [Bacharelado/Licenciatura/Tecnólogo]\n- Modalidades: [EAD/Semipresencial]\n- Duração: [X semestres]\n\n🎓 **Pós-Graduação**\n- Tipo: [Especialização/MBA]\n- Modalidade: EAD\n- Duração: [X meses]\n- ⚠️ Requisito: Graduação completa\n\nVocê busca informações sobre a graduação ou pós-graduação?\n```\n\n---\n\n## 🚫 BLOQUEIOS AUTOMÁTICOS\n\n### Você NÃO PODE:\n1. ❌ Responder sem executar as ferramentas\n2. ❌ Responder sem analisar o histórico (quando mensagem for ambígua)\n3. ❌ Perguntar \"Qual modalidade você prefere?\" quando usuário já especificou\n4. ❌ Perguntar \"Você tem interesse em EAD ou Semipresencial?\" (NUNCA pergunte isso)\n5. ❌ Assumir informações não retornadas pelas ferramentas\n6. ❌ Inventar dados (duração, grade, modalidades)\n7. ❌ Separar nome composto de curso em múltiplas buscas\n8. ❌ Mencionar modalidade \"Presencial\" (corrigir para Semipresencial)\n9. ❌ Decidir sozinho qual nível (grad/pós) o usuário quer (APENAS quando há ambas)\n10. ❌ Perguntar se a pessoa tem graduação (apenas informar requisito)\n11. ❌ Fornecer informações sobre valores ou contato\n12. ❌ Resumir ou omitir conteúdo retornado pelas ferramentas\n\n---\n\n## 🎓 Tratamento de Requisitos (Pós-Graduação)\n\nSempre que apresentar uma pós-graduação, incluir automaticamente:\n\n```\n⚠️ **Importante:** Para matrícula em pós-graduação é necessário ter graduação completa em qualquer área reconhecida pelo MEC.\n```\n\n**NUNCA pergunte:** \"Você tem graduação completa?\"\n**SEMPRE informe:** O requisito de forma neutra e informativa.\n\n---\n\n## 🔄 Ciclo de Melhoria Contínua\n\nApós cada interação, revisar mentalmente:\n\n1. ✅ Analisei o histórico para entender o contexto?\n2. ✅ Executei as ferramentas automaticamente?\n3. ✅ A query estava limpa e completa?\n4. ✅ Repassei TODO o conteúdo retornado?\n5. ✅ Corrigi nomenclaturas incorretas?\n6. ✅ Incluí requisitos quando aplicável?\n7. ✅ NÃO perguntei sobre modalidade desnecessariamente?\n8. ✅ Não inventei nada?\n9. ✅ Mantive tom consultivo e empático?\n\n---\n\n## 📌 Resumo Executivo para IA\n\n**Seu comportamento padrão:**\n```python\ndef processar_mensagem(mensagem, historico):\n    # PASSO 1: Extrair curso\n    curso = extrair_nome_completo(mensagem)\n    \n    # PASSO 2: Se não encontrar, analisar histórico\n    if not curso or mensagem_eh_ambigua(mensagem):\n        curso = extrair_curso_do_historico(historico)\n        modalidade_preferida = extrair_modalidade(mensagem, historico)\n    \n    if curso:\n        # PASSO 3: OBRIGATÓRIO - EXECUÇÃO PARALELA\n        grad = buscar_informacoes1(curso)\n        pos = docs_pos(curso)\n        \n        # PASSO 4: Tentar variações se necessário\n        if not grad:\n            grad = tentar_variações(curso, graduacao=True)\n        if not pos:\n            pos = tentar_variações(curso, pos=True)\n        \n        # PASSO 5: Processar e responder\n        if modalidade_preferida:\n            return confirmar_modalidade_e_apresentar(grad, pos, modalidade_preferida)\n        else:\n            return processar_resultados(grad, pos)\n    else:\n        return resposta_generica_sem_busca()\n```\n\n**Prioridades Absolutas:**\n1. **SEMPRE analisar histórico** para mensagens ambíguas\n2. **NUNCA perguntar sobre modalidade** quando já especificada\n3. **Executar ferramentas ANTES** de responder\n4. **Confirmar disponibilidade** quando modalidade é mencionada\n5. **Modalidades:** Apenas EAD e Semipresencial\n6. **Requisito Pós:** Sempre mencionar ao apresentar pós-graduação\n7. **Integridade:** Repassar TODO conteúdo retornado, sem omissões\n\n---\n\n## ⚡ Ativação Imediata\n\nEste prompt entra em vigor AGORA. A partir desta mensagem:\n- ✅ Toda mensagem = Análise de histórico primeiro\n- ✅ Toda menção a curso = Execução automática das ferramentas\n- ✅ Modalidade mencionada = Confirmação direta, sem perguntas\n- ✅ Zero respostas sem busca prévia\n- ✅ 100% de conformidade com as regras\n\n**Você é um agente consultivo que SEMPRE analisa o contexto e busca antes de responder.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        10224,
        -112
      ],
      "id": "a23eb9ea-5914-43fe-b970-5a2027bcb4ae",
      "name": "receptivo informacoes"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "5bef1068-bdfb-4a81-9fee-51ab13df9bcb",
      "name": "Modelo Output",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        12208,
        720
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        12240,
        896
      ],
      "id": "f1f04ad0-3d1a-4c3a-998c-9b5ddd43fe9b",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "teste_AB",
              "fieldValue": "IA"
            },
            {
              "fieldId": "id_lead",
              "fieldValue": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            }
          ]
        }
      },
      "id": "dac1134c-bbc2-4ea6-8d3b-fe0f6a0271ab",
      "name": "Atualizar Cliente",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4832,
        352
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "pause"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4224,
        496
      ],
      "id": "d945ba65-c952-490b-8c31-715a037a0fad",
      "name": "Pausar IA1",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents_pos (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -960,
        3792
      ],
      "id": "34097669-b890-4566-b5c8-eedfd054005a",
      "name": "documents_pos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE OR REPLACE FUNCTION match_documents_pos (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    documents_pos.id,\n    documents_pos.content,\n    documents_pos.metadata,\n    1 - (documents_pos.embedding <=> query_embedding) AS similarity\n  FROM documents_pos\n  WHERE documents_pos.metadata @> filter\n  ORDER BY documents_pos.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1168,
        3792
      ],
      "id": "18e65587-6863-47d5-be36-026b9f16d269",
      "name": "match_documents_pos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "delimiter": ";",
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        944,
        3440
      ],
      "id": "28420030-14d4-447b-833f-1192daeeedf3",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "# Agente Localização - Universidade Cruzeiro do Sul\n\n## Identidade\nVocê é o **Agente de Localização** da Universidade Cruzeiro do Sul.\nSua única função é processar dados de localização e encontrar o polo mais próximo do lead.\n\n---\n\n## Sua Única Ferramenta\n\n### 🔧 `localizacao`\n**Uso:** Execute esta tool com TODOS os dados de localização recebidos do orquestrador.\n\n**O que fazer:**\n1. Receba os dados de localização do orquestrador (CEP ou cidade + rua + número)\n2. Execute IMEDIATAMENTE: `localizacao(dados_recebidos)`\n3. Retorne TODAS as informações que a tool fornecer\n\n---\n\n## Regras Críticas\n\n✅ **SEMPRE:**\n- Execute a tool `localizacao` com os dados recebidos\n- Passe TODOS os dados exatamente como recebeu\n- Retorne TODAS as informações que a tool fornecer (nome do polo, endereço, distância, etc.)\n- Use linguagem natural e acolhedora na resposta\n- Seja objetivo e direto\n\n❌ **NUNCA:**\n- Invente ou estime informações de localização\n- Omita dados retornados pela tool\n- Responda sem executar a tool\n- Peça informações adicionais (isso é responsabilidade do orquestrador)\n- Modifique ou filtre os dados retornados pela tool\n\n---\n\n## Formato da Resposta\n\nApós executar a tool, apresente as informações de forma clara:\n\n**Estrutura:**\n- Nome/identificação do polo\n- Endereço completo\n- Distância (se disponível)\n- Outras informações relevantes retornadas pela tool\n\n**Tom:** Natural, objetivo e acolhedor.\n\n---\n\n## Fluxo de Trabalho\n\n1. **Recebe dados de localização** → Execute `localizacao(dados)`\n2. **Tool retorna informações** → Apresente todas as informações\n3. **Retorne ao orquestrador** → Sua tarefa está completa\n\n---\n\n## Checklist\n\n- [ ] Executei a tool `localizacao` com os dados recebidos\n- [ ] Incluí TODAS as informações retornadas pela tool\n- [ ] Usei linguagem natural e acolhedora\n- [ ] Não inventei ou omiti informações\n- [ ] Fui objetivo e direto"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9744,
        -272
      ],
      "id": "6a2923d3-4742-45aa-bd98-532b61381bfd",
      "name": "agente localizacao"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "responsesApiEnabled": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        9632,
        -160
      ],
      "id": "ebd73138-c8f2-4d31-b75d-c56eaaec2cf6",
      "name": "OpenAI Chat Model8",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9808,
        -64
      ],
      "id": "dd170487-eade-40ca-bd80-02fca8111feb",
      "name": "Postgres Chat Memory4",
      "credentials": {
        "postgres": {
          "id": "dHx7Kgm2CegjASpN",
          "name": "Sync_dcz"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents_pos",
          "mode": "list",
          "cachedResultName": "documents_pos"
        },
        "options": {
          "queryName": "match_documents_pos"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        10288,
        384
      ],
      "id": "a2ed5cf1-d438-4912-8ad3-58d3b0efd5be",
      "name": "Supabase Vector Store7",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        10400,
        576
      ],
      "id": "be3d32b5-f63a-4163-b880-7f2c57b7621a",
      "name": "Embeddings OpenAI6",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        10656,
        464
      ],
      "id": "83330f5f-aba9-4367-b37d-51c967579e24",
      "name": "OpenAI Chat Model13",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "name": "documents_pos",
        "description": "Base vetorial de CURSOS DE PÓS-GRADUAÇÃO (descrição, ementa, duração, áreas de atuação). Não contém preços.",
        "topK": 8
      },
      "id": "519d396c-cc77-46cd-830a-2c62abaf875b",
      "name": "docs_pos",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        10352,
        192
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "sKCT8MsNtjOFUQVO",
          "mode": "list",
          "cachedResultUrl": "/workflow/sKCT8MsNtjOFUQVO",
          "cachedResultName": "Localização IA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "localização": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('localiza__o', `Cidade, Rua e número  ou CEP`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "localização",
              "displayName": "localização",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9952,
        -112
      ],
      "id": "ff92f1fa-3fc1-4b4e-90ba-70b5798fa9e4",
      "name": "localizacao"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg",
          "mode": "list",
          "cachedResultName": "Cursos Categoria.csv",
          "cachedResultUrl": "https://drive.google.com/file/d/1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        752,
        3440
      ],
      "id": "c5ddc4a3-5345-4466-9cd5-398b337266f2",
      "name": "Download file1",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 60,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        1232,
        3808
      ],
      "id": "7d63d99e-ceca-40ef-a7ca-da180ba3262b",
      "name": "Recursive Character Text Splitter1"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "dados_vocacional",
          "mode": "list",
          "cachedResultName": "dados_vocacional"
        },
        "embeddingBatchSize": 125,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        1152,
        3440
      ],
      "id": "754ed5c1-56db-4960-87c2-601943490bd2",
      "name": "Supabase Vector Store4",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1024,
        3680
      ],
      "id": "eb71cc8a-33b1-4bba-b510-0f710daa9f84",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "Converter documentos em vetoriual sem preço",
        "height": 592,
        "width": 768
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        720,
        3376
      ],
      "id": "4c96c3f6-2e9e-4c83-b22b-5441b90da816",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "options": {
          "delimiter": ";",
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -16,
        3472
      ],
      "id": "322d912a-6771-4855-9ef9-3d4a4b1d25a1",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json['﻿Curso'] }} - {{ $json.Categoria }}",
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        1216,
        3648
      ],
      "id": "b11627ba-5260-4c7b-8923-7f76f563f83b",
      "name": "Default Data Loader1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Responda SOMENTE com a mensagem final para o WhatsApp.\n\nMENSAGEM DO LEAD:\n{{ $('Mensagem Completa1').item.json.mensagem_completa }}\n\nRESPOSTA BASE (NÃO ALTERAR FATOS):\n{{ $json.output }}",
        "messages": {
          "messageValues": [
            {
              "message": "Você é um consultor comercial da Cruzeiro do Sul Virtual. Você recebe a mensagem do lead e uma RESPOSTA BASE do orquestrador (com fatos corretos). Sua tarefa é reescrever em WhatsApp, claro e consultivo.  SAÍDA OBRIGATÓRIA: - Retorne APENAS a mensagem final para o lead. - NÃO escreva cabeçalhos ou meta-texto (ex.: \"Aqui está uma versão…\"). - Sem markdown, sem títulos.  REGRAS CRÍTICAS: - NÃO altere nenhum dado objetivo (preços, datas, nomes, requisitos, modalidades, endereço). - NÃO invente bolsas/descontos/condições. - Use apenas \"EAD\" e \"Semipresencial\".  ---  ## 🚫 PROIBIÇÕES ABSOLUTAS  ### VOCÊ ESTÁ PROIBIDO DE:  1. ❌ Perguntar \"Você prefere EAD ou Semipresencial?\" 2. ❌ Perguntar \"Qual modalidade você quer?\" 3. ❌ Dar escolha de modalidade ao lead 4. ❌ Terminar mensagem sem próximo passo 5. ❌ Mencionar \"condições especiais\" sem contexto 6. ❌ Mencionar \"vagas limitadas\" na primeira mensagem 7. ❌ Ser agressivo ou pressionar excessivamente 8. ❌ Usar linguagem de vendedor \"hard\"  ---  ## 🎯 TOM ADEQUADO  ### EQUILÍBRIO COMERCIAL: - **Consultivo**: Ajude o lead a encontrar o curso ideal - **Profissional**: Mantenha credibilidade e confiança - **Proativo**: Sempre sugira próximo passo, mas com naturalidade - **Amigável**: Tom de WhatsApp, mas não exagerado  ### PROGRESSÃO DE INTENSIDADE: ``` Primeiro contato → Leve e consultivo Lead demonstra interesse → Moderadamente proativo Lead pede inscrição → Direto e eficiente Lead tem objeção → Consultivo com solução ```  ---  ## 🎯 LÓGICA DE VENDAS (BALANCEADA)  ### SITUAÇÃO 1: Lead ainda não especificou curso **Exemplo:** \"oi\", \"olá\", \"boa tarde\", \"quero fazer faculdade\"  **SUA AÇÃO:** - Seja acolhedor e consultivo - Faça 1 pergunta simples - SEM mencionar urgência ou condições especiais  **TEMPLATES:** ``` \"Oi! Tudo bem? 😊 Qual curso você tem interesse em conhecer?\"  \"Olá! Posso te ajudar! Qual área você gostaria de atuar?\"  \"Oi! Fico feliz em te ajudar. Qual curso você quer saber mais?\" ```  **❌ NÃO use:** - \"Tenho ótimas condições disponíveis hoje!\" - \"Condições especiais!\" - \"Vagas limitadas\"  ---  ### SITUAÇÃO 2: Curso já identificado **Exemplo:** \"quero fazer administração\", \"me fale sobre psicologia\"  **SUA AÇÃO - ESTRUTURA:**  **PARTE 1: Informação (3-5 linhas)** - Confirme o curso - Forneça informações relevantes - Mencione modalidades de forma natural  **PARTE 2: Próximo Passo (natural e consultivo)** - Ofereça ajuda para avançar - Sugira inscrição de forma natural - Sem pressão ou urgência artificial  **TEMPLATES DE FECHAMENTO:**  **Modelo 1 - Consultivo:** ``` \"Legal! Posso te ajudar com a inscrição. Me passa seu nome completo e CPF que eu já inicio o processo pra você?\" ```  **Modelo 2 - Facilitador:** ``` \"Ótimo! Se quiser, posso já protocolar sua inscrição. Preciso apenas de nome completo e CPF.\" ```  **Modelo 3 - Direto mas gentil:** ``` \"Perfeito! Para dar andamento, preciso de seu nome completo e CPF. Pode me passar?\" ```  **Modelo 4 - Pergunta suave:** ``` \"Ficou interessado? Posso fazer sua inscrição agora. Nome completo e CPF, por favor?\" ```  ---  ### SITUAÇÃO 3: Lead pede para se inscrever **Exemplo:** \"quero me inscrever\", \"como faço a matrícula\", \"quero fazer\"  **SUA AÇÃO:** - Seja direto mas profissional - Peça dados necessários - Sem rodeios desnecessários  **TEMPLATES:** ``` \"Perfeito! Vou protocolar sua inscrição. Me passa seu nome completo e CPF, por favor.\"  \"Ótimo! Para iniciar, preciso de nome completo e CPF.\"  \"Show! Me envia nome completo e CPF que eu já processo.\" ```  ---  ### SITUAÇÃO 4: Lead demonstra objeção/dúvida **Exemplo:** \"é caro?\", \"tenho que ir presencial?\", \"quanto tempo dura?\"  **SUA AÇÃO - FÓRMULA CONSULTIVA:**  1. **Acolhimento** (1 linha) 2. **Resposta objetiva** (1-3 linhas) 3. **Próximo passo suave** (1 linha)  **EXEMPLOS:**  **Objeção: Preço** ``` \"Entendo! Os valores variam conforme forma de pagamento, mas temos opções bem flexíveis.  Posso te cadastrar para você receber todas as informações detalhadas? Preciso apenas de nome completo e CPF.\" ```  **Objeção: Tempo** ``` \"Tranquilo! O curso tem [X semestres] e é bem flexível. A maioria dos alunos consegue conciliar com trabalho normalmente.  Quer que eu faça sua inscrição? Me passa nome completo e CPF.\" ```  **Objeção: Modalidade** ``` \"Pode ficar tranquilo! O curso está disponível em EAD (100% online) e Semipresencial. Você escolhe a que melhor se encaixa na sua rotina.  Posso iniciar sua inscrição? Nome completo e CPF, por favor.\" ```  ---  ### SITUAÇÃO 5: Lead fica indeciso **Exemplo:** \"vou pensar\", \"depois eu vejo\", \"não sei ainda\"  **SUA AÇÃO - CONSULTIVO MAS PERSISTENTE:**  **TÉCNICA 1: Ofereça informação adicional** ``` \"Sem problema! Posso te enviar mais informações sobre o curso por e-mail, se preferir.   Ou, se quiser, faço um pré-cadastro sem compromisso e você recebe todos os detalhes. Qual seu nome?\" ```  **TÉCNICA 2: Remova barreira** ``` \"Tranquilo! Só pra você saber: a inscrição não te obriga a nada. É só pra você ter acesso a todas as informações e valores.  Quer que eu faça? É rápido - só preciso de nome completo e CPF.\" ```  **TÉCNICA 3: Mantenha conversa ativa** ``` \"Tudo bem! Enquanto você decide, tem alguma dúvida específica que eu possa esclarecer?\" ```  ---  ## 📋 ESTRUTURA PADRÃO DE RESPOSTA  ``` [ACOLHIMENTO/CONFIRMAÇÃO - Tom amigável] ↓ [INFORMAÇÃO OBJETIVA - 2-5 linhas] ↓ [TRANSIÇÃO NATURAL - \"Posso te ajudar\", \"Quer que eu faça\"] ↓ [PRÓXIMO PASSO - Sugestão clara mas não agressiva] ```  ---  ## ⚠️ CHECKLIST ANTES DE ENVIAR (Mental)  - [ ] Tom é consultivo, não agressivo? - [ ] Terminei com próximo passo claro? - [ ] **NÃO perguntei sobre modalidade?** (CRÍTICO) - [ ] NÃO usei \"condições especiais\" sem motivo? - [ ] NÃO criei urgência artificial na 1ª mensagem? - [ ] A mensagem tem 3-7 linhas? - [ ] Linguagem de WhatsApp natural? - [ ] Todos os dados objetivos corretos?  **Se algum item = NÃO, refaça a mensagem.**  ---  ## 💬 EXEMPLOS COMPLETOS (TOM MODERADO)  ### EXEMPLO 1: Primeira mensagem - Lead pergunta sobre curso **Resposta Base:** \"Administração é bacharelado, 8 semestres, disponível EAD e Semipresencial...\"  **SUA RESPOSTA:** ``` Oi! Administração é uma ótima escolha! 😊  O curso é bacharelado, tem 8 semestres e te prepara para atuar em gestão de empresas, planejamento estratégico e várias outras áreas. Está disponível nas modalidades EAD (100% online) e Semipresencial.  Posso te ajudar com a inscrição? Me passa seu nome completo e CPF que eu protocolo pra você. ```  ---  ### EXEMPLO 2: Lead diz apenas \"oi\" **Resposta Base:** \"Olá! Como posso ajudar?\"  **SUA RESPOSTA:** ``` Oi! Tudo bem? 😊  Qual curso você quer fazer? Posso te passar todas as informações! ```  **❌ NÃO use:** ``` \"Oi! Tudo bem? Qual curso você quer fazer? Tenho ótimas condições disponíveis hoje!\" ```  ---  ### EXEMPLO 3: Lead pergunta \"quanto custa?\" **Resposta Base:** \"Para valores, entre em contato...\"  **SUA RESPOSTA:** ``` Ótima pergunta! Os valores variam conforme a forma de pagamento e temos várias opções para facilitar.  Posso te cadastrar para você receber todas as informações de investimento? Preciso só de nome completo e CPF.  Aí você consegue avaliar tranquilamente a melhor opção pra você! 😊 ```  ---  ### EXEMPLO 4: Lead diz \"vou pensar\" **Resposta Base:** [Qualquer resposta]  **SUA RESPOSTA:** ``` Tranquilo! Entendo perfeitamente.  Se quiser, posso fazer um pré-cadastro sem compromisso. Assim você já recebe todas as informações e valores para avaliar com calma.  É rápido - só preciso de nome completo e CPF. Quer que eu faça? ```  ---  ### EXEMPLO 5: Lead quer se inscrever **Resposta Base:** [Informações sobre inscrição]  **SUA RESPOSTA:** ``` Perfeito! Vou protocolar sua inscrição.  Me passa seu nome completo e CPF que eu já dou início ao processo, ok? ```  ---  ## 🎯 PRINCÍPIOS FUNDAMENTAIS  ### SEMPRE: ✅ Seja consultivo e prestativo ✅ Forneça informações claras ✅ Sugira próximo passo de forma natural ✅ Peça nome + CPF quando apropriado ✅ Mantenha tom profissional mas amigável ✅ Remova barreiras e facilite o processo  ### NUNCA: ❌ Pergunte sobre modalidade ❌ Use pressão de vendas agressiva ❌ Mencione \"condições especiais\" sem contexto ❌ Crie urgência artificial logo de cara ❌ Seja passivo demais (sempre sugira próximo passo) ❌ Termine sem call-to-action  ---  ## 🎭 TOM PROGRESSIVO  ### 1ª Mensagem (Qualificação): **Tom:** Acolhedor, consultivo, informativo **Foco:** Entender necessidade **Evitar:** Urgência, pressão, \"condições especiais\"  ### 2ª-3ª Mensagem (Engajamento): **Tom:** Proativo, facilitador **Foco:** Fornecer informações, sugerir inscrição **Pode:** Mencionar facilidades, destacar benefícios  ### 4ª+ Mensagem ou Lead engajado: **Tom:** Mais direto, eficiente **Foco:** Fechar inscrição, pedir dados **Pode:** Criar senso de oportunidade (não urgência artificial)  ---  ## 🚫 ERROS A EVITAR  1. ❌ \"Tenho ótimas condições disponíveis hoje!\" (1ª mensagem) 2. ❌ \"Vagas limitadas!\" (sem contexto) 3. ❌ \"Você prefere EAD ou Semipresencial?\" (PROIBIDO) 4. ❌ \"Qual modalidade?\" (PROIBIDO) 5. ❌ Ser muito passivo: \"Qualquer dúvida, estou à disposição\" 6. ❌ Desistir fácil quando lead diz \"vou pensar\" 7. ❌ Mensagens muito longas (mais de 8 linhas)  ---  ## 🏆 RESUMO EXECUTIVO  ``` MENTALIDADE: Consultor que ajuda + sugere próximo passo  TOM: Profissional, consultivo, amigável, proativo (sem agressividade)  PROGRESSÃO: 1ª msg → Leve e acolhedor Lead engajado → Proativo e facilitador Lead quer inscrever → Direto e eficiente  PROIBIÇÕES CRÍTICAS: - Nunca pergunte sobre modalidade - Nunca use urgência artificial logo de cara - Nunca seja agressivo  SEMPRE TERMINE COM: - Próximo passo claro - Sugestão natural (não pressão) - Pedido de nome/CPF quando apropriado ```  ---  **ATIVAÇÃO IMEDIATA:** Você é um consultor educacional profissional que equilibra vendas com consultoria. Você ajuda, informa e facilita - sempre sugerindo o próximo passo de forma natural. Não é agressivo, mas também não é passivo. É o consultor que todo lead gostaria de ter. GO!"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        10384,
        -480
      ],
      "id": "0ceb920a-9f9f-45ce-a7b3-6895d77e315c",
      "name": "Basic LLM Chain2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        10432,
        -272
      ],
      "id": "be61852b-d28f-43e1-b91c-ea1411ed0d6d",
      "name": "OpenAI Chat Model11",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "8MZHp2mH1c8ZSKB8",
          "mode": "list",
          "cachedResultUrl": "/workflow/8MZHp2mH1c8ZSKB8",
          "cachedResultName": "resposta vocacional"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $json.telefone }}",
            "Mensagem": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
            "Tipo": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
            "id_lead": "={{ $('Buscar Cliente').item.json.id_lead }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Mensagem",
              "displayName": "Mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tipo",
              "displayName": "Tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2032,
        672
      ],
      "id": "2728d0a9-3379-42c8-af4d-4e9a791b2cdf",
      "name": "Execute Workflow"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.vocional_zap }}",
                    "rightValue": "sim",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "25f930b3-b543-4709-abbc-5c6245612d7a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "09c275d0-a3d9-41a4-a366-f21ee825cf97",
                    "leftValue": "={{ $json.vocional_zap }}",
                    "rightValue": "sim",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "VOCACIONAL"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1824,
        464
      ],
      "id": "f7832935-bde8-4b9d-8150-4d6574b837e8",
      "name": "Switch"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "auZgzrcUNe3kYzZR",
          "mode": "list",
          "cachedResultUrl": "/workflow/auZgzrcUNe3kYzZR",
          "cachedResultName": "agente inscricao"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "whatsapp": "={{ $('Code').last().json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').first().json.data._embedded.leads[0].id }}",
            "Nome": "={{ $json.Nome }}",
            "CPF": "={{ $json.CPF }}",
            "RG": "={{ $json.RG }}",
            "Nome da Mãe": "={{ $json['Nome da Mãe'] }}",
            "CEP": "={{ $json.CEP }}",
            "Data de nascimento": "={{ $json['Data de Nascimento'] }}",
            "Número da residência": "={{ $json['Número da residência'] }}",
            "email": "={{ $json['E-mail'] }}",
            "Mensagem": "={{ $('Webhook EVO').last().json.body.data.message.conversation }}",
            "id_contato": "={{ $('Edit Fields1').first().json.data._embedded.leads[0]._embedded.contacts[0].id }}",
            "tipo_mensagem": "={{ $('Webhook EVO').first().json.body.data.messageType }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "whatsapp",
              "displayName": "whatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "Nome",
              "displayName": "Nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CPF",
              "displayName": "CPF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RG",
              "displayName": "RG",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nome da Mãe",
              "displayName": "Nome da Mãe",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CEP",
              "displayName": "CEP",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Data de nascimento",
              "displayName": "Data de nascimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Número da residência",
              "displayName": "Número da residência",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Mensagem",
              "displayName": "Mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_contato",
              "displayName": "id_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tipo_mensagem",
              "displayName": "tipo_mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4720,
        688
      ],
      "id": "271ca1ba-f250-44da-aea8-e1468a366a12",
      "name": "Execute Workflow1"
    },
    {
      "parameters": {
        "jsCode": "// n8n - Code node (JavaScript)\n// Varre o JSON inteiro e extrai valores por field_id (robusto)\n\nconst SPECS = [\n  { id: 304628, outName: \"Nome\" },\n  { id: 31774,  outName: \"CPF\" },\n  { id: 693729, outName: \"Nome da Mãe\" },\n  { id: 689701, outName: \"E-mail\" },\n  { id: 693847, outName: \"RG\" },\n  { id: 689705, outName: \"CEP\" },\n  { id: 693731, outName: \"Número da residência\" },\n  { id: 693775, outName: \"Data de Nascimento\" },\n];\n\nfunction extractValueFromField(fieldObj) {\n  if (!fieldObj || !Array.isArray(fieldObj.values) || fieldObj.values.length === 0) return null;\n\n  // pega o primeiro item de values que tenha algum conteúdo útil\n  const v = fieldObj.values.find(x => x && (x.value !== undefined || x.enum_id !== undefined || x.id !== undefined))\n         || fieldObj.values[0];\n\n  return (v?.value ?? v?.enum_id ?? v?.id ?? null);\n}\n\nfunction collectCustomFieldObjects(root) {\n  const found = [];\n  const visited = new Set();\n\n  function walk(node) {\n    if (!node || typeof node !== \"object\") return;\n    if (visited.has(node)) return;\n    visited.add(node);\n\n    if (Array.isArray(node)) {\n      for (const el of node) walk(el);\n      return;\n    }\n\n    // “parece” um custom field: tem field_id e values (array)\n    if (node.field_id !== undefined && Array.isArray(node.values)) {\n      found.push(node);\n    }\n\n    for (const key of Object.keys(node)) {\n      walk(node[key]);\n    }\n  }\n\n  walk(root);\n  return found;\n}\n\n// monta um mapa field_id -> value, juntando de TODOS os items de entrada\nconst map = new Map();\n\nfor (const item of items) {\n  const fields = collectCustomFieldObjects(item.json);\n\n  for (const f of fields) {\n    const id = Number(f.field_id);\n    if (!Number.isFinite(id)) continue;\n\n    const val = extractValueFromField(f);\n    // só grava se for algo (se vier null, não sobrescreve um valor já encontrado)\n    if (val !== null && val !== undefined) {\n      map.set(id, val);\n    } else if (!map.has(id)) {\n      map.set(id, null);\n    }\n  }\n}\n\n// gera o output final\nconst out = {};\nfor (const s of SPECS) {\n  out[s.outName] = map.has(s.id) ? map.get(s.id) : null;\n}\n\n/* =========================\n   ADIÇÕES (sem remover nada)\n   - Sempre gerar Mensagem e Documento\n   - Documento vem do Analyze document quando existir\n   - Quando não existir, sai '' (vazio) para não quebrar o fluxo\n========================= */\n\nconst norm = (v) => (v === null || v === undefined) ? '' : String(v).trim();\n\nfunction pickFirstNonEmptyByPaths(obj, paths) {\n  for (const p of paths) {\n    // resolve caminho tipo \"a.b.c\"\n    const parts = p.split('.');\n    let cur = obj;\n    for (const k of parts) {\n      cur = cur?.[k];\n      if (cur === undefined || cur === null) break;\n    }\n    const s = norm(cur);\n    if (s) return s;\n  }\n  return '';\n}\n\n// Prioridades comuns de Mensagem (ajuste se o seu caminho for outro)\nconst MSG_PATHS = [\n  'Mensagem',\n  'message',\n  'body.data.message.conversation',\n  'data.message.conversation',\n  'body.data.message.text',\n  'data.message.text',\n];\n\n// Prioridades comuns de Documento\n// - Se for saída do Analyze document: content.parts[0].text\n// - Se já existir como Documento em algum ponto, também pega\nconst DOC_PATHS = [\n  'Documento',\n  'documento',\n  'content.parts.0.text',\n];\n\nlet Mensagem = '';\nlet Documento = '';\n\n// varre todos os items e pega o primeiro valor não vazio\nfor (const item of items) {\n  if (!Mensagem) Mensagem = pickFirstNonEmptyByPaths(item.json, MSG_PATHS);\n  if (!Documento) Documento = pickFirstNonEmptyByPaths(item.json, DOC_PATHS);\n}\n\n// garante que sempre exista (mesmo vazio)\nout.Mensagem = Mensagem || '';\nout.Documento = Documento || '';\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        688
      ],
      "id": "5bee1572-cbdd-4f2b-b323-cb604f251232",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "7e98e826-4198-4c6b-a355-2e378babcb15",
              "leftValue": "={{ !['imageMessage','documentMessage'].includes($('Webhook EVO').item.json.body.data.messageType) }}",
              "rightValue": "imageMessage",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4032,
        656
      ],
      "id": "7087142d-4cca-41f6-aa22-17673fe3da3e",
      "name": "If3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "948a055a-4a7a-4ec6-a011-5e5480d194eb",
              "name": "=Documento",
              "value": "={{ ($json.Documento ?? '').toString().trim() || 'SEM_DOCUMENTO' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4208,
        912
      ],
      "id": "17df52d1-a1e4-4d58-ba7b-c6ad55d9a6c7",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "inscricoes_flow",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2800,
        720
      ],
      "id": "ea4d4b7a-7152-47a4-9c7c-54ad1d39303b",
      "name": "Get a row",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "15kmAHfNkXIOccRl",
          "mode": "list",
          "cachedResultUrl": "/workflow/15kmAHfNkXIOccRl",
          "cachedResultName": "Mensagens_Acad"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "data": "={{ $json.body.data }}",
            "body": "={{ $json.body }}"
          },
          "matchingColumns": [
            "all"
          ],
          "schema": [
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body",
              "displayName": "body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        240,
        736
      ],
      "id": "25d81602-d3a7-4532-81df-1127a2c4a036",
      "name": "Execute Workflow2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE OR REPLACE FUNCTION match_cursos_salesbot_nome (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    cursos_salesbot_nome.id,\n    cursos_salesbot_nome.content,\n    cursos_salesbot_nome.metadata,\n    1 - (cursos_salesbot_nome.embedding <=> query_embedding) AS similarity\n  FROM cursos_salesbot_nome\n  WHERE cursos_salesbot_nome.metadata @> filter\n  ORDER BY cursos_salesbot_nome.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -736,
        3808
      ],
      "id": "c940e701-c993-4a33-917f-cd11b3f105a6",
      "name": "match_documents_salesbot",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "delimiter": ";",
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1008,
        4080
      ],
      "id": "42d6a5ee-223d-4679-b1bf-c41e9147d23c",
      "name": "Extract from File2"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg",
          "mode": "list",
          "cachedResultName": "Cursos Categoria.csv",
          "cachedResultUrl": "https://drive.google.com/file/d/1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        816,
        4080
      ],
      "id": "394f34f5-d64c-4672-b2f9-a79a76b9d88e",
      "name": "Download file2",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "cursos_salesbot_nome",
          "mode": "list",
          "cachedResultName": "cursos_salesbot_nome"
        },
        "embeddingBatchSize": 125,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        1216,
        4080
      ],
      "id": "09b4bdb2-d141-463c-9dfb-93d8c6443eaf",
      "name": "Supabase Vector Store6",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        1360,
        4304
      ],
      "id": "d34056f6-b322-4e69-98a3-a7a15c1f842f",
      "name": "Default Data Loader2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1184,
        4288
      ],
      "id": "5321acda-8df3-48f5-8613-3dae7679692c",
      "name": "Embeddings OpenAI2",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        1456,
        4512
      ],
      "id": "f832eb7c-a872-43d0-a190-26af9d02ef1a",
      "name": "Recursive Character Text Splitter2"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "8omLb3To9kva6LRt",
          "mode": "list",
          "cachedResultUrl": "/workflow/8omLb3To9kva6LRt",
          "cachedResultName": "Resposta ganho"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
            "Telefone": "={{ $('Webhook EVO').item.json.body.data.key.remoteJid }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Telefone",
              "displayName": "Telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4080,
        1024
      ],
      "id": "acf81571-d4e8-42de-9faa-d91205811ca9",
      "name": "Execute Workflow3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2080,
        432
      ],
      "id": "95c6e8a9-d0b2-4caa-be5c-3b3a222b4340",
      "name": "Wait2",
      "webhookId": "cad29b7a-fd5a-420f-894b-521d401ca4f7"
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "orquestrador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase": {
      "main": [
        [
          {
            "node": "Delete Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook EVO": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          },
          {
            "node": "Execute Workflow2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Converter Foto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Atendimento": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Salvar Historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotas1": {
      "main": [
        [
          {
            "node": "Pausar IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reativar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Reativar IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "imagem Redis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Audio Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "Cliente Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cliente Existe?": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Entrando ou Saindo": {
      "main": [
        [
          {
            "node": "Rotas1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "orquestrador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico": {
      "main": [
        [
          {
            "node": "Get a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens": {
      "main": [
        [
          {
            "node": "Buscas Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens": {
      "main": [
        [
          {
            "node": "Compara Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa1": {
      "main": [
        [
          {
            "node": "Deletar Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens": {
      "main": [
        [
          {
            "node": "VERIFICA INTERCAMBIO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compara Memoria": {
      "main": [
        [
          {
            "node": "Mensagem Completa1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens": {
      "main": [
        [
          {
            "node": "Split de Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Converter Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Atualizar Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ROTA Mensagens1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pausar IA1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Workflow3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Busca Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        [
          {
            "node": "Split de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "1 segundo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "orquestrador",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VERIFICA INTERCAMBIO": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge9": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Memory": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agente preços": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "orquestrador": {
      "main": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "agente preços",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "reflexao": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "agente preços",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "agente preços",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "inscricao": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Converter Foto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI5": {
      "main": [
        [
          {
            "node": "Audio Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio1": {
      "main": [
        [
          {
            "node": "OpenAI5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto1": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens1": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens1": {
      "main": [
        [
          {
            "node": "Buscas Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens1": {
      "main": [
        [
          {
            "node": "Compara Memoria1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa": {
      "main": [
        [
          {
            "node": "Deletar Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compara Memoria1": {
      "main": [
        [
          {
            "node": "Mensagem Completa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Converter Audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem1": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Texto Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "Texto Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "imagem Redis1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Fupper",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory5": {
      "ai_memory": [
        [
          {
            "node": "Fupper",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "inscricao1": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano1": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads": {
      "main": [
        [
          {
            "node": "Fupper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone1": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase1": {
      "main": [
        [
          {
            "node": "Delete Memory1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens1": {
      "main": [
        [
          {
            "node": "Split de Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split1": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output1": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Busca Telefone1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes1": {
      "main": [
        [
          {
            "node": "Split de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message1": {
      "main": [
        [
          {
            "node": "1 segundo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Modelo Output1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fupper": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Fupper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think2": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "precos": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "informacoes": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "precos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "precos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "informacoes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory6": {
      "ai_memory": [
        [
          {
            "node": "informacoes",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator1": {
      "ai_tool": [
        [
          {
            "node": "precos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator2": {
      "ai_tool": [
        [
          {
            "node": "informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "perder_lead": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "buscar_documentos",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "buscar_documentos": {
      "ai_tool": [
        [
          {
            "node": "precos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI Vector": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store2": {
      "ai_vectorStore": [
        [
          {
            "node": "buscar_informacoes",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Docs1": {
      "ai_languageModel": [
        [
          {
            "node": "buscar_informacoes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI Vector1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store2",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "buscar_informacoes": {
      "ai_tool": [
        [
          {
            "node": "informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Docs": {
      "ai_languageModel": [
        [
          {
            "node": "buscar_documentos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store5": {
      "ai_vectorStore": [
        [
          {
            "node": "buscar_documentos3",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "buscar_documentos3": {
      "ai_tool": [
        [
          {
            "node": "agente preços",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Docs4": {
      "ai_languageModel": [
        [
          {
            "node": "buscar_documentos3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI Vector4": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store5",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store3": {
      "ai_vectorStore": [
        [
          {
            "node": "buscar_documentos1",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Docs2": {
      "ai_languageModel": [
        [
          {
            "node": "buscar_documentos1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI Vector2": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store3",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "buscar_documentos1": {
      "ai_tool": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "receptivo informacoes": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Modelo Output",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Cliente": {
      "main": [
        [
          {
            "node": "ROTA Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Supabase Vector Store4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "agente localizacao",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory4": {
      "ai_memory": [
        [
          {
            "node": "agente localizacao",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "agente localizacao": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store7": {
      "ai_vectorStore": [
        [
          {
            "node": "docs_pos",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI6": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store7",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model13": {
      "ai_languageModel": [
        [
          {
            "node": "docs_pos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "docs_pos": {
      "ai_tool": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "localizacao": {
      "ai_tool": [
        [
          {
            "node": "agente localizacao",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader1",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store4",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Download file1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store4",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model11": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Execute Workflow1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File2": {
      "main": [
        [
          {
            "node": "Supabase Vector Store6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file2": {
      "main": [
        [
          {
            "node": "Extract from File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader2": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store6",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI2": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store6",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter2": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader2",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Rota Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea",
    "timezone": "America/Sao_Paulo"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "When clicking ‘Execute workflow’": [
      {
        "json": {}
      }
    ],
    "Webhook EVO": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "axios/1.13.2",
            "content-length": "969",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "93d4a78e6a59",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "comercial_cruzeiro",
            "data": {
              "key": {
                "id": "wamid.HBgNNTUxMTk0NTcyMjExNxUCABIYFDNBN0JCQjcxOTc3NzE5RkNCMTNGAA==",
                "remoteJid": "5511945722117@s.whatsapp.net",
                "fromMe": false
              },
              "pushName": "Luan",
              "message": {
                "contextInfo": {
                  "stanzaId": "wamid.HBgNNTUxMTk0NTcyMjExNxUCABEYEkEwOTY2NUNFMkU1ODAzNDExQQA="
                }
              },
              "contextInfo": {
                "stanzaId": "wamid.HBgNNTUxMTk0NTcyMjExNxUCABEYEkEwOTY2NUNFMkU1ODAzNDExQQA="
              },
              "messageType": "interactiveMessage",
              "messageTimestamp": 1769791425,
              "source": "unknown",
              "instanceId": "d8bb7bbd-90b9-443f-b41d-aebffb21477a"
            },
            "destination": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/comercial_cruzeiro",
            "date_time": "2026-01-30T13:43:47.335Z",
            "server_url": "https://outros-evolution-api.ca31ey.easypanel.host",
            "apikey": "EAAVtQLT2wukBPZBxZC9yxTZCTvbCbQZCasYZAdzEBLAgHrBPQX2PaxfR7uKMIr3ZBAbEW4RPlIYNs1ZCZCeU2YACBt3PVseU8rwm81U0P0I1Wy2RXJGFB4ZAppTTeBvmutFz8QPgPMltxZBElNFdL5hWACFzZBlZBE1OjlPDwS7EZA5ZCGb7tysIRcPQJIfAtxVAFieYtvPgZDZD"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/comercial_cruzeiro",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "1c676e1b-47a2-4518-b424-d1a14c0a81f2",
  "activeVersionId": "1c676e1b-47a2-4518-b424-d1a14c0a81f2",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-07-25T20:01:53.090Z",
      "createdAt": "2025-07-25T20:01:53.090Z",
      "role": "workflow:owner",
      "workflowId": "afID0dTfsm0vtXUX",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-30T19:28:31.000Z",
    "createdAt": "2026-01-30T19:28:29.251Z",
    "versionId": "1c676e1b-47a2-4518-b424-d1a14c0a81f2",
    "workflowId": "afID0dTfsm0vtXUX",
    "nodes": [
      {
        "parameters": {
          "options": {}
        },
        "id": "00f79506-a02c-467a-9ff3-0974e9cf02af",
        "name": "Loop Over Items3",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          12608,
          464
        ]
      },
      {
        "parameters": {
          "content": "# Splitar Mensagens",
          "height": 640,
          "width": 2396,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          10848,
          368
        ],
        "typeVersion": 1,
        "id": "c739e568-565d-4553-a87b-21ea8b5ee063",
        "name": "Sticky Note18"
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "maxTokens": 1200,
            "temperature": 0.4,
            "topP": 0.9
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          9200,
          -384
        ],
        "id": "d9367a27-bb20-4242-bad4-82b9ad866dcc",
        "name": "OpenAI Chat Model",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          12192,
          144
        ],
        "id": "072f0f59-58ca-42a3-838f-cc8aefdf3904",
        "name": "Merge1"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "defac08a-6745-422b-bb05-90da9f47d91b",
                "leftValue": "={{ $('Busca Telefone').last().json.values() }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          11696,
          128
        ],
        "id": "035f9184-36af-44bb-9f73-9a1b63889764",
        "name": "If4"
      },
      {
        "parameters": {
          "content": "# Histórico Supabase\n",
          "height": 364,
          "width": 2028,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          10832,
          0
        ],
        "typeVersion": 1,
        "id": "20730bf1-a440-4873-8731-d672945fc1ce",
        "name": "Sticky Note54"
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "chats",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          11536,
          128
        ],
        "id": "b87960ec-b936-405b-8dcc-e0b61e518df3",
        "name": "Busca Telefone",
        "alwaysOutputData": true,
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "tableId": "chats",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "phone",
                "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
              },
              {
                "fieldId": "created_at",
                "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
              },
              {
                "fieldId": "updated_at",
                "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          11920,
          48
        ],
        "id": "80d57a51-82e3-4ef8-b618-437736f18880",
        "name": "Adiciona CHAT supabase",
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "chats",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "condition": "eq",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "updated_at",
                "fieldValue": "={{ $now}}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          11904,
          192
        ],
        "id": "00c3824b-47e7-483a-a032-46e7b3786c13",
        "name": "Atualiza CHAT Supabase",
        "alwaysOutputData": true,
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "tableId": "chat_messages",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "phone",
                "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
              },
              {
                "fieldId": "bot_message",
                "fieldValue": "={{ $('Basic LLM Chain2').item.json.text }}"
              },
              {
                "fieldId": "user_message",
                "fieldValue": "={{ $('Dados').first().json.message.content }}"
              },
              {
                "fieldId": "message_type",
                "fieldValue": "={{ $('Dados').first().json.body.event }}"
              },
              {
                "fieldId": "created_at",
                "fieldValue": "={{ $now }}"
              },
              {
                "fieldId": "id_lead",
                "fieldValue": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          12400,
          144
        ],
        "id": "1b7bbcd6-871c-44a7-b44e-c11d0a5b8e74",
        "name": "Cria Histórico Supabase",
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "fieldToSplitOut": "output.messages",
          "options": {
            "destinationFieldName": "output"
          }
        },
        "id": "c52c47d3-7b80-4dd3-a1cb-acfbf1283ab9",
        "name": "Split de Mensagem",
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          12400,
          432
        ]
      },
      {
        "parameters": {
          "amount": 1
        },
        "id": "90b80d3c-ae16-44b3-af33-d377563acf54",
        "name": "1 segundo",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          13120,
          464
        ],
        "webhookId": "a2c69e1c-13fe-44a2-962c-1249288537eb"
      },
      {
        "parameters": {
          "operation": "delete",
          "key": "={{ $('Dados').first().json.Telefone }}"
        },
        "id": "5af64095-e1bc-4b70-b015-a454ea2839d6",
        "name": "Delete Memory",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          12592,
          144
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "content": "# Enfileirar Mensagens\n",
          "height": 780,
          "width": 1916,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          6960,
          96
        ],
        "typeVersion": 1,
        "id": "8c0acb8f-ff19-4a1d-a32f-fca2ae47747b",
        "name": "Sticky Note17"
      },
      {
        "parameters": {
          "content": "# BUFFERING\n",
          "height": 780,
          "width": 2516,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          4464,
          80
        ],
        "typeVersion": 1,
        "id": "1248d193-005f-4974-906d-edb9859945ec",
        "name": "Sticky Note20"
      },
      {
        "parameters": {
          "content": "# PAUSA",
          "height": 780,
          "width": 2308,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          896,
          0
        ],
        "typeVersion": 1,
        "id": "3a139bd5-534d-451e-8d74-46ae7a72bbff",
        "name": "Sticky Note26"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "comercial_cruzeiro",
          "options": {}
        },
        "id": "602d8256-7107-4d57-9d13-c62f674ee219",
        "name": "Webhook EVO",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -128,
          464
        ],
        "webhookId": "7ecd43ed-123c-4fef-b86d-f9ce39e55d64"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
                "name": "data",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "a4377234-9405-48ea-a843-e903443fe310",
        "name": "Edit Fields3",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          5840,
          544
        ]
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "dados_cliente",
          "filters": {
            "conditions": [
              {
                "keyName": "telefone",
                "condition": "eq",
                "keyValue": "={{ $json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "atendimento_ia",
                "fieldValue": "pause"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2176,
          32
        ],
        "id": "c68aa7b4-0e03-46fb-b15b-6002f8da7687",
        "name": "Pausar IA",
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.atendimento_ia }}",
                      "rightValue": "pause",
                      "operator": {
                        "type": "string",
                        "operation": "notEquals"
                      },
                      "id": "ff00573b-e517-43c6-8644-14a4fe8565d1"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "IA Ativa"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                      "leftValue": "={{ $json.atendimento_ia }}",
                      "rightValue": "=pause",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "IA pausada"
              }
            ]
          },
          "options": {}
        },
        "id": "571380e1-dc30-4174-b66d-0ec91924edc1",
        "name": "Rota Atendimento",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          2288,
          432
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                      "operator": {
                        "type": "string",
                        "operation": "notEquals"
                      },
                      "leftValue": "={{ $('Dados').item.json.message.content }}",
                      "rightValue": "Atendimento finalizado"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "IA Pausada"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Normal ou Treinamento').item.json.message.content }}",
                      "rightValue": "Atendimento finalizado"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Reativar IA"
              }
            ]
          },
          "options": {}
        },
        "id": "ed6cbfda-687e-4400-a78b-5df9d31d1452",
        "name": "Rotas1",
        "type": "n8n-nodes-base.switch",
        "position": [
          1920,
          128
        ],
        "typeVersion": 3.2
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "dados_cliente",
          "filters": {
            "conditions": [
              {
                "keyName": "telefone",
                "condition": "eq",
                "keyValue": "={{ $json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "atendimento_ia",
                "fieldValue": "reativada"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2416,
          240
        ],
        "id": "a2afec9c-ecc3-40a5-afae-0519d3693633",
        "name": "Reativar IA",
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "11800d83-ecca-4f9c-a878-a2419db0c8e9",
                "name": "=message.chat_id",
                "value": "={{ $json.telefoneCorreto }}",
                "type": "string"
              },
              {
                "id": "c33f9527-e661-49e5-8e5e-64f3b430928a",
                "name": "=message.content_type",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}",
                "type": "string"
              },
              {
                "id": "06eba1c9-cff0-4f68-b6da-6bb0092466b7",
                "name": "=message.content",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
                "type": "string"
              },
              {
                "id": "b97f1af3-5361-46fc-9303-d644921231d8",
                "name": "=message.timestamp",
                "value": "={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}",
                "type": "string"
              },
              {
                "id": "dc3dc59c-90a3-4a45-bea2-de092c91083b",
                "name": "=message.content_url",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}",
                "type": "string"
              },
              {
                "id": "8b01a818-a456-476e-bace-adefe2f04eb4",
                "name": "message.event",
                "value": "={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}",
                "type": "string"
              },
              {
                "id": "886e3751-e39b-4fc6-98d1-3113eaeebbb4",
                "name": "=body.event",
                "value": "={{ $('Webhook EVO').item.json.body.event }}",
                "type": "string"
              },
              {
                "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
                "name": "=Telefone",
                "value": "={{ $json.telefoneCorreto }}",
                "type": "string"
              },
              {
                "id": "a57db642-3e13-452e-bb5b-19f7e9f3bd5d",
                "name": "=NomeWhatsapp",
                "value": "={{ $('Webhook EVO').item.json.body.data.pushName }}",
                "type": "string"
              },
              {
                "id": "f5fcee3e-a786-404b-8b92-0163e02c6615",
                "name": "=Instance",
                "value": "={{ $('Webhook EVO').item.json.body.instance }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "776aff2e-f1c5-4975-a5f6-2d3997bc766f",
        "name": "Dados",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          528,
          480
        ]
      },
      {
        "parameters": {
          "amount": 1,
          "unit": "minutes"
        },
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          2240,
          240
        ],
        "id": "0f7cc57a-c6e3-47d3-9166-311b206ca86e",
        "name": "Wait",
        "webhookId": "b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"
      },
      {
        "parameters": {
          "content": "# Configuração Banco de Dados",
          "height": 840,
          "width": 2312,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2880,
          3232
        ],
        "typeVersion": 1,
        "id": "cafd46e4-89a3-45c4-b09c-592b6ec43954",
        "name": "Sticky Note12"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
                "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "6a3ec36a-220e-4470-a7cf-546b66422e23",
        "name": "If6",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          6848,
          592
        ]
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "gpt-4o-mini",
            "mode": "list",
            "cachedResultName": "GPT-4O-MINI"
          },
          "text": "Analise essa imagem e resuma pra mim o que ela é",
          "inputType": "base64",
          "options": {}
        },
        "id": "6bcb7bb1-06e3-4e14-8e66-7c483d362036",
        "name": "OpenAI2",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.6,
        "position": [
          6544,
          592
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "resource": "audio",
          "operation": "transcribe",
          "options": {}
        },
        "id": "682e3656-f4ce-4e90-bab7-ddc74a275834",
        "name": "OpenAI4",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.6,
        "position": [
          6656,
          416
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "dados_cliente",
          "filters": {
            "conditions": [
              {
                "keyName": "telefone",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          752,
          480
        ],
        "id": "3eb313d1-d49b-47fe-9141-a861cfc5eaa3",
        "name": "Buscar Cliente",
        "alwaysOutputData": true,
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "4a6d9aac-8565-4c58-abe3-8741393a5535",
                "leftValue": "={{ $json.telefone }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1056,
          480
        ],
        "id": "4a77a658-a49a-4d25-afe7-71e4c5a9dd00",
        "name": "Cliente Existe?",
        "retryOnFail": true
      },
      {
        "parameters": {
          "tableId": "dados_cliente",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "nomewpp",
                "fieldValue": "={{ $('Dados').item.json.NomeWhatsapp }}"
              },
              {
                "fieldId": "telefone",
                "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
              },
              {
                "fieldId": "created_at",
                "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          1280,
          576
        ],
        "id": "e9a2521c-2670-415f-a01c-4825c4644b6d",
        "name": "Criar Cliente",
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Dados').item.json.message.event }}",
                      "rightValue": "outcoming",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "7c878f9b-2c93-4061-954a-a832153e7647"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "outcoming"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "d7b42536-638f-4128-b51b-6aa913e9d9bc",
                      "leftValue": "={{ $('Dados').item.json.message.event }}",
                      "rightValue": "incoming",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "incoming"
              }
            ]
          },
          "options": {}
        },
        "id": "af5f2298-bea5-499a-863c-034a10becec6",
        "name": "ROTA Entrando ou Saindo",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          1584,
          448
        ]
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "data",
          "options": {
            "fileName": "file.ogg",
            "mimeType": "application/ogg"
          }
        },
        "id": "7b206cd0-bed3-4121-84e4-d7ee7ec22f56",
        "name": "Converter Audio",
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          6384,
          416
        ]
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "data",
          "options": {
            "fileName": "file.png",
            "mimeType": "image/png"
          }
        },
        "id": "5a436850-6711-41df-abb0-d7aa02ffbe96",
        "name": "Converter Foto",
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          6144,
          608
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "extendedTextMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "conversation",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "audioMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "8e717a3a-742c-4dd1-883a-42833cf813e9"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "audio"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "imageMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "image"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "38594d27-4ce1-4b6e-9dfc-ce5f2edca486",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "buttonMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "id": "9b24c7e1-a0d6-4ccb-9c9e-d08d553cce48",
        "name": "ROTA Mensagens",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          5456,
          352
        ]
      },
      {
        "parameters": {
          "content": "# Agente FUPPER\n",
          "height": 1228,
          "width": 1924,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          8944,
          1040
        ],
        "typeVersion": 1,
        "id": "7b005708-8712-408c-9dd4-12c6542a1961",
        "name": "Sticky Note16"
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
          "contextWindowLength": 10
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          10032,
          -400
        ],
        "id": "e91938cf-ab01-4343-b3cc-3fd7e362338a",
        "name": "Postgres Chat Memory",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "n8n_chat_histories",
            "mode": "list",
            "cachedResultName": "n8n_chat_histories"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "session_id": "={{ $('Dados').item.json.Telefone }}",
              "message": "={{ JSON.stringify({ \n      type: \"ai\",\n      content: $('Dados').item.json.message.content || '', \n      additional_kwargs: {}, \n      response_metadata: {} \n   }) }}"
            },
            "matchingColumns": [
              "id"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": false,
                "defaultMatch": true,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "session_id",
                "displayName": "session_id",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "message",
                "displayName": "message",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          2544,
          640
        ],
        "id": "9cc64a6b-4676-489a-a8ca-61e2a0b8ed7b",
        "name": "Salvar Historico",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "n8n_chat_histories",
            "mode": "list",
            "cachedResultName": "n8n_chat_histories"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "session_id": "={{ $('Dados').item.json.Telefone }}",
              "message": "={\"type\": \"human\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
            },
            "matchingColumns": [
              "id"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": false,
                "defaultMatch": true,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "session_id",
                "displayName": "session_id",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "message",
                "displayName": "message",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          2640,
          128
        ],
        "id": "db888d90-dc9d-4e8e-9d34-920428442dc3",
        "name": "Salvar Historico1",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          8912,
          608
        ],
        "id": "b698989c-6ea4-4432-982e-980928ddb7c6",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          2800,
          112
        ],
        "id": "e176a487-085f-431d-8ead-9a710cbf787d",
        "name": "No Operation, do nothing1"
      },
      {
        "parameters": {
          "amount": 15
        },
        "id": "01633671-792f-4dbc-9bd6-ad8026ea8576",
        "name": "Intervalo entre Mensagens",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          7776,
          384
        ],
        "webhookId": "9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Code').item.json.telefoneCorreto }}",
          "messageData": "={{ $('Dados').item.json.message.content }}",
          "tail": true
        },
        "id": "41c1e92f-1523-4d29-bdc5-f7ffebeab0a0",
        "name": "Texto Redis",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          6288,
          144
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $json.text }}",
          "tail": true
        },
        "id": "20357602-c607-49a4-a13a-49e6983dd24f",
        "name": "Audio Redis",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          6880,
          432
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
          "tail": true
        },
        "id": "db975a2b-d4f1-4b9b-b9ad-61d312141f9c",
        "name": "imagem Redis",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7312,
          480
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
          "tail": true
        },
        "id": "e7f58a93-e164-45f1-b716-594520b279e4",
        "name": "Imagem Redis",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7328,
          624
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "key": "={{ $('Code').item.json.telefoneCorreto }}",
          "options": {}
        },
        "id": "60cb757b-b9d3-497e-8438-a19fbf13d36f",
        "name": "Buscas Mensagens",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7952,
          384
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
                "name": "mensagem_completa",
                "value": "={{ $json.propertyName }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          8304,
          320
        ],
        "id": "3d4e3fdf-b6e8-4e0d-a0c9-39a419c6223a",
        "name": "Mensagem Completa1"
      },
      {
        "parameters": {
          "operation": "delete",
          "key": "={{ $('Code').item.json.telefoneCorreto }}"
        },
        "id": "919b688c-93df-43d8-b072-c2043af478b9",
        "name": "Deletar Mensagens",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          8448,
          304
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2800,
          3392
        ],
        "id": "cd60fdff-566d-472b-87c4-455b6fdf9adb",
        "name": "chat_messages",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "create table dados_cliente (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2400,
          3392
        ],
        "id": "df63e760-f356-4e2e-9575-e5d8415533fa",
        "name": "dados_cliente",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1776,
          3392
        ],
        "id": "b763abad-b368-4911-a822-6b8d420f6143",
        "name": "chats",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "create extension vector;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2608,
          3392
        ],
        "id": "34bc1642-0494-4f35-9fce-fc1dc64650d6",
        "name": "vetor",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "create function match_documents (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    id,\n    content,\n    metadata,\n    1 - (documents.embedding <=> query_embedding) as similarity\n  from documents\n  where metadata @> filter\n  order by documents.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2000,
          3392
        ],
        "id": "063250e4-d7bc-4e9a-a990-cdece81965bc",
        "name": "match_documents",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- Create a table to store your documents\ncreate table documents (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2208,
          3392
        ],
        "id": "df2373cf-1419-436a-9f31-b8283b710158",
        "name": "documents",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "content": "## Criação\n",
          "height": 324,
          "width": 2224,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2832,
          3312
        ],
        "typeVersion": 1,
        "id": "7f1d437e-2570-424d-b079-d2c9427e2dfa",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "## Limpeza\n",
          "height": 260,
          "width": 1616,
          "color": 7
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2832,
          3712
        ],
        "typeVersion": 1,
        "id": "dd3e5ce6-7a6b-4267-89ee-95ba1d7f43d9",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "DELETE FROM n8n_chat_histories",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2736,
          3792
        ],
        "id": "03c27b4f-e2d7-4e12-b33a-a6786c981a08",
        "name": "Deletar Histórico",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "delete from chat_messages",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1712,
          3792
        ],
        "id": "01e1effd-8827-4935-ad1d-f668206becec",
        "name": "Deletar conteúdo Chat_Messages",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "delete from dados_cliente",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2240,
          3792
        ],
        "id": "7c373d55-c3c8-4156-a2d5-8e06751402d1",
        "name": "Deletar conteúdo Dados Cliente",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "delete from chats",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -2480,
          3792
        ],
        "id": "fbf9bc82-b22a-4d4b-9891-e29e57e72f67",
        "name": "Deletar conteúdo Chats",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "delete from documents",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1968,
          3792
        ],
        "id": "9aaadc7e-a21d-439f-b0ba-c0daae26e4fc",
        "name": "Deletar conteúdo Documentos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "d5a342e9-585b-42ea-be44-644adae10199",
                "leftValue": "={{ $('Mensagem').item.json.mensagem }}",
                "rightValue": "={{ $json.propertyName?.last() }}",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "22c78d64-bd4f-4136-abb4-4a0a03ce46e9",
        "name": "Compara Memoria",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          8096,
          384
        ]
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Whatsapp message to be splitted and formatted: {{ $('Basic LLM Chain2').item.json.text }}",
          "hasOutputParser": true,
          "messages": {
            "messageValues": [
              {
                "message": "={\n  \"messages\": [\n    \"Você é um assistente que divide mensagens longas de WhatsApp em partes menores, mantendo tom natural e fluido.\",\n    \"CRÍTICO: Responda APENAS com JSON puro. Formato obrigatório: {\\\"messages\\\": [\\\"mensagem 1\\\", \\\"mensagem 2\\\"]}\",\n    \"NÃO use markdown, NÃO use ```json, NÃO adicione texto explicativo. SOMENTE o objeto JSON.\",\n    \"Use quebras de linha reais (\\\\n) dentro das strings. Nunca escape como \\\\\\\\n.\",\n    \"Cada mensagem: 250-350 caracteres. Não quebre frases no meio.\",\n    \"NÃO reescreva. NÃO expanda. NÃO adicione conteúdo. Apenas divida o texto original.\",\n    \"Máximo 4 mensagens. Prefira menos se possível.\",\n    \"NUNCA gere mensagens vazias.\",\n    \"Remova toda formatação: negrito, itálico, tachado.\",\n    \"Links https:// devem ficar entre crases: `https://exemplo.com`\",\n    \"NÃO adicione códigos, identificadores ou qualquer texto extra além das mensagens divididas.\",\n    \"A entrada virá assim: Whatsapp message to be splitted and formatted: [TEXTO]\"\n  ]\n}"
              }
            ]
          }
        },
        "id": "2ddcf8f7-ed70-4a00-bad5-96b321c0b110",
        "name": "Split de mensagens",
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.4,
        "position": [
          11904,
          416
        ]
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "7a1830f8-fca5-4b10-b824-dce7b74b344d",
        "name": "OpenAI Split",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          11872,
          624
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "content": "# INICIO\n\n",
          "height": 780,
          "width": 1040,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -176,
          32
        ],
        "typeVersion": 1,
        "id": "a2b40d9d-4e8c-4278-bf24-1ed35ff2239c",
        "name": "Sticky Note32"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
                "name": "data",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "69a59373-8ee0-4d1b-bb60-2dc4b86df588",
        "name": "Edit Fields",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6080,
          448
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
                "name": "mensagem",
                "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7600,
          352
        ],
        "id": "2fb04853-a3c8-42af-8414-60266a8c1f5d",
        "name": "Mensagem"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1.2,
        "position": [
          64,
          3696
        ],
        "id": "8e3608dd-7863-4861-b850-a13196be7760",
        "name": "Embeddings OpenAI",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $json['﻿Curso'] }} {{ $json[' Preço '] }} {{ $json.Modalidade }}",
          "textSplittingMode": "custom",
          "options": {
            "metadata": {
              "metadataValues": [
                {
                  "name": "tipo",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n\n    // Insere a vírgula que está faltando entre \"valor\" e \"grau\"\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n\n    const obj = JSON.parse(fixed);\n    return obj.tipo;\n  })()\n}}"
                },
                {
                  "name": "curso",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.curso;\n  })()\n}}"
                },
                {
                  "name": "area",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.area;\n  })()\n}}"
                },
                {
                  "name": "grau",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.grau;\n  })()\n}}"
                },
                {
                  "name": "modalidade",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.modalidade;\n  })()\n}}"
                },
                {
                  "name": "valor",
                  "value": "={{\n  (() => {\n    const raw = $json.Metadata;\n    if (!raw) return null;\n    const fixed = raw.replace(/(\"valor\":\\s*\\d+(?:\\.\\d+)?)(\\s*\"grau\")/, '$1, $2');\n    const obj = JSON.parse(fixed);\n    return obj.valor;\n  })()\n}}"
                }
              ]
            }
          }
        },
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1.1,
        "position": [
          240,
          3680
        ],
        "id": "4289d36e-aae0-46aa-ada7-cfbd8fba5b86",
        "name": "Default Data Loader"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [
          -400,
          3472
        ],
        "id": "63ff7cca-3f26-459f-ae80-4944ce93744d",
        "name": "When clicking ‘Execute workflow’"
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": {
            "__rl": true,
            "value": "1uuSFEfXVNfsG1cYDvE4OSKD7ST5ym6bK",
            "mode": "list",
            "cachedResultName": "precos_grad_IA_2601.csv",
            "cachedResultUrl": "https://drive.google.com/file/d/1uuSFEfXVNfsG1cYDvE4OSKD7ST5ym6bK/view?usp=drivesdk"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -208,
          3472
        ],
        "id": "dda4e7de-7bef-4c0b-a0db-c6493b14d55f",
        "name": "Download file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "6631e3XH0YrNrV8w",
            "name": "powerbieduit"
          }
        }
      },
      {
        "parameters": {
          "chunkSize": 512,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          256,
          3840
        ],
        "id": "28f00a23-ad47-417f-8f6b-834dde54d7c8",
        "name": "Recursive Character Text Splitter"
      },
      {
        "parameters": {
          "content": "Converte Documentos em Vetorial \n",
          "height": 580,
          "width": 996
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -416,
          3392
        ],
        "id": "b3ab877e-43a1-4c93-bc6a-11af5a0c5356",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "documents_precos",
            "mode": "list",
            "cachedResultName": "documents_precos"
          },
          "embeddingBatchSize": 135,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1.3,
        "position": [
          176,
          3472
        ],
        "id": "ab6df33b-8f15-4db6-aae4-03a160098e5b",
        "name": "Supabase Vector Store1",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 89820300,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      },
                      "id": "81bf90a7-0a29-4229-9fb3-cc04be0bfca0"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "RECEPTIVO"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "a11dec04-2f57-42bf-a6fc-2add3efe8afd",
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 89820304,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "FOLLOW UP "
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "27bccebf-da1a-4af0-8f3f-5d1d362dd733",
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 53917599,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "SALESBOT"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "08f20f5b-a9b8-49f4-a766-b2364f777b0e",
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 99045180,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "agente inscricao"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "680b674d-8f0f-407e-8656-e876d770146f",
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 48566207,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "ACEITE"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "8b0049c1-ee21-4a6c-ac95-836fc5d77877",
                      "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                      "rightValue": 74941508,
                      "operator": {
                        "type": "number",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Aguardando resposta"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra"
          }
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          3808,
          416
        ],
        "id": "1a381b09-f91c-46c7-a600-1caabe96bf6e",
        "name": "Switch1"
      },
      {
        "parameters": {
          "url": "https://admamoeduitcombr.kommo.com/api/v4/leads",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "with",
                "value": "contacts"
              },
              {
                "name": "query",
                "value": "={{ ' ' + $('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net', '') }}"
              },
              {
                "name": "filter[statuses][0][pipeline_id]",
                "value": "11685120"
              },
              {
                "name": "filter[statuses][0][status_id]",
                "value": "89820300"
              },
              {
                "name": "filter[statuses][1][pipeline_id]",
                "value": "11685120"
              },
              {
                "name": "filter[statuses][1][status_id]",
                "value": "89820304"
              },
              {
                "name": "filter[statuses][2][pipeline_id]",
                "value": "5481944"
              },
              {
                "name": "filter[statuses][2][status_id]",
                "value": "99045180"
              },
              {
                "name": "filter[statuses][3][pipeline_id]",
                "value": "5481944"
              },
              {
                "name": "filter[statuses][3][status_id]",
                "value": "48566207"
              },
              {
                "name": "filter[statuses][4][pipeline_id]",
                "value": "5481944"
              },
              {
                "name": "filter[statuses][4][status_id]",
                "value": "74941508"
              }
            ]
          },
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "accept",
                "value": "application/json"
              },
              {
                "name": "authorization",
                "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjFlMmU2MTQ1ZGIxNDliZTk0MmI1MDEwZDU5NDVmNzNiNDljOWNiNTVjZjQ5MjQyNWQ3ZTAzY2M5NWNhYWJkNmUzZDI2NDA4MzA1OGZlYWY1In0.eyJhdWQiOiI3MGFhNjUzZS04NmI5LTQ4ZjgtOTZhNy1kMjc4YzJiMTA4ZWEiLCJqdGkiOiIxZTJlNjE0NWRiMTQ5YmU5NDJiNTAxMGQ1OTQ1ZjczYjQ5YzljYjU1Y2Y0OTI0MjVkN2UwM2NjOTVjYWFiZDZlM2QyNjQwODMwNThmZWFmNSIsImlhdCI6MTc2NjE0OTIwMCwibmJmIjoxNzY2MTQ5MjAwLCJleHAiOjE4MTE4MDgwMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzAyMTQ1NjgsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJoYXNoX3V1aWQiOiJhOWIzZTRjNC01NmU0LTRhNDktYWEyYS1jMzI3ZjJiODcwZmYiLCJ1c2VyX2ZsYWdzIjowLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.bGhuPREV7xSfbw-SZissYXy22s3j86kBfQg1os2gE1WlVbU5D1-P4vwOJZ1pi3OvQTL8HG4RtnfjTmMns5CzAy7lcoixG8x4iE-DBi5zjXq6cE2HJxBmwvqbdzKc6CsDUoMBM23nXbchZkOxOu5hfN4cDvdMj7Xg7MH8H1g6Wj-rmsw3H1dtgCqOqMEGUAs4uzToXWqh5YtBi1E16B48-RlJH3Q0oxf5unkJPbBTm-GxaT_i72uk-nHri1fdS52lzDaQ60xA0CFbkm0rmWIGv_-YCeRjvLXh6EMbD908WD5zIWZ8tA4lQBLB43QToiuFcfzWb8UaxS05Gpl_h5Yf9A"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          3328,
          400
        ],
        "id": "3355c2b9-f52e-43c9-ad29-acca22c81e01",
        "name": "HTTP Request",
        "retryOnFail": false
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "f5c281d3-f206-42bd-a05a-02d2b2c427a0",
                "name": "=data",
                "value": "={{ $json.data }}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          3536,
          400
        ],
        "id": "58c07f42-e9e2-46b1-921e-4e1dde98f4c1",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "jsCode": "let telefoneRaw;\nlet telefoneCorreto;\n\n// 1. Tenta pegar do formato processado (por ex. depois de um Set)\nif ($json.Telefone) {\n  telefoneRaw = $json.Telefone;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 2. Tenta pegar do JSON bruto vindo direto do webhook\nelse if ($json.body?.data?.key?.remoteJid) {\n  telefoneRaw = $json.body.data.key.remoteJid;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 3. Caso não encontre nada, define como null\nelse {\n  telefoneCorreto = null;\n}\n\nreturn [\n  {\n    json: {\n      telefoneCorreto\n    }\n  }\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          304,
          480
        ],
        "id": "6e510c74-aad1-4540-9a79-4520edf712c0",
        "name": "Code"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          11328,
          128
        ],
        "id": "c22955d4-4321-43d0-9167-4d0633871840",
        "name": "Merge"
      },
      {
        "parameters": {
          "content": "# KOMMO\n\n",
          "height": 780,
          "width": 1236,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          3184,
          64
        ],
        "typeVersion": 1,
        "id": "d735445a-c32e-4751-9a49-1d8422c8ee12",
        "name": "Sticky Note21"
      },
      {
        "parameters": {
          "amount": 10
        },
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          3072,
          400
        ],
        "id": "aeeb12d4-c628-4931-b84e-5304103a9c59",
        "name": "Wait1",
        "webhookId": "9570c1d5-ac36-4517-8cfb-32ad769dfb8a"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          6096,
          272
        ],
        "id": "400e7a2e-bf02-4495-afd2-5036b573ce40",
        "name": "Merge2"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          5904,
          112
        ],
        "id": "ed287bc7-4b86-4304-a18b-91422e3ba8d9",
        "name": "Merge3"
      },
      {
        "parameters": {
          "resource": "notes",
          "operation": "createNotes",
          "notes": {
            "common": [
              {
                "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
                "text": "={{ $json.text }} - {{ $execution.id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-kommo.kommo",
        "typeVersion": 1,
        "position": [
          11408,
          448
        ],
        "id": "df75a852-d089-4656-a3ab-95b360a9556b",
        "name": "Create new notes",
        "credentials": {
          "kommoOAuth2Api": {
            "id": "nwQNgfBiNqLrzKlG",
            "name": "Kommo Comercial CSV"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- Create a table to store your documents\ncreate table documents_precos (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1312,
          3392
        ],
        "id": "40c98457-87a3-467c-9262-59385bd291ed",
        "name": "documents_precos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "delete from documents_precos",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1440,
          3792
        ],
        "id": "f6cfdc2a-5be1-4e4e-97b3-08d7e74e8d58",
        "name": "Deletar conteúdo documents_precos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "CREATE FUNCTION match_documents_precos (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    documents_precos.id,\n    documents_precos.content,\n    documents_precos.metadata,\n    1 - (documents_precos.embedding <=> query_embedding) as similarity\n  FROM documents_precos  -- ✅ CORRIGIDO: Agora busca na tabela certa\n  WHERE documents_precos.metadata @> filter\n  ORDER BY documents_precos.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1552,
          3392
        ],
        "id": "b135fcc5-79d5-4ce1-b525-342a7e26af93",
        "name": "match_documents_precos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "send",
          "phoneNumberId": "440327379171310",
          "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
          "textBody": "={{ $json.output }}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.whatsApp",
        "typeVersion": 1,
        "position": [
          12848,
          448
        ],
        "id": "e5ad1fd8-5bf3-4778-bd39-6b0e4f4e0d97",
        "name": "Send message",
        "webhookId": "97ad0e83-cc00-48c6-8948-06d3a14986f0",
        "credentials": {
          "whatsAppApi": {
            "id": "uKAVEc80et1CTr0c",
            "name": "WACA CSV Comercial"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- Create a table to store your documents\ncreate table rerank (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1056,
          3392
        ],
        "id": "68d8e18a-8187-444a-807f-682a4257ef91",
        "name": "rerank",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "DROP FUNCTION IF EXISTS rerank(vector, integer, jsonb);\n\nCREATE FUNCTION rerank(\n  query_embedding vector(1536),\n  match_count int DEFAULT NULL,\n  filter jsonb DEFAULT '{}'::jsonb\n)\nRETURNS TABLE (\n  id uuid,\n  content text,\n  metadata jsonb,\n  similarity double precision\n)\nLANGUAGE plpgsql\nSTABLE\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT\n    d.id,\n    d.content,\n    d.metadata,\n    1 - (d.embedding <=> query_embedding) AS similarity   -- cosine similarity\n  FROM documents_precos AS d\n  WHERE (filter IS NULL OR filter = '{}'::jsonb OR d.metadata @> filter)\n  ORDER BY d.embedding <=> query_embedding                 -- menor distância primeiro\n  LIMIT match_count;                                       -- NULL = sem limite\nEND;\n$$;\n",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -848,
          3408
        ],
        "id": "4d5cf367-83ab-44dc-bda9-a295609dd3d6",
        "name": "match_rerank",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "289b3516-051b-4605-9478-38fecd86aa17",
                "leftValue": "={{ $json.id_lead }}",
                "rightValue": "",
                "operator": {
                  "type": "number",
                  "operation": "notExists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          8816,
          288
        ],
        "id": "f9c67ba5-d701-493c-a5b3-12ee0ad18577",
        "name": "If"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          3808,
          880
        ],
        "id": "21138c3c-27bd-4a07-b00c-6fcf18f1bf5d",
        "name": "No Operation, do nothing3"
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "intercambio_bu",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "keyValue": "={{ '+'.concat($('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net','')) }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          8624,
          288
        ],
        "id": "f81f0750-eb56-440b-bfde-1c508254a474",
        "name": "VERIFICA INTERCAMBIO",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "iGh1fsnV8INZevlH",
            "name": "Supabase IA ANH/SUM"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          5840,
          704
        ],
        "id": "600048b3-8d4b-47a4-85ca-dcf177d57b3e",
        "name": "Merge9"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "942f92f3-349c-4cb2-9a0c-e94ce223017e",
                "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
                "rightValue": "Quero mais informações",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              },
              {
                "id": "7f34371a-d6ca-4701-bddf-d992722b86ba",
                "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
                "rightValue": "👨‍🎓 Quero mais informações",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          12800,
          144
        ],
        "id": "ddb74841-1a9e-43ea-bd89-e49fd68e1fad",
        "name": "If1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          13008,
          240
        ],
        "id": "125a1342-9c71-4bcd-a7cf-5d744ae93983",
        "name": "No Operation, do nothing5"
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "face-insta",
            "mode": "list",
            "cachedResultName": "face-insta"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "created_at": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            },
            "matchingColumns": [
              "id"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": false,
                "defaultMatch": true,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "created_at",
                "displayName": "created_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          13008,
          48
        ],
        "id": "746b1b21-d768-461a-8df4-bc43e6197201",
        "name": "Insert rows in a table",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "chame esse agente para procurar preços",
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "# Agente Preços - Consulta de Valores\n\n## Identidade\nEspecialista em consultar preços de cursos da Cruzeiro do Sul Virtual.\n**Tom:** Profissional e objetivo.\n**Ferramenta:** buscar_documentos3\n\n---\n\n## Query da Ferramenta\n\n### REGRA CRÍTICA:\nUse **APENAS o nome limpo do curso** na query.\n\n**❌ NÃO inclua:**\n- \"curso de\", \"graduação\", \"pós-graduação\", \"tecnólogo\", \"MBA\"\n- \"EAD\", \"semipresencial\", \"presencial\"\n- \"preço\", \"valor\", \"mensalidade\"\n- \"bacharelado\", \"licenciatura\"\n\n**✅ Exemplos corretos:**\n- Usuário: \"Quanto custa Psicologia EAD?\" → Query: `\"Psicologia\"`\n- Usuário: \"Valor de MBA em RH\" → Query: `\"Recursos Humanos\"`\n- Usuário: \"Mensalidade de Gestão de Projetos\" → Query: `\"Gestão de Projetos\"`\n\n---\n\n## Processo\n\n1. **Extrair** o nome limpo do curso\n2. **Buscar** com 2-3 variações do nome\n3. **Identificar** o nível do curso (graduação ou pós-graduação)\n4. **Coletar** todos os preços disponíveis\n5. **Enviar** resultado estruturado\n\n---\n\n## Regras por Nível\n\n### 📘 GRADUAÇÃO\n- Retorne **TODAS** as modalidades (EAD, Semipresencial)\n- Valores **EXATOS** (nunca use \"aproximadamente\")\n- **Ignore** completamente pós-graduação se existir\n\n### 📕 PÓS-GRADUAÇÃO\n- Retorne **SEMPRE 2 PREÇOS** quando disponível\n- **Preço menor** = curso de **menor duração**\n- **Preço maior** = curso de **maior duração**\n- Informe as durações correspondentes\n\n---\n\n## Regras Críticas\n\n### ❌ NUNCA:\n- Inventar ou arredondar preços\n- Responder sem usar buscar_documentos3\n- Misturar graduação com pós-graduação\n- Usar \"aproximadamente\", \"cerca de\", \"a partir de\"\n\n### ✅ SEMPRE:\n- Buscar com 2-3 variações do nome\n- Apresentar valores EXATOS\n- Informar \"sem_resultado\" se não encontrar\n- Para pós: coletar AMBOS os preços (curta e longa duração)\n\n---\n\n## Templates de Resposta\n\n### ✅ Graduação Encontrada:\n```xml\n<graduacao>\n  <curso>[Nome]</curso>\n  <modalidades>\n    <ead>\n      <mensalidade>R$ [valor exato]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </ead>\n    <semipresencial>\n      <mensalidade>R$ [valor exato]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </semipresencial>\n  </modalidades>\n</graduacao>\n```\n\n### ✅ Pós-Graduação Encontrada:\n```xml\n<pos_graduacao>\n  <curso>[Nome]</curso>\n  <opcoes>\n    <curta_duracao>\n      <duracao>[X meses]</duracao>\n      <mensalidade>R$ [valor menor]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </curta_duracao>\n    <longa_duracao>\n      <duracao>[Y meses]</duracao>\n      <mensalidade>R$ [valor maior]</mensalidade>\n      <detalhes>[informações]</detalhes>\n    </longa_duracao>\n  </opcoes>\n</pos_graduacao>\n```\n\n### ❌ Não Encontrado:\n```xml\n<sem_resultado>\n  <buscas_realizadas>\n    - [termo 1]\n    - [termo 2]\n  </buscas_realizadas>\n  <mensagem>Curso não encontrado</mensagem>\n</sem_resultado>\n```\n\n---\n\n## Checklist Antes de Enviar\n\n- [ ] Query com nome LIMPO?\n- [ ] Busquei 2-3 variações?\n- [ ] Identifiquei o nível correto?\n- [ ] Coletei TODOS os preços?\n- [ ] Pós-graduação: peguei AMBAS durações?\n- [ ] Valores EXATOS (sem \"aproximadamente\")?\n- [ ] Não inventei dados?\n\n---\n\n## Exemplos de Variações\n\n- **RH:** \"Recursos Humanos\" + \"Gestão de Recursos Humanos\"\n- **Marketing:** \"Marketing\" + \"Gestão de Marketing\"  \n- **Administração:** \"Administração\" + \"Administração de Empresas\""
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agentTool",
        "typeVersion": 2.2,
        "position": [
          9408,
          -320
        ],
        "id": "943a481b-dd91-448b-a7b8-335ed81cf4bf",
        "name": "agente preços"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "=# PROMPT DO ORQUESTRADOR\n\nVocê é um orquestrador inteligente de atendimento educacional. Sua função é analisar mensagens, decidir qual ferramenta usar e fornecer contexto completo aos agentes DE FORMA INTERNA.\n\n## ⚠️ REGRA CRÍTICA: CONTEXTO É INTERNO\n\n**NUNCA exponha o contexto interno ao cliente. O contexto serve apenas para:**\n- Você entender a situação completa\n- Passar informações relevantes aos agentes via parâmetros das tools\n- Tomar decisões inteligentes\n\n**O cliente NUNCA deve ver:**\n- ❌ \"CONTEXTO DA CONVERSA:\"\n- ❌ \"Curso mencionado: [nome]\"\n- ❌ \"Informações do lead: [dados]\"\n- ❌ \"Histórico relevante: [resumo]\"\n\n---\n\n## REGRAS DE ANÁLISE DE CONTEXTO (USO INTERNO)\n\n### 1. SEMPRE ANALISE O HISTÓRICO COMPLETO (INTERNAMENTE)\nAntes de executar qualquer tool, você DEVE (internamente):\n- ✅ Verificar TODO o histórico da conversa\n- ✅ Identificar qual curso foi mencionado anteriormente\n- ✅ Capturar informações já fornecidas pelo lead (nome, cidade, CEP, etc.)\n- ✅ Entender o contexto completo da solicitação\n\n### 2. USE O CONTEXTO PARA TOMAR DECISÕES\n- Use o histórico para entender o que o lead quer\n- Identifique informações já fornecidas para não pedir novamente\n- Tome decisões inteligentes baseadas no contexto completo\n\n### 3. PASSE INFORMAÇÕES DIRETAMENTE AOS AGENTES\nAo chamar uma tool, construa uma mensagem completa e natural que inclua as informações necessárias de forma direta.\n\n---\n\n## FERRAMENTAS (5 Tools)\n\n### 🔧 `receptivo_informacoes`\n**Quando usar:** Perguntas sobre cursos (duração, grade, modalidade, matérias, etc.)\n\n**Como usar:**\n- SEMPRE execute esta tool para qualquer pergunta sobre cursos\n- NUNCA responda sobre cursos sem executá-la\n- Construa uma mensagem clara especificando o curso se ele já foi mencionado\n\n---\n\n### 🔧 `agente_precos`\n**Quando usar:** Perguntas sobre valores, mensalidades, preços, taxas, bolsas ou descontos.\n\n**Processo de decisão INTERNO:**\n1. Verificar o histórico: qual curso o lead mencionou?\n2. Se NÃO houver curso mencionado: pergunte ao lead\n3. Se HOUVER curso no histórico: construa a chamada incluindo o nome do curso\n\n**Regras de apresentação:**\n- SEMPRE execute esta tool para qualquer pergunta sobre preços\n- NUNCA invente, estime ou arredonde valores\n- Use EXATAMENTE os valores retornados pela tool\n- Se a tool retornar múltiplas modalidades (EAD, Semipresencial), apresente TODAS as opções\n- Apresente cada modalidade com seu respectivo valor\n- Ao mencionar EAD, use apenas \"EAD\" sem adicionar \"100% online\" ou similares\n\n---\n\n### 🔧 `agente_localizacao`\n**Quando usar:** \n\n**EXECUTAR IMEDIATAMENTE quando a mensagem contém:**\n1. **CEP** - 8 dígitos com ou sem hífen (ex: 01310-100 ou 01310100)\n2. **Nome de cidade** (ex: São Paulo, Campinas, Curitiba)\n3. **Nome de bairro** (ex: Centro, Vila Mariana)\n4. **Endereço** (ex: Rua XV de Novembro, Av. Paulista)\n5. **Pergunta sobre localização de polo ou unidade**\n\n**🚨 REGRA ABSOLUTA:**\n- Se detectar CEP ou localização na mensagem → EXECUTAR `agente_localizacao` AUTOMATICAMENTE\n- Não pergunte nada, apenas execute a tool com a informação fornecida\n- Se não houver CEP/localização E o lead perguntou sobre polo → Pergunte o CEP ou endereço\n\n**Como chamar:**\n- \"Localizar polo mais próximo do CEP [CEP]\"\n- \"Localizar polo mais próximo de [cidade/bairro/endereço]\"\n\n---\n\n### 🔧 `distribuir_humano`\n**Quando usar:**\n- Lead pede para falar com atendente humano\n- `receptivo_informacoes` não encontra o curso e não há sugestões\n- Pergunta sobre assunto que você não sabe responder\n- Mensagem confusa ou incompreensível após 2 tentativas de esclarecimento\n- Dúvidas complexas sobre documentação ou processos\n\n---\n\n### 🔧 `inscricao`\n**Quando usar:** Lead confirma que quer se matricular (apenas na confirmação final)\n\n**Processo INTERNO:**\n1. Verificar se você tem: curso, modalidade, polo\n2. Se falta algo, pergunte ao lead\n3. Se tem tudo, execute a tool\n\n**⚠️ OBRIGATÓRIO:** \n- Só execute após o lead confirmar explicitamente o interesse em se matricular\n\n---\n\n## FLUXO DE DECISÃO INTERNO\n\n### ANÁLISE PRIORITÁRIA A CADA MENSAGEM:\n\n**1. PRIMEIRA VERIFICAÇÃO (PRIORIDADE MÁXIMA):**\n- [ ] A mensagem contém CEP (8 dígitos)?\n- [ ] A mensagem contém nome de cidade?\n- [ ] A mensagem contém endereço/bairro?\n- **SE SIM → EXECUTAR `agente_localizacao` IMEDIATAMENTE**\n\n**2. SEGUNDA VERIFICAÇÃO:**\n- [ ] Pergunta sobre curso? → `receptivo_informacoes`\n- [ ] Pergunta sobre preço? → `agente_precos`\n- [ ] Quer se matricular? → `inscricao`\n- [ ] Quer atendente humano? → `distribuir_humano`\n\n---\n\n## VERIFICAÇÃO ANTES DE AGIR\n\nAntes de qualquer ação, pergunte-se (INTERNAMENTE):\n\n1. ✅ **A mensagem contém CEP ou localização?** (VERIFICAR PRIMEIRO)\n2. ✅ Analisei o histórico?\n3. ✅ Sei qual curso o lead está falando (se relevante)?\n4. ✅ Tenho os dados necessários para executar a tool?\n5. ✅ Vou expor contexto interno ao cliente? (DEVE SER NÃO!)\n\n---\n\n## TOM DE COMUNICAÇÃO COM O CLIENTE\n\n- 🎯 Profissional e acolhedor\n- 💬 Linguagem clara e acessível\n- ⚡ Respostas diretas e objetivas\n- 🤝 Empático e prestativo\n- 🚫 Nunca use tom robótico\n- 🚫 Nunca exponha sua análise interna\n- ✅ Seja natural e conversacional\n\n---\n\n## RESUMO: O QUE O CLIENTE VÊ vs O QUE É INTERNO\n\n### ❌ Cliente NUNCA vê:\n- Sua análise do histórico\n- \"CONTEXTO DA CONVERSA\"\n- \"Informações identificadas\"\n- Seus processos de decisão\n- Referências ao orquestrador ou agentes\n\n### ✅ Cliente vê apenas:\n- Respostas naturais e diretas\n- Perguntas quando você precisa de mais informações\n- Resultados das consultas aos agentes\n- Comunicação fluida e profissional\n\n---\n\n## IMPORTANTE: DETECÇÃO AUTOMÁTICA DE LOCALIZAÇÃO\n\n**A detecção de CEP e localização tem PRIORIDADE ABSOLUTA sobre todas as outras análises.**\n\nSe a mensagem do lead contém qualquer informação de localização (CEP, cidade, bairro, endereço), você DEVE executar `agente_localizacao` imediatamente, sem perguntar nada ao lead."
          }
        },
        "id": "33b8ada0-2ca4-4530-a7a6-fa5869e11216",
        "name": "orquestrador",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          9664,
          -640
        ]
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolCalculator",
        "typeVersion": 1,
        "position": [
          9440,
          32
        ],
        "id": "67918d65-084b-4f79-a504-f71cd6e52d68",
        "name": "Calculator"
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolThink",
        "typeVersion": 1.1,
        "position": [
          10576,
          64
        ],
        "id": "88916fab-40b9-4573-87c0-84192a2fd89e",
        "name": "Think"
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolThink",
        "typeVersion": 1.1,
        "position": [
          9808,
          -416
        ],
        "id": "fb0708b5-1bec-4574-91fa-25702b5101dd",
        "name": "reflexao"
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "maxTokens": 600,
            "temperature": 0,
            "topP": 0
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          9296,
          -32
        ],
        "id": "ae40995a-bbf6-4ba0-8436-f244e22a2046",
        "name": "OpenAI Chat Model2",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "maxTokens": 1200,
            "temperature": 0.4,
            "topP": 0.9
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          9936,
          192
        ],
        "id": "cc447526-f61c-459e-86f8-eb3cd9bafd03",
        "name": "OpenAI Chat Model3",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
          "contextWindowLength": 6
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          9360,
          96
        ],
        "id": "462c96d8-14f1-4492-b46c-c63b5c59b3f2",
        "name": "Postgres Chat Memory1",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
          "contextWindowLength": 6
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          10080,
          144
        ],
        "id": "80c8ec31-f990-4703-b9ab-fc6a8cac0662",
        "name": "Postgres Chat Memory2",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "description": "use essa tool para enviar o template de inscricao do whatsapp ",
          "workflowId": {
            "__rl": true,
            "value": "FgPYiDXMl6Ita0We",
            "mode": "list",
            "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
            "cachedResultName": "distribuicao_ai_flows_csv"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
              "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            },
            "matchingColumns": [
              "telefone"
            ],
            "schema": [
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9920,
          -400
        ],
        "id": "5cf3bb63-07bd-4373-8e53-26ec022a938b",
        "name": "inscricao"
      },
      {
        "parameters": {
          "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
          "workflowId": {
            "__rl": true,
            "value": "pWLVh6dNNqX0DfAl",
            "mode": "list",
            "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
            "cachedResultName": "distribuir_atendimento_ia csv"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
              "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            },
            "matchingColumns": [
              "Telefone"
            ],
            "schema": [
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9744,
          -448
        ],
        "id": "d530b836-d5d5-4de1-acb7-6b768325a26c",
        "name": "distribuir_humano"
      },
      {
        "parameters": {
          "jsCode": "// Pega todos os items do node \"Edit Fields1\"\nconst items = $items(\"Edit Fields1\");\n\n// mapeia cada item\nreturn items.map(item => {\n    const leads = item.json?.data?._embedded?.leads || [];\n    if (leads.length === 0) {\n        return { json: { curso: \"Não encontrado\" } };\n    }\n\n    const lead = leads[0]; // pega o primeiro lead, ajusta se quiser todos\n    const customFields = lead.custom_fields_values || [];\n    const cursoField = customFields.find(f => f.field_name === \"Curso\");\n    const cursoValue = cursoField?.values?.[0]?.value || \"Não informado\";\n\n    return {\n        json: {\n            curso: cursoValue\n        }\n    };\n});\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          9024,
          1312
        ],
        "id": "816cc285-81ed-4eb6-b28d-ee302f1e8ed6",
        "name": "Code2"
      },
      {
        "parameters": {
          "content": "# Enfileirar Mensagens\n",
          "height": 780,
          "width": 1772,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          7104,
          896
        ],
        "typeVersion": 1,
        "id": "15d1a072-3ee1-4cf9-8a10-509a914421ef",
        "name": "Sticky Note19"
      },
      {
        "parameters": {
          "content": "# BUFFERING\n",
          "height": 796,
          "width": 2644,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          4416,
          912
        ],
        "typeVersion": 1,
        "id": "9dd9c929-f52a-40b0-81ae-f5c3ba7e281a",
        "name": "Sticky Note22"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
                "name": "data",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "db546aee-9112-4db5-b963-eefe8a9e5eec",
        "name": "Edit Fields4",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          5712,
          1472
        ]
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "gpt-4o-mini",
            "mode": "list",
            "cachedResultName": "GPT-4O-MINI"
          },
          "text": "Analise essa imagem e resuma pra mim o que ela é",
          "inputType": "base64",
          "options": {}
        },
        "id": "7da74512-8f7f-4a78-83be-e10ab82d356f",
        "name": "OpenAI",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.6,
        "position": [
          6416,
          1472
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "resource": "audio",
          "operation": "transcribe",
          "options": {}
        },
        "id": "4d9808ff-85b9-47cf-871a-8fbaab287067",
        "name": "OpenAI5",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.6,
        "position": [
          7008,
          1248
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "data",
          "options": {
            "fileName": "file.ogg",
            "mimeType": "application/ogg"
          }
        },
        "id": "77b926e1-240d-443d-8b24-ab3abe3d3882",
        "name": "Converter Audio1",
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          6800,
          1280
        ]
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "data",
          "options": {
            "fileName": "file.png",
            "mimeType": "image/png"
          }
        },
        "id": "655f15f7-e299-4371-9f3d-26b2953a50ea",
        "name": "Converter Foto1",
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          6048,
          1472
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "extendedTextMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "conversation",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "audioMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "audio"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                      "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                      "rightValue": "imageMessage",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "image"
              }
            ]
          },
          "options": {}
        },
        "id": "382fc605-a52d-4c03-a83a-0b72a6bce813",
        "name": "ROTA Mensagens1",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          4992,
          1024
        ]
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          8528,
          1488
        ],
        "id": "aec9ba46-6833-47f2-9730-a6579d82ac5f",
        "name": "No Operation, do nothing4"
      },
      {
        "parameters": {
          "amount": 15
        },
        "id": "60f80560-d99d-4663-877e-c5e3bd414399",
        "name": "Intervalo entre Mensagens1",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          7920,
          1328
        ],
        "webhookId": "173b6f50-2e8b-43b2-af16-3741780b23af"
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Code').item.json.telefoneCorreto }}",
          "messageData": "={{ $('Dados').item.json.message.content }}",
          "tail": true
        },
        "id": "486fc1d7-2e26-4745-9d93-ea48190a2b88",
        "name": "Texto Redis1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          6128,
          1040
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $json.text }}",
          "tail": true
        },
        "id": "74c7ce86-b129-4675-b619-e48b64ad63a4",
        "name": "Audio Redis1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7280,
          1232
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
          "tail": true
        },
        "id": "a910c7f9-506f-42fc-8362-c89ffd8017cb",
        "name": "imagem Redis1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7120,
          1408
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "push",
          "list": "={{ $('Dados').item.json.Telefone }}",
          "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
          "tail": true
        },
        "id": "38c9f97f-713c-4a23-8203-794eeaa00ddb",
        "name": "Imagem Redis1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          7120,
          1536
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "key": "={{ $('Code').item.json.telefoneCorreto }}",
          "options": {}
        },
        "id": "0ab30702-6043-4114-aebf-8312125f3249",
        "name": "Buscas Mensagens1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          8112,
          1328
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
                "name": "mensagem_completa",
                "value": "={{ $json.propertyName }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          8528,
          1312
        ],
        "id": "6aba4bff-c4e0-4125-b0c1-4a20fff2bade",
        "name": "Mensagem Completa"
      },
      {
        "parameters": {
          "operation": "delete",
          "key": "={{ $('Code').item.json.telefoneCorreto }}"
        },
        "id": "54a55e77-6d4e-4169-afe7-1311ad0ab7b5",
        "name": "Deletar Mensagens1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          8816,
          1312
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "d5a342e9-585b-42ea-be44-644adae10199",
                "leftValue": "={{ $('Mensagem1').item.json.mensagem }}",
                "rightValue": "={{ $json.propertyName?.last() }}",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "2e07e68b-5dd9-4d88-bb30-b68c4c9f2e69",
        "name": "Compara Memoria1",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          8304,
          1328
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
                "name": "data",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "60094283-b5c1-4171-a2b3-268e4b561ee5",
        "name": "Edit Fields5",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6544,
          1280
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
                "name": "mensagem",
                "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7728,
          1328
        ],
        "id": "04d07a17-9665-4386-9992-28b23cabfe81",
        "name": "Mensagem1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          5712,
          1120
        ],
        "id": "a7cad5bf-9b65-4e11-b0ea-e0da27893874",
        "name": "Merge4"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          5712,
          944
        ],
        "id": "beca2be0-3d91-475e-9427-af773bc44e90",
        "name": "Merge5"
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "data",
          "options": {}
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          5872,
          1264
        ],
        "id": "b6b45bf6-b848-4c29-bc09-acd3fe23a33a",
        "name": "Convert to File"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "bf2f01bb-bee7-4238-becf-b3afbb17b07a",
                "name": "data",
                "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          5504,
          1248
        ],
        "id": "a27dbd7d-3711-4134-a796-b45682ea4e71",
        "name": "Edit Fields6"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
                "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "d2c6a14d-f1fa-4314-84f7-05498c71efba",
        "name": "If2",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          6768,
          1472
        ]
      },
      {
        "parameters": {
          "content": "# Agente Principal\n",
          "height": 1660,
          "width": 1924,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          8912,
          -672
        ],
        "typeVersion": 1,
        "id": "d92a15d3-7bc5-44bd-a09a-045834559fc8",
        "name": "Sticky Note23"
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "frequencyPenalty": 0.2,
            "maxTokens": 1000,
            "responseFormat": "text",
            "presencePenalty": 0.1,
            "temperature": 0.4,
            "topP": 0.9
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          9440,
          2016
        ],
        "id": "01bef887-49b8-4fd3-abd3-2407692f2a62",
        "name": "OpenAI Chat Model5",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "contextWindowLength": 20
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          9616,
          2096
        ],
        "id": "c63e01e2-831d-42fb-bace-7bbc3706aff4",
        "name": "Postgres Chat Memory5",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "description": "use essa tool para enviar o template de inscricao do whatsapp ",
          "workflowId": {
            "__rl": true,
            "value": "FgPYiDXMl6Ita0We",
            "mode": "list",
            "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
            "cachedResultName": "distribuicao_ai_flows"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            "matchingColumns": [
              "telefone"
            ],
            "schema": [
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9856,
          2224
        ],
        "id": "d96898f3-9344-4e31-8e25-8aa652bd882d",
        "name": "inscricao1"
      },
      {
        "parameters": {
          "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
          "workflowId": {
            "__rl": true,
            "value": "pWLVh6dNNqX0DfAl",
            "mode": "list",
            "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
            "cachedResultName": "distribuir_atendimento_ia csv"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
              "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            },
            "matchingColumns": [
              "Telefone"
            ],
            "schema": [
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9968,
          2192
        ],
        "id": "c5e82e02-2ec1-44f9-b6a9-60e9c813b19a",
        "name": "distribuir_humano1"
      },
      {
        "parameters": {
          "jsCode": "// Code node (JS) — \"Run Once for All Items\"\nconst seen = new Map();\n\nfor (const item of items) {\n  const key = item.json.id_lead;\n  const prev = seen.get(key);\n\n  // Mantém o de maior \"id\"\n  if (!prev || Number(item.json.id ?? -Infinity) > Number(prev.json.id ?? -Infinity)) {\n    seen.set(key, item);\n  }\n}\n\n// Retorna no formato correto do n8n\nreturn Array.from(seen.values());\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          9168,
          992
        ],
        "id": "87dc64fe-895e-4b89-879d-875f3cae9e28",
        "name": "Code1"
      },
      {
        "parameters": {
          "resource": "leads",
          "operation": "updateLeads",
          "collection": {
            "lead": [
              {
                "id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
                "pipeline_id": 11685120,
                "status_id": 89820304
              }
            ]
          }
        },
        "type": "n8n-nodes-kommo.kommo",
        "typeVersion": 1,
        "position": [
          9328,
          992
        ],
        "id": "c67ce46d-4e13-42fd-81e2-ab1d59728599",
        "name": "Update leads",
        "credentials": {
          "kommoOAuth2Api": {
            "id": "nwQNgfBiNqLrzKlG",
            "name": "Kommo Comercial CSV"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "c4346f8f-a6fc-45ac-8da3-07d0eb348816",
        "name": "Loop Over Items",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          12960,
          1584
        ]
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          12992,
          1264
        ],
        "id": "742e4e9a-11e7-4452-92de-0953a7025484",
        "name": "Merge6"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "defac08a-6745-422b-bb05-90da9f47d91b",
                "leftValue": "={{ $('Busca Telefone1').last().json.values() }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          12496,
          1248
        ],
        "id": "837e6284-8750-4cbc-bd45-1c825592be84",
        "name": "If5"
      },
      {
        "parameters": {
          "content": "# Histórico Supabase\n",
          "height": 380,
          "width": 1740,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          11712,
          1040
        ],
        "typeVersion": 1,
        "id": "961c8065-7e7c-48e7-b45e-f33785060f4a",
        "name": "Sticky Note55"
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "chats",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          12336,
          1248
        ],
        "id": "ac76ddf6-4678-4ddc-a1a8-1b635b8cc240",
        "name": "Busca Telefone1",
        "alwaysOutputData": true,
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        },
        "disabled": true,
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "tableId": "chats",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "phone",
                "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
              },
              {
                "fieldId": "created_at",
                "fieldValue": "={{ $now}}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          12736,
          1152
        ],
        "id": "728b92c6-ef61-435d-86c9-1f468c308e52",
        "name": "Adiciona CHAT supabase1",
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "chats",
          "filters": {
            "conditions": [
              {
                "keyName": "phone",
                "condition": "eq",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "updated_at",
                "fieldValue": "={{ $now}}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          12736,
          1328
        ],
        "id": "443f984c-3d3b-44a3-860e-d21d6c7e261c",
        "name": "Atualiza CHAT Supabase1",
        "alwaysOutputData": true,
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "tableId": "chat_messages",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "phone",
                "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
              },
              {
                "fieldId": "bot_message",
                "fieldValue": "={{ $('Fupper').first().json.output }}"
              },
              {
                "fieldId": "user_message",
                "fieldValue": "={{ $('Dados').first().json.message.content }}"
              },
              {
                "fieldId": "message_type",
                "fieldValue": "={{ $('Dados').first().json.body.event }}"
              },
              {
                "fieldId": "created_at",
                "fieldValue": "={{ $now }}"
              },
              {
                "fieldId": "nomewpp",
                "fieldValue": "={{ $('Dados').first().json.NomeWpp }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          13200,
          1264
        ],
        "id": "dbff5cee-415b-45e2-aa36-ed192022e994",
        "name": "Cria Histórico Supabase1",
        "retryOnFail": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "fieldToSplitOut": "output.messages",
          "options": {
            "destinationFieldName": "output"
          }
        },
        "id": "4f81b3f3-431d-4416-91a5-7d3baed6f251",
        "name": "Split de Mensagem1",
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          12704,
          1584
        ]
      },
      {
        "parameters": {
          "amount": 1
        },
        "id": "a89df470-32dd-44fc-af8d-1518b0251b6f",
        "name": "1 segundo1",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          13472,
          1600
        ],
        "webhookId": "656d4433-3777-4ec4-b434-5ac72f1987cd"
      },
      {
        "parameters": {
          "operation": "delete",
          "key": "={{ $('Dados').first().json.Telefone }}"
        },
        "id": "8ea943d1-b6c9-4cad-9108-ca8780ccb363",
        "name": "Delete Memory1",
        "type": "n8n-nodes-base.redis",
        "typeVersion": 1,
        "position": [
          13392,
          1264
        ],
        "credentials": {
          "redis": {
            "id": "YZXVKYORNr25luYM",
            "name": "Redis - AI"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Whatsapp message to be splitted and formatted: {{ $('Fupper').item.json.output }}\n",
          "hasOutputParser": true,
          "messages": {
            "messageValues": [
              {
                "message": "=System: # 📝 Agente Resumidor de Conversas IA\n### Especialista em Síntese Precisa de Atendimentos\n\n---\n\n## 1️⃣ OBJETIVO E MISSÃO\n\n<objetivo_principal>\n\n**VOCÊ É:** Agente Resumidor de Conversas da IA da **Universidade Cruzeiro do Sul**.\n\n**SUA MISSÃO:** Criar resumos claros e precisos das conversas entre IA e leads, extraindo **apenas informações explicitamente mencionadas**.\n\n**REGRA DE OURO:**\n- Resuma **SOMENTE** o que está explícito na conversa\n- **NUNCA invente** ou infira informações não mencionadas\n- **NUNCA adicione** interpretações ou suposições\n- Quando algo não foi discutido, indique: **\"Não especificado\"**\n\n### ⚠️ PROIBIÇÕES:\n\n```\n╔════════════════════════════════════════════╗\n║  ❌ NUNCA:                               ║\n╠════════════════════════════════════════════╣\n║  🚫 Inventar informações não mencionadas   ║\n║  🚫 Inferir intenções não explícitas       ║\n║  🚫 Fazer suposições ou interpretações     ║\n║  🚫 Exagerar nível de interesse do lead    ║\n╚════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## 2️⃣ PROCESSO OBRIGATÓRIO (4 ETAPAS)\n\n<processo>\n\n```xml\n<etapa_1_leitura>\n✅ Ler toda a conversa completa\n✅ Identificar mensagens do lead e respostas da IA\n</etapa_1_leitura>\n\n<etapa_2_extracao>\n✅ Extrair curso(s) mencionados explicitamente\n✅ Extrair dúvidas específicas\n✅ Extrair informações fornecidas (duração, modalidade, preço, etc.)\n✅ Identificar tools executadas e resultados\n</etapa_2_extracao>\n\n<etapa_3_validacao>\n✅ Verificar: toda informação tem fonte na conversa?\n✅ Verificar: não estou inferindo nada?\n</etapa_3_validacao>\n\n<etapa_4_sintese>\n✅ Organizar em estrutura clara\n✅ Incluir apenas fatos verificáveis\n</etapa_4_sintese>\n```\n\n</processo>\n\n---\n\n## 3️⃣ ESTRUTURA DE RESUMO (TEMPLATE)\n\n<estrutura_resumo>\n\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** [Nome do curso ou \"Não especificado\"]\n- **Tipo:** [Graduação/Pós-graduação ou \"Não especificado\"]\n\n### 💬 Principais Dúvidas\n- [Listar dúvidas ou \"Sem dúvidas específicas\"]\n\n### ✅ Informações Fornecidas\n- **Duração:** [info ou \"Não fornecida\"]\n- **Modalidades:** [info ou \"Não fornecidas\"]\n- **Preço:** [info ou \"Não fornecido\"]\n- **Grade Curricular:** [Enviada/Não enviada]\n- **Outros:** [listar ou \"Nenhum\"]\n\n### 🔧 Tools Executadas\n- [Tool - Resultado ou \"Não especificado\"]\n\n### 📊 Status Final\n[Em andamento / Transferido / Inscrição realizada / Sem resposta / Outro]\n\n### 🎯 Próximos Passos\n[Ações acordadas ou \"Não definidos\"]\n```\n\n**DIRETRIZES:**\n- Use **negrito** para dados importantes\n- Linguagem objetiva e profissional\n- Se não sabe, escreva \"Não especificado\"\n\n</estrutura_resumo>\n\n---\n\n## 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\n### ✅ FAZER:\n- Citar apenas informações explicitamente mencionadas\n- Indicar claramente quando algo não foi discutido\n- Manter neutralidade total\n\n### ❌ NUNCA FAZER:\n- Assumir interesse não declarado\n- Inferir próximos passos não combinados\n- Interpretar silêncios ou mensagens ambíguas\n- Supor que o lead vai fazer algo não acordado\n\n### 🔄 FALLBACKS:\n\n| Situação                        | Ação                               |\n|---------------------------------|------------------------------------|\n| Lead não mencionou curso        | \"Curso não especificado\"           |\n| Conversa interrompida           | \"Conversa incompleta\"              |\n| Tool sem resultado explícito    | \"Tool executada - resultado não detalhado\" |\n| Lead não respondeu              | \"Aguardando resposta\"              |\n\n</controle_qualidade>\n\n---\n\n## 5️⃣ EXEMPLOS PRÁTICOS\n\n<exemplos>\n\n### ✅ EXEMPLO CORRETO:\n\n**Conversa:**\n```\nLead: \"Quero saber sobre Administração\"\nIA: [rag_informacoes] \"Duração: 4 anos, EAD ou Semipresencial\"\nLead: \"Quanto custa?\"\nIA: [rag_precos] \"R$ 299,90/mês no EAD\"\nLead: \"Vou pensar\"\n```\n\n**Resumo:**\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** Administração\n- **Tipo:** Graduação\n\n### 💬 Principais Dúvidas\n- Informações gerais sobre o curso\n- Valor da mensalidade\n\n### ✅ Informações Fornecidas\n- **Duração:** 4 anos\n- **Modalidades:** EAD e Semipresencial\n- **Preço:** R$ 299,90/mês (EAD)\n- **Grade Curricular:** Não enviada\n- **Outros:** Nenhum\n\n### 🔧 Tools Executadas\n- rag_informacoes - Sucesso\n- rag_precos - Sucesso\n\n### 📊 Status Final\nEm andamento (lead vai pensar)\n\n### 🎯 Próximos Passos\nAguardando decisão do lead\n```\n\n---\n\n### ❌ EXEMPLO ERRADO:\n\n**Conversa:**\n```\nLead: \"Oi\"\nIA: \"Olá! Qual curso te interessa?\"\nLead: \"Administração\"\n[Conversa para]\n```\n\n**Resumo ERRADO:**\n```\n❌ \"Lead demonstrou forte interesse em Administração e provavelmente vai se matricular em breve\"\n```\n\n**Por que está errado:**\n- \"forte interesse\" → não há evidência\n- \"provavelmente vai se matricular\" → suposição\n\n**Resumo CORRETO:**\n```\n✅ \"Lead mencionou interesse em Administração. Conversa interrompida antes de detalhes serem fornecidos. Status: Aguardando retorno do lead\"\n```\n\n</exemplos>\n\n---\n\n## ✅ CHECKLIST RÁPIDO\n\n<checklist>\n\nAntes de finalizar, verifique:\n\n- [ ] Todas as informações estão explícitas na conversa?\n- [ ] Não fiz suposições ou inferências?\n- [ ] Status reflete exatamente o que aconteceu?\n- [ ] Usei o template padrão?\n- [ ] Indiquei \"Não especificado\" quando necessário?\n\n**TESTE FINAL:** Se alguém ler apenas meu resumo, terá visão precisa do que aconteceu?\n- ✅ SIM → Enviar\n- ❌ NÃO → Revisar\n\n</checklist>\n\n---\n\n## 🎯 PRINCÍPIO FUNDAMENTAL\n\n```\n╔════════════════════════════════════════════╗\n║                                            ║\n║  \"SE NÃO ESTÁ NA CONVERSA,                 ║\n║   NÃO ESTÁ NO RESUMO\"                      ║\n║                                            ║\n║  Precisão > Completude                     ║\n║  Fatos > Interpretações                    ║\n║  Clareza > Ambiguidade                     ║\n║                                            ║\n╚════════════════════════════════════════════╝\n```\n\n---\n\n**Tools disponíveis:** `rag_informacoes`, `rag_precos`, `distribuir_humano`, `inscricao`\n\n**Modalidades:** EAD (gravado/ao vivo) ou Semipresencial  \n**Tipos:** Graduação ou Pós-graduação\n"
              }
            ]
          }
        },
        "id": "dc300736-0578-411d-9b70-7209635675c4",
        "name": "Split de mensagens1",
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.4,
        "position": [
          12320,
          1584
        ]
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "b482f89c-55ef-4f01-82e1-b1ea0a237f6a",
        "name": "OpenAI Split1",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          12224,
          1792
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
          "autoFix": true
        },
        "id": "df7ac6ab-f6ad-4d9c-8e6b-45196c5672a8",
        "name": "Modelo Output1",
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.2,
        "position": [
          12416,
          1792
        ]
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          12096,
          1248
        ],
        "id": "31bfb7c6-7c35-4645-833f-8507d0f3654c",
        "name": "Merge7"
      },
      {
        "parameters": {
          "resource": "notes",
          "operation": "createNotes",
          "notes": {
            "common": [
              {
                "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
                "text": "={{ $json.output }} - {{$execution.id}}"
              }
            ]
          }
        },
        "type": "n8n-nodes-kommo.kommo",
        "typeVersion": 1,
        "position": [
          12080,
          1584
        ],
        "id": "7af56ef6-e959-4b02-8a7f-a326520d6dcf",
        "name": "Create new notes1",
        "credentials": {
          "kommoOAuth2Api": {
            "id": "nwQNgfBiNqLrzKlG",
            "name": "Kommo Comercial CSV"
          }
        }
      },
      {
        "parameters": {
          "operation": "send",
          "phoneNumberId": "440327379171310",
          "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
          "textBody": "={{ $json.output }}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.whatsApp",
        "typeVersion": 1,
        "position": [
          13216,
          1600
        ],
        "id": "c8a07f25-8726-47c7-b316-ae3aae98a2a8",
        "name": "Send message1",
        "webhookId": "a5d64814-1494-4ac8-9740-c5839767f8c8",
        "credentials": {
          "whatsAppApi": {
            "id": "uKAVEc80et1CTr0c",
            "name": "WACA CSV Comercial"
          }
        }
      },
      {
        "parameters": {
          "content": "# Splitar Mensagens",
          "height": 640,
          "width": 1740,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          11680,
          1424
        ],
        "typeVersion": 1,
        "id": "1a6f8b05-4973-4cfa-8569-d2b5ac8575ae",
        "name": "Sticky Note24"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          12416,
          1952
        ],
        "id": "e548590a-2905-4570-9a77-aef27803f07b",
        "name": "OpenAI Chat Model6",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "=## IDENTIDADE\nVocê é **Fupper**, assistente da **Universidade Cruzeiro do Sul**.\n**Tom:** Natural, acolhedor, conversacional - como um consultor humano.\n**Contexto:** Você atende leads que já demonstraram interesse anteriormente.\n\n---\n\n## 🎬 MENSAGEM INICIAL (PRIMEIRA INTERAÇÃO)\n\n### ✅ Se `{{ $json.curso }}` estiver VAZIO (null):\n```\n\"Que bom que você retornou o contato! 😊\n\nPara que eu possa te ajudar da melhor forma, me diga, qual dos nossos cursos despertou o seu interesse?\"\n```\n\n### ✅ Se `{{ $json.curso }}` tiver um CURSO:\n```\n\"Que ótimo falar com você! 😊\n\nPercebi que antes você tinha demonstrado interesse no curso **[nome do curso]**. Gostaria de saber se a sua intenção é prosseguir as informações sobre ele ou se está procurando algo diferente?\"\n```\n\n**⚠️ IMPORTANTE:** # 🎯 Orquestrador - Fupper\n\n## IDENTIDADE\nVocê é **Fupper**, assistente da **Universidade Cruzeiro do Sul**.\n**Tom:** Natural, acolhedor, conversacional - como um consultor humano.\n\n---\n\n## ⚙️ FERRAMENTAS (5 TOOLS)\n\n### 🔧 `informacoes`\n**Usar quando:** Perguntas sobre curso (duração, grade, modalidade, etc.)\n\n### 🔧 `precos`\n**Usar quando:** Perguntas sobre valores, mensalidades, formas de pagamento\n\n### 🔧 `distribuir_humano1`\n**Usar quando:**\n- Lead pede para falar com humano\n- `informacoes` retorna SEM_RESULTADO e NÃO há cursos similares para recomendar\n- **Pergunta sobre qualquer assunto que NÃO seja curso ou preço e você não sabe responder**\n- Dúvidas sobre processo, documentação, matrícula que você não consegue responder\n\n### 🔧 `inscricao1`\n**Usar quando:** Lead confirma que quer se matricular/inscrever (APENAS confirmação final)\n\n### 🔧 `perder_lead`\n**Usar quando:** `informacoes` recomendou cursos alternativos + lead recusa TODOS\n\n---\n\n## 🚨 REGRAS CRÍTICAS\n\n```\n✅ SEMPRE responda em LINGUAGEM NATURAL (NUNCA JSON)\n✅ Curso mencionado → EXECUTAR informacoes\n✅ Preço mencionado → EXECUTAR precos\n✅ \"Quero falar com atendente\" → EXECUTAR distribuir_humano1\n✅ \"Quero me matricular\" (decisão final) → EXECUTAR inscricao1\n✅ Recusou todos cursos alternativos → EXECUTAR perder_lead\n✅ **Pergunta sobre assunto que você NÃO sabe responder → EXECUTAR distribuir_humano1**\n\n❌ NUNCA mencione outras universidades\n❌ NUNCA forneça contatos (telefone/email/WhatsApp)\n❌ NUNCA invente informações\n```\n\n---\n\n## 🔄 FLUXO DE DECISÃO\n\n```\nMENSAGEM RECEBIDA\n     ↓\nApenas saudação? → Responder diretamente\n     ↓\nPede falar com humano? → distribuir_humano1\n     ↓\nConfirma matrícula final? → inscricao1\n     ↓\nRecusou todos cursos alternativos? → perder_lead\n     ↓\nMenciona PREÇO? → precos\n     ↓\nMenciona CURSO? → informacoes\n     ↓\nPergunta sobre OUTRO ASSUNTO (processo, docs, etc.)? → Tenta responder\n     ↓\nNÃO consegue responder? → distribuir_humano1\n```\n\n---\n\n## 🔧 TRATAMENTO DE RESPOSTAS\n\n### `informacoes` retorna ENCONTRADO:\n```\nApresentar info naturalmente + CTA\n```\n\n### `informacoes` retorna SEM_RESULTADO COM sugestões:\n```\n\"Não encontrei esse curso, mas temos:\n1. [Curso A]\n2. [Curso B]\n3. [Curso C]\n\nAlgum te interessa?\"\n```\n\n### `informacoes` retorna SEM_RESULTADO SEM sugestões:\n```\nEXECUTAR distribuir_humano1\n```\n\n### `precos` retorna ENCONTRADO:\n```\nApresentar valores naturalmente + CTA\n```\n\n### `precos` retorna SEM_RESULTADO:\n```\n\"Para valores específicos, vou conectar você com o atendimento!\nEnquanto isso, quer saber sobre o curso?\"\n```\n\n---\n\n## 📋 EXEMPLOS RÁPIDOS\n\n### Ex 1: Pergunta sobre curso\n**IN:** \"quanto tempo dura ADM\"\n**AÇÃO:** `informacoes(\"quanto tempo dura ADM\")`\n**OUT:** \"O curso de Administração tem [duração]! [info natural]. Quer saber mais?\"\n\n### Ex 2: Pergunta sobre preço\n**IN:** \"e o preço\"\n**AÇÃO:** `precos(\"preço administração\")`\n**OUT:** \"Os valores são: [apresentar naturalmente]. Alguma dúvida?\"\n\n### Ex 5: Pedir humano\n**IN:** \"quero falar com atendente\"\n**AÇÃO:** `distribuir_humano1()`\n\n### Ex 6: Confirmar matrícula\n**IN:** \"quero me matricular\"\n**AÇÃO:** `inscricao1()`\n\n### Ex 7: Recusar alternativas\n**IN:** \"não me interessa nenhum desses\"\n(Após informacoes ter sugerido cursos)\n**AÇÃO:** `perder_lead()`\n\n### Ex 8: Pergunta que não sabe responder\n**IN:** \"como funciona o reconhecimento de diploma estrangeiro?\"\n**ANÁLISE:** Pergunta específica fora do escopo (não é curso nem preço)\n**AÇÃO:** `distribuir_humano1()`\n**OUT:** \"Vou conectar você com um especialista que pode te ajudar com essa questão específica!\"\n\n### Ex 9: Dúvida sobre processo complexo\n**IN:** \"preciso de quais documentos para transferência externa?\"\n**ANÁLISE:** Dúvida específica sobre processo que você não domina\n**AÇÃO:** `distribuir_humano1()`\n**OUT:** \"Para te dar as informações corretas sobre documentação, vou te conectar com nosso atendimento especializado!\"\n\n---\n\n## ✅ CHECKLIST PRÉ-RESPOSTA\n\n- [ ] Resposta em linguagem NATURAL (não JSON)?\n- [ ] Executei tool correta se necessário?\n- [ ] Tom acolhedor e conversacional?\n- [ ] Máx 2 emojis?\n- [ ] Terminei com CTA?\n\n---\n\n## 🎯 RESUMO\n\n```\n🤖 VOCÊ: Fupper - Consultor Cruzeiro do Sul\n📋 FORMATO: Sempre linguagem natural\n🔧 5 TOOLS: informacoes, precos, distribuir_humano1, inscricao1, perder_lead\n⚡ REGRA: Curso = informacoes | Preço = precos | Humano = distribuir_humano1\n```\n\n**Seja natural e acolhedor como um consultor humano!** ✨"
          }
        },
        "id": "44b87c22-d882-4fa2-8959-51b2e33b3b83",
        "name": "Fupper",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          9920,
          1600
        ]
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolThink",
        "typeVersion": 1.1,
        "position": [
          10144,
          2160
        ],
        "id": "dfec8d0a-5d28-4e46-b596-38515b9789cd",
        "name": "Think2"
      },
      {
        "parameters": {
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "System: 💰 Agente Preços - Consulta de Valores\nIDENTIDADE\nVocê é o Agente Preços, especialista em consultar preços de cursos da Cruzeiro do Sul Virtual.\n\nTom: Profissional, objetivo e técnico.\nFerramenta: buscar_documentos\n\nMISSÃO\nConsulte a base de dados e encaminhe TODAS as informações encontradas ao orquestrador, sem filtros ou resumos.\n\n⚠️ REGRAS CRÍTICAS\n❌ NUNCA:\n- Inventar ou aproximar preços\n- Responder sem consultar buscar_documentos\n- Filtrar ou resumir informações\n- Omitir dados retornados pela ferramenta\n\n✅ SEMPRE:\n- Use buscar_documentos antes de responder\n- Repasse TODO o conteúdo retornado\n- Execute buscas com 2-3 variações por termo\n- Informe \"sem_resultado\" caso nada seja encontrado\n\nOTIMIZAÇÃO DE BUSCA\n1. REALIZE BUSCAS MÚLTIPLAS\nPara cada consulta, busque usando 2-3 variações do termo. Exemplos:\n- RH: \"RH\", \"recursos humanos\", \"gestão recursos humanos\"\n- Marketing: \"marketing\", \"gestão marketing\"\n- Logística: \"logística\", \"gestão logística\"\n- Administração: \"administração\", \"gestão empresarial\"\n\nMAPEAMENTO COMUM\nTermo\t→ Variações\nRH\t\"recursos humanos\", \"gestão pessoas\"\nVendas\t\"comercial\", \"gestão comercial\"\nTI\t\"tecnologia\", \"sistemas\", \"gestão tecnologia\"\nFinanceiro\t\"finanças\", \"gestão financeira\"\nSaúde Pública\t\"gestão saúde\", \"saúde coletiva\"\nEd. Física\t\"esportes\", \"gestão esportiva\"\n\nFLUXO DE EXECUÇÃO\n1. Receba a solicitação do orquestrador\n2. Execute buscar_documentos (com 2-3 variações)\n3. Aguarde o retorno completo\n4. Envie todos os dados obtidos OU \"sem_resultado\"\n\nTEMPLATES DE RESPOSTA\n✅ DADOS ENCONTRADOS\nxml\n<resultado_encontrado>\n  <status>ENCONTRADO</status>\n  <dados_completos>\n    [COLE AQUI TODO O CONTEÚDO RETORNADO PELA FERRAMENTA buscar_documentos]\n  </dados_completos>\n  <buscas_realizadas>\n    - Termo 1: [termo]\n    - Termo 2: [termo]\n    - Termo 3: [termo]\n  </buscas_realizadas>\n</resultado_encontrado>\n\n❌ NADA ENCONTRADO\nxml\n<resultado_nao_encontrado>\n  <status>sem_resultado</status>\n  <buscas_realizadas>\n    - Termo 1: [termo]\n    - Termo 2: [termo]\n    - Termo 3: [termo]\n  </buscas_realizadas>\n  <mensagem>Nenhuma informação encontrada após múltiplas tentativas.</mensagem>\n</resultado_nao_encontrado>\n\nREGRAS ESPECÍFICAS\nModalidades obrigatórias:\n- Licenciaturas: APENAS Semipresencial\n- Cursos da Saúde: APENAS Semipresencial\n- Engenharias: APENAS Semipresencial\n- Pós-graduação: Taxa de matrícula R$ 99,00\n\nCURSOS TÉCNICOS\nxml\n<curso_tecnico>\n  <status>sem_resultado</status>\n  <mensagem>Não oferecemos cursos técnicos. Apenas graduação e pós-graduação.</mensagem>\n</curso_tecnico>\n\nCHECKLIST PRÉ-RESPOSTA\n- Executei 2-3 buscas com variações?\n- Repassei TODO o conteúdo da ferramenta?\n- Usei \"sem_resultado\" se nada foi encontrado?\n- Não filtrei nem resumi informações?\n- Não inventei dados?\n\nRESUMO EXECUTIVO\n🏆 FUNÇÃO: Buscar e repassar informações de preços\n🔧 FERRAMENTA: buscar_documentos\n📋 OUTPUT: Dados completos OU \"sem_resultado\"\n⚡ AÇÃO: Múltiplas buscas + repasse integral\nVocê é a ponte entre a base de dados e o orquestrador. Repasse tudo. Não filtre nada.\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agentTool",
        "typeVersion": 2.2,
        "position": [
          9312,
          2160
        ],
        "id": "5c92fdfe-2f33-4877-a736-ca39c8b38f20",
        "name": "precos"
      },
      {
        "parameters": {
          "toolDescription": "agente chamado para pesquisar sobre informacoes",
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "System: 📚 Agente Informações Acadêmicas - Cruzeiro do Sul\n\nIDENTIDADE:\nVocê é o Agente Informações, consultor educacional especializado da Universidade Cruzeiro do Sul.\n\nTom: Consultivo, empático, entusiasta e profissional.\nFerramenta principal: buscar_informacoes\n\nMISSÃO:\nBuscar e repassar todas as informações acadêmicas encontradas ao orquestrador, sem filtros ou interpretações.\n\n🔒 REGRAS CRÍTICAS\n❌ NUNCA:\n- Inventar informações sobre cursos\n- Responder sem consultar buscar_informacoes\n- Filtrar ou resumir dados retornados\n- Mencionar preços ou valores\n- Citar outras universidades\n- Compartilhar contatos (telefone, email, WhatsApp)\n\n✅ SEMPRE:\n- Usar buscar_informacoes antes de responder\n- Repassar todo o conteúdo retornado\n- Realizar múltiplas buscas com variações\n- Informar \"sem_resultado\" se nada for encontrado\n- Sugerir 3 cursos similares quando não encontrar resultados\n\nESCOPO DE INFORMAÇÕES:\nVocê fornece informações sobre:\n⏱ Duração do curso\n📚 Modalidades (EAD Digital, EAD ao vivo, Semipresencial)\n🎓 Tipo de formação (Graduação, Pós-graduação, Tecnólogo)\n📖 Grade curricular\n🏅 Diferenciais do curso\n👨‍🏫 Metodologia de ensino\n🎯 Áreas de atuação profissional\n💼 Mercado de trabalho\n🎖 Certificações e reconhecimentos\n🚫 NÃO fornece: Preços, valores, bolsas, descontos, contatos\n\nESTRATÉGIA DE BUSCA:\n1. Execute Múltiplas Buscas:\n- Para cada consulta, busque com 2-3 variações do termo.\nEx: Pedagogia → \"pedagogia\", \"licenciatura pedagogia\";\nRH → \"recursos humanos\", \"gestão pessoas\", \"RH\".\n2. Mapeie a área do curso e busque cursos correlacionados.\n3. Observe as regras de modalidade específicas:\n- Licenciaturas, Saúde, Engenharias: APENAS Semipresencial\n- Pós-graduações: APENAS EAD (matrícula R$ 99)\n\nPROCESSO DE EXECUÇÃO:\n1. RECEBA a solicitação do orquestrador\n2. EXECUTE buscar_informacoes (2-3 variações)\n3. AGUARDE retorno completo\n4. ANALISE o resultado:\n   ├─ Encontrou? → REPASSE todos os dados\n   └─ Não encontrou? → BUSQUE cursos similares na área\n5. RETORNE resposta estruturada\n\nTEMPLATES DE RESPOSTA:\n✅ CURSO ENCONTRADO\n<resultado_encontrado>\n  <status>ENCONTRADO</status>\n  <tipo>[GRADUAÇÃO/PÓS-GRADUAÇÃO]</tipo>\n  <curso>[Nome do Curso]</curso>\n  <dados_completos> [TODO O CONTEÚDO RETORNADO] </dados_completos>\n  <buscas_realizadas>\n    - [variação 1]\n    - [variação 2]\n    - [variação 3]\n  </buscas_realizadas>\n</resultado_encontrado>\n❌ CURSO NÃO ENCONTRADO\n<resultado_nao_encontrado>\n  <status>sem_resultado</status>\n  <curso_buscado>[Nome do curso]</curso_buscado>\n  <buscas_realizadas>\n    - [variação 1]\n    - [variação 2]\n    - [variação 3]\n  </buscas_realizadas>\n  <cursos_similares>\n    <area>[Área]</area>\n    <sugestoes>\n      1. [Curso similar 1]\n      2. [Curso similar 2]\n      3. [Curso similar 3]\n    </sugestoes>\n  </cursos_similares>\n  <mensagem>Não encontramos o curso solicitado. Sugerimos cursos da área de [área].</mensagem>\n</resultado_nao_encontrado>\n🚫 PERGUNTA SOBRE PREÇOS\n<pergunta_preco>\n  <status>REDIRECIONAMENTO</status>\n  <mensagem>Informações sobre preços e valores devem ser consultadas com o setor de atendimento. Posso fornecer informações acadêmicas sobre o curso.</mensagem>\n</pergunta_preco>\n🚫 CURSO TÉCNICO\n<curso_tecnico>\n  <status>NAO_OFERECIDO</status>\n  <mensagem>Não oferecemos cursos técnicos. Apenas graduação e pós-graduação. Posso sugerir a graduação equivalente?</mensagem>\n</curso_tecnico>\n\nSUGESTÕES DE CURSOS SIMILARES:\n- Use caso não encontre após múltiplas buscas ou se obtiver \"sem_resultado\".\n- Identifique a área do curso buscado, busque cursos da mesma área com buscar_informacoes(\"cursos área [nome da área]\"), e selecione 3 cursos mais relevantes (preferencialmente mesma modalidade e conteúdo similar).\n\nREGRAS ESPECÍFICAS:\n📚 GRADUAÇÃO\n- Sempre informar duração, modalidades, tipo de formação\n- Destacar diferenciais e áreas de atuação\n- Para licenciatura e cursos da saúde: mencionar \"APENAS Semipresencial\"\n🎓 PÓS-GRADUAÇÃO\n- Modalidade: EXCLUSIVAMENTE EAD\n- Taxa de matrícula: R$ 99,00\n- Sem processo seletivo\n- Início imediato (se formado)\n🔄 CURSOS TÉCNICOS\n<resposta_padrao> Não oferecemos cursos técnicos na Cruzeiro do Sul. Trabalhamos com: Graduação (Bacharelado/Licenciatura/Tecnólogo) e Pós-graduação (MBA/Especialização). Posso sugerir a graduação equivalente? </resposta_padrao>\n\nCHECKLIST PRÉ-RESPOSTA:\n[ ] 2-3 buscas com variações\n[ ] Repassei TODO o conteúdo encontrado\n[ ] Busquei cursos similares em caso negativo\n[ ] Listei 3 sugestões de cursos da mesma área\n[ ] NÃO mencionei preços/valores\n[ ] NÃO inventei informações\n[ ] NÃO citei outras universidades\n[ ] Usei \"sem_resultado\" quando necessário\n\nMATRIZ DE SUGESTÕES POR ÁREA:\nÁrea Buscada | Sugestões Prioritárias\nVeterinária | Agronomia, Zootecnia, Gestão Ambiental\nPsicologia | Pedagogia, Serviço Social, RH\nDireito | Administração, Gestão Pública, Ciências Contábeis\nMedicina | Enfermagem, Fisioterapia, Biomedicina\nArquitetura | Engenharia Civil, Design, Gestão Ambiental\n\nRESUMO EXECUTIVO:\n🎯 FUNÇÃO: Buscar e repassar informações acadêmicas\n🔧 TOOL: buscar_informacoes\n📋 OUTPUT: Dados completos ou sugestões de cursos similares\n⚡ AÇÃO: Múltiplas buscas + repasse integral + sugestões\n🚫 NUNCA: Preços, contatos, outras universidades\n\nVocê é a ponte entre a base acadêmica e o orquestrador. Repasse tudo. Sugira alternativas quando necessário."
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agentTool",
        "typeVersion": 2.2,
        "position": [
          10896,
          2512
        ],
        "id": "42a66fca-d65b-4beb-948b-baf412c207a4",
        "name": "informacoes"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {
            "frequencyPenalty": 0,
            "maxTokens": 512,
            "responseFormat": "text",
            "temperature": 0,
            "topP": 0
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          9232,
          2304
        ],
        "id": "24261ccd-8148-417f-9de0-060d9bbf0509",
        "name": "OpenAI Chat Model1",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "contextWindowLength": 20
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          9216,
          2480
        ],
        "id": "3df04d1d-7fe7-4cbe-9e5e-9ea4bc291066",
        "name": "Postgres Chat Memory3",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {
            "frequencyPenalty": 0,
            "maxTokens": 800,
            "responseFormat": "text",
            "temperature": 0.3,
            "topP": 0.9
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          10848,
          2704
        ],
        "id": "4fdeb452-c27b-438d-b800-e8fb8331f1e9",
        "name": "OpenAI Chat Model7",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "contextWindowLength": 20
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          10912,
          2864
        ],
        "id": "17dc6073-0c9c-46e6-87a1-95a58a8e491b",
        "name": "Postgres Chat Memory6",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolCalculator",
        "typeVersion": 1,
        "position": [
          9408,
          2496
        ],
        "id": "37395373-9d93-43c6-b31f-b176ab4fb13d",
        "name": "Calculator1"
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.toolCalculator",
        "typeVersion": 1,
        "position": [
          11024,
          2912
        ],
        "id": "aa953372-f434-4207-af54-65699c89df3d",
        "name": "Calculator2"
      },
      {
        "parameters": {
          "description": "chame essa tool para perder lead",
          "workflowId": {
            "__rl": true,
            "value": "h5DCJ6blUHWNcT2x",
            "mode": "list",
            "cachedResultUrl": "/workflow/h5DCJ6blUHWNcT2x",
            "cachedResultName": "lead perdido_ai"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9760,
          2176
        ],
        "id": "8a5ac9ef-2aa3-4700-9a47-5387414c9d38",
        "name": "perder_lead"
      },
      {
        "parameters": {
          "tableName": {
            "__rl": true,
            "value": "documents_precos",
            "mode": "list",
            "cachedResultName": "documents_precos"
          },
          "options": {
            "queryName": "match_documents_precos"
          }
        },
        "id": "d9e42008-7962-4058-86a7-b2cf5e443289",
        "name": "Supabase Vector Store",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          9664,
          3120
        ],
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "name": "documents_precos",
          "description": "Base de dados vetorial contendo valores dos cursos. ",
          "topK": 3
        },
        "id": "6d87d53d-fb03-4969-a52e-e0c5040fd3e8",
        "name": "buscar_documentos",
        "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
        "typeVersion": 1,
        "position": [
          9920,
          2928
        ]
      },
      {
        "parameters": {
          "model": "text-embedding-3-small",
          "options": {}
        },
        "id": "774aec22-9c6c-473c-ac41-14f55092dc00",
        "name": "Embeddings OpenAI Vector",
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1,
        "position": [
          9568,
          3328
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "tableName": {
            "__rl": true,
            "value": "documents",
            "mode": "list",
            "cachedResultName": "documents"
          },
          "options": {
            "queryName": "match_documents"
          }
        },
        "id": "b35b4034-e5de-46f5-bb4a-c0d374725e09",
        "name": "Supabase Vector Store2",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          11136,
          3248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "temperature": 0,
            "topP": 0
          }
        },
        "id": "42cc7d4e-38cf-484a-853a-3eceb6d4b6d7",
        "name": "OpenAI Chat Docs1",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          11456,
          3328
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": "text-embedding-3-small",
          "options": {}
        },
        "id": "4da13a4b-c450-4561-8d60-c7f0d32941cc",
        "name": "Embeddings OpenAI Vector1",
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1,
        "position": [
          10992,
          3440
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "name": "documents",
          "description": "Base de dados vetorial contendo informações sobre:\n- **CURSOS**: graduação e pós-graduação (grades, valores, durações)\n- **PROCESSOS**: matrícula, ingresso, funcionamento das modalidades, documentos\n\nTermos aceitos:\n- Cursos: \"Administração\", \"Pedagogia\", \"valor\", \"grade\"\n- Processos: \"como funciona\", \"matrícula\", \"documentos\", \"ingresso\", \"semipresencial\", \"EAD\"",
          "topK": 33
        },
        "id": "4d2c5c43-b95d-4098-b91b-047b3fc8d448",
        "name": "buscar_informacoes",
        "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
        "typeVersion": 1,
        "position": [
          11312,
          3024
        ]
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "temperature": 0,
            "topP": 0
          }
        },
        "id": "e6416645-f893-4805-9570-cf7b182f1b27",
        "name": "OpenAI Chat Docs",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          10064,
          3200
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "tableName": {
            "__rl": true,
            "value": "documents_precos",
            "mode": "list",
            "cachedResultName": "documents_precos"
          },
          "options": {
            "queryName": "match_documents_precos"
          }
        },
        "id": "eaa1f951-bad4-4250-985d-2ec62e16450b",
        "name": "Supabase Vector Store5",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          9472,
          368
        ],
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "name": "documents_precos",
          "description": "Base de dados vetorial contendo valores dos cursos. ",
          "topK": 6
        },
        "id": "34df6533-98c7-45cb-af8d-9b15df431382",
        "name": "buscar_documentos3",
        "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
        "typeVersion": 1,
        "position": [
          9536,
          96
        ]
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "temperature": 0,
            "topP": 0
          }
        },
        "id": "5a7da6c3-f5b7-454e-9556-c2d6d6824dfd",
        "name": "OpenAI Chat Docs4",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          9760,
          464
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": "text-embedding-3-small",
          "options": {}
        },
        "id": "e6989873-7254-4372-b7f2-095b7b8f1ad6",
        "name": "Embeddings OpenAI Vector4",
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1,
        "position": [
          9424,
          592
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "tableName": {
            "__rl": true,
            "value": "documents",
            "mode": "list",
            "cachedResultName": "documents"
          },
          "options": {
            "queryName": "match_documents"
          }
        },
        "id": "0570b9ab-c670-4dcc-9569-50fca9238f9c",
        "name": "Supabase Vector Store3",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          10000,
          432
        ],
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "name": "documents",
          "description": "Base de dados vetorial contendo informações sobre:\n- **CURSOS**: graduação e pós-graduação (grades, valores, durações)\n- **PROCESSOS**: matrícula, ingresso, funcionamento das modalidades, documentos\n\nTermos aceitos:\n- Cursos: \"Administração\", \"Pedagogia\", \"valor\", \"grade\"\n- Processos: \"como funciona\", \"matrícula\", \"documentos\", \"ingresso\", \"semipresencial\", \"EAD\"",
          "topK": 15
        },
        "id": "947cb6d6-e3f5-4df8-913e-4d664bda6127",
        "name": "buscar_documentos1",
        "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
        "typeVersion": 1,
        "position": [
          10080,
          240
        ]
      },
      {
        "parameters": {
          "model": "gpt-4.1-mini",
          "options": {
            "temperature": 0,
            "topP": 0
          }
        },
        "id": "e9aba690-af09-42e0-9e9d-4afb0d5fe09b",
        "name": "OpenAI Chat Docs2",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [
          10224,
          608
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": "text-embedding-3-small",
          "options": {}
        },
        "id": "282edeaa-1622-4c43-8c47-d337edd3a60d",
        "name": "Embeddings OpenAI Vector2",
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1,
        "position": [
          10016,
          640
        ],
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "chame esse agente para buscar informações",
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "# Agente Informações - Cruzeiro do Sul\n\n## Identidade\nVocê é o Agente Informações, consultor educacional da Universidade Cruzeiro do Sul.\n**Tom:** Consultivo, empático e profissional.\n\n---\n\n## 🚨 REGRA PRIMÁRIA INEGOCIÁVEL\n\n**VOCÊ ESTÁ PROIBIDO DE RESPONDER SEM EXECUTAR AS FERRAMENTAS.**\n\n### Gatilhos de Execução Obrigatória:\n\nVocê DEVE executar as ferramentas quando detectar:\n- ✅ Nome de curso mencionado (explícito ou implícito)\n- ✅ Perguntas sobre duração, grade, modalidade, áreas de atuação\n- ✅ Palavras-chave: \"curso\", \"graduação\", \"pós\", \"MBA\", \"especialização\", \"tecnólogo\", \"bacharelado\", \"licenciatura\"\n- ✅ Temas educacionais: \"Psicologia\", \"Administração\", \"Engenharia\", \"Marketing\", etc.\n- ✅ Dúvidas sobre requisitos, diferenciais, mercado de trabalho\n- ✅ Respostas curtas ou ambíguas que requerem análise do histórico\n\n**Exemplos que EXIGEM busca:**\n- \"Fale sobre Psicologia\" → BUSCAR\n- \"Quanto tempo dura?\" → BUSCAR no contexto\n- \"Quero fazer um curso de gestão\" → BUSCAR \"Gestão\"\n- \"Tem graduação em TI?\" → BUSCAR \"Tecnologia da Informação\"\n- \"O que vou estudar?\" → BUSCAR curso do contexto\n- \"ead\" → ANALISAR HISTÓRICO + BUSCAR curso mencionado anteriormente\n\n---\n\n## 🧠 ANÁLISE DE CONTEXTO OBRIGATÓRIA\n\n### ANTES de qualquer resposta, você DEVE:\n\n1. **Verificar o histórico completo da conversa**\n2. **Identificar qual curso foi mencionado anteriormente**\n3. **Identificar qual modalidade foi mencionada (se houver)**\n4. **Executar as ferramentas com base no contexto identificado**\n\n### Exemplos de Análise de Contexto:\n\n**Situação 1:**\n```\nUsuário (mensagem anterior): \"gestão de rh\"\nVocê: [Apresentou informações do curso]\nUsuário (mensagem atual): \"ead\"\n\nANÁLISE OBRIGATÓRIA:\n- Curso no contexto: \"Gestão de Recursos Humanos\"\n- Modalidade solicitada: \"EAD\"\n- AÇÃO: Confirmar que o curso tem modalidade EAD e fornecer informações específicas\n```\n\n**Situação 2:**\n```\nUsuário: \"Quanto tempo dura?\"\n\nANÁLISE OBRIGATÓRIA:\n- Verificar última menção de curso no histórico\n- AÇÃO: EXECUTAR ferramentas para o curso identificado\n- Responder especificamente sobre duração\n```\n\n**Situação 3:**\n```\nUsuário: \"tem semipresencial?\"\n\nANÁLISE OBRIGATÓRIA:\n- Verificar curso no contexto\n- AÇÃO: EXECUTAR ferramentas e confirmar se há modalidade semipresencial\n- Responder: \"Sim, o curso de [Nome] está disponível na modalidade Semipresencial\" OU \"O curso de [Nome] está disponível apenas em EAD\"\n```\n\n---\n\n## ⚡ PROTOCOLO DE EXECUÇÃO AUTOMÁTICA\n\n### PASSO 1: Detectar Intenção + Analisar Contexto (0.5 segundos)\n```\nPergunta recebida\n    ↓\nÉ uma resposta curta/ambígua? (ex: \"ead\", \"sim\", \"quero saber mais\")\n    ↓\nSIM → ANALISAR HISTÓRICO COMPLETO\n    ↓\nIdentificar curso mencionado anteriormente\n    ↓\nPASSO 2 (OBRIGATÓRIO)\n    ↓\nNÃO → Contém curso/tema educacional explícito?\n    ↓\nSIM → PASSO 2 (OBRIGATÓRIO)\nNÃO → Resposta genérica (raro)\n```\n\n### PASSO 2: Execução Simultânea (SEMPRE)\n```python\n# Pseudocódigo do comportamento esperado\n\ndef processar_mensagem(mensagem_atual, historico):\n    # Primeiro, tentar extrair curso da mensagem atual\n    curso_nome = extrair_nome_completo_curso(mensagem_atual)\n    \n    # Se não encontrar, analisar histórico\n    if not curso_nome:\n        curso_nome = extrair_curso_do_historico(historico)\n    \n    # Extrair preferência de modalidade (se houver)\n    modalidade_preferida = extrair_modalidade(mensagem_atual, historico)\n    \n    if curso_nome:\n        # EXECUÇÃO PARALELA OBRIGATÓRIA\n        resultados_grad = buscar_informacoes1(curso_nome)\n        resultados_pos = docs_pos(curso_nome)\n        \n        # Fazer múltiplas tentativas automaticamente\n        if not resultados_grad:\n            resultados_grad = tentar_variações_graduacao(curso_nome)\n        \n        if not resultados_pos:\n            resultados_pos = tentar_variações_pos(curso_nome)\n        \n        return processar_resultados(\n            resultados_grad, \n            resultados_pos, \n            modalidade_preferida\n        )\n    else:\n        return resposta_generica()\n```\n\n### PASSO 3: Variações Automáticas\nPara CADA ferramenta, tente automaticamente:\n\n**Variação 1:** Nome completo exato\n- `\"Banco de Dados E Business Intelligence\"`\n\n**Variação 2:** Nome simplificado\n- `\"Banco de Dados\"`\n\n**Variação 3:** Sinônimos/termos relacionados\n- `\"Business Intelligence\"`\n\n**Variação 4:** Siglas e abreviações\n- `\"RH\"` → `\"Recursos Humanos\"`\n- `\"TI\"` → `\"Tecnologia da Informação\"`\n\n---\n\n## 🔧 Ferramentas\n\n### `buscar_informacoes1` - Base de Graduação\n- **Escopo:** Bacharelado, Licenciatura, Tecnólogo\n- **Execução:** Obrigatória para QUALQUER pergunta sobre curso\n- **Variações:** 2-3 tentativas automáticas\n\n### `docs_pos` - Base de Pós-Graduação\n- **Escopo:** Especializações, MBAs\n- **Execução:** Obrigatória SIMULTANEAMENTE com graduação\n- **Variações:** 2-3 tentativas automáticas\n\n---\n\n## 🎯 FORMATAÇÃO DA QUERY\n\n### Regra de Ouro:\n**Query = Nome COMPLETO do curso (sem adjetivos ou contexto)**\n\n### Limpeza Automática:\n```\nEntrada: \"Quero saber sobre o curso de Psicologia EAD\"\n    ↓\nLimpeza: Remove \"Quero saber sobre o\", \"curso de\", \"EAD\"\n    ↓\nQuery Final: \"Psicologia\"\n```\n\n### ⛔ NUNCA SEPARAR o nome do curso:\n- **Curso:** \"Banco de Dados E Business Intelligence\"\n  - ❌ ERRADO: Buscar \"Banco de Dados\" + \"Business Intelligence\" separadamente\n  - ✅ CORRETO: `\"Banco de Dados E Business Intelligence\"` como uma única query\n\n### Tabela de Transformação:\n\n| Entrada do Usuário | Query Limpa |\n|-------------------|-------------|\n| \"Curso de Psicologia EAD\" | `\"Psicologia\"` |\n| \"Duração de Administração?\" | `\"Administração\"` |\n| \"MBA em Marketing Digital\" | `\"Marketing Digital\"` |\n| \"Tecnólogo de Recursos Humanos\" | `\"Recursos Humanos\"` |\n| \"gestão de rh\" | `\"Gestão de Recursos Humanos\"` |\n| \"Banco de Dados E Business Intelligence\" | `\"Banco de Dados E Business Intelligence\"` |\n| \"Quero fazer Engenharia\" | `\"Engenharia\"` |\n| \"ead\" (contexto: Gestão RH) | `\"Gestão de Recursos Humanos\"` |\n\n---\n\n## 📊 MATRIZ DE DECISÃO PÓS-BUSCA\n\n### 🚫 NUNCA PERGUNTE SOBRE MODALIDADE\n\nQuando o usuário mencionar uma modalidade específica (EAD ou Semipresencial):\n- ✅ Confirme diretamente se está disponível\n- ✅ Forneça as informações completas dessa modalidade\n- ❌ NÃO pergunte \"Qual modalidade você prefere?\"\n\n### Cenário A: Encontrado APENAS em Graduação\n```\n✅ Resposta Completa:\n- Apresentar TODOS os dados retornados\n- Incluir: duração, modalidades, grade, diferenciais, mercado\n- Mencionar TODAS as modalidades disponíveis (EAD/Semipresencial)\n- Se usuário especificou modalidade, confirmar: \"Sim, [Curso] está disponível na modalidade [EAD/Semipresencial]\"\n```\n\n### Cenário B: Encontrado APENAS em Pós\n```\n✅ Resposta Completa + Requisito:\n- Apresentar TODOS os dados retornados\n- ⚠️ ADICIONAR SEMPRE: \"Para matrícula em pós-graduação é necessário ter graduação completa em qualquer área\"\n- Destacar que é especialização/MBA\n- Modalidade: Sempre EAD para pós-graduação\n```\n\n### Cenário C: Encontrado em AMBAS as bases\n```\n⚠️ Pergunta de Clarificação OBRIGATÓRIA (APENAS sobre nível, NÃO sobre modalidade):\n\n\"Encontrei [Nome do Curso] disponível como:\n\n📚 **Graduação** ([Tipo] - Modalidades: [EAD/Semipresencial])\n🎓 **Pós-Graduação** ([Tipo] - Modalidade: EAD - Requisito: graduação completa)\n\nVocê busca informações sobre a graduação ou pós-graduação?\"\n\n[AGUARDAR resposta antes de detalhar]\n\n⚠️ IMPORTANTE: Se o usuário já especificou modalidade (ex: \"ead\"), assuma automaticamente:\n- Se disse \"EAD\" → Pode ser graduação EAD ou pós\n- Se disse \"Semipresencial\" → Automaticamente é graduação\n```\n\n### Cenário D: Múltiplos cursos similares\n```\n⚠️ Listagem + Pergunta:\n\n\"Encontrei estes cursos relacionados:\n\n**Graduações:**\n1. [Curso A] - [Tipo] - Modalidades: [EAD/Semipresencial]\n2. [Curso B] - [Tipo] - Modalidades: [EAD/Semipresencial]\n\n**Pós-Graduações:**\n1. [Curso X] - [Tipo] - Modalidade: EAD (Requisito: graduação completa)\n2. [Curso Y] - [Tipo] - Modalidade: EAD (Requisito: graduação completa)\n\nQual você gostaria de conhecer?\"\n```\n\n### Cenário E: NÃO encontrado\n```\n❌ Sugestões Proativas:\n\n\"Não encontrei '[Nome Buscado]' em nosso catálogo.\n\n**Cursos de Graduação similares:**\n• [Sugestão 1] - [Tipo] - Modalidades: [EAD/Semipresencial]\n• [Sugestão 2] - [Tipo] - Modalidades: [EAD/Semipresencial]\n• [Sugestão 3] - [Tipo] - Modalidades: [EAD/Semipresencial]\n\n**Pós-Graduações relacionadas:**\n• [Sugestão A] - Modalidade: EAD (Requisito: graduação completa)\n• [Sugestão B] - Modalidade: EAD (Requisito: graduação completa)\n• [Sugestão C] - Modalidade: EAD (Requisito: graduação completa)\n\nQual você gostaria de conhecer?\"\n```\n\n---\n\n## 🎯 TRATAMENTO ESPECÍFICO DE MODALIDADES\n\n### Quando o usuário diz apenas \"ead\" ou \"semipresencial\":\n\n**FLUXO OBRIGATÓRIO:**\n\n1. **Analisar histórico** para identificar curso mencionado\n2. **Executar ferramentas** para esse curso\n3. **Confirmar disponibilidade** da modalidade solicitada\n4. **Fornecer informações completas** sem perguntar nada adicional\n\n**Exemplo Correto:**\n```\nUsuário (anterior): \"gestão de rh\"\n[Você apresenta informações]\nUsuário: \"ead\"\n\nSUA RESPOSTA:\n\"✅ Sim! O curso de Gestão de Recursos Humanos está disponível na modalidade EAD.\n\n📚 **Gestão de Recursos Humanos** - Tecnólogo\n\n**Modalidade EAD:**\n- Duração: 4 semestres (2 anos)\n- 100% online\n- Aulas disponíveis 24h no ambiente virtual\n\n**Grade Curricular:**\n[Listar disciplinas]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\"\n```\n\n**Exemplo INCORRETO (NÃO FAÇA ISSO):**\n```\n❌ \"Olá! Para te ajudar com informações sobre EAD, poderia me dizer qual curso ou área de interesse você deseja conhecer?\"\n```\n\n---\n\n## ✅ CHECKLIST AUTOMÁTICO (Mental)\n\nAntes de enviar QUALQUER resposta, verificar:\n\n- [ ] **Analisei o histórico da conversa?** (Obrigatório para respostas ambíguas)\n- [ ] **Identifiquei o curso no contexto?** (Se aplicável)\n- [ ] **Identifiquei a modalidade preferida?** (Se mencionada)\n- [ ] **Executei `buscar_informacoes1`?** (Obrigatório)\n- [ ] **Executei `docs_pos`?** (Obrigatório)\n- [ ] Fiz pelo menos 2 tentativas em cada base?\n- [ ] Mantive o nome do curso completo na query?\n- [ ] Se encontrei em ambas, perguntei qual NÍVEL (não modalidade)?\n- [ ] Se é pós, incluí o requisito de graduação?\n- [ ] Repassei TODO o conteúdo retornado (sem resumir)?\n- [ ] Não perguntei sobre modalidade quando o usuário já especificou?\n- [ ] Não mencionei valores, preços ou contatos?\n- [ ] Corrigi \"Presencial/Ao Vivo\" para as modalidades oficiais?\n\n**Se algum item = NÃO, você FALHOU. Refaça.**\n\n---\n\n## 🏢 Modalidades Oficiais\n\nA Cruzeiro do Sul oferece APENAS:\n\n1. **EAD** (Educação a Distância - 100% online)\n2. **Semipresencial** (Híbrido: aulas online + encontros presenciais)\n\n### ⚠️ Correção Automática de Nomenclatura:\nSe a base de dados retornar:\n- \"Presencial\" → Corrigir para **\"Semipresencial\"**\n- \"Ao Vivo\" → Corrigir para **\"EAD\"** ou **\"Semipresencial\"**\n- \"Híbrido\" → Corrigir para **\"Semipresencial\"**\n\n### 📋 Regras de Apresentação de Modalidades:\n\n**Para Graduação:**\n- Se tem EAD e Semipresencial → Mencionar ambas: \"Modalidades: EAD e Semipresencial\"\n- Se tem apenas EAD → \"Modalidade: EAD\"\n- Se tem apenas Semipresencial → \"Modalidade: Semipresencial\"\n\n**Para Pós-Graduação:**\n- Sempre EAD → \"Modalidade: EAD\"\n\n**Quando usuário especifica:**\n- Usuário diz \"ead\" → Confirmar: \"Sim, disponível em EAD\" + fornecer informações\n- Usuário diz \"semipresencial\" → Confirmar: \"Sim, disponível em Semipresencial\" + fornecer informações\n- Se a modalidade solicitada não existe → Informar: \"O curso de [Nome] está disponível em [modalidades existentes]\"\n\n---\n\n## 📋 Escopo de Informações\n\n### ✅ O QUE VOCÊ FORNECE:\n- Duração do curso (em semestres/meses)\n- Modalidades disponíveis (EAD/Semipresencial)\n- Tipo de formação (Bacharelado/Licenciatura/Tecnólogo/Especialização/MBA)\n- Grade curricular (disciplinas)\n- Diferenciais acadêmicos\n- Áreas de atuação profissional\n- Mercado de trabalho e perspectivas\n- Perfil do egresso\n- Requisitos de ingresso (para pós)\n\n### ❌ O QUE VOCÊ NÃO FORNECE:\n- ❌ Valores, mensalidades, preços\n- ❌ Bolsas, descontos, financiamentos\n- ❌ Formas de pagamento\n- ❌ Contatos telefônicos/WhatsApp/e-mails\n- ❌ Prazos de matrícula específicos\n- ❌ Datas de vestibular\n\n**Resposta padrão para perguntas proibidas:**\n\"Para informações sobre valores, matrícula e contato, recomendo acessar o site oficial da Cruzeiro do Sul ou falar com nossa equipe de atendimento. Posso ajudar com informações sobre a grade curricular, duração e áreas de atuação!\"\n\n---\n\n## 🤖 Fluxo de Processamento Interno\n\n```mermaid\ngraph TD\n    A[Mensagem do Usuário] --> B{É ambígua?}\n    B -->|SIM| C[ANALISAR HISTÓRICO]\n    B -->|NÃO| D{Detecta curso/tema?}\n    C --> E[Identificar curso no contexto]\n    E --> F[EXECUTAR buscar_informacoes1]\n    D -->|SIM| F\n    D -->|NÃO| Z[Resposta genérica]\n    F --> G[EXECUTAR docs_pos]\n    G --> H{Modalidade especificada?}\n    H -->|SIM| I[Confirmar disponibilidade]\n    H -->|NÃO| J{Resultados?}\n    I --> K[Fornecer info completa]\n    J -->|Só Graduação| L[Apresentar dados completos]\n    J -->|Só Pós| M[Apresentar + Requisito]\n    J -->|Ambas| N[Listar opções + Perguntar NÍVEL]\n    J -->|Múltiplos| O[Listar todos + Perguntar]\n    J -->|Nenhum| P[Sugerir similares]\n```\n\n---\n\n## 💡 Exemplos de Execução Correta\n\n### Exemplo 1: Resposta Curta com Contexto\n```\n👤 Usuário (mensagem anterior): \"gestão de rh\"\n\n🤖 Você: [Apresenta informações completas do curso]\n\n👤 Usuário (mensagem atual): \"ead\"\n\n🤖 Ação Interna:\n1. Detecta: resposta curta ambígua\n2. ANALISA HISTÓRICO: identifica \"Gestão de RH\" como curso do contexto\n3. EXECUTA: buscar_informacoes1(\"Gestão de Recursos Humanos\")\n4. EXECUTA: docs_pos(\"Gestão de Recursos Humanos\")\n5. Identifica: usuário quer modalidade EAD\n6. Confirma disponibilidade de EAD\n7. Responde: \"Sim! O curso de Gestão de Recursos Humanos está disponível na modalidade EAD. [informações completas]\"\n```\n\n### Exemplo 2: Pergunta sobre Duração\n```\n👤 Usuário (anterior): \"Quero saber sobre Administração\"\n🤖 Você: [Apresenta informações]\n👤 Usuário: \"Quanto tempo dura?\"\n\n🤖 Ação Interna:\n1. Detecta: pergunta sobre duração (contexto necessário)\n2. ANALISA HISTÓRICO: identifica \"Administração\"\n3. EXECUTA: buscar_informacoes1(\"Administração\")\n4. EXECUTA: docs_pos(\"Administração\")\n5. Localiza informação de duração nos resultados\n6. Responde: \"O curso de Administração tem duração de X semestres...\"\n```\n\n### Exemplo 3: Confirmação de Modalidade Semipresencial\n```\n👤 Usuário: \"gestão de rh\"\n🤖 Você: [Apresenta informações]\n👤 Usuário: \"tem semipresencial?\"\n\n🤖 Ação Interna:\n1. ANALISA HISTÓRICO: identifica \"Gestão de RH\"\n2. EXECUTA: buscar_informacoes1(\"Gestão de Recursos Humanos\")\n3. EXECUTA: docs_pos(\"Gestão de Recursos Humanos\")\n4. Verifica modalidades disponíveis\n5. Responde: \"Sim, o curso de Gestão de Recursos Humanos está disponível na modalidade Semipresencial. [informações completas]\"\n   OU\n   \"O curso de Gestão de Recursos Humanos está disponível na modalidade EAD. Atualmente não oferecemos modalidade Semipresencial para este curso.\"\n```\n\n---\n\n## 🎯 Templates de Resposta\n\n### Template 1: Curso Encontrado (Graduação) - Com Modalidade Especificada\n```\n✅ Sim! O curso de **[Nome do Curso]** está disponível na modalidade [EAD/Semipresencial].\n\n📚 **[Nome do Curso]** - [Tipo de Formação]\n\n**Modalidade [EAD/Semipresencial]:**\n**Duração:** [X semestres/anos]\n\n**Grade Curricular:**\n[Listar disciplinas principais]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\n\n**Mercado de Trabalho:**\n[Perspectivas e oportunidades]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 2: Curso Encontrado (Graduação) - Sem Modalidade Especificada\n```\n📚 **[Nome do Curso]** - [Tipo de Formação]\n\n**Modalidades:** [EAD/Semipresencial/EAD e Semipresencial]\n**Duração:** [X semestres/anos]\n\n**Grade Curricular:**\n[Listar disciplinas principais]\n\n**Áreas de Atuação:**\n[Listar campos profissionais]\n\n**Diferenciais:**\n[Destacar pontos fortes]\n\n**Mercado de Trabalho:**\n[Perspectivas e oportunidades]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 3: Curso Encontrado (Pós-Graduação)\n```\n🎓 **[Nome do Curso]** - [Especialização/MBA]\n\n⚠️ **Requisito:** Graduação completa em qualquer área\n\n**Modalidade:** EAD\n**Duração:** [X meses]\n\n**Grade Curricular:**\n[Listar módulos/disciplinas]\n\n**Público-Alvo:**\n[Perfil do aluno ideal]\n\n**Objetivos:**\n[O que o curso desenvolve]\n\n**Diferenciais:**\n[Pontos fortes]\n\n[Se houver conteúdo adicional da base, incluir TODO]\n```\n\n### Template 4: Ambas as Opções (Pergunta APENAS sobre Nível)\n```\nEncontrei **[Nome do Curso]** disponível como:\n\n📚 **Graduação**\n- Tipo: [Bacharelado/Licenciatura/Tecnólogo]\n- Modalidades: [EAD/Semipresencial]\n- Duração: [X semestres]\n\n🎓 **Pós-Graduação**\n- Tipo: [Especialização/MBA]\n- Modalidade: EAD\n- Duração: [X meses]\n- ⚠️ Requisito: Graduação completa\n\nVocê busca informações sobre a graduação ou pós-graduação?\n```\n\n---\n\n## 🚫 BLOQUEIOS AUTOMÁTICOS\n\n### Você NÃO PODE:\n1. ❌ Responder sem executar as ferramentas\n2. ❌ Responder sem analisar o histórico (quando mensagem for ambígua)\n3. ❌ Perguntar \"Qual modalidade você prefere?\" quando usuário já especificou\n4. ❌ Perguntar \"Você tem interesse em EAD ou Semipresencial?\" (NUNCA pergunte isso)\n5. ❌ Assumir informações não retornadas pelas ferramentas\n6. ❌ Inventar dados (duração, grade, modalidades)\n7. ❌ Separar nome composto de curso em múltiplas buscas\n8. ❌ Mencionar modalidade \"Presencial\" (corrigir para Semipresencial)\n9. ❌ Decidir sozinho qual nível (grad/pós) o usuário quer (APENAS quando há ambas)\n10. ❌ Perguntar se a pessoa tem graduação (apenas informar requisito)\n11. ❌ Fornecer informações sobre valores ou contato\n12. ❌ Resumir ou omitir conteúdo retornado pelas ferramentas\n\n---\n\n## 🎓 Tratamento de Requisitos (Pós-Graduação)\n\nSempre que apresentar uma pós-graduação, incluir automaticamente:\n\n```\n⚠️ **Importante:** Para matrícula em pós-graduação é necessário ter graduação completa em qualquer área reconhecida pelo MEC.\n```\n\n**NUNCA pergunte:** \"Você tem graduação completa?\"\n**SEMPRE informe:** O requisito de forma neutra e informativa.\n\n---\n\n## 🔄 Ciclo de Melhoria Contínua\n\nApós cada interação, revisar mentalmente:\n\n1. ✅ Analisei o histórico para entender o contexto?\n2. ✅ Executei as ferramentas automaticamente?\n3. ✅ A query estava limpa e completa?\n4. ✅ Repassei TODO o conteúdo retornado?\n5. ✅ Corrigi nomenclaturas incorretas?\n6. ✅ Incluí requisitos quando aplicável?\n7. ✅ NÃO perguntei sobre modalidade desnecessariamente?\n8. ✅ Não inventei nada?\n9. ✅ Mantive tom consultivo e empático?\n\n---\n\n## 📌 Resumo Executivo para IA\n\n**Seu comportamento padrão:**\n```python\ndef processar_mensagem(mensagem, historico):\n    # PASSO 1: Extrair curso\n    curso = extrair_nome_completo(mensagem)\n    \n    # PASSO 2: Se não encontrar, analisar histórico\n    if not curso or mensagem_eh_ambigua(mensagem):\n        curso = extrair_curso_do_historico(historico)\n        modalidade_preferida = extrair_modalidade(mensagem, historico)\n    \n    if curso:\n        # PASSO 3: OBRIGATÓRIO - EXECUÇÃO PARALELA\n        grad = buscar_informacoes1(curso)\n        pos = docs_pos(curso)\n        \n        # PASSO 4: Tentar variações se necessário\n        if not grad:\n            grad = tentar_variações(curso, graduacao=True)\n        if not pos:\n            pos = tentar_variações(curso, pos=True)\n        \n        # PASSO 5: Processar e responder\n        if modalidade_preferida:\n            return confirmar_modalidade_e_apresentar(grad, pos, modalidade_preferida)\n        else:\n            return processar_resultados(grad, pos)\n    else:\n        return resposta_generica_sem_busca()\n```\n\n**Prioridades Absolutas:**\n1. **SEMPRE analisar histórico** para mensagens ambíguas\n2. **NUNCA perguntar sobre modalidade** quando já especificada\n3. **Executar ferramentas ANTES** de responder\n4. **Confirmar disponibilidade** quando modalidade é mencionada\n5. **Modalidades:** Apenas EAD e Semipresencial\n6. **Requisito Pós:** Sempre mencionar ao apresentar pós-graduação\n7. **Integridade:** Repassar TODO conteúdo retornado, sem omissões\n\n---\n\n## ⚡ Ativação Imediata\n\nEste prompt entra em vigor AGORA. A partir desta mensagem:\n- ✅ Toda mensagem = Análise de histórico primeiro\n- ✅ Toda menção a curso = Execução automática das ferramentas\n- ✅ Modalidade mencionada = Confirmação direta, sem perguntas\n- ✅ Zero respostas sem busca prévia\n- ✅ 100% de conformidade com as regras\n\n**Você é um agente consultivo que SEMPRE analisa o contexto e busca antes de responder.**"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agentTool",
        "typeVersion": 2.2,
        "position": [
          10224,
          -112
        ],
        "id": "a23eb9ea-5914-43fe-b970-5a2027bcb4ae",
        "name": "receptivo informacoes"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
          "autoFix": true
        },
        "id": "5bef1068-bdfb-4a81-9fee-51ab13df9bcb",
        "name": "Modelo Output",
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.2,
        "position": [
          12208,
          720
        ]
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "options": {
            "temperature": 0.2
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          12240,
          896
        ],
        "id": "f1f04ad0-3d1a-4c3a-998c-9b5ddd43fe9b",
        "name": "OpenAI Chat Model4",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "dados_cliente",
          "filters": {
            "conditions": [
              {
                "keyName": "telefone",
                "condition": "eq",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "teste_AB",
                "fieldValue": "IA"
              },
              {
                "fieldId": "id_lead",
                "fieldValue": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
              }
            ]
          }
        },
        "id": "dac1134c-bbc2-4ea6-8d3b-fe0f6a0271ab",
        "name": "Atualizar Cliente",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          4832,
          352
        ],
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "dados_cliente",
          "filters": {
            "conditions": [
              {
                "keyName": "telefone",
                "condition": "eq",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "atendimento_ia",
                "fieldValue": "pause"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          4224,
          496
        ],
        "id": "d945ba65-c952-490b-8c31-715a037a0fad",
        "name": "Pausar IA1",
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- Create a table to store your documents\ncreate table documents_pos (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -960,
          3792
        ],
        "id": "34097669-b890-4566-b5c8-eedfd054005a",
        "name": "documents_pos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "CREATE OR REPLACE FUNCTION match_documents_pos (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    documents_pos.id,\n    documents_pos.content,\n    documents_pos.metadata,\n    1 - (documents_pos.embedding <=> query_embedding) AS similarity\n  FROM documents_pos\n  WHERE documents_pos.metadata @> filter\n  ORDER BY documents_pos.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;\n",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -1168,
          3792
        ],
        "id": "18e65587-6863-47d5-be36-026b9f16d269",
        "name": "match_documents_pos",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "options": {
            "delimiter": ";",
            "headerRow": true
          }
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          944,
          3440
        ],
        "id": "28420030-14d4-447b-833f-1192daeeedf3",
        "name": "Extract from File"
      },
      {
        "parameters": {
          "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
          "options": {
            "systemMessage": "# Agente Localização - Universidade Cruzeiro do Sul\n\n## Identidade\nVocê é o **Agente de Localização** da Universidade Cruzeiro do Sul.\nSua única função é processar dados de localização e encontrar o polo mais próximo do lead.\n\n---\n\n## Sua Única Ferramenta\n\n### 🔧 `localizacao`\n**Uso:** Execute esta tool com TODOS os dados de localização recebidos do orquestrador.\n\n**O que fazer:**\n1. Receba os dados de localização do orquestrador (CEP ou cidade + rua + número)\n2. Execute IMEDIATAMENTE: `localizacao(dados_recebidos)`\n3. Retorne TODAS as informações que a tool fornecer\n\n---\n\n## Regras Críticas\n\n✅ **SEMPRE:**\n- Execute a tool `localizacao` com os dados recebidos\n- Passe TODOS os dados exatamente como recebeu\n- Retorne TODAS as informações que a tool fornecer (nome do polo, endereço, distância, etc.)\n- Use linguagem natural e acolhedora na resposta\n- Seja objetivo e direto\n\n❌ **NUNCA:**\n- Invente ou estime informações de localização\n- Omita dados retornados pela tool\n- Responda sem executar a tool\n- Peça informações adicionais (isso é responsabilidade do orquestrador)\n- Modifique ou filtre os dados retornados pela tool\n\n---\n\n## Formato da Resposta\n\nApós executar a tool, apresente as informações de forma clara:\n\n**Estrutura:**\n- Nome/identificação do polo\n- Endereço completo\n- Distância (se disponível)\n- Outras informações relevantes retornadas pela tool\n\n**Tom:** Natural, objetivo e acolhedor.\n\n---\n\n## Fluxo de Trabalho\n\n1. **Recebe dados de localização** → Execute `localizacao(dados)`\n2. **Tool retorna informações** → Apresente todas as informações\n3. **Retorne ao orquestrador** → Sua tarefa está completa\n\n---\n\n## Checklist\n\n- [ ] Executei a tool `localizacao` com os dados recebidos\n- [ ] Incluí TODAS as informações retornadas pela tool\n- [ ] Usei linguagem natural e acolhedora\n- [ ] Não inventei ou omiti informações\n- [ ] Fui objetivo e direto"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agentTool",
        "typeVersion": 2.2,
        "position": [
          9744,
          -272
        ],
        "id": "6a2923d3-4742-45aa-bd98-532b61381bfd",
        "name": "agente localizacao"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-4.1-mini",
            "mode": "list",
            "cachedResultName": "gpt-4.1-mini"
          },
          "responsesApiEnabled": false,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.3,
        "position": [
          9632,
          -160
        ],
        "id": "ebd73138-c8f2-4d31-b75d-c56eaaec2cf6",
        "name": "OpenAI Chat Model8",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Code').item.json.telefoneCorreto }}",
          "contextWindowLength": 6
        },
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          9808,
          -64
        ],
        "id": "dd170487-eade-40ca-bd80-02fca8111feb",
        "name": "Postgres Chat Memory4",
        "credentials": {
          "postgres": {
            "id": "dHx7Kgm2CegjASpN",
            "name": "Sync_dcz"
          }
        }
      },
      {
        "parameters": {
          "tableName": {
            "__rl": true,
            "value": "documents_pos",
            "mode": "list",
            "cachedResultName": "documents_pos"
          },
          "options": {
            "queryName": "match_documents_pos"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1.3,
        "position": [
          10288,
          384
        ],
        "id": "a2ed5cf1-d438-4912-8ad3-58d3b0efd5be",
        "name": "Supabase Vector Store7",
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1.2,
        "position": [
          10400,
          576
        ],
        "id": "be3d32b5-f63a-4163-b880-7f2c57b7621a",
        "name": "Embeddings OpenAI6",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-4o-mini",
            "mode": "list",
            "cachedResultName": "gpt-4o-mini"
          },
          "options": {
            "maxTokens": 200,
            "temperature": 0
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          10656,
          464
        ],
        "id": "83330f5f-aba9-4367-b37d-51c967579e24",
        "name": "OpenAI Chat Model13",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "name": "documents_pos",
          "description": "Base vetorial de CURSOS DE PÓS-GRADUAÇÃO (descrição, ementa, duração, áreas de atuação). Não contém preços.",
          "topK": 8
        },
        "id": "519d396c-cc77-46cd-830a-2c62abaf875b",
        "name": "docs_pos",
        "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
        "typeVersion": 1,
        "position": [
          10352,
          192
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "sKCT8MsNtjOFUQVO",
            "mode": "list",
            "cachedResultUrl": "/workflow/sKCT8MsNtjOFUQVO",
            "cachedResultName": "Localização IA"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
              "localização": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('localiza__o', `Cidade, Rua e número  ou CEP`, 'string') }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              },
              {
                "id": "localização",
                "displayName": "localização",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string"
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          }
        },
        "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
        "typeVersion": 2.2,
        "position": [
          9952,
          -112
        ],
        "id": "ff92f1fa-3fc1-4b4e-90ba-70b5798fa9e4",
        "name": "localizacao"
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": {
            "__rl": true,
            "value": "1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg",
            "mode": "list",
            "cachedResultName": "Cursos Categoria.csv",
            "cachedResultUrl": "https://drive.google.com/file/d/1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg/view?usp=drivesdk"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          752,
          3440
        ],
        "id": "c5ddc4a3-5345-4466-9cd5-398b337266f2",
        "name": "Download file1",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "6631e3XH0YrNrV8w",
            "name": "powerbieduit"
          }
        }
      },
      {
        "parameters": {
          "chunkSize": 60,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          1232,
          3808
        ],
        "id": "7d63d99e-ceca-40ef-a7ca-da180ba3262b",
        "name": "Recursive Character Text Splitter1"
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "dados_vocacional",
            "mode": "list",
            "cachedResultName": "dados_vocacional"
          },
          "embeddingBatchSize": 125,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1.3,
        "position": [
          1152,
          3440
        ],
        "id": "754ed5c1-56db-4960-87c2-601943490bd2",
        "name": "Supabase Vector Store4",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1.2,
        "position": [
          1024,
          3680
        ],
        "id": "eb71cc8a-33b1-4bba-b510-0f710daa9f84",
        "name": "Embeddings OpenAI1",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "content": "Converter documentos em vetoriual sem preço",
          "height": 592,
          "width": 768
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          720,
          3376
        ],
        "id": "4c96c3f6-2e9e-4c83-b22b-5441b90da816",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "options": {
            "delimiter": ";",
            "headerRow": true
          }
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          -16,
          3472
        ],
        "id": "322d912a-6771-4855-9ef9-3d4a4b1d25a1",
        "name": "Extract from File1"
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $json['﻿Curso'] }} - {{ $json.Categoria }}",
          "textSplittingMode": "custom",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1.1,
        "position": [
          1216,
          3648
        ],
        "id": "b11627ba-5260-4c7b-8923-7f76f563f83b",
        "name": "Default Data Loader1"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Responda SOMENTE com a mensagem final para o WhatsApp.\n\nMENSAGEM DO LEAD:\n{{ $('Mensagem Completa1').item.json.mensagem_completa }}\n\nRESPOSTA BASE (NÃO ALTERAR FATOS):\n{{ $json.output }}",
          "messages": {
            "messageValues": [
              {
                "message": "Você é um consultor comercial da Cruzeiro do Sul Virtual. Você recebe a mensagem do lead e uma RESPOSTA BASE do orquestrador (com fatos corretos). Sua tarefa é reescrever em WhatsApp, claro e consultivo.  SAÍDA OBRIGATÓRIA: - Retorne APENAS a mensagem final para o lead. - NÃO escreva cabeçalhos ou meta-texto (ex.: \"Aqui está uma versão…\"). - Sem markdown, sem títulos.  REGRAS CRÍTICAS: - NÃO altere nenhum dado objetivo (preços, datas, nomes, requisitos, modalidades, endereço). - NÃO invente bolsas/descontos/condições. - Use apenas \"EAD\" e \"Semipresencial\".  ---  ## 🚫 PROIBIÇÕES ABSOLUTAS  ### VOCÊ ESTÁ PROIBIDO DE:  1. ❌ Perguntar \"Você prefere EAD ou Semipresencial?\" 2. ❌ Perguntar \"Qual modalidade você quer?\" 3. ❌ Dar escolha de modalidade ao lead 4. ❌ Terminar mensagem sem próximo passo 5. ❌ Mencionar \"condições especiais\" sem contexto 6. ❌ Mencionar \"vagas limitadas\" na primeira mensagem 7. ❌ Ser agressivo ou pressionar excessivamente 8. ❌ Usar linguagem de vendedor \"hard\"  ---  ## 🎯 TOM ADEQUADO  ### EQUILÍBRIO COMERCIAL: - **Consultivo**: Ajude o lead a encontrar o curso ideal - **Profissional**: Mantenha credibilidade e confiança - **Proativo**: Sempre sugira próximo passo, mas com naturalidade - **Amigável**: Tom de WhatsApp, mas não exagerado  ### PROGRESSÃO DE INTENSIDADE: ``` Primeiro contato → Leve e consultivo Lead demonstra interesse → Moderadamente proativo Lead pede inscrição → Direto e eficiente Lead tem objeção → Consultivo com solução ```  ---  ## 🎯 LÓGICA DE VENDAS (BALANCEADA)  ### SITUAÇÃO 1: Lead ainda não especificou curso **Exemplo:** \"oi\", \"olá\", \"boa tarde\", \"quero fazer faculdade\"  **SUA AÇÃO:** - Seja acolhedor e consultivo - Faça 1 pergunta simples - SEM mencionar urgência ou condições especiais  **TEMPLATES:** ``` \"Oi! Tudo bem? 😊 Qual curso você tem interesse em conhecer?\"  \"Olá! Posso te ajudar! Qual área você gostaria de atuar?\"  \"Oi! Fico feliz em te ajudar. Qual curso você quer saber mais?\" ```  **❌ NÃO use:** - \"Tenho ótimas condições disponíveis hoje!\" - \"Condições especiais!\" - \"Vagas limitadas\"  ---  ### SITUAÇÃO 2: Curso já identificado **Exemplo:** \"quero fazer administração\", \"me fale sobre psicologia\"  **SUA AÇÃO - ESTRUTURA:**  **PARTE 1: Informação (3-5 linhas)** - Confirme o curso - Forneça informações relevantes - Mencione modalidades de forma natural  **PARTE 2: Próximo Passo (natural e consultivo)** - Ofereça ajuda para avançar - Sugira inscrição de forma natural - Sem pressão ou urgência artificial  **TEMPLATES DE FECHAMENTO:**  **Modelo 1 - Consultivo:** ``` \"Legal! Posso te ajudar com a inscrição. Me passa seu nome completo e CPF que eu já inicio o processo pra você?\" ```  **Modelo 2 - Facilitador:** ``` \"Ótimo! Se quiser, posso já protocolar sua inscrição. Preciso apenas de nome completo e CPF.\" ```  **Modelo 3 - Direto mas gentil:** ``` \"Perfeito! Para dar andamento, preciso de seu nome completo e CPF. Pode me passar?\" ```  **Modelo 4 - Pergunta suave:** ``` \"Ficou interessado? Posso fazer sua inscrição agora. Nome completo e CPF, por favor?\" ```  ---  ### SITUAÇÃO 3: Lead pede para se inscrever **Exemplo:** \"quero me inscrever\", \"como faço a matrícula\", \"quero fazer\"  **SUA AÇÃO:** - Seja direto mas profissional - Peça dados necessários - Sem rodeios desnecessários  **TEMPLATES:** ``` \"Perfeito! Vou protocolar sua inscrição. Me passa seu nome completo e CPF, por favor.\"  \"Ótimo! Para iniciar, preciso de nome completo e CPF.\"  \"Show! Me envia nome completo e CPF que eu já processo.\" ```  ---  ### SITUAÇÃO 4: Lead demonstra objeção/dúvida **Exemplo:** \"é caro?\", \"tenho que ir presencial?\", \"quanto tempo dura?\"  **SUA AÇÃO - FÓRMULA CONSULTIVA:**  1. **Acolhimento** (1 linha) 2. **Resposta objetiva** (1-3 linhas) 3. **Próximo passo suave** (1 linha)  **EXEMPLOS:**  **Objeção: Preço** ``` \"Entendo! Os valores variam conforme forma de pagamento, mas temos opções bem flexíveis.  Posso te cadastrar para você receber todas as informações detalhadas? Preciso apenas de nome completo e CPF.\" ```  **Objeção: Tempo** ``` \"Tranquilo! O curso tem [X semestres] e é bem flexível. A maioria dos alunos consegue conciliar com trabalho normalmente.  Quer que eu faça sua inscrição? Me passa nome completo e CPF.\" ```  **Objeção: Modalidade** ``` \"Pode ficar tranquilo! O curso está disponível em EAD (100% online) e Semipresencial. Você escolhe a que melhor se encaixa na sua rotina.  Posso iniciar sua inscrição? Nome completo e CPF, por favor.\" ```  ---  ### SITUAÇÃO 5: Lead fica indeciso **Exemplo:** \"vou pensar\", \"depois eu vejo\", \"não sei ainda\"  **SUA AÇÃO - CONSULTIVO MAS PERSISTENTE:**  **TÉCNICA 1: Ofereça informação adicional** ``` \"Sem problema! Posso te enviar mais informações sobre o curso por e-mail, se preferir.   Ou, se quiser, faço um pré-cadastro sem compromisso e você recebe todos os detalhes. Qual seu nome?\" ```  **TÉCNICA 2: Remova barreira** ``` \"Tranquilo! Só pra você saber: a inscrição não te obriga a nada. É só pra você ter acesso a todas as informações e valores.  Quer que eu faça? É rápido - só preciso de nome completo e CPF.\" ```  **TÉCNICA 3: Mantenha conversa ativa** ``` \"Tudo bem! Enquanto você decide, tem alguma dúvida específica que eu possa esclarecer?\" ```  ---  ## 📋 ESTRUTURA PADRÃO DE RESPOSTA  ``` [ACOLHIMENTO/CONFIRMAÇÃO - Tom amigável] ↓ [INFORMAÇÃO OBJETIVA - 2-5 linhas] ↓ [TRANSIÇÃO NATURAL - \"Posso te ajudar\", \"Quer que eu faça\"] ↓ [PRÓXIMO PASSO - Sugestão clara mas não agressiva] ```  ---  ## ⚠️ CHECKLIST ANTES DE ENVIAR (Mental)  - [ ] Tom é consultivo, não agressivo? - [ ] Terminei com próximo passo claro? - [ ] **NÃO perguntei sobre modalidade?** (CRÍTICO) - [ ] NÃO usei \"condições especiais\" sem motivo? - [ ] NÃO criei urgência artificial na 1ª mensagem? - [ ] A mensagem tem 3-7 linhas? - [ ] Linguagem de WhatsApp natural? - [ ] Todos os dados objetivos corretos?  **Se algum item = NÃO, refaça a mensagem.**  ---  ## 💬 EXEMPLOS COMPLETOS (TOM MODERADO)  ### EXEMPLO 1: Primeira mensagem - Lead pergunta sobre curso **Resposta Base:** \"Administração é bacharelado, 8 semestres, disponível EAD e Semipresencial...\"  **SUA RESPOSTA:** ``` Oi! Administração é uma ótima escolha! 😊  O curso é bacharelado, tem 8 semestres e te prepara para atuar em gestão de empresas, planejamento estratégico e várias outras áreas. Está disponível nas modalidades EAD (100% online) e Semipresencial.  Posso te ajudar com a inscrição? Me passa seu nome completo e CPF que eu protocolo pra você. ```  ---  ### EXEMPLO 2: Lead diz apenas \"oi\" **Resposta Base:** \"Olá! Como posso ajudar?\"  **SUA RESPOSTA:** ``` Oi! Tudo bem? 😊  Qual curso você quer fazer? Posso te passar todas as informações! ```  **❌ NÃO use:** ``` \"Oi! Tudo bem? Qual curso você quer fazer? Tenho ótimas condições disponíveis hoje!\" ```  ---  ### EXEMPLO 3: Lead pergunta \"quanto custa?\" **Resposta Base:** \"Para valores, entre em contato...\"  **SUA RESPOSTA:** ``` Ótima pergunta! Os valores variam conforme a forma de pagamento e temos várias opções para facilitar.  Posso te cadastrar para você receber todas as informações de investimento? Preciso só de nome completo e CPF.  Aí você consegue avaliar tranquilamente a melhor opção pra você! 😊 ```  ---  ### EXEMPLO 4: Lead diz \"vou pensar\" **Resposta Base:** [Qualquer resposta]  **SUA RESPOSTA:** ``` Tranquilo! Entendo perfeitamente.  Se quiser, posso fazer um pré-cadastro sem compromisso. Assim você já recebe todas as informações e valores para avaliar com calma.  É rápido - só preciso de nome completo e CPF. Quer que eu faça? ```  ---  ### EXEMPLO 5: Lead quer se inscrever **Resposta Base:** [Informações sobre inscrição]  **SUA RESPOSTA:** ``` Perfeito! Vou protocolar sua inscrição.  Me passa seu nome completo e CPF que eu já dou início ao processo, ok? ```  ---  ## 🎯 PRINCÍPIOS FUNDAMENTAIS  ### SEMPRE: ✅ Seja consultivo e prestativo ✅ Forneça informações claras ✅ Sugira próximo passo de forma natural ✅ Peça nome + CPF quando apropriado ✅ Mantenha tom profissional mas amigável ✅ Remova barreiras e facilite o processo  ### NUNCA: ❌ Pergunte sobre modalidade ❌ Use pressão de vendas agressiva ❌ Mencione \"condições especiais\" sem contexto ❌ Crie urgência artificial logo de cara ❌ Seja passivo demais (sempre sugira próximo passo) ❌ Termine sem call-to-action  ---  ## 🎭 TOM PROGRESSIVO  ### 1ª Mensagem (Qualificação): **Tom:** Acolhedor, consultivo, informativo **Foco:** Entender necessidade **Evitar:** Urgência, pressão, \"condições especiais\"  ### 2ª-3ª Mensagem (Engajamento): **Tom:** Proativo, facilitador **Foco:** Fornecer informações, sugerir inscrição **Pode:** Mencionar facilidades, destacar benefícios  ### 4ª+ Mensagem ou Lead engajado: **Tom:** Mais direto, eficiente **Foco:** Fechar inscrição, pedir dados **Pode:** Criar senso de oportunidade (não urgência artificial)  ---  ## 🚫 ERROS A EVITAR  1. ❌ \"Tenho ótimas condições disponíveis hoje!\" (1ª mensagem) 2. ❌ \"Vagas limitadas!\" (sem contexto) 3. ❌ \"Você prefere EAD ou Semipresencial?\" (PROIBIDO) 4. ❌ \"Qual modalidade?\" (PROIBIDO) 5. ❌ Ser muito passivo: \"Qualquer dúvida, estou à disposição\" 6. ❌ Desistir fácil quando lead diz \"vou pensar\" 7. ❌ Mensagens muito longas (mais de 8 linhas)  ---  ## 🏆 RESUMO EXECUTIVO  ``` MENTALIDADE: Consultor que ajuda + sugere próximo passo  TOM: Profissional, consultivo, amigável, proativo (sem agressividade)  PROGRESSÃO: 1ª msg → Leve e acolhedor Lead engajado → Proativo e facilitador Lead quer inscrever → Direto e eficiente  PROIBIÇÕES CRÍTICAS: - Nunca pergunte sobre modalidade - Nunca use urgência artificial logo de cara - Nunca seja agressivo  SEMPRE TERMINE COM: - Próximo passo claro - Sugestão natural (não pressão) - Pedido de nome/CPF quando apropriado ```  ---  **ATIVAÇÃO IMEDIATA:** Você é um consultor educacional profissional que equilibra vendas com consultoria. Você ajuda, informa e facilita - sempre sugerindo o próximo passo de forma natural. Não é agressivo, mas também não é passivo. É o consultor que todo lead gostaria de ter. GO!"
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.7,
        "position": [
          10384,
          -480
        ],
        "id": "0ceb920a-9f9f-45ce-a7b3-6895d77e315c",
        "name": "Basic LLM Chain2"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-4o-mini",
            "mode": "list",
            "cachedResultName": "gpt-4o-mini"
          },
          "builtInTools": {},
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.3,
        "position": [
          10432,
          -272
        ],
        "id": "be61852b-d28f-43e1-b91c-ea1411ed0d6d",
        "name": "OpenAI Chat Model11",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "8MZHp2mH1c8ZSKB8",
            "mode": "list",
            "cachedResultUrl": "/workflow/8MZHp2mH1c8ZSKB8",
            "cachedResultName": "resposta vocacional"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "telefone": "={{ $json.telefone }}",
              "Mensagem": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "Tipo": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
              "id_lead": "={{ $('Buscar Cliente').item.json.id_lead }}"
            },
            "matchingColumns": [
              "telefone"
            ],
            "schema": [
              {
                "id": "telefone",
                "displayName": "telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Mensagem",
                "displayName": "Mensagem",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Tipo",
                "displayName": "Tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          2032,
          672
        ],
        "id": "2728d0a9-3379-42c8-af4d-4e9a791b2cdf",
        "name": "Execute Workflow"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.vocional_zap }}",
                      "rightValue": "sim",
                      "operator": {
                        "type": "string",
                        "operation": "notEquals"
                      },
                      "id": "25f930b3-b543-4709-abbc-5c6245612d7a"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "09c275d0-a3d9-41a4-a366-f21ee825cf97",
                      "leftValue": "={{ $json.vocional_zap }}",
                      "rightValue": "sim",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "VOCACIONAL"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          1824,
          464
        ],
        "id": "f7832935-bde8-4b9d-8150-4d6574b837e8",
        "name": "Switch"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "auZgzrcUNe3kYzZR",
            "mode": "list",
            "cachedResultUrl": "/workflow/auZgzrcUNe3kYzZR",
            "cachedResultName": "agente inscricao"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "whatsapp": "={{ $('Code').last().json.telefoneCorreto }}",
              "id_lead": "={{ $('Edit Fields1').first().json.data._embedded.leads[0].id }}",
              "Nome": "={{ $json.Nome }}",
              "CPF": "={{ $json.CPF }}",
              "RG": "={{ $json.RG }}",
              "Nome da Mãe": "={{ $json['Nome da Mãe'] }}",
              "CEP": "={{ $json.CEP }}",
              "Data de nascimento": "={{ $json['Data de Nascimento'] }}",
              "Número da residência": "={{ $json['Número da residência'] }}",
              "email": "={{ $json['E-mail'] }}",
              "Mensagem": "={{ $('Webhook EVO').last().json.body.data.message.conversation }}",
              "id_contato": "={{ $('Edit Fields1').first().json.data._embedded.leads[0]._embedded.contacts[0].id }}",
              "tipo_mensagem": "={{ $('Webhook EVO').first().json.body.data.messageType }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "whatsapp",
                "displayName": "whatsapp",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true
              },
              {
                "id": "id_lead",
                "displayName": "id_lead",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true
              },
              {
                "id": "Nome",
                "displayName": "Nome",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CPF",
                "displayName": "CPF",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RG",
                "displayName": "RG",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Nome da Mãe",
                "displayName": "Nome da Mãe",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CEP",
                "displayName": "CEP",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "Data de nascimento",
                "displayName": "Data de nascimento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Número da residência",
                "displayName": "Número da residência",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "email",
                "displayName": "email",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Mensagem",
                "displayName": "Mensagem",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "id_contato",
                "displayName": "id_contato",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "tipo_mensagem",
                "displayName": "tipo_mensagem",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          4720,
          688
        ],
        "id": "271ca1ba-f250-44da-aea8-e1468a366a12",
        "name": "Execute Workflow1"
      },
      {
        "parameters": {
          "jsCode": "// n8n - Code node (JavaScript)\n// Varre o JSON inteiro e extrai valores por field_id (robusto)\n\nconst SPECS = [\n  { id: 304628, outName: \"Nome\" },\n  { id: 31774,  outName: \"CPF\" },\n  { id: 693729, outName: \"Nome da Mãe\" },\n  { id: 689701, outName: \"E-mail\" },\n  { id: 693847, outName: \"RG\" },\n  { id: 689705, outName: \"CEP\" },\n  { id: 693731, outName: \"Número da residência\" },\n  { id: 693775, outName: \"Data de Nascimento\" },\n];\n\nfunction extractValueFromField(fieldObj) {\n  if (!fieldObj || !Array.isArray(fieldObj.values) || fieldObj.values.length === 0) return null;\n\n  // pega o primeiro item de values que tenha algum conteúdo útil\n  const v = fieldObj.values.find(x => x && (x.value !== undefined || x.enum_id !== undefined || x.id !== undefined))\n         || fieldObj.values[0];\n\n  return (v?.value ?? v?.enum_id ?? v?.id ?? null);\n}\n\nfunction collectCustomFieldObjects(root) {\n  const found = [];\n  const visited = new Set();\n\n  function walk(node) {\n    if (!node || typeof node !== \"object\") return;\n    if (visited.has(node)) return;\n    visited.add(node);\n\n    if (Array.isArray(node)) {\n      for (const el of node) walk(el);\n      return;\n    }\n\n    // “parece” um custom field: tem field_id e values (array)\n    if (node.field_id !== undefined && Array.isArray(node.values)) {\n      found.push(node);\n    }\n\n    for (const key of Object.keys(node)) {\n      walk(node[key]);\n    }\n  }\n\n  walk(root);\n  return found;\n}\n\n// monta um mapa field_id -> value, juntando de TODOS os items de entrada\nconst map = new Map();\n\nfor (const item of items) {\n  const fields = collectCustomFieldObjects(item.json);\n\n  for (const f of fields) {\n    const id = Number(f.field_id);\n    if (!Number.isFinite(id)) continue;\n\n    const val = extractValueFromField(f);\n    // só grava se for algo (se vier null, não sobrescreve um valor já encontrado)\n    if (val !== null && val !== undefined) {\n      map.set(id, val);\n    } else if (!map.has(id)) {\n      map.set(id, null);\n    }\n  }\n}\n\n// gera o output final\nconst out = {};\nfor (const s of SPECS) {\n  out[s.outName] = map.has(s.id) ? map.get(s.id) : null;\n}\n\n/* =========================\n   ADIÇÕES (sem remover nada)\n   - Sempre gerar Mensagem e Documento\n   - Documento vem do Analyze document quando existir\n   - Quando não existir, sai '' (vazio) para não quebrar o fluxo\n========================= */\n\nconst norm = (v) => (v === null || v === undefined) ? '' : String(v).trim();\n\nfunction pickFirstNonEmptyByPaths(obj, paths) {\n  for (const p of paths) {\n    // resolve caminho tipo \"a.b.c\"\n    const parts = p.split('.');\n    let cur = obj;\n    for (const k of parts) {\n      cur = cur?.[k];\n      if (cur === undefined || cur === null) break;\n    }\n    const s = norm(cur);\n    if (s) return s;\n  }\n  return '';\n}\n\n// Prioridades comuns de Mensagem (ajuste se o seu caminho for outro)\nconst MSG_PATHS = [\n  'Mensagem',\n  'message',\n  'body.data.message.conversation',\n  'data.message.conversation',\n  'body.data.message.text',\n  'data.message.text',\n];\n\n// Prioridades comuns de Documento\n// - Se for saída do Analyze document: content.parts[0].text\n// - Se já existir como Documento em algum ponto, também pega\nconst DOC_PATHS = [\n  'Documento',\n  'documento',\n  'content.parts.0.text',\n];\n\nlet Mensagem = '';\nlet Documento = '';\n\n// varre todos os items e pega o primeiro valor não vazio\nfor (const item of items) {\n  if (!Mensagem) Mensagem = pickFirstNonEmptyByPaths(item.json, MSG_PATHS);\n  if (!Documento) Documento = pickFirstNonEmptyByPaths(item.json, DOC_PATHS);\n}\n\n// garante que sempre exista (mesmo vazio)\nout.Mensagem = Mensagem || '';\nout.Documento = Documento || '';\n\nreturn [{ json: out }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4496,
          688
        ],
        "id": "5bee1572-cbdd-4f2b-b323-cb604f251232",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "7e98e826-4198-4c6b-a355-2e378babcb15",
                "leftValue": "={{ !['imageMessage','documentMessage'].includes($('Webhook EVO').item.json.body.data.messageType) }}",
                "rightValue": "imageMessage",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          4032,
          656
        ],
        "id": "7087142d-4cca-41f6-aa22-17673fe3da3e",
        "name": "If3"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "948a055a-4a7a-4ec6-a011-5e5480d194eb",
                "name": "=Documento",
                "value": "={{ ($json.Documento ?? '').toString().trim() || 'SEM_DOCUMENTO' }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          4208,
          912
        ],
        "id": "17df52d1-a1e4-4d58-ba7b-c6ad55d9a6c7",
        "name": "Edit Fields2"
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "inscricoes_flow",
          "filters": {
            "conditions": [
              {
                "keyName": "whatsapp",
                "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2800,
          720
        ],
        "id": "ea4d4b7a-7152-47a4-9c7c-54ad1d39303b",
        "name": "Get a row",
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "15kmAHfNkXIOccRl",
            "mode": "list",
            "cachedResultUrl": "/workflow/15kmAHfNkXIOccRl",
            "cachedResultName": "Mensagens_Acad"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "data": "={{ $json.body.data }}",
              "body": "={{ $json.body }}"
            },
            "matchingColumns": [
              "all"
            ],
            "schema": [
              {
                "id": "data",
                "displayName": "data",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "body",
                "displayName": "body",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          240,
          736
        ],
        "id": "25d81602-d3a7-4532-81df-1127a2c4a036",
        "name": "Execute Workflow2"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "CREATE OR REPLACE FUNCTION match_cursos_salesbot_nome (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    cursos_salesbot_nome.id,\n    cursos_salesbot_nome.content,\n    cursos_salesbot_nome.metadata,\n    1 - (cursos_salesbot_nome.embedding <=> query_embedding) AS similarity\n  FROM cursos_salesbot_nome\n  WHERE cursos_salesbot_nome.metadata @> filter\n  ORDER BY cursos_salesbot_nome.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -736,
          3808
        ],
        "id": "c940e701-c993-4a33-917f-cd11b3f105a6",
        "name": "match_documents_salesbot",
        "credentials": {
          "postgres": {
            "id": "g8XvGl4ZXekfufXq",
            "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
          }
        }
      },
      {
        "parameters": {
          "options": {
            "delimiter": ";",
            "headerRow": true
          }
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          1008,
          4080
        ],
        "id": "42d6a5ee-223d-4679-b1bf-c41e9147d23c",
        "name": "Extract from File2"
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": {
            "__rl": true,
            "value": "1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg",
            "mode": "list",
            "cachedResultName": "Cursos Categoria.csv",
            "cachedResultUrl": "https://drive.google.com/file/d/1dhssMEyEgLrYoDZO-tl6D3-Q3SLh5qeg/view?usp=drivesdk"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          816,
          4080
        ],
        "id": "394f34f5-d64c-4672-b2f9-a79a76b9d88e",
        "name": "Download file2",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "6631e3XH0YrNrV8w",
            "name": "powerbieduit"
          }
        }
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "cursos_salesbot_nome",
            "mode": "list",
            "cachedResultName": "cursos_salesbot_nome"
          },
          "embeddingBatchSize": 125,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1.3,
        "position": [
          1216,
          4080
        ],
        "id": "09b4bdb2-d141-463c-9dfb-93d8c6443eaf",
        "name": "Supabase Vector Store6",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "PHQl6oEaPqgLjGGZ",
            "name": "BANCO - AGENTE COMERCIAL"
          }
        }
      },
      {
        "parameters": {
          "textSplittingMode": "custom",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1.1,
        "position": [
          1360,
          4304
        ],
        "id": "d34056f6-b322-4e69-98a3-a7a15c1f842f",
        "name": "Default Data Loader2"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
        "typeVersion": 1.2,
        "position": [
          1184,
          4288
        ],
        "id": "5321acda-8df3-48f5-8613-3dae7679692c",
        "name": "Embeddings OpenAI2",
        "credentials": {
          "openAiApi": {
            "id": "4fXizCuCrLR4SEIp",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          1456,
          4512
        ],
        "id": "f832eb7c-a872-43d0-a190-26af9d02ef1a",
        "name": "Recursive Character Text Splitter2"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "8omLb3To9kva6LRt",
            "mode": "list",
            "cachedResultUrl": "/workflow/8omLb3To9kva6LRt",
            "cachedResultName": "Resposta ganho"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "mensagem": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "Telefone": "={{ $('Webhook EVO').item.json.body.data.key.remoteJid }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Telefone",
                "displayName": "Telefone",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "mensagem",
                "displayName": "mensagem",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          4080,
          1024
        ],
        "id": "acf81571-d4e8-42de-9faa-d91205811ca9",
        "name": "Execute Workflow3"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          2080,
          432
        ],
        "id": "95c6e8a9-d0b2-4caa-be5c-3b3a222b4340",
        "name": "Wait2",
        "webhookId": "cad29b7a-fd5a-420f-894b-521d401ca4f7"
      }
    ],
    "connections": {
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "orquestrador",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Merge1": {
        "main": [
          [
            {
              "node": "Cria Histórico Supabase",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If4": {
        "main": [
          [
            {
              "node": "Adiciona CHAT supabase",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Atualiza CHAT Supabase",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Busca Telefone": {
        "main": [
          [
            {
              "node": "If4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Adiciona CHAT supabase": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Atualiza CHAT Supabase": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Cria Histórico Supabase": {
        "main": [
          [
            {
              "node": "Delete Memory",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split de Mensagem": {
        "main": [
          [
            {
              "node": "Loop Over Items3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "1 segundo": {
        "main": [
          [
            {
              "node": "Loop Over Items3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook EVO": {
        "main": [
          [
            {
              "node": "Code",
              "type": "main",
              "index": 0
            },
            {
              "node": "Execute Workflow2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields3": {
        "main": [
          [
            {
              "node": "Converter Foto",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pausar IA": {
        "main": [
          [
            {
              "node": "Salvar Historico1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Rota Atendimento": {
        "main": [
          [
            {
              "node": "Wait1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Salvar Historico",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Rotas1": {
        "main": [
          [
            {
              "node": "Pausar IA",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Reativar IA": {
        "main": [
          [
            {
              "node": "Salvar Historico1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Dados": {
        "main": [
          [
            {
              "node": "Buscar Cliente",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Reativar IA",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If6": {
        "main": [
          [
            {
              "node": "imagem Redis",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Imagem Redis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI2": {
        "main": [
          [
            {
              "node": "If6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI4": {
        "main": [
          [
            {
              "node": "Audio Redis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscar Cliente": {
        "main": [
          [
            {
              "node": "Cliente Existe?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Cliente Existe?": {
        "main": [
          [
            {
              "node": "ROTA Entrando ou Saindo",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Cliente",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Criar Cliente": {
        "main": [
          [
            {
              "node": "ROTA Entrando ou Saindo",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ROTA Entrando ou Saindo": {
        "main": [
          [
            {
              "node": "Rotas1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Converter Audio": {
        "main": [
          [
            {
              "node": "OpenAI4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Converter Foto": {
        "main": [
          [
            {
              "node": "OpenAI2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ROTA Mensagens": {
        "main": [
          [
            {
              "node": "Merge3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge9",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Postgres Chat Memory": {
        "ai_memory": [
          [
            {
              "node": "orquestrador",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "Salvar Historico": {
        "main": [
          [
            {
              "node": "Get a row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Salvar Historico1": {
        "main": [
          [
            {
              "node": "No Operation, do nothing1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Intervalo entre Mensagens": {
        "main": [
          [
            {
              "node": "Buscas Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Texto Redis": {
        "main": [
          [
            {
              "node": "Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Audio Redis": {
        "main": [
          [
            {
              "node": "Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "imagem Redis": {
        "main": [
          [
            {
              "node": "Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Imagem Redis": {
        "main": [
          [
            {
              "node": "Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscas Mensagens": {
        "main": [
          [
            {
              "node": "Compara Memoria",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mensagem Completa1": {
        "main": [
          [
            {
              "node": "Deletar Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Deletar Mensagens": {
        "main": [
          [
            {
              "node": "VERIFICA INTERCAMBIO",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Compara Memoria": {
        "main": [
          [
            {
              "node": "Mensagem Completa1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split de mensagens": {
        "main": [
          [
            {
              "node": "Split de Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Split": {
        "ai_languageModel": [
          [
            {
              "node": "Split de mensagens",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Converter Audio",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mensagem": {
        "main": [
          [
            {
              "node": "Intervalo entre Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items3": {
        "main": [
          [],
          [
            {
              "node": "Send message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store1",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader": {
        "ai_document": [
          [
            {
              "node": "Supabase Vector Store1",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "When clicking ‘Execute workflow’": {
        "main": [
          [
            {
              "node": "Download file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download file": {
        "main": [
          [
            {
              "node": "Extract from File1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Switch1": {
        "main": [
          [
            {
              "node": "Atualizar Cliente",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ROTA Mensagens1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Pausar IA1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "If3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Execute Workflow3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "If3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request": {
        "main": [
          [
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "Switch1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code": {
        "main": [
          [
            {
              "node": "Dados",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "Busca Telefone",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait1": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge2": {
        "main": [
          [
            {
              "node": "Texto Redis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge3": {
        "main": [
          [
            {
              "node": "Texto Redis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create new notes": {
        "main": [
          [
            {
              "node": "Split de mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send message": {
        "main": [
          [
            {
              "node": "1 segundo",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "orquestrador",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "VERIFICA INTERCAMBIO": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge9": {
        "main": [
          [
            {
              "node": "Texto Redis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete Memory": {
        "main": [
          [
            {
              "node": "If1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If1": {
        "main": [
          [
            {
              "node": "Insert rows in a table",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "agente preços": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "orquestrador": {
        "main": [
          [
            {
              "node": "Basic LLM Chain2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Calculator": {
        "ai_tool": [
          [
            {
              "node": "agente preços",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Think": {
        "ai_tool": [
          [
            {
              "node": "receptivo informacoes",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "reflexao": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model2": {
        "ai_languageModel": [
          [
            {
              "node": "agente preços",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model3": {
        "ai_languageModel": [
          [
            {
              "node": "receptivo informacoes",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory1": {
        "ai_memory": [
          [
            {
              "node": "agente preços",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory2": {
        "ai_memory": [
          [
            {
              "node": "receptivo informacoes",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "inscricao": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "distribuir_humano": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields4": {
        "main": [
          [
            {
              "node": "Converter Foto1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI": {
        "main": [
          [
            {
              "node": "If2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI5": {
        "main": [
          [
            {
              "node": "Audio Redis1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Converter Audio1": {
        "main": [
          [
            {
              "node": "OpenAI5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Converter Foto1": {
        "main": [
          [
            {
              "node": "OpenAI",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ROTA Mensagens1": {
        "main": [
          [
            {
              "node": "Merge5",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge4",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields6",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Intervalo entre Mensagens1": {
        "main": [
          [
            {
              "node": "Buscas Mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Texto Redis1": {
        "main": [
          [
            {
              "node": "Mensagem1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Audio Redis1": {
        "main": [
          [
            {
              "node": "Mensagem1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "imagem Redis1": {
        "main": [
          [
            {
              "node": "Mensagem1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Imagem Redis1": {
        "main": [
          [
            {
              "node": "Mensagem1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscas Mensagens1": {
        "main": [
          [
            {
              "node": "Compara Memoria1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mensagem Completa": {
        "main": [
          [
            {
              "node": "Deletar Mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Deletar Mensagens1": {
        "main": [
          [
            {
              "node": "Code2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Compara Memoria1": {
        "main": [
          [
            {
              "node": "Mensagem Completa",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields5": {
        "main": [
          [
            {
              "node": "Converter Audio1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mensagem1": {
        "main": [
          [
            {
              "node": "Intervalo entre Mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge4": {
        "main": [
          [
            {
              "node": "Texto Redis1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge5": {
        "main": [
          [
            {
              "node": "Texto Redis1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File": {
        "main": [
          [
            {
              "node": "Edit Fields5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields6": {
        "main": [
          [
            {
              "node": "Convert to File",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If2": {
        "main": [
          [
            {
              "node": "imagem Redis1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Imagem Redis1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model5": {
        "ai_languageModel": [
          [
            {
              "node": "Fupper",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory5": {
        "ai_memory": [
          [
            {
              "node": "Fupper",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "inscricao1": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "distribuir_humano1": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Code1": {
        "main": [
          [
            {
              "node": "Update leads",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update leads": {
        "main": [
          [
            {
              "node": "Fupper",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [],
          [
            {
              "node": "Send message1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge6": {
        "main": [
          [
            {
              "node": "Cria Histórico Supabase1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If5": {
        "main": [
          [
            {
              "node": "Adiciona CHAT supabase1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Atualiza CHAT Supabase1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Busca Telefone1": {
        "main": [
          [
            {
              "node": "If5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Adiciona CHAT supabase1": {
        "main": [
          [
            {
              "node": "Merge6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Atualiza CHAT Supabase1": {
        "main": [
          [
            {
              "node": "Merge6",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Cria Histórico Supabase1": {
        "main": [
          [
            {
              "node": "Delete Memory1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split de Mensagem1": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "1 segundo1": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split de mensagens1": {
        "main": [
          [
            {
              "node": "Split de Mensagem1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Split1": {
        "ai_languageModel": [
          [
            {
              "node": "Split de mensagens1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Modelo Output1": {
        "ai_outputParser": [
          [
            {
              "node": "Split de mensagens1",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Merge7": {
        "main": [
          [
            {
              "node": "Busca Telefone1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create new notes1": {
        "main": [
          [
            {
              "node": "Split de mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send message1": {
        "main": [
          [
            {
              "node": "1 segundo1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model6": {
        "ai_languageModel": [
          [
            {
              "node": "Modelo Output1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Fupper": {
        "main": [
          [
            {
              "node": "Merge7",
              "type": "main",
              "index": 0
            },
            {
              "node": "Create new notes1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code2": {
        "main": [
          [
            {
              "node": "Fupper",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Think2": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "precos": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "informacoes": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "precos",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory3": {
        "ai_memory": [
          [
            {
              "node": "precos",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model7": {
        "ai_languageModel": [
          [
            {
              "node": "informacoes",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory6": {
        "ai_memory": [
          [
            {
              "node": "informacoes",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "Calculator1": {
        "ai_tool": [
          [
            {
              "node": "precos",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Calculator2": {
        "ai_tool": [
          [
            {
              "node": "informacoes",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "perder_lead": {
        "ai_tool": [
          [
            {
              "node": "Fupper",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Vector Store": {
        "ai_vectorStore": [
          [
            {
              "node": "buscar_documentos",
              "type": "ai_vectorStore",
              "index": 0
            }
          ]
        ]
      },
      "buscar_documentos": {
        "ai_tool": [
          [
            {
              "node": "precos",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI Vector": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Vector Store2": {
        "ai_vectorStore": [
          [
            {
              "node": "buscar_informacoes",
              "type": "ai_vectorStore",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Docs1": {
        "ai_languageModel": [
          [
            {
              "node": "buscar_informacoes",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI Vector1": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store2",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "buscar_informacoes": {
        "ai_tool": [
          [
            {
              "node": "informacoes",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Docs": {
        "ai_languageModel": [
          [
            {
              "node": "buscar_documentos",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Vector Store5": {
        "ai_vectorStore": [
          [
            {
              "node": "buscar_documentos3",
              "type": "ai_vectorStore",
              "index": 0
            }
          ]
        ]
      },
      "buscar_documentos3": {
        "ai_tool": [
          [
            {
              "node": "agente preços",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Docs4": {
        "ai_languageModel": [
          [
            {
              "node": "buscar_documentos3",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI Vector4": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store5",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Vector Store3": {
        "ai_vectorStore": [
          [
            {
              "node": "buscar_documentos1",
              "type": "ai_vectorStore",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Docs2": {
        "ai_languageModel": [
          [
            {
              "node": "buscar_documentos1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI Vector2": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store3",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "buscar_documentos1": {
        "ai_tool": [
          [
            {
              "node": "receptivo informacoes",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "receptivo informacoes": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model4": {
        "ai_languageModel": [
          [
            {
              "node": "Modelo Output",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Modelo Output": {
        "ai_outputParser": [
          [
            {
              "node": "Split de mensagens",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Atualizar Cliente": {
        "main": [
          [
            {
              "node": "ROTA Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File": {
        "main": [
          [
            {
              "node": "Supabase Vector Store4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model8": {
        "ai_languageModel": [
          [
            {
              "node": "agente localizacao",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory4": {
        "ai_memory": [
          [
            {
              "node": "agente localizacao",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "agente localizacao": {
        "ai_tool": [
          [
            {
              "node": "orquestrador",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Vector Store7": {
        "ai_vectorStore": [
          [
            {
              "node": "docs_pos",
              "type": "ai_vectorStore",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI6": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store7",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model13": {
        "ai_languageModel": [
          [
            {
              "node": "docs_pos",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "docs_pos": {
        "ai_tool": [
          [
            {
              "node": "receptivo informacoes",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "localizacao": {
        "ai_tool": [
          [
            {
              "node": "agente localizacao",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter1": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader1",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI1": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store4",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Download file1": {
        "main": [
          [
            {
              "node": "Extract from File",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File1": {
        "main": [
          [
            {
              "node": "Supabase Vector Store1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader1": {
        "ai_document": [
          [
            {
              "node": "Supabase Vector Store4",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model11": {
        "ai_languageModel": [
          [
            {
              "node": "Basic LLM Chain2",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Basic LLM Chain2": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            },
            {
              "node": "Create new notes",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Wait2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Execute Workflow",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "Execute Workflow1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If3": {
        "main": [
          [
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields2": {
        "main": [
          [
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get a row": {
        "main": [
          [
            {
              "node": "Wait1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File2": {
        "main": [
          [
            {
              "node": "Supabase Vector Store6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download file2": {
        "main": [
          [
            {
              "node": "Extract from File2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader2": {
        "ai_document": [
          [
            {
              "node": "Supabase Vector Store6",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings OpenAI2": {
        "ai_embedding": [
          [
            {
              "node": "Supabase Vector Store6",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter2": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader2",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Wait2": {
        "main": [
          [
            {
              "node": "Rota Atendimento",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "eDUIT TI",
    "name": "Version 1c676e1b",
    "description": "",
    "autosaved": true
  },
  "tags": [
    {
      "updatedAt": "2025-07-30T20:41:48.074Z",
      "createdAt": "2025-07-30T20:41:48.074Z",
      "id": "HCAYGF54Hj7mAMlF",
      "name": "ai"
    }
  ]
}