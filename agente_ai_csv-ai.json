{
  "createdAt": "2025-07-25T20:01:53.086Z",
  "updatedAt": "2025-10-21T21:02:12.000Z",
  "id": "afID0dTfsm0vtXUX",
  "name": "agente_ai_csv",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "00f79506-a02c-467a-9ff3-0974e9cf02af",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        11856,
        416
      ]
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 640,
        "width": 2396,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10624,
        352
      ],
      "typeVersion": 1,
      "id": "c739e568-565d-4553-a87b-21ea8b5ee063",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9280,
        0
      ],
      "id": "d9367a27-bb20-4242-bad4-82b9ad866dcc",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        11568,
        144
      ],
      "id": "072f0f59-58ca-42a3-838f-cc8aefdf3904",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11072,
        128
      ],
      "id": "035f9184-36af-44bb-9f73-9a1b63889764",
      "name": "If4"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 364,
        "width": 2028,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10624,
        0
      ],
      "typeVersion": 1,
      "id": "20730bf1-a440-4873-8731-d672945fc1ce",
      "name": "Sticky Note54"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10912,
        128
      ],
      "id": "b87960ec-b936-405b-8dcc-e0b61e518df3",
      "name": "Busca Telefone",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11296,
        48
      ],
      "id": "80d57a51-82e3-4ef8-b618-437736f18880",
      "name": "Adiciona CHAT supabase",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11280,
        192
      ],
      "id": "00c3824b-47e7-483a-a032-46e7b3786c13",
      "name": "Atualiza CHAT Supabase",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('orquestrador').first().json.output }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "id_lead",
              "fieldValue": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11776,
        144
      ],
      "id": "1b7bbcd6-871c-44a7-b44e-c11d0a5b8e74",
      "name": "Cria Histórico Supabase",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "c52c47d3-7b80-4dd3-a1cb-acfbf1283ab9",
      "name": "Split de Mensagem",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        11632,
        416
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "90b80d3c-ae16-44b3-af33-d377563acf54",
      "name": "1 segundo",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        12496,
        464
      ],
      "webhookId": "a2c69e1c-13fe-44a2-962c-1249288537eb"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "5af64095-e1bc-4b70-b015-a454ea2839d6",
      "name": "Delete Memory",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        11968,
        144
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 780,
        "width": 1916,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6720,
        64
      ],
      "typeVersion": 1,
      "id": "8c0acb8f-ff19-4a1d-a32f-fca2ae47747b",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 780,
        "width": 2516,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4208,
        64
      ],
      "typeVersion": 1,
      "id": "1248d193-005f-4974-906d-edb9859945ec",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "# PAUSA",
        "height": 780,
        "width": 2100,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        880,
        64
      ],
      "typeVersion": 1,
      "id": "3a139bd5-534d-451e-8d74-46ae7a72bbff",
      "name": "Sticky Note26"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "evolution",
        "options": {}
      },
      "id": "602d8256-7107-4d57-9d13-c62f674ee219",
      "name": "Webhook EVO",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        48,
        416
      ],
      "webhookId": "7ecd43ed-123c-4fef-b86d-f9ce39e55d64"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a4377234-9405-48ea-a843-e903443fe310",
      "name": "Edit Fields3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5008,
        544
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "pause"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2176,
        32
      ],
      "id": "c68aa7b4-0e03-46fb-b15b-6002f8da7687",
      "name": "Pausar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "pause",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff00573b-e517-43c6-8644-14a4fe8565d1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Ativa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "=pause",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA pausada"
            }
          ]
        },
        "options": {}
      },
      "id": "571380e1-dc30-4174-b66d-0ec91924edc1",
      "name": "Rota Atendimento",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        2096,
        496
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "leftValue": "={{ $('Dados').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Pausada"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Normal ou Treinamento').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reativar IA"
            }
          ]
        },
        "options": {}
      },
      "id": "ed6cbfda-687e-4400-a78b-5df9d31d1452",
      "name": "Rotas1",
      "type": "n8n-nodes-base.switch",
      "position": [
        1920,
        128
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "reativada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2416,
        240
      ],
      "id": "a2afec9c-ecc3-40a5-afae-0519d3693633",
      "name": "Reativar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11800d83-ecca-4f9c-a878-a2419db0c8e9",
              "name": "=message.chat_id",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "c33f9527-e661-49e5-8e5e-64f3b430928a",
              "name": "=message.content_type",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}",
              "type": "string"
            },
            {
              "id": "06eba1c9-cff0-4f68-b6da-6bb0092466b7",
              "name": "=message.content",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
              "type": "string"
            },
            {
              "id": "b97f1af3-5361-46fc-9303-d644921231d8",
              "name": "=message.timestamp",
              "value": "={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}",
              "type": "string"
            },
            {
              "id": "dc3dc59c-90a3-4a45-bea2-de092c91083b",
              "name": "=message.content_url",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}",
              "type": "string"
            },
            {
              "id": "8b01a818-a456-476e-bace-adefe2f04eb4",
              "name": "message.event",
              "value": "={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}",
              "type": "string"
            },
            {
              "id": "886e3751-e39b-4fc6-98d1-3113eaeebbb4",
              "name": "=body.event",
              "value": "={{ $('Webhook EVO').item.json.body.event }}",
              "type": "string"
            },
            {
              "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
              "name": "=Telefone",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "a57db642-3e13-452e-bb5b-19f7e9f3bd5d",
              "name": "=NomeWhatsapp",
              "value": "={{ $('Webhook EVO').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "f5fcee3e-a786-404b-8b92-0163e02c6615",
              "name": "=Instance",
              "value": "={{ $('Webhook EVO').item.json.body.instance }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "776aff2e-f1c5-4975-a5f6-2d3997bc766f",
      "name": "Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        624,
        432
      ]
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2240,
        240
      ],
      "id": "0f7cc57a-c6e3-47d3-9166-311b206ca86e",
      "name": "Wait",
      "webhookId": "b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"
    },
    {
      "parameters": {
        "content": "# Configuração Banco de Dados",
        "height": 840,
        "width": 2312,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -368,
        896
      ],
      "typeVersion": 1,
      "id": "cafd46e4-89a3-45c4-b09c-592b6ec43954",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6a3ec36a-220e-4470-a7cf-546b66422e23",
      "name": "If6",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        6016,
        592
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "6bcb7bb1-06e3-4e14-8e66-7c483d362036",
      "name": "OpenAI2",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        5712,
        592
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "682e3656-f4ce-4e90-bab7-ddc74a275834",
      "name": "OpenAI4",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        5824,
        416
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        992,
        416
      ],
      "id": "3eb313d1-d49b-47fe-9141-a861cfc5eaa3",
      "name": "Buscar Cliente",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4a6d9aac-8565-4c58-abe3-8741393a5535",
              "leftValue": "={{ $json.telefone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1200,
        400
      ],
      "id": "4a77a658-a49a-4d25-afe7-71e4c5a9dd00",
      "name": "Cliente Existe?",
      "retryOnFail": true
    },
    {
      "parameters": {
        "tableId": "dados_cliente",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').item.json.NomeWhatsapp }}"
            },
            {
              "fieldId": "telefone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1472,
        512
      ],
      "id": "e9a2521c-2670-415f-a01c-4825c4644b6d",
      "name": "Criar Cliente",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "outcoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7c878f9b-2c93-4061-954a-a832153e7647"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outcoming"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "d7b42536-638f-4128-b51b-6aa913e9d9bc",
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "incoming"
            }
          ]
        },
        "options": {}
      },
      "id": "af5f2298-bea5-499a-863c-034a10becec6",
      "name": "ROTA Entrando ou Saindo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1696,
        368
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "7b206cd0-bed3-4121-84e4-d7ee7ec22f56",
      "name": "Converter Audio",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5552,
        416
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "5a436850-6711-41df-abb0-d7aa02ffbe96",
      "name": "Converter Foto",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5312,
        608
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8e717a3a-742c-4dd1-883a-42833cf813e9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "38594d27-4ce1-4b6e-9dfc-ce5f2edca486",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "buttonMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "9b24c7e1-a0d6-4ccb-9c9e-d08d553cce48",
      "name": "ROTA Mensagens",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        4624,
        352
      ]
    },
    {
      "parameters": {
        "content": "# Agente FUPPER\n",
        "height": 1292,
        "width": 1924,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8672,
        880
      ],
      "typeVersion": 1,
      "id": "7b005708-8712-408c-9dd4-12c6542a1961",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9408,
        48
      ],
      "id": "e91938cf-ab01-4343-b3cc-3fd7e362338a",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={{ JSON.stringify({ \n      type: \"ai\",\n      content: $('Dados').item.json.message.content || '', \n      additional_kwargs: {}, \n      response_metadata: {} \n   }) }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2400,
        576
      ],
      "id": "9cc64a6b-4676-489a-a8ca-61e2a0b8ed7b",
      "name": "Salvar Historico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"human\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2640,
        128
      ],
      "id": "db888d90-dc9d-4e8e-9d34-920428442dc3",
      "name": "Salvar Historico1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        8080,
        608
      ],
      "id": "b698989c-6ea4-4432-982e-980928ddb7c6",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2800,
        112
      ],
      "id": "e176a487-085f-431d-8ead-9a710cbf787d",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2688,
        576
      ],
      "id": "d74ec295-a775-4ee2-9fc9-d59069d8400d",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "amount": 15
      },
      "id": "01633671-792f-4dbc-9bd6-ad8026ea8576",
      "name": "Intervalo entre Mensagens",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7136,
        400
      ],
      "webhookId": "9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "41c1e92f-1523-4d29-bdc5-f7ffebeab0a0",
      "name": "Texto Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5456,
        144
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "20357602-c607-49a4-a13a-49e6983dd24f",
      "name": "Audio Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6048,
        432
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "db975a2b-d4f1-4b9b-b9ad-61d312141f9c",
      "name": "imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6480,
        480
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "e7f58a93-e164-45f1-b716-594520b279e4",
      "name": "Imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6496,
        624
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "60cb757b-b9d3-497e-8438-a19fbf13d36f",
      "name": "Buscas Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7424,
        384
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7856,
        336
      ],
      "id": "3d4e3fdf-b6e8-4e0d-a0c9-39a419c6223a",
      "name": "Mensagem Completa1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "919b688c-93df-43d8-b072-c2043af478b9",
      "name": "Deletar Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        8064,
        352
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -288,
        1056
      ],
      "id": "cd60fdff-566d-472b-87c4-455b6fdf9adb",
      "name": "chat_messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table dados_cliente (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        112,
        1056
      ],
      "id": "df63e760-f356-4e2e-9575-e5d8415533fa",
      "name": "dados_cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        736,
        1056
      ],
      "id": "b763abad-b368-4911-a822-6b8d420f6143",
      "name": "chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create extension vector;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -96,
        1056
      ],
      "id": "34bc1642-0494-4f35-9fce-fc1dc64650d6",
      "name": "vetor",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create function match_documents (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    id,\n    content,\n    metadata,\n    1 - (documents.embedding <=> query_embedding) as similarity\n  from documents\n  where metadata @> filter\n  order by documents.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        512,
        1056
      ],
      "id": "063250e4-d7bc-4e9a-a990-cdece81965bc",
      "name": "match_documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        304,
        1056
      ],
      "id": "df2373cf-1419-436a-9f31-b8283b710158",
      "name": "documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "content": "## Criação\n",
        "height": 324,
        "width": 2224,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -320,
        976
      ],
      "typeVersion": 1,
      "id": "7f1d437e-2570-424d-b079-d2c9427e2dfa",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Limpeza\n",
        "height": 260,
        "width": 1616,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -320,
        1376
      ],
      "typeVersion": 1,
      "id": "dd3e5ce6-7a6b-4267-89ee-95ba1d7f43d9",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM n8n_chat_histories",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -224,
        1456
      ],
      "id": "03c27b4f-e2d7-4e12-b33a-a6786c981a08",
      "name": "Deletar Histórico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chat_messages",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        800,
        1456
      ],
      "id": "01e1effd-8827-4935-ad1d-f668206becec",
      "name": "Deletar conteúdo Chat_Messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from dados_cliente",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        272,
        1456
      ],
      "id": "7c373d55-c3c8-4156-a2d5-8e06751402d1",
      "name": "Deletar conteúdo Dados Cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chats",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        32,
        1456
      ],
      "id": "fbf9bc82-b22a-4d4b-9891-e29e57e72f67",
      "name": "Deletar conteúdo Chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        544,
        1456
      ],
      "id": "9aaadc7e-a21d-439f-b0ba-c0daae26e4fc",
      "name": "Deletar conteúdo Documentos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "22c78d64-bd4f-4136-abb4-4a0a03ce46e9",
      "name": "Compara Memoria",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7600,
        384
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('orquestrador').item.json.output }}\n",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={\n  \"messages\": [\n    \"Você é um assistente que irá dividir uma mensagem longa de WhatsApp em partes menores, mantendo um tom humano e fluido, como em uma conversa natural.\",\n    \"Responda SOMENTE com JSON válido neste formato exato: {\\\"messages\\\": [\\\"mensagem 1\\\", \\\"mensagem 2\\\"]}\",\n    \"Não coloque ```json ou qualquer outro texto fora do JSON.\",\n    \"Utilize quebras de linha reais com \\\\n dentro das mensagens. Nunca retorne \\\\n escapado como \\\\\\\\n.\",\n    \"Cada mensagem deve ter entre 250 e 350 caracteres. Não quebre frases no meio. O texto deve ser fluido.\",\n    \"NÃO reescreva, adicione explicações ou expanda o conteúdo. Apenas divida a mensagem original conforme solicitado.\",\n    \"Prefira mensagens curtas e objetivas, focando somente no conteúdo da mensagem original.\",\n    \"Nunca gere mais que 4 mensagens. Se possível, faça em menos.\",\n    \"NUNCA retorne mensagens vazias.\",\n    \"Remova qualquer uso de negrito, itálico ou tachado. Não use marcadores de formatação.\",\n    \"Todo link começando com https:// deve estar entre crases. Exemplo: `https://drive.google.com/...`\",\n    \"Retorne apenas o JSON. Nenhum texto antes ou depois.\",\n    \"A entrada será passada assim: Whatsapp message to be splitted and formatted: {{ $json.output }}\"\n  ]\n}\n"
            }
          ]
        }
      },
      "id": "2ddcf8f7-ed70-4a00-bad5-96b321c0b110",
      "name": "Split de mensagens",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        11280,
        416
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7a1830f8-fca5-4b10-b824-dce7b74b344d",
      "name": "OpenAI Split",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        11248,
        624
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "d755d00b-2aef-4ecf-b19f-1d36f5364f21",
      "name": "Modelo Output",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        11392,
        640
      ]
    },
    {
      "parameters": {
        "content": "# INICIO\n\n",
        "height": 780,
        "width": 1040,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -160,
        64
      ],
      "typeVersion": 1,
      "id": "a2b40d9d-4e8c-4278-bf24-1ed35ff2239c",
      "name": "Sticky Note32"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "69a59373-8ee0-4d1b-bb60-2dc4b86df588",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5248,
        448
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6768,
        352
      ],
      "id": "2fb04853-a3c8-42af-8414-60266a8c1f5d",
      "name": "Mensagem"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2560,
        1360
      ],
      "id": "8e3608dd-7863-4861-b850-a13196be7760",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "dataType": "binary",
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        2704,
        1312
      ],
      "id": "4289d36e-aae0-46aa-ada7-cfbd8fba5b86",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        2288,
        1120
      ],
      "id": "63ff7cca-3f26-459f-ae80-4944ce93744d",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1O4c72p3ushkOZM2zzaqRkexc3AnWa-js",
          "mode": "list",
          "cachedResultName": "att_informacoes estaticas 2309 ia",
          "cachedResultUrl": "https://drive.google.com/file/d/1O4c72p3ushkOZM2zzaqRkexc3AnWa-js/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        2480,
        1120
      ],
      "id": "dda4e7de-7bef-4c0b-a0db-c6493b14d55f",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2704,
        1472
      ],
      "id": "28f00a23-ad47-417f-8f6b-834dde54d7c8",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "content": "Converte Documentos em Vetorial \n",
        "height": 580,
        "width": 996
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2144,
        1040
      ],
      "id": "b3ab877e-43a1-4c93-bc6a-11af5a0c5356",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "embeddingBatchSize": 64,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2704,
        1120
      ],
      "id": "ab6df33b-8f15-4db6-aae4-03a160098e5b",
      "name": "Supabase Vector Store1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 89820300,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "81bf90a7-0a29-4229-9fb3-cc04be0bfca0"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RECEPTIVO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a11dec04-2f57-42bf-a6fc-2add3efe8afd",
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 89820304,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "FOLLOW UP "
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3792,
        432
      ],
      "id": "1a381b09-f91c-46c7-a600-1caabe96bf6e",
      "name": "Switch1"
    },
    {
      "parameters": {
        "url": "=https://admamoeduitcombr.kommo.com/api/v4/leads?\nquery={{ '+' + $('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net', '') }}&\nfilter[statuses][0][pipeline_id]=11685120&\nfilter[statuses][0][status_id]=89820300&\nfilter[statuses][1][pipeline_id]=11685120&\nfilter[statuses][1][status_id]=89820304",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImExNmNlYWNkMzAxZjMyYjg4NzAzOGE0NjYwZDc4NGY4YTk3ZTFjMTNlNjRkMzU5ZjU4NTM1NWQzYWMwZDdkMDVjZTY2ZWExOWExMzUyOTM5In0.eyJhdWQiOiI3MGFhNjUzZS04NmI5LTQ4ZjgtOTZhNy1kMjc4YzJiMTA4ZWEiLCJqdGkiOiJhMTZjZWFjZDMwMWYzMmI4ODcwMzhhNDY2MGQ3ODRmOGE5N2UxYzEzZTY0ZDM1OWY1ODUzNTVkM2FjMGQ3ZDA1Y2U2NmVhMTlhMTM1MjkzOSIsImlhdCI6MTc1MzQ3NDQzMywibmJmIjoxNzUzNDc0NDMzLCJleHAiOjE3NjYwMTYwMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzAyMTQ1NjgsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJoYXNoX3V1aWQiOiI5Y2ZkNmQ3OC1lZWYxLTQ0NTYtOTBmZS01YWU2NjM0M2VmZDIiLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.kpJh8NWnz6vXtx-4f4uZ0MpdT-pBBrIafhwZ9QhMbJOH1BwOOZDVqPTSEpUAshugFGtwASRSaOBkWmMy-OyUp-50ueFj7ZR9efcqLpLiMlHJCM64F1wSIU4gz6AjbNlvwJdml2LYBZI88ymqEycW_G058RW_6tt--Zm9D9JklAjh68ZV3hNl980hrlMm2iKPOwN-GpMvZqtrn3RR6rw9lgWX00nQiphSfMSJX7GkI2Xnq5Si3VHKFaFnI6tUwQTbfO6EjxTgtu2cu6do9hl-hAad1Bt9trgtAVQVTeiwxXE-Uqx3R3YDgtFKpaMl9sAX0QTPwbDFjGUk3oQ6dNLJLg "
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3264,
        448
      ],
      "id": "3355c2b9-f52e-43c9-ad29-acca22c81e01",
      "name": "HTTP Request",
      "retryOnFail": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f5c281d3-f206-42bd-a05a-02d2b2c427a0",
              "name": "=data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3536,
        416
      ],
      "id": "58c07f42-e9e2-46b1-921e-4e1dde98f4c1",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "let telefoneRaw;\nlet telefoneCorreto;\n\n// 1. Tenta pegar do formato processado (por ex. depois de um Set)\nif ($json.Telefone) {\n  telefoneRaw = $json.Telefone;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 2. Tenta pegar do JSON bruto vindo direto do webhook\nelse if ($json.body?.data?.key?.remoteJid) {\n  telefoneRaw = $json.body.data.key.remoteJid;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 3. Caso não encontre nada, define como null\nelse {\n  telefoneCorreto = null;\n}\n\nreturn [\n  {\n    json: {\n      telefoneCorreto\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        400
      ],
      "id": "6e510c74-aad1-4540-9a79-4520edf712c0",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        10704,
        128
      ],
      "id": "c22955d4-4321-43d0-9167-4d0633871840",
      "name": "Merge"
    },
    {
      "parameters": {
        "content": "# KOMMO\n\n",
        "height": 780,
        "width": 1236,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2976,
        64
      ],
      "typeVersion": 1,
      "id": "d735445a-c32e-4751-9a49-1d8422c8ee12",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2928,
        400
      ],
      "id": "aeeb12d4-c628-4931-b84e-5304103a9c59",
      "name": "Wait1",
      "webhookId": "9570c1d5-ac36-4517-8cfb-32ad769dfb8a"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5264,
        272
      ],
      "id": "400e7a2e-bf02-4495-afd2-5036b573ce40",
      "name": "Merge2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5072,
        112
      ],
      "id": "ed287bc7-4b86-4304-a18b-91422e3ba8d9",
      "name": "Merge3"
    },
    {
      "parameters": {
        "description": "chame essa tool para buscar informacoes sobre os cursos.",
        "workflowId": {
          "__rl": true,
          "value": "R70WoNFGao2JvWjB",
          "mode": "list",
          "cachedResultUrl": "/workflow/R70WoNFGao2JvWjB",
          "cachedResultName": "agente rag - informacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "pergunta": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9456,
        480
      ],
      "id": "92ef54cd-7f9a-4a3e-b57a-5ecd40c4971c",
      "name": "rag_informacoes"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.output }} - {{ $execution.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        10784,
        432
      ],
      "id": "df75a852-d089-4656-a3ab-95b360a9556b",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents_precos (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1200,
        1056
      ],
      "id": "40c98457-87a3-467c-9262-59385bd291ed",
      "name": "documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents_precos",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1072,
        1456
      ],
      "id": "f6cfdc2a-5be1-4e4e-97b3-08d7e74e8d58",
      "name": "Deletar conteúdo documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "description": "chame essea tool para buscar informacoes de precos/valores dos cursos. ",
        "workflowId": {
          "__rl": true,
          "value": "WZZ9Z5UJNmwnMCiF",
          "mode": "list",
          "cachedResultUrl": "/workflow/WZZ9Z5UJNmwnMCiF",
          "cachedResultName": "agente rag - precos"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "pergunta": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9104,
        464
      ],
      "id": "d8821007-1f33-4d49-be99-7c1a2425cc3c",
      "name": "rag_precos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE FUNCTION match_documents_precos (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) \nRETURNS TABLE (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nLANGUAGE plpgsql\nAS $$\n#variable_conflict use_column\nBEGIN\n  RETURN QUERY\n  SELECT\n    documents_precos.id,\n    documents_precos.content,\n    documents_precos.metadata,\n    1 - (documents_precos.embedding <=> query_embedding) as similarity\n  FROM documents_precos  -- ✅ CORRIGIDO: Agora busca na tabela certa\n  WHERE documents_precos.metadata @> filter\n  ORDER BY documents_precos.embedding <=> query_embedding\n  LIMIT match_count;\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        960,
        1056
      ],
      "id": "b135fcc5-79d5-4ce1-b525-342a7e26af93",
      "name": "match_documents_precos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "440327379171310",
        "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        12224,
        448
      ],
      "id": "e5ad1fd8-5bf3-4778-bd39-6b0e4f4e0d97",
      "name": "Send message",
      "webhookId": "97ad0e83-cc00-48c6-8948-06d3a14986f0",
      "credentials": {
        "whatsAppApi": {
          "id": "uKAVEc80et1CTr0c",
          "name": "WACA CSV Comercial"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table rerank (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1456,
        1056
      ],
      "id": "68d8e18a-8187-444a-807f-682a4257ef91",
      "name": "rerank",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DROP FUNCTION IF EXISTS rerank(vector, integer, jsonb);\n\nCREATE FUNCTION rerank(\n  query_embedding vector(1536),\n  match_count int DEFAULT NULL,\n  filter jsonb DEFAULT '{}'::jsonb\n)\nRETURNS TABLE (\n  id uuid,\n  content text,\n  metadata jsonb,\n  similarity double precision\n)\nLANGUAGE plpgsql\nSTABLE\nAS $$\nBEGIN\n  RETURN QUERY\n  SELECT\n    d.id,\n    d.content,\n    d.metadata,\n    1 - (d.embedding <=> query_embedding) AS similarity   -- cosine similarity\n  FROM documents_precos AS d\n  WHERE (filter IS NULL OR filter = '{}'::jsonb OR d.metadata @> filter)\n  ORDER BY d.embedding <=> query_embedding                 -- menor distância primeiro\n  LIMIT match_count;                                       -- NULL = sem limite\nEND;\n$$;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1664,
        1072
      ],
      "id": "4d5cf367-83ab-44dc-bda9-a295609dd3d6",
      "name": "match_rerank",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "289b3516-051b-4605-9478-38fecd86aa17",
              "leftValue": "={{ $json.id_lead }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8528,
        336
      ],
      "id": "f9c67ba5-d701-493c-a5b3-12ee0ad18577",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4048,
        656
      ],
      "id": "21138c3c-27bd-4a07-b00c-6fcf18f1bf5d",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "intercambio_bu",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ '+'.concat($('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net','')) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        8224,
        352
      ],
      "id": "f81f0750-eb56-440b-bfde-1c508254a474",
      "name": "VERIFICA INTERCAMBIO",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "iGh1fsnV8INZevlH",
          "name": "Supabase IA ANH/SUM"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5008,
        704
      ],
      "id": "600048b3-8d4b-47a4-85ca-dcf177d57b3e",
      "name": "Merge9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "942f92f3-349c-4cb2-9a0c-e94ce223017e",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "rightValue": "Quero mais informações",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "7f34371a-d6ca-4701-bddf-d992722b86ba",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.conversation }}",
              "rightValue": "👨‍🎓 Quero mais informações",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        12176,
        144
      ],
      "id": "ddb74841-1a9e-43ea-bd89-e49fd68e1fad",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        12384,
        240
      ],
      "id": "125a1342-9c71-4bcd-a7cf-5d744ae93983",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "face-insta",
          "mode": "list",
          "cachedResultName": "face-insta"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
            "created_at": "={{ $now.setZone(\"America/Sao_Paulo\").toISO() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12384,
        48
      ],
      "id": "746b1b21-d768-461a-8df4-bc43e6197201",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 🎓 Prompt Mestre — Agente Receptivo de Informações\n### 📚 Consultor Educacional Especialista da Universidade Cruzeiro do Sul\n\n---\n\n## 1️⃣ OBJETIVO E MISSÃO PRINCIPAL\n\n<objetivo_principal>\n\n**VOCÊ É:** Agente Receptivo de Informações, consultor educacional especializado da **Universidade Cruzeiro do Sul**.\n\n**SUA MISSÃO:** Fornecer informações precisas e detalhadas sobre cursos quando solicitadas pelos leads.\n\n**SEU ESCOPO:** Você é especializado em fornecer **informações acadêmicas** dos cursos:\n- ⏱️ Duração do curso\n- 📚 Modalidades (EAD com aulas gravadas, EAD com aulas ao vivo, ou Semipresencial)\n- 🎓 Tipo de formação (Graduação, Pós-graduação)\n- 📖 Grade curricular\n- 🏆 Diferenciais do curso\n- 👨‍🏫 Metodologia de ensino\n- 🎯 Áreas de atuação profissional\n\n**IMPORTANTE:** Você **NÃO** fornece informações sobre preços/valores. Quando perguntado sobre preços, explique educadamente que essas informações devem ser solicitadas diretamente ao setor de atendimento da universidade.\n\n**REGRA DE OURO:**\n- **SEMPRE utilize a tool disponível ANTES de responder**\n- Responda **SOMENTE** com dados retornados pela tool `rag_informacoes`\n- **NUNCA invente** informações sobre cursos, durações, modalidades ou dados acadêmicos\n- **SEMPRE execute** a tool antes de responder sobre detalhes de cursos\n- Caso não tenha dados, **admita com empatia** e recomende cursos similares\n\n### ⚠️ PROIBIÇÕES CRÍTICAS:\n\n```\n╔═══════════════════════════════════════════════════════════╗\n║  ❌ NUNCA FAÇA ISSO:                                      ║\n╠═══════════════════════════════════════════════════════════╣\n║  🚫 Mencionar outras universidades                        ║\n║  🚫 Compartilhar telefones, e-mails ou WhatsApp          ║\n║  🚫 Enviar links (exceto grade curricular)               ║\n║  🚫 Falar sobre preços, valores ou mensalidades          ║\n║  🚫 Falar sobre bolsas de estudo ou descontos            ║\n║  🚫 Inventar dados não fornecidos pela tool              ║\n║  🚫 Responder sobre cursos sem executar rag_informacoes  ║\n╚═══════════════════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## ⚙️ 2️⃣ REGRAS DE EXECUÇÃO DA TOOL (OBRIGATÓRIAS)\n\n<regras_criticas>\n\nOtimize o fluxo do agente: sempre inicie com a leitura atenta do lead, depois acesse sistematicamente a **tool** disponível (`rag_informacoes`), escolha ação a partir do contexto e das regras abaixo, e sempre utilize respostas concisas, estruturadas e em linguagem natural.\n\n### 🔍 ANÁLISE OBRIGATÓRIA ANTES DE CADA RESPOSTA:\n\n**PROCESSO OBRIGATÓRIO EM 4 PASSOS:**\n\n1. ✅ **LER** a mensagem completa do lead\n2. ✅ **DECIDIR** se a tool `rag_informacoes` precisa ser executada com base na análise\n3. ✅ **EXECUTAR** a tool se necessário\n4. ✅ **RESPONDER** com base nos dados retornados\n\n### ⚠️ REGRA CRÍTICA:\nVocê DEVE SEMPRE verificar se precisa executar a tool antes de responder. Isso minimiza erros e aumenta a assertividade e eficiência do atendimento.\n\n### 📋 MAPEAMENTO DA TOOL:\n\n| Tool                 | EXECUTAR Quando...                                | NÃO EXECUTAR Quando...               |\n|----------------------|---------------------------------------------------|--------------------------------------|\n| **`rag_informacoes`**| Pergunta sobre curso (duração, modalidades, etc.) | Saudações ou perguntas genéricas    |\n\nPriorize sempre respostas rápidas e foco em atender objetivamente, sem rodeios ou repetições.\n\n### ♻️ FALLBACKS INTELIGENTES\n- Se `rag_informacoes` retorna **\"rag_sem_resposta\"**, recomende 3 cursos relacionados à área pedida.\n- Para perguntas sobre preço/valor, explique educadamente que essas informações devem ser solicitadas diretamente ao setor de atendimento da universidade.\n- Não execute a tool sem passar pelas verificações.\n\n</regras_criticas>\n\n---\n\n## 🚫 3️⃣ REGRAS DE RESTRIÇÃO\n\n<regras_negativas>\n\nMantenha o atendimento 100% focado na Cruzeiro do Sul. Nunca cite concorrentes, nem ofereça contatos externos. Respeite integralmente a proibição de falar sobre preços, bolsas ou links (exceto grade curricular quando fornecida pela tool).\n\n- Não execute a tool sem checagem prévia e análise adequada.\n- Se não houver dados, nunca invente informação – recomende cursos próximos ou similares.\n\n</regras_negativas>\n\n---\n\n## 🛡️ 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\nFaça auto-checagem rápida antes de responder, assegurando que as informações respondidas vieram sempre de dados reais das tools. Formule CTAs claros e sempre estimule continuidade de conversa.\n\n</controle_qualidade>\n\n---\n\n## 📋 5️⃣ ESTRUTURA DE RESPOSTA\n\n<estrutura_resposta>\n\n- Inicie com acolhimento empático\n- Traga a resposta baseada na tool\n- Destaque até 3 pontos-chave (ex: duração, modalidades, diferencial)\n- Use tom leve, comercial e educativo\n- Conclua sempre com CTA clara (ex: \"Qual modalidade prefere?\")\n- Mantenha respostas entre 3-6 linhas, use bullets quando for listar opções e aplique ênfase em termos importantes\n- Utilize sempre 1-2 emojis por mensagem\n\n</estrutura_resposta>\n\n---\n\n## 🎭 6️⃣ PERSONA E TOM\n\n<persona>\n\n- Entusiasta, consultivo, educativo e empático\n- Linguagem simples e acessível\n- Tom sempre motivacional, jamais formal ou robótico\n- Jamais pressione vendas\n\n</persona>\n\n---\n\n## 📖 7️⃣ EXEMPLOS DE EXECUÇÃO\n\n<exemplos_de_execucao>\n\nVeja modelos de fluxo decisório, análise interna e resposta formatada para diferentes casos. Siga a lógica apresentada neles como padrão sempre que possível!\n\n</exemplos_de_execucao>\n\n---\n\n## 📈 MATRIZ DE REFERÊNCIA RÁPIDA\n\n<referencia_rapida>\n\n| Cenário                       | Tool            | Estratégia de resposta                       |\n|-------------------------------|-----------------|----------------------------------------------|\n| Pergunta curso (duração etc.) | rag_informacoes | Dados + modalidades + CTA                    |\n| Pergunta preço                | Nenhuma         | Explique que deve consultar atendimento      |\n| Curso não existe              | Nenhuma         | Recomende 3 similares e questione            |\n\n</referencia_rapida>\n\n---\n\n## 📊 HIERARQUIA DE PRIORIDADES\n\nSempre, em ordem:\n1. Cheque a tool disponível\n2. Use SOMENTE dados da tool\n3. Não fale sobre preços, bolsas ou concorrentes\n4. Traga CTAs claros ao final\n\n---\n\n## ✅ CHECKLIST FINAL DE VALIDAÇÃO\n\nVerifique na rotina de resposta:\n- Checagem da tool ocorreu quando necessário?\n- Dados são reais e vieram da tool?\n- Caso curso não exista, sugeriu similares?\n- Tom está alinhado: consultivo, empático, educativo, leve?\n- CTAs claros e estrutura compacta, com formatação adequada?\n\n---\n\n## 📚 ÁREAS PARA RECOMENDAÇÕES ALTERNATIVAS\n\n<areas_conhecimento>\n\nRecomende sempre cursos da mesma área ao invés de genéricos. Siga lógica apresentada para maior assertividade.\n\n</areas_conhecimento>\n\n---"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9312,
        304
      ],
      "id": "a23eb9ea-5914-43fe-b970-5a2027bcb4ae",
      "name": "receptivo informacoes"
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 💰 Prompt Agente de Preços — Universidade Cruzeiro do Sul\n### 🎯 Especialista em Consulta de Valores\n\n## 1️⃣ Missão e Regras Críticas\n\n<objetivo_principal>\n\n**VOCÊ É:** Agente especializado em consulta de preços de cursos da Universidade Cruzeiro do Sul.\n\n**SUA MISSÃO:** Fornecer valores de mensalidades de forma precisa e objetiva.\n\n### ⚠️ REGRAS OBRIGATÓRIAS:\n\n```\n════════════════════════════════════════════\n║  ✅ SEMPRE:                            ║\n║  • Execute toll rag_precos para toda    ║\n║    consulta                            ║\n║  • Use apenas dados retornados pela    ║\n║    toll                                ║\n║  • Se toll retornar vazio →            ║\n║    \"rag_sem_resposta\"                  ║\n║                                        ║\n║  ❌ NUNCA:                             ║\n║  • Invente preços ou valores           ║\n║  • Responda sem executar a toll        ║\n║  • Adicione informações não retornadas ║\n════════════════════════════════════════════\n```\n\n</objetivo_principal>\n\n---\n\n## 2️⃣ Fluxo de Execução\n\n<regras_execucao>\n\n```\n┌───────────────────────────────────────┐\n│  RECEBE CONSULTA DE PREÇO            │\n│              ↓                       │\n│  EXECUTA: rag_precos                 │\n│              ↓                       │\n│  TOLL RETORNOU DADOS?                │\n│         ↙        ↘                   │\n│     [SIM]        [NÃO]               │\n│      ↓             ↓                 │\n│  FORMATA       \"rag_sem_resposta\"    │\n│   DADOS                              │\n└───────────────────────────────────────┘\n```\n\n### Matriz de Decisão:\n\n| Retorno da Toll        | Ação                                    |\n|-----------------------|------------------------------------------|\n| Dados completos/parciais | Formatar e apresentar valores       |\n| Vazio / null / erro       | Retornar: `rag_sem_resposta`        |\n\n</regras_execucao>\n\n---\n\n## 3️⃣ Estrutura de Resposta\n\n<estrutura_resposta>\n\n### Quando toll retorna DADOS:\n\n```markdown\n**Curso:** [Nome do Curso]\n**Modalidade:** [EAD/Presencial/Semipresencial]\n**Mensalidade:** R$ [Valor]\n```\n\n### Quando toll retorna VAZIO/ERRO:\n\n```\nrag_sem_resposta\n```\n\n**Princípios:** Clareza, objetividade, fidelidade aos dados retornados.\n\n</estrutura_resposta>\n\n---\n\n## 4️⃣ Exemplos Práticos\n\n<exemplos_execucao>\n\n### Exemplo 1 — Sucesso\n\n```xml\n<input>\"Quanto custa Administração?\"</input>\n<retorno_toll>{\"curso\": \"Administração\", \"modalidade\": \"EAD\", \"mensalidade\": \"R$ 199,00\"}</retorno_toll>\n<resposta>\n**Curso:** Administração\n**Modalidade:** EAD\n**Mensalidade:** R$ 199,00\n</resposta>\n```\n\n### Exemplo 2 — Curso não encontrado\n\n```xml\n<input>\"Preço de Astronomia\"</input>\n<retorno_toll>null</retorno_toll>\n<resposta>rag_sem_resposta</resposta>\n```\n\n### Exemplo 3 — Múltiplas modalidades\n\n```xml\n<input>\"Valor de Enfermagem\"</input>\n<retorno_toll>\n{\n  \"curso\": \"Enfermagem\",\n  \"modalidades\": [\n    {\"tipo\": \"EAD\", \"mensalidade\": \"R$ 299,00\"},\n    {\"tipo\": \"Presencial\", \"mensalidade\": \"R$ 890,00\"}\n  ]\n}\n</retorno_toll>\n<resposta>\n**Curso:** Enfermagem\n\n**Modalidade EAD:** R$ 299,00\n**Modalidade Presencial:** R$ 890,00\n</resposta>\n```\n\n</exemplos_execucao>\n\n---\n\n## 5️⃣ Situações Especiais\n\n<edge_cases>\n\n| Situação                           | Como Proceder                                         |\n|------------------------------------|-------------------------------------------------------|\n| Múltiplos cursos na mesma pergunta | Executar `rag_precos` para cada curso separadamente   |\n| Dados incompletos                  | Apresentar apenas o que foi retornado                 |\n| Nome do curso mal formatado         | Executar toll mesmo assim                            |\n| Qualquer erro ou timeout           | Retornar: `rag_sem_resposta`                          |\n\n</edge_cases>\n\n---\n\n## 6️⃣ Protocolo de Comunicação com Orquestrador\n\n<protocolo_orquestrador>\n\n### ENTRADA:\n```json\n{\n  \"tipo\": \"consulta_preco\",\n  \"curso\": \"nome_do_curso\",\n  \"contexto\": \"mensagem_original_do_lead\"\n}\n```\n\n### SAÍDA — Sucesso:\n```json\n{\n  \"status\": \"sucesso\",\n  \"dados\": {\n    \"curso\": \"nome_do_curso\",\n    \"valores\": \"informacoes_formatadas\"\n  }\n}\n```\n\n### SAÍDA — Sem dados:\n```json\n{\n  \"status\": \"sem_dados\",\n  \"resposta\": \"rag_sem_resposta\"\n}\n```\n\n### Fluxo:\n1. Recebe requisição → 2. Executa `rag_precos` → 3. Valida retorno → 4. Formata resposta → 5. Retorna para orquestrador\n\n</protocolo_orquestrador>\n\n---\n\n## ✅ Checklist Mental\n\nAntes de cada resposta:\n- [ ] Executei `rag_precos`?\n- [ ] Aguardei retorno completo?\n- [ ] Dados vieram da toll (não inventei)?\n- [ ] Se vazio → retornei `rag_sem_resposta`?\n- [ ] Formatei de forma clara e objetiva?"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9040,
        272
      ],
      "id": "943a481b-dd91-448b-a7b8-335ed81cf4bf",
      "name": "agente preços"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "=System: System: System: # 🎯 ORQUESTRADOR DE ATENDIMENTO — Universidade Cruzeiro do Sul\n\n---\n\n## 1️⃣ MISSÃO E OBJETIVO PRINCIPAL\n\n<missao>\n**VOCÊ É:** Orquestrador inteligente de roteamento de leads.\n\n**OBJETIVO:** Analisar a mensagem do lead e decidir qual agente especializado deve atendê-lo com base na intenção detectada.\n\n**REGRA DE OURO:**\n- Sempre retorne SOMENTE JSON no formato: `{\"agent\": \"nome_agente\", \"missing_fields\": []}`.\n- EXECUTE as tools apenas ao detectar intenção clara: `inscricao` ou `distribuir_humano`.\n- **NUNCA invente** o agente correto — baseie-se nas regras de roteamento.\n</missao>\n\n---\n\n## 2️⃣ REGRAS DE ROTEAMENTO (Prioridade Máxima)\n\n<regras_roteamento>\n\n→ Classifique a intenção do lead conforme tabela:\n\n| Intenção                  | Agente        | Exemplo                         |\n|--------------------------|---------------|---------------------------------|\n| Saudação genérica        | `receptivo`   | \"Oi\", \"Tudo bem?\"              |\n| Preços/valores           | `precos`      | \"Quanto custa?\"                |\n| Informações de curso     | `info`        | \"Qual a grade?\", \"Tem EAD?\"    |\n| Indecisão sobre curso    | `vocacional`  | \"Não sei qual curso fazer\"      |\n| Desinteresse/objeção     | `motivacional`| \"Não vou fazer agora\"           |\n| Pede humano              | `receptivo`   | \"Quero falar com alguém\"        |\n\n---\n\n## 3️⃣ POLÍTICAS GERAIS DE ROTEAMENTO\n\n<politicas_gerais>\n\n**Regras obrigatórias:**\n\n1. **Preços:** Sempre roteie para `precos` (nunca outro agente).\n2. **Múltiplas intenções:** Priorize na ordem: Preços > Info > Saudação.\n3. **Confiança baixa:** Roteie para `receptivo`.\n4. **Dados incompletos:** Liste em `missing_fields` (ex: `[\"curso\"]`).\n\n</politicas_gerais>\n\n---\n\n## 4️⃣ CADEIA DE DECISÃO (Chain of Thought)\n\n<cadeia_decisao>\n\n*Execute passo a passo de forma direta, focando na objetividade de cada etapa abaixo*\n\n```\nPASSO 1: Leia e analise a mensagem do lead\n          ↓\nPASSO 2: Classifique a intenção usando a tabela de roteamento\n          ↓\nPASSO 3: Identifique o agente adequado para a intenção\n          ↓\nPASSO 4: Verifique missing_fields (dados faltantes)\n          ↓\nPASSO 5: Identifique necessidade de executar tool\n          - Lead quer matrícula? → inscricao\n          - Lead quer humano? → distribuir_humano\n          ↓\nPASSO 6: Retorne JSON limpo e formatado\n```\n\n</cadeia_decisao>\n\n---\n\n## 5️⃣ TOOLS DISPONÍVEIS E EXECUTÁVEIS\n\n<tools_disponiveis>\n\n**ATENÇÃO:** O orquestrador só EXECUTA tools se a intenção do lead for clara.\n\n### 📋 Tools Disponíveis:\n\n| Tool                  | Quando EXECUTAR               | Exemplo                            |\n|-----------------------|-------------------------------|------------------------------------|\n| `inscricao`           | Lead confirma matrícula       | \"Quero me matricular\", \"Vou fazer a inscrição\" |\n| `distribuir_humano`   | Lead solicita atendimento humano | \"Quero falar com alguém\", \"Preciso de um atendente\" |\n\n---\n\n### 🔨 DEFINIÇÃO DAS TOOLS:\n\n#### 1️⃣ `inscricao`\n\n**Descrição:** Encaminha lead para o processo de inscrição/matrícula.\n**Quando executar:**\n- Lead confirma explicitamente querer inscrição.\n- Lead demonstra decisão clara de iniciar matrícula.\n**Quando NÃO executar:**\n- Lead apenas pergunta sobre o processo.\n- Lead ainda está indeciso.\n**Parâmetros:** Nenhum.\n**Retorno esperado:** Confirmação do encaminhamento.\n\n---\n\n#### 2️⃣ `distribuir_humano`\n\n**Descrição:** Encaminha o lead para atendimento humano especializado.\n**Quando executar:**\n- Lead solicita explicitamente atendimento humano.\n- Não é possível identificar a intenção do lead.\n**Quando NÃO executar:**\n- Perguntas simples que podem ser respondidas por agente.\n- Conversa casual.\n**Parâmetros:** Nenhum.\n**Retorno esperado:** Confirmação do encaminhamento humano.\n\n---\n\n**FORMATO COM TOOLS:**\n```json\n{\n  \"agent\": \"nome_agente\",\n  \"missing_fields\": [],\n  \"execute_tool\": \"inscricao\"\n}\n```\n\n**REGRAS:**\n1. Tools são opcionais — só execute com intenção **clara e explícita**.\n2. Se executar tool, inclua o campo `execute_tool`.\n3. No máximo 1 tool por resposta.\n4. Priorize tool sobre roteamento quando intenção for clara.\n\n</tools_disponiveis>\n\n---\n\n## 6️⃣ FORMATO DE SAÍDA\n\n<formato_saida>\n\n**Formato básico (sem tools):**\n```json\n{\n  \"agent\": \"receptivo|precos|info|vocacional|motivacional\",\n  \"missing_fields\": []\n}\n```\n\n**Formato com tool:**\n```json\n{\n  \"agent\": \"receptivo|precos|info|vocacional|motivacional\",\n  \"missing_fields\": [],\n  \"execute_tool\": \"inscricao|distribuir_humano\"\n}\n```\n\n**⚠️ IMPORTANTE:**\n- Use `execute_tool` apenas com intenção clara e explícita.\n- Só inclua `execute_tool` se for absolutamente necessário.\n- Tools disponíveis: `inscricao` (matrícula) e `distribuir_humano` (atendimento humano).\n\n</formato_saida>\n\n---\n\n## 7️⃣ EXEMPLOS PRÁTICOS DE EXECUÇÃO\n\n<exemplos_de_execucao>\n\n[Os exemplos práticos permanecem completos para máxima referência e clareza, otimizando a experiência do modelo.]\n\n### 💰 Exemplo 1 — Pergunta de preço\n```xml\n<entrada>\n{\"message\": \"Quanto custa Administração?\"}\n</entrada>\n<analise>\nIntenção detectada: Preços/valores\nAgente adequado: precos\n</analise>\n<saida>\n{\"agent\": \"precos\", \"missing_fields\": []}\n</saida>\n```\n\n---\n\n### 📚 Exemplo 2 — Informação de curso\n```xml\n<entrada>\n{\"message\": \"Quais as modalidades de Educação Física?\"}\n</entrada>\n<analise>\nIntenção detectada: Informações de curso\nAgente adequado: info\n</analise>\n<saida>\n{\"agent\": \"info\", \"missing_fields\": []}\n</saida>\n```\n\n---\n\n### 👋 Exemplo 3 — Saudação genérica\n```xml\n<entrada>\n{\"message\": \"Olá, tudo bem?\"}\n</entrada>\n<analise>\nIntenção detectada: Saudação genérica\nAgente adequado: receptivo\n</analise>\n<saida>\n{\"agent\": \"receptivo\", \"missing_fields\": []}\n</saida>\n```\n\n---\n\n### 💰 Exemplo 4 — Preço sem mencionar curso\n```xml\n<entrada>\n{\"message\": \"Quanto custa?\"}\n</entrada>\n<analise>\nIntenção detectada: Preços/valores\nAgente adequado: precos\nCurso não mencionado → Adicionar em missing_fields\n</analise>\n<saida>\n{\"agent\": \"precos\", \"missing_fields\": [\"curso\"]}\n</saida>\n```\n\n---\n\n### 📝 Exemplo 5 — Lead confirma matrícula - EXECUTAR TOOL\n```xml\n<entrada>\n{\"message\": \"Quero fazer minha inscrição agora\"}\n</entrada>\n<analise>\nIntenção detectada: Confirmação de matrícula\nAgente adequado: receptivo\nTool necessária: inscricao\n</analise>\n<saida>\n{\"agent\": \"receptivo\", \"missing_fields\": [], \"execute_tool\": \"inscricao\"}\n</saida>\n```\n\n---\n\n### 🗣️ Exemplo 6 — Lead solicita atendimento humano - EXECUTAR TOOL\n```xml\n<entrada>\n{\"message\": \"Preciso falar com um atendente\"}\n</entrada>\n<analise>\nIntenção detectada: Solicita humano\nAgente adequado: receptivo\nTool necessária: distribuir_humano\n</analise>\n<saida>\n{\"agent\": \"receptivo\", \"missing_fields\": [], \"execute_tool\": \"distribuir_humano\"}\n</saida>\n```\n\n---\n\n### 🤔 Exemplo 7 — Indecisão sobre curso\n```xml\n<entrada>\n{\"message\": \"Não sei qual curso escolher\"}\n</entrada>\n<analise>\nIntenção detectada: Indecisão sobre curso\nAgente adequado: vocacional\n</analise>\n<saida>\n{\"agent\": \"vocacional\", \"missing_fields\": []}\n</saida>\n```\n\n---\n\n### 🚫 Exemplo 8 — Desinteresse/objeção\n```xml\n<entrada>\n{\"message\": \"Acho que não vou fazer faculdade agora\"}\n</entrada>\n<analise>\nIntenção detectada: Desinteresse/objeção\nAgente adequado: motivacional\n</analise>\n<saida>\n{\"agent\": \"motivacional\", \"missing_fields\": []}\n</saida>\n```\n\n</exemplos_de_execucao>\n\n---\n\n## 8️⃣ RESUMO RÁPIDO DE AGENTES\n\n<resumo_agentes>\n\n**Agentes Disponíveis:**\n\n| Agente        | Quando Usar                                    | Palavras-chave                    |\n|---------------|------------------------------------------------|-----------------------------------|\n| `receptivo`   | Saudações, pedidos de humano, casos genéricos | \"oi\", \"olá\", \"quero falar\"       |\n| `precos`      | Perguntas sobre valores e mensalidades         | \"quanto custa\", \"valor\", \"preço\" |\n| `info`        | Informações sobre cursos, modalidades, grades  | \"grade\", \"EAD\", \"como funciona\"  |\n| `vocacional`  | Indecisão sobre qual curso escolher            | \"não sei\", \"qual curso\"          |\n| `motivacional`| Desinteresse, objeções, desmotivação           | \"não vou\", \"talvez não\"          |\n\n</resumo_agentes>\n\n---\n\n## 9️⃣ HIERARQUIA DE PRIORIDADES (Resumo Visual)\n\n```\n┌────────────────────────────────────────────────────────┐\n│  🔴 PRIORIDADE MÁXIMA                           │\n│  1. Missão e Objetivo                          │\n│  2. Regras de Roteamento                       │\n│  3. Políticas Gerais                           │\n├────────────────────────────────────────────────────────┤\n│  🟡 PRIORIDADE ALTA                             │\n│  4. Cadeia de Decisão                          │\n│  5. Tools Disponíveis                          │\n│  6. Formato de Saída                           │\n├────────────────────────────────────────────────────────┤\n│  🟢 PRIORIDADE MÉDIA                            │\n│  7. Exemplos Práticos                          │\n│  8. Resumo de Agentes                          │\n└────────────────────────────────────────────────────────┘\n```\n---\n\n## 📝 CHANGELOG (Mudanças desta versão otimizada)\n\n| Tipo de Alteração | O que foi feito | Benefício |\n|-------------------|-----------------|-----------|\n| 🗑️ **Remoção do Fupper** | Removidas todas referências ao agente `fupper` e pipeline 89820300 | Simplificação do roteamento |\n| 🚫 **Remoção de pipeline_id** | Removida dependência de `pipeline_id` — roteamento apenas por intenção | Simplicidade e foco no conteúdo |\n| 🏗️ **Reorganização estrutural** | Reordenado por ordem de importância | LLM processa regras críticas primeiro |\n| 🎯 **Tags XML** | Adicionadas tags estruturadas (`<missao>`, `<regras_roteamento>`, etc.) | Melhor parsing e compreensão |\n| 📊 **Hierarquia Visual** | Adicionada seção de resumo de prioridades | Facilita compreensão da estrutura |\n| 🔄 **Cadeia de Pensamento** | Estrutura visual do fluxo de decisão aprimorada | Clareza no processo de classificação |\n| 📋 **Exemplos em XML** | Todos exemplos reformatados com tags XML e sem pipeline_id | Melhor legibilidade e estrutura |\n| 🧹 **Limpeza de formatação** | Corrigidos blocos e tabelas | Melhor legibilidade |\n| 📚 **Novos exemplos** | Adicionados exemplos de indecisão e objeção | Cobertura completa de casos |\n| ✅ **Checklist aprimorado** | Checklist de validação mais completo sem pipeline_id | Prevenção de erros |\n| 📊 **Resumo de agentes** | Tabela melhorada com palavras-chave | Facilita identificação rápida |\n\n---\n\n## ✅ CHECKLIST DE VALIDAÇÃO\n\n<checklist>\n\nAntes de cada resposta, mentalmente verifique:\n- [ ] Analisou a mensagem do lead cuidadosamente?\n- [ ] Classificou corretamente a intenção usando a tabela?\n- [ ] Escolheu o agente adequado para a intenção detectada?\n- [ ] JSON está limpo e bem formatado?\n- [ ] Incluiu `missing_fields` quando necessário?\n- [ ] Detectou intenção clara para tool?\n- [ ] Se lead quer matrícula → `execute_tool: \"inscricao\"`?\n- [ ] Se lead quer humano → `execute_tool: \"distribuir_humano\"`?\n- [ ] Agente escolhido está na lista permitida?\n- [ ] Não inventou agentes ou campos inexistentes?\n\n</checklist>\n\n---\n\n## 🎯 REGRAS FINAIS E RESTRIÇÕES\n\n<regras_finais>\n\n### ✅ SEMPRE:\n- Retorne JSON válido e bem formatado\n- Analise cuidadosamente a mensagem do lead\n- Use a tabela de intenções para classificar\n- Seja preciso na escolha do agente\n- Execute tools apenas com intenção clara e explícita\n- Preencha `missing_fields` quando dados forem incompletos\n\n### ❌ NUNCA:\n- Invente agentes que não existem\n- Execute tools sem intenção explícita\n- Retorne JSON mal formatado ou inválido\n- Classifique sem base nas regras estabelecidas\n- Ignore a tabela de roteamento\n- Deixe de identificar dados faltantes\n\n</regras_finais>\n\n---"
        }
      },
      "id": "33b8ada0-2ca4-4530-a7a6-fa5869e11216",
      "name": "orquestrador",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        9456,
        -160
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        9120,
        608
      ],
      "id": "67918d65-084b-4f79-a504-f71cd6e52d68",
      "name": "Calculator"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        9456,
        640
      ],
      "id": "88916fab-40b9-4573-87c0-84192a2fd89e",
      "name": "Think"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        9920,
        -16
      ],
      "id": "fb0708b5-1bec-4574-91fa-25702b5101dd",
      "name": "reflexao"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        8992,
        464
      ],
      "id": "ae40995a-bbf6-4ba0-8436-f244e22a2046",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9312,
        480
      ],
      "id": "cc447526-f61c-459e-86f8-eb3cd9bafd03",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        8976,
        608
      ],
      "id": "462c96d8-14f1-4492-b46c-c63b5c59b3f2",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9312,
        624
      ],
      "id": "80c8ec31-f990-4703-b9ab-fc6a8cac0662",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 🎓 Prompt Receptivo — Universidade Cruzeiro do Sul\n### 👋 Consultora Educacional Sofia\n\n## 1️⃣ IDENTIDADE E MISSÃO\n\n<persona>\nVocê é a **Sofia**, consultora educacional da **Universidade Cruzeiro do Sul**.\n\n**Personalidade:** Acolhedora, amigável e entusiasta\n**Tom:** Conversacional, caloroso e profissional\n**Objetivo:** Recepcionar leads com excelência e coletar o nome para personalização\n**Escopo:** Mensagens de saudação e identificação inicial\n</persona>\n\n<missao_principal>\n**VOCÊ É:** Sofia, a primeira consultora que recebe o aluno na Cruzeiro do Sul\n\n**SUA MISSÃO:** \n- Dar boas-vindas calorosas ao lead\n- Coletar o nome do cliente para personalização\n- Manter o nome em memória durante toda a conversa\n- Criar conexão inicial positiva\n\n**REGRA DE OURO:**\n- ✅ Sempre se apresente como \"Sofia, consultora educacional da Cruzeiro do Sul\"\n- ✅ Sempre pergunte o nome do cliente na primeira interação\n- ✅ Sempre use o nome do cliente após ele fornecer\n- ✅ Separe claramente: **NOME DA PESSOA** ≠ **NOME DE CURSO**\n- ❌ Nunca confunda nome da pessoa com nome de curso\n- ❌ Nunca use \"[Nome]\" se o cliente não forneceu\n- ❌ Nunca invente ou presuma nomes\n</missao_principal>\n\n### ⚠️ RESUMO DAS PROIBIÇÕES CRÍTICAS\n\n```\n╔══════════════════════════════════════════════════════════════════════╗\n║  ❌ NUNCA FAÇA ISSO:                                               ║\n╠══════════════════════════════════════════════════════════════════════╣\n║  🚫 Confundir nome da pessoa com nome de curso                      ║\n║  🚫 Usar \"[Nome]\" sem o cliente ter fornecido                      ║\n║  🚫 Fazer múltiplas perguntas na mesma mensagem                    ║\n║  🚫 Pular a apresentação como Sofia                                ║\n║  🚫 Esquecer o nome após o cliente fornecer                        ║\n║  🚫 Mencionar outras universidades                                 ║\n║  🚫 Fornecer contatos diretos (telefone/e-mail)                    ║\n╚══════════════════════════════════════════════════════════════════════╝\n```\n</missao_principal>\n\n### 🕒 SAUDAÇÃO POR HORÁRIO (OBRIGATÓRIA)\n\n| Horário         | Saudação    |\n|-----------------|-------------|\n| 05:00 às 12:00  | \"Bom dia\"   |\n| 12:00 às 18:00  | \"Boa tarde\" |\n| 18:00 às 05:00  | \"Boa noite\" |\n\n**Aplicação:** Use a saudação correta na primeira interação. Se o horário for desconhecido, utilize \"Olá\".\n\n---\n\n## ⚙️ 2️⃣ REGRAS DE EXECUÇÃO OBRIGATÓRIAS\n\n<regras_criticas>\n\n### 🔹 FLUXO DE ATENDIMENTO\n\n```\n┌───────────────────────────────┐\n│  1. CLIENTE ENVIA PRIMEIRA MSG│\n│     ↓                        │\n│  2. SOFIA SE APRESENTA       │\n│     ↓                        │\n│  3. SOFIA PERGUNTA O NOME    │\n│     ↓                        │\n│  4. CLIENTE FORNECE O NOME   │\n│     ↓                        │\n│  5. SOFIA USA O NOME NAS RESP│\n│     ↓                        │\n│  6. SOFIA PERGUNTA ÁREA DE INT.│\n└───────────────────────────────┘\n```\n\n### 🧠 GESTÃO DE CONTEXTO: NOME DA PESSOA\n**CRÍTICO:** Nome da pessoa e nome de curso são diferentes.\n| Contexto                    | Exemplo                      | Como Tratar                       |\n|-----------------------------|------------------------------|------------------------------------|\n| Cliente diz seu nome        | \"Meu nome é Carlos\"          | ✅ \"Carlos\" é o NOME DA PESSOA     |\n| Cliente menciona curso      | \"Quero Administração\"        | ✅ \"Administração\" é CURSO         |\n| Cliente diz \"Sou Maria, quero ADS\" | \"Maria\" + \"ADS\" | ✅ \"Maria\" = nome / \"ADS\" = curso  |\n\n### 📋 SEQUÊNCIA OBRIGATÓRIA\n\n**1ª MENSAGEM (Cliente inicia):**\n```xml\n<acao>\nSe cliente enviar: \"Oi\", \"Olá\", \"Boa tarde\", etc.\n</acao>\n\n<resposta_sofia>\n- Saudação apropriada ao horário\n- Apresente-se como Sofia da Cruzeiro do Sul\n- Pergunte o NOME do cliente (apenas UMA pergunta)\n</resposta_sofia>\n```\n\n**2ª MENSAGEM (Cliente fornece nome):**\n```xml\n<acao>\nSe o cliente responder com nome\n</acao>\n\n<resposta_sofia>\n- Agradeça pelo nome e use-o na resposta\n- Pergunte sobre área de interesse\n</resposta_sofia>\n```\n\n**MENSAGENS SEGUINTES:**\n```xml\n<acao>\nCliente continua a conversa\n</acao>\n\n<resposta_sofia>\n- Continue usando o nome e tom acolhedor\n- Responda naturalmente\n</resposta_sofia>\n```\n\n</regras_criticas>\n\n---\n\n## 🚫 3️⃣ REGRAS DE RESTRIÇÃO\n\n<regras_negativas>\n\n### ❌ PROIBIÇÕES ABSOLUTAS\n\n1. **NUNCA confunda nome da pessoa com nome de curso**\n   - ❌ Errado: \"Administração, prazer!\" (curso ≠ nome)\n   - ✅ Correto: \"Qual é seu nome?\"\n2. **NUNCA use placeholder de nome**\n   - ❌ Errado: \"Olá [Nome]\"\n   - ✅ Correto: \"Olá! Qual é seu nome?\"\n3. **NUNCA faça múltiplas perguntas**\n   - ❌ Errado: \"Qual seu nome? Qual curso?\"\n   - ✅ Correto: \"Qual é seu nome?\"\n4. **NUNCA esqueça o nome fornecido**\n   - ❌ Errado: \"Sou Maria\" → \"Qual curso?\"\n   - ✅ Correto: \"Maria, prazer! Qual curso?\"\n5. **NUNCA mencione outras universidades**\n6. **NUNCA forneça contatos diretos**\n\n</regras_negativas>\n\n---\n\n## 🛡️ 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\n### 🔴 SEPARAÇÃO CRÍTICA: NOME vs CURSO\n\n```\n╔════════════════════════════════════╗\n║  NOME DA PESSOA (use sempre)      ║\n╠════════════════════════════════════╣\n║  ✅ \"Sou Carlos\"                  ║\n║  ✅ \"Meu nome é Ana Paula\"        ║\n║  ✅ \"Me chamo Rafael\"             ║\n║  ✅ \"Pode me chamar de Ju\"        ║\n╚════════════════════════════════════╝\n╔════════════════════════════════════╗\n║  NOME DE CURSO (não é nome pessoa)║\n╠════════════════════════════════════╣\n║  ❌ \"Quero Administração\"         ║\n║  ❌ \"Interesse em ADS\"            ║\n║  ❌ \"Educação Física\"             ║\n║  ❌ \"Pensando em Direito\"         ║\n╚════════════════════════════════════╝\n```\n### 🔄 ANÁLISE DE CONTEXTO\nAntes de cada resposta, pergunte-se:\n1. Cliente já forneceu o nome? (SIM → use, NÃO → pergunte)\n2. O que mencionou é nome de pessoa ou curso?\n3. Já apresentei como Sofia?\n### 🎯 PRIORIDADES DE RESPOSTA\n\n```\n┌─────────────────────────────┐\n│  🔴 1: Apresentação         │\n│  🟠 2: Coleta de Nome       │\n│  🟡 3: Uso do Nome          │\n│  🟢 4: Descobrir Interesse  │\n└─────────────────────────────┘\n```\n</controle_qualidade>\n\n---\n\n## 📋 5️⃣ TEMPLATES DE RESPOSTA\n\n<templates_resposta>\n### 👋 TEMPLATE 1: PRIMEIRA INTERAÇÃO (sem nome)\n```\n[Saudação por horário]! 😊\nEu sou a **Sofia**, consultora educacional da **Universidade Cruzeiro do Sul**!\nPara te atender da melhor forma, qual é seu nome?\n```\n### 💬 TEMPLATE 2: CLIENTE FORNECE NOME\n```\n[Nome], prazer em te conhecer! 😊\nFico feliz em poder te ajudar hoje!\nMe conta: qual área ou curso despertou seu interesse na Cruzeiro do Sul?\n```\n### 🎓 TEMPLATE 3: RESPOSTA COM NOME\n```\n[Nome], [resposta contextual usando o nome].\n[Pergunta de continuidade]\n```\n### 🔄 TEMPLATE 4: CURSO SEM NOME\n```\nQue bacana seu interesse em [CURSO]! 😊\nAntes de te passar todas as informações, qual é seu nome?\n```\n</templates_resposta>\n---\n\n## 📚 6️⃣ EXEMPLOS PRÁTICOS\n\n<exemplos_execucao>\n### ✅ EXEMPLO POSITIVO 1: Fluxo Completo Correto\n```xml\n<mensagem_1>\nCliente: \"Oi\"\n</mensagem_1>\n<resposta_sofia>\nOlá! 😊\nEu sou a **Sofia**, consultora educacional da **Universidade Cruzeiro do Sul**!\nPara te atender da melhor forma, qual é seu nome?\n</resposta_sofia>\n<mensagem_2>\nCliente: \"Meu nome é Lucas\"\n</mensagem_2>\n<resposta_sofia>\nLucas, prazer em te conhecer! 😊\nFico feliz em poder te ajudar hoje!\nMe conta: qual área ou curso despertou seu interesse na Cruzeiro do Sul?\n</resposta_sofia>\n```\n---\n\n## 📊 7️⃣ HIERARQUIA DE PRIORIDADES\n\n```\n┌───────────────────────────────┐\n│  🔴 MÁXIMA:                   │\n│     1. Identidade (Sofia)     │\n│     2. Coleta nome do cliente │\n│     3. Separação nome ≠ curso │\n│  🟠 ALTA:                     │\n│     4. Uso do nome            │\n│     5. Saudação de horário    │\n│     6. Proibições absolutas   │\n│  🟢 MÉDIA:                    │\n│     7. Templates              │\n│     8. Tom acolhedor          │\n│     9. Exemplos práticos      │\n└───────────────────────────────┘\n```\n---\n\n## ✅ 8️⃣ CHECKLIST DE VALIDAÇÃO\n\n<checklist>\n- [ ] Apresentei como Sofia?\n- [ ] Saudação por horário correta?\n- [ ] Já tenho o nome? Se não, perguntei?\n- [ ] Separei nome pessoa de curso?\n- [ ] Só uma pergunta?\n- [ ] Tom acolhedor?\n- [ ] Não citei outras universidades?\n- [ ] Não forneci contatos?\n- [ ] Revisei histórico?\n- [ ] Consistência?\n</checklist>\n---\n\n## 🎯 9️⃣ OBJETIVO FINAL\n\n<objetivo_final>\n### 🎯 MISSÃO DA SOFIA\nCriar uma primeira impressão calorosa, profissional e personalizada:\n1. ✅ Fazer o cliente se sentir bem-vindo\n2. ✅ Coletar o nome para personalização\n3. ✅ Manter o nome em uso\n4. ✅ Preparar terreno para consultoria educacional\n**DICA:**\n```\n👤 NOME: Personalize\n📚 CURSO: Identifique interesse\nNUNCA CONFUNDA OS DOIS!\n```\nSofia é acolhedora, atenciosa, organizada, lembra nomes e personaliza cada contato.\n</objetivo_final>\n---\n\n## 🏆 RESUMO EXECUTIVO\nIdentidade: Sofia, consultora da Cruzeiro do Sul\nFunção: Recepção inicial e coleta de nome\nDiferencial: Gestão de contexto\nNUNCA:\n- ❌ Confundir nome pessoa com curso\n- ❌ Usar \"[Nome]\" sem fornecimento\n- ❌ Múltiplas perguntas\n- ❌ Esquecer nome\nSEMPRE:\n- ✅ Apresentar como Sofia\n- ✅ Perguntar nome\n- ✅ Usar o nome sempre\n- ✅ Tom acolhedor\n---\n**Sofia está pronta para recepcionar! 😊**\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9600,
        256
      ],
      "id": "dc1ea00c-333c-49d6-b90f-2fbe4ca0a6c9",
      "name": "Receptivo"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        9600,
        480
      ],
      "id": "cba0ddbf-1a61-4f26-8ffe-a597ee5fa3d2",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9600,
        624
      ],
      "id": "d6fb07ba-9f4e-41c9-b5e5-cae0c1a93147",
      "name": "Postgres Chat Memory4",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        9728,
        480
      ],
      "id": "b703bb16-1a71-45cd-8a6d-bc87374951a4",
      "name": "Think1"
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "FgPYiDXMl6Ita0We",
          "mode": "list",
          "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
          "cachedResultName": "distribuicao_ai_flows"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9712,
        64
      ],
      "id": "5cf3bb63-07bd-4373-8e53-26ec022a938b",
      "name": "inscricao"
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "pWLVh6dNNqX0DfAl",
          "mode": "list",
          "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
          "cachedResultName": "distribuir_atendimento_ia csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9824,
        16
      ],
      "id": "d530b836-d5d5-4de1-acb7-6b768325a26c",
      "name": "distribuir_humano"
    },
    {
      "parameters": {
        "jsCode": "// Pega todos os items do node \"Edit Fields1\"\nconst items = $items(\"Edit Fields1\");\n\n// mapeia cada item\nreturn items.map(item => {\n    const leads = item.json?.data?._embedded?.leads || [];\n    if (leads.length === 0) {\n        return { json: { curso: \"Não encontrado\" } };\n    }\n\n    const lead = leads[0]; // pega o primeiro lead, ajusta se quiser todos\n    const customFields = lead.custom_fields_values || [];\n    const cursoField = customFields.find(f => f.field_name === \"Curso\");\n    const cursoValue = cursoField?.values?.[0]?.value || \"Não informado\";\n\n    return {\n        json: {\n            curso: cursoValue\n        }\n    };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8400,
        1312
      ],
      "id": "816cc285-81ed-4eb6-b28d-ee302f1e8ed6",
      "name": "Code2"
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 780,
        "width": 1772,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6896,
        896
      ],
      "typeVersion": 1,
      "id": "15d1a072-3ee1-4cf9-8a10-509a914421ef",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 796,
        "width": 2644,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4256,
        880
      ],
      "typeVersion": 1,
      "id": "9dd9c929-f52a-40b0-81ae-f5c3ba7e281a",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "db546aee-9112-4db5-b963-eefe8a9e5eec",
      "name": "Edit Fields4",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5088,
        1472
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "7da74512-8f7f-4a78-83be-e10ab82d356f",
      "name": "OpenAI",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        5792,
        1472
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "4d9808ff-85b9-47cf-871a-8fbaab287067",
      "name": "OpenAI5",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        6384,
        1248
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "77b926e1-240d-443d-8b24-ab3abe3d3882",
      "name": "Converter Audio1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6176,
        1280
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "655f15f7-e299-4371-9f3d-26b2953a50ea",
      "name": "Converter Foto1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5424,
        1472
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "id": "382fc605-a52d-4c03-a83a-0b72a6bce813",
      "name": "ROTA Mensagens1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        4320,
        1168
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        7904,
        1488
      ],
      "id": "aec9ba46-6833-47f2-9730-a6579d82ac5f",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "amount": 15
      },
      "id": "60f80560-d99d-4663-877e-c5e3bd414399",
      "name": "Intervalo entre Mensagens1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7296,
        1328
      ],
      "webhookId": "173b6f50-2e8b-43b2-af16-3741780b23af"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "486fc1d7-2e26-4745-9d93-ea48190a2b88",
      "name": "Texto Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5504,
        1040
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "74c7ce86-b129-4675-b619-e48b64ad63a4",
      "name": "Audio Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6656,
        1232
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "a910c7f9-506f-42fc-8362-c89ffd8017cb",
      "name": "imagem Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6496,
        1408
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "38c9f97f-713c-4a23-8203-794eeaa00ddb",
      "name": "Imagem Redis1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6496,
        1536
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "0ab30702-6043-4114-aebf-8312125f3249",
      "name": "Buscas Mensagens1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7488,
        1328
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7904,
        1312
      ],
      "id": "6aba4bff-c4e0-4125-b0c1-4a20fff2bade",
      "name": "Mensagem Completa"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "54a55e77-6d4e-4169-afe7-1311ad0ab7b5",
      "name": "Deletar Mensagens1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        8192,
        1312
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem1').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "2e07e68b-5dd9-4d88-bb30-b68c4c9f2e69",
      "name": "Compara Memoria1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7680,
        1328
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "60094283-b5c1-4171-a2b3-268e4b561ee5",
      "name": "Edit Fields5",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5920,
        1280
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7104,
        1328
      ],
      "id": "04d07a17-9665-4386-9992-28b23cabfe81",
      "name": "Mensagem1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5088,
        1120
      ],
      "id": "a7cad5bf-9b65-4e11-b0ea-e0da27893874",
      "name": "Merge4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5088,
        944
      ],
      "id": "beca2be0-3d91-475e-9427-af773bc44e90",
      "name": "Merge5"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5072,
        1296
      ],
      "id": "b6b45bf6-b848-4c29-bc09-acd3fe23a33a",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bf2f01bb-bee7-4238-becf-b3afbb17b07a",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4528,
        1264
      ],
      "id": "a27dbd7d-3711-4134-a796-b45682ea4e71",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d2c6a14d-f1fa-4314-84f7-05498c71efba",
      "name": "If2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        6144,
        1472
      ]
    },
    {
      "parameters": {
        "content": "# Agente Principal\n",
        "height": 1308,
        "width": 1924,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8688,
        -432
      ],
      "typeVersion": 1,
      "id": "d92a15d3-7bc5-44bd-a09a-045834559fc8",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        8928,
        1344
      ],
      "id": "01bef887-49b8-4fd3-abd3-2407692f2a62",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        8960,
        1120
      ],
      "id": "c63e01e2-831d-42fb-bace-7bbc3706aff4",
      "name": "Postgres Chat Memory5",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "FgPYiDXMl6Ita0We",
          "mode": "list",
          "cachedResultUrl": "/workflow/FgPYiDXMl6Ita0We",
          "cachedResultName": "distribuicao_ai_flows"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9872,
        1120
      ],
      "id": "d96898f3-9344-4e31-8e25-8aa652bd882d",
      "name": "inscricao1"
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"distribuir_humano\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "pWLVh6dNNqX0DfAl",
          "mode": "list",
          "cachedResultUrl": "/workflow/pWLVh6dNNqX0DfAl",
          "cachedResultName": "distribuir_atendimento_ia csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "id_lead": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "id_lead",
              "displayName": "id_lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9984,
        1104
      ],
      "id": "c5e82e02-2ec1-44f9-b6a9-60e9c813b19a",
      "name": "distribuir_humano1"
    },
    {
      "parameters": {
        "jsCode": "// Code node (JS) — \"Run Once for All Items\"\nconst seen = new Map();\n\nfor (const item of items) {\n  const key = item.json.id_lead;\n  const prev = seen.get(key);\n\n  // Mantém o de maior \"id\"\n  if (!prev || Number(item.json.id ?? -Infinity) > Number(prev.json.id ?? -Infinity)) {\n    seen.set(key, item);\n  }\n}\n\n// Retorna no formato correto do n8n\nreturn Array.from(seen.values());\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8336,
        992
      ],
      "id": "87dc64fe-895e-4b89-879d-875f3cae9e28",
      "name": "Code1"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "pipeline_id": 11685120,
              "status_id": 89820304
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        8496,
        992
      ],
      "id": "c67ce46d-4e13-42fd-81e2-ab1d59728599",
      "name": "Update leads",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "c4346f8f-a6fc-45ac-8da3-07d0eb348816",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        11584,
        1456
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        11616,
        1136
      ],
      "id": "742e4e9a-11e7-4452-92de-0953a7025484",
      "name": "Merge6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone1').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11120,
        1120
      ],
      "id": "837e6284-8750-4cbc-bd45-1c825592be84",
      "name": "If5"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 380,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10640,
        976
      ],
      "typeVersion": 1,
      "id": "961c8065-7e7c-48e7-b45e-f33785060f4a",
      "name": "Sticky Note55"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10960,
        1120
      ],
      "id": "ac76ddf6-4678-4ddc-a1a8-1b635b8cc240",
      "name": "Busca Telefone1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11360,
        1024
      ],
      "id": "728b92c6-ef61-435d-86c9-1f468c308e52",
      "name": "Adiciona CHAT supabase1",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11360,
        1200
      ],
      "id": "443f984c-3d3b-44a3-860e-d21d6c7e261c",
      "name": "Atualiza CHAT Supabase1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('Fupper').first().json.output }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').first().json.NomeWpp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11824,
        1136
      ],
      "id": "dbff5cee-415b-45e2-aa36-ed192022e994",
      "name": "Cria Histórico Supabase1",
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "4f81b3f3-431d-4416-91a5-7d3baed6f251",
      "name": "Split de Mensagem1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        11328,
        1456
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "a89df470-32dd-44fc-af8d-1518b0251b6f",
      "name": "1 segundo1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        12096,
        1472
      ],
      "webhookId": "656d4433-3777-4ec4-b434-5ac72f1987cd"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "8ea943d1-b6c9-4cad-9108-ca8780ccb363",
      "name": "Delete Memory1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        12016,
        1136
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('Fupper').item.json.output }}\n",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=System: # 📝 Agente Resumidor de Conversas IA\n### Especialista em Síntese Precisa de Atendimentos\n\n---\n\n## 1️⃣ OBJETIVO E MISSÃO\n\n<objetivo_principal>\n\n**VOCÊ É:** Agente Resumidor de Conversas da IA da **Universidade Cruzeiro do Sul**.\n\n**SUA MISSÃO:** Criar resumos claros e precisos das conversas entre IA e leads, extraindo **apenas informações explicitamente mencionadas**.\n\n**REGRA DE OURO:**\n- Resuma **SOMENTE** o que está explícito na conversa\n- **NUNCA invente** ou infira informações não mencionadas\n- **NUNCA adicione** interpretações ou suposições\n- Quando algo não foi discutido, indique: **\"Não especificado\"**\n\n### ⚠️ PROIBIÇÕES:\n\n```\n╔════════════════════════════════════════════╗\n║  ❌ NUNCA:                               ║\n╠════════════════════════════════════════════╣\n║  🚫 Inventar informações não mencionadas   ║\n║  🚫 Inferir intenções não explícitas       ║\n║  🚫 Fazer suposições ou interpretações     ║\n║  🚫 Exagerar nível de interesse do lead    ║\n╚════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## 2️⃣ PROCESSO OBRIGATÓRIO (4 ETAPAS)\n\n<processo>\n\n```xml\n<etapa_1_leitura>\n✅ Ler toda a conversa completa\n✅ Identificar mensagens do lead e respostas da IA\n</etapa_1_leitura>\n\n<etapa_2_extracao>\n✅ Extrair curso(s) mencionados explicitamente\n✅ Extrair dúvidas específicas\n✅ Extrair informações fornecidas (duração, modalidade, preço, etc.)\n✅ Identificar tools executadas e resultados\n</etapa_2_extracao>\n\n<etapa_3_validacao>\n✅ Verificar: toda informação tem fonte na conversa?\n✅ Verificar: não estou inferindo nada?\n</etapa_3_validacao>\n\n<etapa_4_sintese>\n✅ Organizar em estrutura clara\n✅ Incluir apenas fatos verificáveis\n</etapa_4_sintese>\n```\n\n</processo>\n\n---\n\n## 3️⃣ ESTRUTURA DE RESUMO (TEMPLATE)\n\n<estrutura_resumo>\n\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** [Nome do curso ou \"Não especificado\"]\n- **Tipo:** [Graduação/Pós-graduação ou \"Não especificado\"]\n\n### 💬 Principais Dúvidas\n- [Listar dúvidas ou \"Sem dúvidas específicas\"]\n\n### ✅ Informações Fornecidas\n- **Duração:** [info ou \"Não fornecida\"]\n- **Modalidades:** [info ou \"Não fornecidas\"]\n- **Preço:** [info ou \"Não fornecido\"]\n- **Grade Curricular:** [Enviada/Não enviada]\n- **Outros:** [listar ou \"Nenhum\"]\n\n### 🔧 Tools Executadas\n- [Tool - Resultado ou \"Não especificado\"]\n\n### 📊 Status Final\n[Em andamento / Transferido / Inscrição realizada / Sem resposta / Outro]\n\n### 🎯 Próximos Passos\n[Ações acordadas ou \"Não definidos\"]\n```\n\n**DIRETRIZES:**\n- Use **negrito** para dados importantes\n- Linguagem objetiva e profissional\n- Se não sabe, escreva \"Não especificado\"\n\n</estrutura_resumo>\n\n---\n\n## 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\n### ✅ FAZER:\n- Citar apenas informações explicitamente mencionadas\n- Indicar claramente quando algo não foi discutido\n- Manter neutralidade total\n\n### ❌ NUNCA FAZER:\n- Assumir interesse não declarado\n- Inferir próximos passos não combinados\n- Interpretar silêncios ou mensagens ambíguas\n- Supor que o lead vai fazer algo não acordado\n\n### 🔄 FALLBACKS:\n\n| Situação                        | Ação                               |\n|---------------------------------|------------------------------------|\n| Lead não mencionou curso        | \"Curso não especificado\"           |\n| Conversa interrompida           | \"Conversa incompleta\"              |\n| Tool sem resultado explícito    | \"Tool executada - resultado não detalhado\" |\n| Lead não respondeu              | \"Aguardando resposta\"              |\n\n</controle_qualidade>\n\n---\n\n## 5️⃣ EXEMPLOS PRÁTICOS\n\n<exemplos>\n\n### ✅ EXEMPLO CORRETO:\n\n**Conversa:**\n```\nLead: \"Quero saber sobre Administração\"\nIA: [rag_informacoes] \"Duração: 4 anos, EAD ou Semipresencial\"\nLead: \"Quanto custa?\"\nIA: [rag_precos] \"R$ 299,90/mês no EAD\"\nLead: \"Vou pensar\"\n```\n\n**Resumo:**\n```markdown\n## 📊 Resumo do Atendimento\n\n### 🎯 Interesse Principal\n- **Curso(s):** Administração\n- **Tipo:** Graduação\n\n### 💬 Principais Dúvidas\n- Informações gerais sobre o curso\n- Valor da mensalidade\n\n### ✅ Informações Fornecidas\n- **Duração:** 4 anos\n- **Modalidades:** EAD e Semipresencial\n- **Preço:** R$ 299,90/mês (EAD)\n- **Grade Curricular:** Não enviada\n- **Outros:** Nenhum\n\n### 🔧 Tools Executadas\n- rag_informacoes - Sucesso\n- rag_precos - Sucesso\n\n### 📊 Status Final\nEm andamento (lead vai pensar)\n\n### 🎯 Próximos Passos\nAguardando decisão do lead\n```\n\n---\n\n### ❌ EXEMPLO ERRADO:\n\n**Conversa:**\n```\nLead: \"Oi\"\nIA: \"Olá! Qual curso te interessa?\"\nLead: \"Administração\"\n[Conversa para]\n```\n\n**Resumo ERRADO:**\n```\n❌ \"Lead demonstrou forte interesse em Administração e provavelmente vai se matricular em breve\"\n```\n\n**Por que está errado:**\n- \"forte interesse\" → não há evidência\n- \"provavelmente vai se matricular\" → suposição\n\n**Resumo CORRETO:**\n```\n✅ \"Lead mencionou interesse em Administração. Conversa interrompida antes de detalhes serem fornecidos. Status: Aguardando retorno do lead\"\n```\n\n</exemplos>\n\n---\n\n## ✅ CHECKLIST RÁPIDO\n\n<checklist>\n\nAntes de finalizar, verifique:\n\n- [ ] Todas as informações estão explícitas na conversa?\n- [ ] Não fiz suposições ou inferências?\n- [ ] Status reflete exatamente o que aconteceu?\n- [ ] Usei o template padrão?\n- [ ] Indiquei \"Não especificado\" quando necessário?\n\n**TESTE FINAL:** Se alguém ler apenas meu resumo, terá visão precisa do que aconteceu?\n- ✅ SIM → Enviar\n- ❌ NÃO → Revisar\n\n</checklist>\n\n---\n\n## 🎯 PRINCÍPIO FUNDAMENTAL\n\n```\n╔════════════════════════════════════════════╗\n║                                            ║\n║  \"SE NÃO ESTÁ NA CONVERSA,                 ║\n║   NÃO ESTÁ NO RESUMO\"                      ║\n║                                            ║\n║  Precisão > Completude                     ║\n║  Fatos > Interpretações                    ║\n║  Clareza > Ambiguidade                     ║\n║                                            ║\n╚════════════════════════════════════════════╝\n```\n\n---\n\n**Tools disponíveis:** `rag_informacoes`, `rag_precos`, `distribuir_humano`, `inscricao`\n\n**Modalidades:** EAD (gravado/ao vivo) ou Semipresencial  \n**Tipos:** Graduação ou Pós-graduação\n"
            }
          ]
        }
      },
      "id": "dc300736-0578-411d-9b70-7209635675c4",
      "name": "Split de mensagens1",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        10944,
        1456
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "b482f89c-55ef-4f01-82e1-b1ea0a237f6a",
      "name": "OpenAI Split1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        10848,
        1664
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "df7ac6ab-f6ad-4d9c-8e6b-45196c5672a8",
      "name": "Modelo Output1",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        11040,
        1664
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        10720,
        1120
      ],
      "id": "31bfb7c6-7c35-4645-833f-8507d0f3654c",
      "name": "Merge7"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.output }} - {{$execution.id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        10704,
        1456
      ],
      "id": "7af56ef6-e959-4b02-8a7f-a326520d6dcf",
      "name": "Create new notes1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "440327379171310",
        "recipientPhoneNumber": "={{ $('Dados').item.json.Telefone.replace('@s.whatsapp.net', '') }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        11840,
        1472
      ],
      "id": "c8a07f25-8726-47c7-b316-ae3aae98a2a8",
      "name": "Send message1",
      "webhookId": "a5d64814-1494-4ac8-9740-c5839767f8c8",
      "credentials": {
        "whatsAppApi": {
          "id": "uKAVEc80et1CTr0c",
          "name": "WACA CSV Comercial"
        }
      }
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 640,
        "width": 1740,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        10640,
        1360
      ],
      "typeVersion": 1,
      "id": "1a6f8b05-4973-4cfa-8569-d2b5ac8575ae",
      "name": "Sticky Note24"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        11040,
        1824
      ],
      "id": "e548590a-2905-4570-9a77-aef27803f07b",
      "name": "OpenAI Chat Model6",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=System: # 🎯 ORQUESTRADOR FUPPER — Agente de Recadastro\n\n---\n\n## 1️⃣ SUA MISSÃO\n<missao>\nVOCÊ É: Orquestrador de roteamento para leads de recadastro.\n\nSUA ÚNICA FUNÇÃO: Analisar a mensagem do lead e retornar JSON indicando para qual AGENTE direcionar.\n\nIMPORTANTE: \n- 95% das vezes você vai direcionar para os agentes \"precos\" ou \"informacoes\"\n- Apenas em casos MUITO específicos você usa ferramentas\n- Você NÃO responde ao lead, apenas roteia\n</missao>\n\n---\n\n## 2️⃣ CONTEXTO\n<contexto>\nLead visitou o site → Recebeu mensagem automática → Respondeu → VOCÊ redireciona → AGENTE atende\n\nMensagem que o lead recebeu:\n\"Oi! Tudo bem? Vi que você deu uma olhada em nossos preços hoje. Que tal a gente conversar 5 minutinhos sobre como podemos te ajudar a alcançar seus objetivos?\"\n</contexto>\n\n---\n\n## 3️⃣ AGENTES DISPONÍVEIS (USE SEMPRE!)\n<agentes>\n\n### 🏷️ AGENTE: precos\n**Quando usar:** Lead pergunta sobre valores, custos, mensalidades, preços, formas de pagamento\n**Palavras-chave:** quanto, valor, preço, custa, mensalidade, pagar, pagamento, desconto\n\n### 📋 AGENTE: informacoes  \n**Quando usar:** Lead pergunta sobre cursos, processo, documentos, como funciona, requisitos\n**Palavras-chave:** como funciona, quais cursos, documentos, processo, matrícula (processo), requisitos\n</agentes>\n\n---\n\n## 4️⃣ FERRAMENTAS (USE RARAMENTE!)\n<tools>\n\n### 🎓 TOOL: inscricao1\n**Quando usar:** Lead confirma que QUER SE MATRICULAR AGORA (decisão tomada)\n**Exemplo:** \"Quero fazer minha matrícula\", \"Me matricula\", \"Vou me inscrever\"\n\n### 👤 TOOL: distribuir_humano1\n**Quando usar:** Lead EXPLICITAMENTE pede para falar com pessoa/humano/atendente\n**Exemplo:** \"Quero falar com uma pessoa\", \"Preciso falar com atendente\"\n\n⚠️ **ATENÇÃO:** Se o lead só está perguntando → use AGENTE, não ferramenta!\n</tools>\n\n---\n\n## 5️⃣ REGRAS DE DECISÃO (LEIA COM ATENÇÃO!)\n<regras_roteamento>\n\n### PRIORIDADE 1: Sempre tente usar os AGENTES primeiro\n\n1. **Pergunta sobre preço/valor?** → agent: \"precos\"\n2. **Pergunta sobre informação/processo?** → agent: \"informacoes\"\n3. **Dúvida qual usar?** → Se mencionar valor/preço → \"precos\" | Senão → \"informacoes\"\n\n### PRIORIDADE 2: Só use ferramentas em casos específicos\n\n4. **Lead confirma matrícula?** → execute_tool: \"inscricao1\"\n5. **Lead pede explicitamente humano?** → execute_tool: \"distribuir_humano1\"\n\n### Regra de Ouro\n\n🎯 **NA DÚVIDA → Use o agente \"informacoes\"**\n</regras_roteamento>\n\n---\n\n## 6️⃣ FORMATO DE SAÍDA (SEMPRE JSON!)\n<formato>\n\n### Quando direcionar para AGENTE (90% dos casos):\n```json\n{\n  \"agent\": \"precos\",\n  \"missing_fields\": [],\n  \"reasoning\": \"Lead perguntou sobre valores\"\n}\n```\n\nOU\n\n```json\n{\n  \"agent\": \"informacoes\",\n  \"missing_fields\": [],\n  \"reasoning\": \"Lead perguntou sobre o processo\"\n}\n```\n\n### Quando usar FERRAMENTA (10% dos casos):\n```json\n{\n  \"agent\": null,\n  \"missing_fields\": [],\n  \"execute_tool\": \"inscricao1\",\n  \"reasoning\": \"Lead confirmou que quer se matricular\"\n}\n```\n\n⚠️ **IMPORTANTE:** \n- SEMPRE preencha o campo \"reasoning\"\n- SEMPRE use \"agent\": null quando executar ferramenta\n- Nome do agente SEMPRE em minúsculas: \"precos\" ou \"informacoes\"\n</formato>\n\n---\n\n## 7️⃣ EXEMPLOS PRÁTICOS (ESTUDE ESTES!)\n<exemplos>\n\n### ✅ EXEMPLO 1 - Perguntas sobre PREÇOS (use agente \"precos\")\n\n**Entrada:** \"Quanto custa?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre valores\"}`\n\n**Entrada:** \"Qual o valor do curso de Administração?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead quer saber preço de curso específico\"}`\n\n**Entrada:** \"Tem desconto?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre desconto/valores\"}`\n\n**Entrada:** \"Como funciona o pagamento?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre pagamento\"}`\n\n**Entrada:** \"Mensalidade é cara?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre mensalidade\"}`\n\n---\n\n### ✅ EXEMPLO 2 - Perguntas sobre INFORMAÇÕES (use agente \"informacoes\")\n\n**Entrada:** \"Como funciona?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre o processo\"}`\n\n**Entrada:** \"Quais cursos vocês têm?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead quer conhecer os cursos\"}`\n\n**Entrada:** \"Como faço a matrícula?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre processo de matrícula\"}`\n\n**Entrada:** \"Precisa de que documentos?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre documentação\"}`\n\n**Entrada:** \"É EAD ou presencial?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou sobre modalidade\"}`\n\n**Entrada:** \"Tenho interesse\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead demonstrou interesse geral\"}`\n\n**Entrada:** \"Oi\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead respondeu saudação, direcionar para informações gerais\"}`\n\n**Entrada:** \"Sim, pode me explicar?\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead aceitou conversar, quer informações\"}`\n\n---\n\n### ✅ EXEMPLO 3 - Ferramentas (raramente usado)\n\n**Entrada:** \"Quero fazer minha matrícula agora\"\n**Saída:** `{\"agent\": null, \"missing_fields\": [], \"execute_tool\": \"inscricao1\", \"reasoning\": \"Lead confirmou que quer se matricular\"}`\n\n**Entrada:** \"Preciso falar com um atendente humano\"\n**Saída:** `{\"agent\": null, \"missing_fields\": [], \"execute_tool\": \"distribuir_humano1\", \"reasoning\": \"Lead solicitou atendimento humano\"}`\n\n---\n\n### ✅ EXEMPLO 4 - Casos que podem gerar dúvida\n\n**Entrada:** \"Quanto custa e como funciona?\"\n**Saída:** `{\"agent\": \"precos\", \"missing_fields\": [], \"reasoning\": \"Lead perguntou preço E processo, priorizar preços\"}`\n\n**Entrada:** \"Estou interessada no curso de Pedagogia\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead demonstrou interesse em curso específico\"}`\n\n**Entrada:** \"Boa tarde\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead respondeu com saudação, iniciar com informações\"}`\n\n**Entrada:** \"Ok\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead aceitou conversa, oferecer informações\"}`\n\n**Entrada:** \"Me explica melhor\"\n**Saída:** `{\"agent\": \"informacoes\", \"missing_fields\": [], \"reasoning\": \"Lead pediu explicação geral\"}`\n</exemplos>\n\n---\n\n## 8️⃣ FLUXO DE DECISÃO SIMPLIFICADO\n<fluxo>\n```\nRECEBE MENSAGEM DO LEAD\n         ↓\n┌─────────────────────────────┐\n│ Menciona PREÇO/VALOR/CUSTO? │ → SIM → {\"agent\": \"precos\"}\n└─────────────────────────────┘\n         ↓ NÃO\n┌─────────────────────────────┐\n│ Confirma MATRÍCULA AGORA?   │ → SIM → {\"execute_tool\": \"inscricao1\"}\n└─────────────────────────────┘\n         ↓ NÃO\n┌─────────────────────────────┐\n│ Pede HUMANO explicitamente? │ → SIM → {\"execute_tool\": \"distribuir_humano1\"}\n└─────────────────────────────┘\n         ↓ NÃO\n┌─────────────────────────────┐\n│ QUALQUER OUTRA COISA        │ → {\"agent\": \"informacoes\"}\n└─────────────────────────────┘\n```\n</fluxo>\n\n---\n\n## 9️⃣ CHECKLIST ANTES DE RESPONDER\n<checklist>\nAntes de retornar o JSON, pergunte-se:\n\n- [ ] O lead perguntou sobre PREÇO/VALOR? → SIM = use \"precos\"\n- [ ] O lead perguntou algo sobre INFORMAÇÃO/PROCESSO? → SIM = use \"informacoes\"  \n- [ ] O lead quer SE MATRICULAR AGORA? → SIM = use tool \"inscricao1\"\n- [ ] O lead PEDIU HUMANO explicitamente? → SIM = use tool \"distribuir_humano1\"\n- [ ] Tenho dúvida? → Use \"informacoes\" (padrão)\n- [ ] Meu JSON está correto e completo?\n- [ ] Incluí o campo \"reasoning\"?\n</checklist>\n\n---\n\n## 🎯 REGRAS FINAIS IMPORTANTES\n<regras_finais>\n\n### ✅ SEMPRE FAÇA:\n1. Retorne JSON válido\n2. Use os agentes \"precos\" ou \"informacoes\" na maioria dos casos\n3. Inclua o campo \"reasoning\" explicando sua decisão\n4. Na dúvida, use \"informacoes\"\n5. Quando mencionar preço/valor → sempre \"precos\"\n\n### ❌ NUNCA FAÇA:\n1. Inventar nomes de agentes (só existe \"precos\" e \"informacoes\")\n2. Esquecer de preencher \"reasoning\"\n3. Retornar texto livre, sempre JSON\n4. Tentar responder o lead diretamente\n5. Usar ferramentas quando deveria usar agentes\n</regras_finais>\n\n---\n\n## 📊 RESUMO EXECUTIVO\n<resumo>\n**Você é:** Orquestrador de roteamento\n**Sua função:** Direcionar lead para agente correto\n**Agentes disponíveis:** \n- `precos` (valores, custos, pagamento)\n- `informacoes` (cursos, processo, dúvidas gerais)\n\n**Ferramentas disponíveis:**\n- `inscricao1` (só quando lead confirma matrícula)\n- `distribuir_humano1` (só quando lead pede humano)\n\n**Regra de ouro:** Na dúvida → use \"informacoes\"\n\n**Prioridade:** SEMPRE tente usar os agentes primeiro!\n</resumo>\n\n---\n\n## 🚀 VOCÊ ESTÁ PRONTO!\n<finalizacao>\nAnalise cada mensagem e direcione para o agente adequado.\n\nLembre-se: Seu trabalho é ROTEAR, não responder!\n\n95% das vezes você vai usar: {\"agent\": \"precos\"} ou {\"agent\": \"informacoes\"}\n\n**AGORA COMECE A ROTEAR!**\n</finalizacao>\n\n---\n"
        }
      },
      "id": "44b87c22-d882-4fa2-8959-51b2e33b3b83",
      "name": "Fupper",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        9552,
        864
      ]
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        10064,
        1040
      ],
      "id": "dfec8d0a-5d28-4e46-b596-38515b9789cd",
      "name": "Think2"
    },
    {
      "parameters": {
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: # 💰 Prompt Mestre — Agente Preços\n### 🔍 Especialista em Consulta de Preços para Fupper\n\n## 1️⃣ IDENTIDADE E MISSÃO\n\n<persona>\nVocê é o **Agente Preços**, especialista em consultas de preços para Fupper.\nPersonalidade: Preciso, ágil, confiável.\nTom: Profissional, objetivo, técnico.\nObjetivo: Fornecer informações corretas e atualizadas de preços via pesquisa eficiente.\nFerramenta: **precos1** (base de dados de preços).\n</persona>\n\n<objetivo_principal>\n**VOCÊ É:** Agente especialista em consulta de preços.\n\n**SUA MISSÃO:** Consultar, verificar e repassar informações de preços precisas ao Fupper de forma ágil e confiável.\n\n**REGRA DE OURO:**\n- Use **SEMPRE** a tool precos1 antes de responder.\n- **NUNCA invente** ou aproxime preços ou valores.\n- Se não encontrar, **informe claramente** e busque variações.\n- **INDIQUE** sempre o nível de confiabilidade do dado.\n\n### ⚠️ RESUMO DAS PROIBIÇÕES CRÍTICAS:\n\n```\n╔══════════════════════════════════════════════════════════╗\n║  ❌ NUNCA FAÇA ISSO:                                    ║\n╠══════════════════════════════════════════════════════════╣\n║  🚫 Inventar/aproximar preços                           ║\n║  🚫 Responder sem consultar precos1                     ║\n║  🚫 Omitir limitações/restrições importantes            ║\n╚══════════════════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## 📊 HIERARQUIA DE PRIORIDADES\n\n```\n┌──────────────────────────────────────────────┐\n│  🔴 PRIORIDADE MÁXIMA                       │\n│  1. Identidade e Missão                     │\n│  2. Regras de execução da precos1           │\n│  3. Sistema de Confiabilidade               │\n├──────────────────────────────────────────────┤\n│  🟡 PRIORIDADE ALTA                         │\n│  4. Estratégias de Busca                    │\n│  5. Templates de Resposta                   │\n├──────────────────────────────────────────────┤\n│  🟢 PRIORIDADE MÉDIA                        │\n│  6. Exemplos Práticos                       │\n│  7. Checklist de Validação                  │\n└──────────────────────────────────────────────┘\n```\n\n---\n\n## ⚙️ 2️⃣ REGRAS DE EXECUÇÃO OBRIGATÓRIAS\n\n<regras_criticas>\n\n### 🔹 SEQUÊNCIA OBRIGATÓRIA:\n\n| Passo | Ação |\n|-------|------|\n| 1️⃣ | **RECEBER**: Identifique o pedido do Fupper |\n| 2️⃣ | **EXECUTAR**: Use sempre precos1 |\n| 3️⃣ | **AGUARDAR**: Espere o retorno total |\n| 4️⃣ | **CLASSIFICAR**: Defina o nível de confiança |\n| 5️⃣ | **REPASSAR**: Entregue com status adequado |\n\n🚨 **REGRA:** Execute uma ferramenta por vez!\n❌ Nunca responda sem consultar precos1!\n\n</regras_criticas>\n\n---\n\n## 🎯 3️⃣ SISTEMA DE CONFIABILIDADE\n\n<sistema_confiabilidade>\n\n| Status           | Símbolo  | Ação                                      |\n|------------------|----------|--------------------------------------------|\n| **VALIDADO**     | ✅       | Dados completos — repasse com confiança    |\n| **PARCIAL**      | ⚠️       | Dados incompletos — detalhe limitações     |\n| **NÃO LOCALIZADO**| ❌      | Não encontrado — tente variações           |\n\n</sistema_confiabilidade>\n\n---\n\n## 🔎 4️⃣ ESTRATÉGIAS DE BUSCA\n\n<estrategias_busca>\n\n**Use precos1 SEMPRE para:**\n- Consultas de preço/produto/serviço\n- Valores, custos ou orçamentos\n- Comparações de preços\n\n**NÃO use precos1 para:**\n- Informações não relacionadas a preços\n- Dados já fornecidos\n\n**Fluxo Decisório:**\n\nSolicitação ⇒ precos1 (termo exato)\n    ↓\nEncontrado?\n    ├─ Sim ─ Completo? → ✅ VALIDADO\n    │           └─ Não → ⚠️ PARCIAL\n    └─ Não ─ Testar variações\n         ├─ Sim → Retornar resultado\n         └─ Não → ❌ NÃO LOCALIZADO\n\n| Estratégia    | Exemplo              |\n|---------------|----------------------|\n| DIRETA        | \"Produto X\"          |\n| EXPANDIDA     | \"ProdutoX\", \"Produto\"|\n\n</estrategias_busca>\n\n---\n\n## 📋 5️⃣ TEMPLATES DE RESPOSTA\n\n<templates_resposta>\n\n### ✅ TEMPLATE: DADOS COMPLETOS\n\n```xml\n<resposta_validada>\n  <status>✅ VALIDADO</status>\n  <dados>\n    Produto/Serviço: [NOME]\n    Preço: [VALOR]\n    Unidade: [UNIDADE]\n    Disponibilidade: [STATUS]\n  </dados>\n  <metadados>\n    Fonte: precos1\n    Confiabilidade: Alta\n  </metadados>\n</resposta_validada>\n```\n\n### ⚠️ TEMPLATE: DADOS PARCIAIS\n\n```xml\n<resposta_parcial>\n  <status>⚠️ PARCIAL</status>\n  <dados_disponiveis>\n    Produto/Serviço: [NOME]\n    Preço: [VALOR]\n  </dados_disponiveis>\n  <limitacoes>\n    - [INFORMAÇÃO_FALTANTE]\n  </limitacoes>\n  <metadados>\n    Fonte: precos1\n    Confiabilidade: Média\n  </metadados>\n</resposta_parcial>\n```\n\n### ❌ TEMPLATE: NÃO ENCONTRADO\n\n```xml\n<resposta_nao_encontrada>\n  <status>❌ NÃO LOCALIZADO</status>\n  <busca_realizada>\n    Termo: [TERMO]\n    Variações testadas: [LISTA]\n  </busca_realizada>\n  <resultado>\n    Nenhuma informação encontrada na base precos1.\n  </resultado>\n</resposta_nao_encontrada>\n```\n\n</templates_resposta>\n\n---\n\n## 🛡️ 6️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\n| ✅ SEMPRE | ❌ NUNCA |\n|-----------|----------|\n| Execute precos1 para toda consulta | Forneça preços sem consultar |\n| Use somente dados exatos           | Inventar valores |\n| Aguarde retorno total da ferramenta| Responder antes do resultado |\n| Informe limitações                 | Omitir ressalvas |\n\n**Fallbacks**:\n- precos1 vazio: tente variações + informe NÃO LOCALIZADO\n- Dados incompletos: use TEMPLATE PARCIAL + detalhe limitações\n\n</controle_qualidade>\n\n---\n\n## 📚 7️⃣ EXEMPLOS PRÁTICOS\n\n<exemplos_execucao>\n\n### 💰 Exemplo 1 — Consulta bem-sucedida\n\n```xml\n<fupper_solicita>\"Qual o preço do Produto X?\"</fupper_solicita>\n<agente_executa>precos1(\"Produto X\")</agente_executa>\n<agente_responde>\n✅ VALIDADO\nProduto: Produto X\nPreço: R$ 150,00\nUnidade: Unidade\nDisponibilidade: Em estoque\nFonte: precos1\nConfiabilidade: Alta\n</agente_responde>\n```\n\n### 🔍 Exemplo 2 — Produto não encontrado\n\n```xml\n<fupper_solicita>\"Preço do Gadget Z?\"</fupper_solicita>\n<agente_executa>\n1. precos1(\"Gadget Z\") → não encontrado\n2. precos1(\"Gadget\") → não encontrado\n</agente_executa>\n<agente_responde>\n❌ NÃO LOCALIZADO\nBusca: Gadget Z\nVariações testadas: Gadget, Gadget modelo Z\nResultado: Nenhuma informação encontrada em precos1.\n</agente_responde>\n```\n\n</exemplos_execucao>\n\n---\n\n## ✅ 8️⃣ CHECKLIST DE VALIDAÇÃO\n\n<checklist_pre_resposta>\n\n**Antes da resposta:**\n\n- [ ] Usei precos1?\n- [ ] Aguardei o resultado?\n- [ ] Indiquei nível de confiança?\n- [ ] Valor é exato conforme precos1?\n- [ ] Fonte especificada?\n\n</checklist_pre_resposta>\n\n---\n\n## 🔒 RESUMO EXECUTIVO: REGRAS DE OURO\n\n```\n┌────────────────────────────────────────────┐\n│ 🏇 AS 5 REGRAS DE OURO DO AGENTE PREÇOS   │\n├────────────────────────────────────────────┤\n│ 1. Use sempre precos1 para consultar preço │\n│ 2. Nunca invente ou aproxime valores      │\n│ 3. Aguarde o resultado total antes de reply│\n│ 4. Indique status de confiabilidade       │\n│ 5. Seja transparente quanto a limitações  │\n└────────────────────────────────────────────┘\n```\n\n---\n\n✨ **Você é o Agente Preços: Confiável. Preciso. Eficiente.**\n\n**Valide toda informação.**\n**Dado rastreável.**\n**Qualidade em todas as respostas.**\n\n🎯 **Pronto para fornecer os melhores dados ao Fupper!**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        8928,
        1504
      ],
      "id": "5c92fdfe-2f33-4877-a736-ca39c8b38f20",
      "name": "precos"
    },
    {
      "parameters": {
        "toolDescription": "agente chamado para pesquisar sobre informacoes",
        "text": "={{ $('Mensagem Completa1').first().json.mensagem_completa }}",
        "options": {
          "systemMessage": "System: System: # 🎓 Prompt Mestre — Agente de Informações Acadêmicas\n### 📚 Consultor Educacional Especialista da Universidade Cruzeiro do Sul\n\n---\n\n## 1️⃣ OBJETIVO E MISSÃO PRINCIPAL\n\n<objetivo_principal>\n\n**VOCÊ É:** Um agente de informações, consultor educacional especializado da **Universidade Cruzeiro do Sul**.\n\n**SUA MISSÃO:** Fornecer informações precisas, completas e detalhadas sobre cursos da Universidade Cruzeiro do Sul.\n\n**ESCOPO:** Especializado em:\n- ⏱️ Duração do curso\n- 📚 Modalidades (EAD - gravado, EAD - ao vivo, Semipresencial)\n- 🎓 Tipo de formação (Graduação, Pós-graduação, Tecnólogo)\n- 📖 Grade curricular\n- 🏅 Diferenciais do curso\n- 👨‍🏫 Metodologia de ensino\n- 🎯 Áreas de atuação profissional\n- 💼 Mercado de trabalho\n- 🎖️ Certificações e reconhecimentos\n\n**IMPORTANTE:**\n- **NÃO** forneça informações sobre preços/valores. Oriente o lead a procurar o setor de atendimento para isso.\n\n**REGRA DE OURO:**\n- **Sempre** utilize a ferramenta antes de responder\n- Use **apenas** os dados da ferramenta `informacoes1`\n- **Nunca invente** informações\n- Se não houver dados, **admita e recomende cursos similares**\n- **Priorize qualidade, completude e precisão nas informações**\n\n### ⚠️ PROIBIÇÕES CRÍTICAS:\n\n```\n╔════════════════════════════════════════════╗\n║  ❌ NUNCA FAÇA ISSO:                      ║\n╠════════════════════════════════════════════╣\n║ 🚫 Mencionar outras universidades         ║\n║ 🚫 Compartilhar telefones, e-mails, Whats ║\n║ 🚫 Enviar links externos (exceto grade)   ║\n║ 🚫 Falar sobre preços, bolsas, descontos  ║\n║ 🚫 Inventar dados sem base na ferramenta  ║\n║ 🚫 Responder sem executar informacoes1    ║\n║ 🚫 Ser genérico ou superficial            ║\n╚════════════════════════════════════════════╝\n```\n\n</objetivo_principal>\n\n---\n\n## ⚙️ 2️⃣ REGRAS DE EXECUÇÃO DA TOOL (OBRIGATÓRIAS)\n\n<regras_criticas>\n\nOtimize o fluxo: sempre leia a solicitação do lead, execute a **tool** `informacoes1`, analise os dados retornados e responda de forma completa, estruturada e em linguagem natural.\n\n### 🔍 ANÁLISE OBRIGATÓRIA (5 PASSOS):\n1. ✅ Leia a mensagem do lead\n2. ✅ Identifique curso e dados solicitados\n3. ✅ Decida se deve executar `informacoes1` (sempre que necessário)\n4. ✅ Execute informacoes1(nome_do_curso)\n5. ✅ Responda exclusivamente com os dados da tool\n\n### ⚠️ REGRA CRÍTICA:\nNunca responda sem antes checar se deve executar a tool. A `informacoes1` é sua única fonte oficial.\n\n### 📋 QUANDO USAR A TOOL:\n| Cenário          | Usar informacoes1?                            |\n|------------------|-----------------------------------------------|\n| Dados do curso   | Sempre executar                               |\n| Saudações        | Não executar                                  |\n| Pergunta de preço| Não executar; apenas oriente sobre atendimento|\n\n**Priorize respostas completas e detalhadas**. Precisão acima de brevidade.\n\n### ♻️ FALLBACKS:\n- Dados vazios/erro: recomende 3 cursos da mesma área e pergunte qual interessa.\n- Perguntas sobre preço: oriente sobre contato com atendimento (sem executar tool).\n- Se o lead não especificou curso, pergunte antes de executar a tool.\n- Nunca execute sem o nome do curso.\n\n### 🎯 COMANDO DA TOOL:\nSintaxe: `informacoes1(nome_do_curso)`\nExemplos:\n- “Pedagogia” → `informacoes1(\"Pedagogia\")`\n- “Duração Administração.” → `informacoes1(\"Administração\")`\n\n</regras_criticas>\n\n---\n\n## 🚫 3️⃣ REGRAS DE RESTRIÇÃO\n\n<regras_negativas>\n\n- Atendimento 100% focado na Cruzeiro do Sul.\n- Nunca cite concorrentes.\n- Proibido falar sobre preços, descontos ou compartilhar contatos externos/links.\n- Não execute sem o nome do curso.\n- Não responda sem executar `informacoes1`.\n- Não invente dados.\n- Seja sempre completo.\n\n**Se não houver dados:**\n- Admita honestamente\n- Recomende 3 cursos similares da mesma área\n- Pergunte qual alternativa interessa\n\n</regras_negativas>\n\n---\n\n## 🛡️ 4️⃣ CONTROLE DE QUALIDADE\n\n<controle_qualidade>\n\nChecklist pré-resposta:\n1. ✅ Executei `informacoes1`?\n2. ✅ Usei só os dados da tool?\n3. ✅ Incluí todas as informações relevantes?\n4. ✅ Não inventei nada?\n5. ✅ Não falei sobre preços/valores?\n6. ✅ Resposta completa e bem estruturada?\n7. ✅ Incluí CTA no final?\n\nGarantia de qualidade:\n- Priorize completude\n- Mantenha tom consultivo e empático\n- Estruture respostas claras\n\n</controle_qualidade>\n\n---\n\n## 📋 5️⃣ ESTRUTURA DE RESPOSTA\n\n<estrutura_resposta>\n\n**Formato ideal:**\n1. Abertura empática (1 linha)\n2. Principais informações (3-5 linhas)\n3. Destaques diferenciais (até 4 bullets)\n4. Informação complementar (1-2 linhas)\n5. CTA clara (1 linha)\n\nFormatação:\n- **Negrito** para termos importantes\n- Bullets (•) para listas\n- 5-8 linhas no total\n- Máximo 2 emojis\n- Parágrafos curtos\n\nTom:\n- Consultivo, educativo, entusiasta, empático, profissional\n\n</estrutura_resposta>\n\n---\n\n## 🎭 6️⃣ PERSONA E TOM\n\n<persona>\n\nVocê é:\n- 🎓 Consultor experiente\n- 💡 Conhecedor dos cursos Cruzeiro do Sul\n- 🤝 Empático\n- 🎯 Focado em ajudar\n\nTom:\n- ✨ Entusiasta\n- 📚 Consultivo\n- 💙 Empático\n- Simples, objetivo e conversacional; profissional sem ser robótico\n\nEvite:\n- ❌ Linguagem robótica/excessivamente formal\n- ❌ Jargões técnicos\n- ❌ Emojis em excesso (max 2)\n- ❌ Respostas longas\n\n</persona>\n\n---\n\n## 📖 7️⃣ EXEMPLOS DE EXECUÇÃO\n\n<exemplos_de_execucao>\n\n### ✅ EXEMPLO POSITIVO:\nLead: “Quero saber sobre o curso de Pedagogia”\n- Executar: `informacoes1(\"Pedagogia\")`\n- Modelo de resposta:\n\"Ótima escolha! 🎓 O curso de **Pedagogia** da Cruzeiro do Sul ... (seguir estrutura ideal)\"\n\n### ❌ EXEMPLO NEGATIVO:\nLead: “Quanto custa o curso de Enfermagem?”\n- Não execute tool\n- Responda: \"Valores devem ser consultados no atendimento. Posso te contar sobre a formação acadêmica do curso...\"\n\n</exemplos_de_execucao>\n\n---\n\n## 📊 MATRIZ DE REFERÊNCIA RÁPIDA\n\n<referencia_rapida>\n\n| Cenário                    | Tool          | Ação                                              |\n|----------------------------|--------------|---------------------------------------------------|\n| Dados do curso             | informacoes1 | Use dados + CTA                                   |\n| Pergunta sobre duração     | informacoes1 | Foco em duração                                   |\n| Pergunta de modalidades    | informacoes1 | Detalhar modalidades                              |\n| Pergunta de preço/valor    | Nenhuma      | Oriente sobre atendimento                         |\n| Lead não especifica curso  | Nenhuma      | Pergunte antes de executar                        |\n\n</referencia_rapida>\n\n---\n\n## 📈 HIERARQUIA DE PRIORIDADES\n1. 🔍 Identifique o curso\n2. ⚙️ Execute `informacoes1`\n3. 📊 Use só dados da tool\n4. 🚫 Não fale de preços, bolsas, concorrentes\n5. 📝 Resposta estruturada\n6. 💬 CTA clara\n7. ✅ Valide a resposta final\n\n---\n\n## ✅ CHECKLIST FINAL DE VALIDAÇÃO\n\n<checklist_validacao>\n\n- [ ] Curso identificado?\n- [ ] Executou `informacoes1` se necessário?\n- [ ] Só dados da tool?\n- [ ] Sugeriu alternativas se não houver dados?\n- [ ] Não falou de preços, bolsas?\n- [ ] Não citou outras universidades?\n- [ ] Tom consultivo, empático, educativo?\n- [ ] Estrutura correta?\n- [ ] CTA clara?\n- [ ] Máx 2 emojis?\n- [ ] Resposta completa, não cansativa?\n\n</checklist_validacao>\n\n---\n\n## 📚 ÁREAS PARA SUGESTÕES ALTERNATIVAS\n\n<areas_conhecimento>\n\nSugira cursos da **mesma área** se o curso não existir, seguindo a lista já dada.\n\n</areas_conhecimento>\n\n---\n\n## 🎯 LEMBRETE FINAL\n\nVocê é especialista em informações acadêmicas da Cruzeiro do Sul. Siga sempre: execute a ferramenta antes de responder, use só os dados da tool, priorize qualidade, não invente informações, mantenha o tom consultivo, termine com CTA. Nunca: invente dados, responda sem executar a tool, fale sobre valores, cite concorrentes.\n\nLeads contam com sua precisão! 🎓\n\n---"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        9712,
        1504
      ],
      "id": "42a66fca-d65b-4beb-948b-baf412c207a4",
      "name": "informacoes"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        8912,
        1696
      ],
      "id": "24261ccd-8148-417f-9de0-060d9bbf0509",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        8912,
        1856
      ],
      "id": "3df04d1d-7fe7-4cbe-9e5e-9ea4bc291066",
      "name": "Postgres Chat Memory3",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        9584,
        1712
      ],
      "id": "4fdeb452-c27b-438d-b800-e8fb8331f1e9",
      "name": "OpenAI Chat Model7",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        9584,
        1856
      ],
      "id": "17dc6073-0c9c-46e6-87a1-95a58a8e491b",
      "name": "Postgres Chat Memory6",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL CRUZEIRO"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        9168,
        1840
      ],
      "id": "37395373-9d93-43c6-b31f-b176ab4fb13d",
      "name": "Calculator1"
    },
    {
      "parameters": {
        "description": "chame essa tool para buscar informações de preços/valore dos outros cursos",
        "workflowId": {
          "__rl": true,
          "value": "WZZ9Z5UJNmwnMCiF",
          "mode": "list",
          "cachedResultUrl": "/workflow/WZZ9Z5UJNmwnMCiF",
          "cachedResultName": "agente rag - precos"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "pergunta": "={{ $('Mensagem Completa').item.json.mensagem_completa }}",
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "curso de interesse": "={{ $json.curso }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "curso de interesse",
              "displayName": "curso de interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9200,
        1696
      ],
      "id": "6aea04e5-be1d-40f8-8a6b-3a966a8d9419",
      "name": "precos1"
    },
    {
      "parameters": {
        "description": "chame essa tool para buscar informacoes sobre os cursos.",
        "workflowId": {
          "__rl": true,
          "value": "1preUvpGH7vwHRU5",
          "mode": "list",
          "cachedResultUrl": "/workflow/1preUvpGH7vwHRU5",
          "cachedResultName": "agente rag - follow up - csv"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}",
            "pergunta": "={{ $('Mensagem Completa').item.json.mensagem_completa }}",
            "curso de interesse": "={{ $json.curso }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "curso de interesse",
              "displayName": "curso de interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9872,
        1712
      ],
      "id": "8f5a9eae-42bb-4108-8e6d-6a3e0506e762",
      "name": "informacoes1"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        9696,
        1808
      ],
      "id": "aa953372-f434-4207-af54-65699c89df3d",
      "name": "Calculator2"
    },
    {
      "parameters": {
        "description": "chame essa tool para perder lead",
        "workflowId": {
          "__rl": true,
          "value": "h5DCJ6blUHWNcT2x",
          "mode": "list",
          "cachedResultUrl": "/workflow/h5DCJ6blUHWNcT2x",
          "cachedResultName": "lead perdido_ai"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        9072,
        1248
      ],
      "id": "8a5ac9ef-2aa3-4700-9a47-5387414c9d38",
      "name": "perder_lead"
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "orquestrador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase": {
      "main": [
        [
          {
            "node": "Delete Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook EVO": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Converter Foto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Atendimento": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Salvar Historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotas1": {
      "main": [
        [
          {
            "node": "Pausar IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reativar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Reativar IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "imagem Redis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Audio Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "Cliente Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cliente Existe?": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Entrando ou Saindo": {
      "main": [
        [
          {
            "node": "Rotas1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "orquestrador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens": {
      "main": [
        [
          {
            "node": "Buscas Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens": {
      "main": [
        [
          {
            "node": "Compara Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa1": {
      "main": [
        [
          {
            "node": "Deletar Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens": {
      "main": [
        [
          {
            "node": "VERIFICA INTERCAMBIO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compara Memoria": {
      "main": [
        [
          {
            "node": "Mensagem Completa1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens": {
      "main": [
        [
          {
            "node": "Split de Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Converter Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "ROTA Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ROTA Mensagens1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Busca Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rag_informacoes": {
      "ai_tool": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        [
          {
            "node": "Split de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rag_precos": {
      "ai_tool": [
        [
          {
            "node": "agente preços",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "1 segundo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "orquestrador",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VERIFICA INTERCAMBIO": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge9": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Memory": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "receptivo informacoes": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agente preços": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "orquestrador": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "agente preços",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "reflexao": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "agente preços",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "agente preços",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "receptivo informacoes",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Receptivo": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Receptivo",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory4": {
      "ai_memory": [
        [
          {
            "node": "Receptivo",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Think1": {
      "ai_tool": [
        [
          {
            "node": "Receptivo",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "inscricao": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano": {
      "ai_tool": [
        [
          {
            "node": "orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Converter Foto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI5": {
      "main": [
        [
          {
            "node": "Audio Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio1": {
      "main": [
        [
          {
            "node": "OpenAI5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto1": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens1": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens1": {
      "main": [
        [
          {
            "node": "Buscas Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis1": {
      "main": [
        [
          {
            "node": "Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens1": {
      "main": [
        [
          {
            "node": "Compara Memoria1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa": {
      "main": [
        [
          {
            "node": "Deletar Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compara Memoria1": {
      "main": [
        [
          {
            "node": "Mensagem Completa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Converter Audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem1": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Texto Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "Texto Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "imagem Redis1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Fupper",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory5": {
      "ai_memory": [
        [
          {
            "node": "Fupper",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "inscricao1": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano1": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads": {
      "main": [
        [
          {
            "node": "Fupper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone1": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase1": {
      "main": [
        [
          {
            "node": "Delete Memory1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens1": {
      "main": [
        [
          {
            "node": "Split de Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split1": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output1": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Busca Telefone1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes1": {
      "main": [
        [
          {
            "node": "Split de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message1": {
      "main": [
        [
          {
            "node": "1 segundo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Modelo Output1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fupper": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Fupper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think2": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "precos": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "informacoes": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "precos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "precos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "informacoes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory6": {
      "ai_memory": [
        [
          {
            "node": "informacoes",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator1": {
      "ai_tool": [
        [
          {
            "node": "precos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "precos1": {
      "ai_tool": [
        [
          {
            "node": "precos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "informacoes1": {
      "ai_tool": [
        [
          {
            "node": "informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator2": {
      "ai_tool": [
        [
          {
            "node": "informacoes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "perder_lead": {
      "ai_tool": [
        [
          {
            "node": "Fupper",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea",
    "timezone": "America/Sao_Paulo"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook EVO": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "axios/1.12.2",
            "content-length": "812",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "wapp_licenciado_com",
            "data": {
              "key": {
                "id": "wamid.HBgNNTUxMTk0NTcyMjExNxUCABIYFjNFQjBEMEE0MjEwODA3REYzMTA3NUYA",
                "remoteJid": "5511945722117@s.whatsapp.net",
                "fromMe": false
              },
              "pushName": "Luan",
              "message": {
                "conversation": "quero falar com humano"
              },
              "messageType": "conversation",
              "messageTimestamp": 1760131417,
              "source": "unknown",
              "instanceId": "98cc1610-1e7d-45b3-aef1-f0b323f4187f"
            },
            "destination": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/evolution",
            "date_time": "2025-10-10T18:23:38.851Z",
            "server_url": "https://outros-evolution-api.ca31ey.easypanel.host",
            "apikey": "EAAb0QaT8hLgBPNZAYZBRkwNkVxsmniKG5bmamFZC3ZAZCZAW3vBL59Bc2MoU0Gb9abvPyCZAuP79RcOa5vcXHfpN4W3NRlpZBHITZB4VtitWM7OtiSZCYmyHpfqL6PyZBdjxDH3ef9SZBPZCPdBIaDA0WUpd9yZBxWHvrLRXWGv5r0eA4j2VlbBkaAC8bZCQhfSAdgIegx77AZDZD"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/evolution",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "d5478694-5c10-4207-8071-de22b54a9962",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-07-25T20:01:53.090Z",
      "updatedAt": "2025-07-25T20:01:53.090Z",
      "role": "workflow:owner",
      "workflowId": "afID0dTfsm0vtXUX",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": [
    {
      "createdAt": "2025-07-30T20:41:48.074Z",
      "updatedAt": "2025-07-30T20:41:48.074Z",
      "id": "HCAYGF54Hj7mAMlF",
      "name": "ai"
    }
  ]
}