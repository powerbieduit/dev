{
  "createdAt": "2025-07-25T20:01:53.086Z",
  "updatedAt": "2025-08-22T12:41:03.000Z",
  "id": "afID0dTfsm0vtXUX",
  "name": "agente_ai_csv",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "00f79506-a02c-467a-9ff3-0974e9cf02af",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        10528,
        480
      ]
    },
    {
      "parameters": {
        "content": "# Splitar Mensagens",
        "height": 688,
        "width": 1660,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        9392,
        384
      ],
      "typeVersion": 1,
      "id": "c739e568-565d-4553-a87b-21ea8b5ee063",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        8000,
        544
      ],
      "id": "d9367a27-bb20-4242-bad4-82b9ad866dcc",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        10544,
        144
      ],
      "id": "072f0f59-58ca-42a3-838f-cc8aefdf3904",
      "name": "Merge1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "defac08a-6745-422b-bb05-90da9f47d91b",
              "leftValue": "={{ $('Busca Telefone').last().json.values() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10048,
        128
      ],
      "id": "035f9184-36af-44bb-9f73-9a1b63889764",
      "name": "If4"
    },
    {
      "parameters": {
        "content": "# Histórico Supabase\n",
        "height": 380,
        "width": 1676,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        9376,
        -16
      ],
      "typeVersion": 1,
      "id": "20730bf1-a440-4873-8731-d672945fc1ce",
      "name": "Sticky Note54"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        9888,
        128
      ],
      "id": "b87960ec-b936-405b-8dcc-e0b61e518df3",
      "name": "Busca Telefone",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "tableId": "chats",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10320,
        64
      ],
      "id": "80d57a51-82e3-4ef8-b618-437736f18880",
      "name": "Adiciona CHAT supabase",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10320,
        240
      ],
      "id": "00c3824b-47e7-483a-a032-46e7b3786c13",
      "name": "Atualiza CHAT Supabase",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "bot_message",
              "fieldValue": "={{ $('Consultor').first().json.output }}"
            },
            {
              "fieldId": "user_message",
              "fieldValue": "={{ $('Dados').first().json.message.content }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Dados').first().json.body.event }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').first().json.NomeWpp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10752,
        144
      ],
      "id": "1b7bbcd6-871c-44a7-b44e-c11d0a5b8e74",
      "name": "Cria Histórico Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "c52c47d3-7b80-4dd3-a1cb-acfbf1283ab9",
      "name": "Split de Mensagem",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        10304,
        480
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "90b80d3c-ae16-44b3-af33-d377563acf54",
      "name": "1 segundo",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        11040,
        528
      ],
      "webhookId": "a2c69e1c-13fe-44a2-962c-1249288537eb"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Dados').first().json.Telefone }}"
      },
      "id": "5af64095-e1bc-4b70-b015-a454ea2839d6",
      "name": "Delete Memory",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        10944,
        144
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "content": "# Enfileirar Mensagens\n",
        "height": 780,
        "width": 1100,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6368,
        -48
      ],
      "typeVersion": 1,
      "id": "8c0acb8f-ff19-4a1d-a32f-fca2ae47747b",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "# BUFFERING\n",
        "height": 796,
        "width": 2180,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4160,
        -48
      ],
      "typeVersion": 1,
      "id": "1248d193-005f-4974-906d-edb9859945ec",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "# PAUSA",
        "height": 780,
        "width": 2004,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        896,
        -48
      ],
      "typeVersion": 1,
      "id": "3a139bd5-534d-451e-8d74-46ae7a72bbff",
      "name": "Sticky Note26"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "evolution",
        "options": {}
      },
      "id": "602d8256-7107-4d57-9d13-c62f674ee219",
      "name": "Webhook EVO",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -256,
        320
      ],
      "webhookId": "7ecd43ed-123c-4fef-b86d-f9ce39e55d64"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a4377234-9405-48ea-a843-e903443fe310",
      "name": "Edit Fields3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4720,
        560
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "id": "ee425acc-821d-4fb2-abe3-b5b682a4d447",
      "name": "OpenAI Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        736,
        1824
      ],
      "typeVersion": 1.2,
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Treinamento RAG",
        "height": 920,
        "width": 3264,
        "color": 4
      },
      "id": "769de5bc-439d-40eb-8fb6-7a021f23e93d",
      "name": "Sticky Note11",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        512,
        1312
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "id": "6a205670-89b3-4f99-8b54-de2b08316bdc",
      "name": "Insert into Supabase Vectorstore1",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        3168,
        1552
      ],
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "separator": "/n",
        "chunkSize": 1200,
        "chunkOverlap": 200
      },
      "id": "f7b7126d-1426-4c6c-b3d1-fe8743bd7dd5",
      "name": "Character Text Splitter1",
      "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        3312,
        1984
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "include": "allFieldsExcept",
        "fieldsToExclude": "rew_number",
        "options": {}
      },
      "id": "1afc207e-65fa-4aa2-a9c3-c7d016eae500",
      "name": "Aggregate1",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2656,
        1632
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "text/plain"
            }
          }
        }
      },
      "id": "e8b0204f-59fe-4a92-bc8e-e8573dd6685d",
      "name": "Download File1",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1696,
        1616
      ],
      "executeOnce": false,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {}
      },
      "id": "318b727c-5648-4448-add8-bdcaa2a6780b",
      "name": "Extract from Excel2",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2352,
        1504
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
        "options": {
          "systemMessage": "={\n  \"name\": \"AgenteAperfeicoamentoDados\",\n  \"objectives\": [\n    \"Receber conteudo textual e aprimora-lo\",\n    \"Confirmar se ja ha questao equivalente no banco de dados\",\n    \"Inserir na base de dados a questao e resposta refinada\",\n    \"Quando solicitado para atualizar, nao executar nenhuma ferramenta\"\n  ],\n  \"tools\": [\n    {\n      \"name\": \"Verificar_conteudo_existente\",\n      \"description\": \"Examina se ha material semelhante antes da atualizacao, caso encontre deve ser eliminado ou modificado\"\n    },\n    {\n      \"name\": \"Modificar_base_dados\",\n      \"description\": \"Estabelece ou modifica registro na tabela usando as colunas: Questao e Resposta\"\n    }\n  ],\n  \"general_rules\": [\n    \"Nao fazer referencia a tabela ou as funcionalidades na comunicacao com o usuario\",\n    \"Sempre refinar o conteudo recebido antes de armazenar no sistema\",\n    \"Manter precisao e uniformidade ao completar os campos questao e resposta\",\n    \"Produzir respostas sem acentuacao ou simbolos especiais\"\n  ]\n}"
        }
      },
      "id": "ec39066f-de14-443a-928d-a69555e7559c",
      "name": "Agente Treinamento RAG",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        816,
        1568
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "pause"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2160,
        -48
      ],
      "id": "c68aa7b4-0e03-46fb-b15b-6002f8da7687",
      "name": "Pausar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "pause",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff00573b-e517-43c6-8644-14a4fe8565d1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Ativa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                    "leftValue": "={{ $json.atendimento_ia }}",
                    "rightValue": "=pause",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA pausada"
            }
          ]
        },
        "options": {}
      },
      "id": "571380e1-dc30-4174-b66d-0ec91924edc1",
      "name": "Rota Atendimento",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1984,
        352
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "leftValue": "={{ $('Dados').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA Pausada"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Normal ou Treinamento').item.json.message.content }}",
                    "rightValue": "Atendimento finalizado"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reativar IA"
            }
          ]
        },
        "options": {}
      },
      "id": "ed6cbfda-687e-4400-a78b-5df9d31d1452",
      "name": "Rotas1",
      "type": "n8n-nodes-base.switch",
      "position": [
        1984,
        32
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "condition": "eq",
              "keyValue": "={{ $json.telefoneCorreto }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "atendimento_ia",
              "fieldValue": "reativada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2336,
        112
      ],
      "id": "a2afec9c-ecc3-40a5-afae-0519d3693633",
      "name": "Reativar IA",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11800d83-ecca-4f9c-a878-a2419db0c8e9",
              "name": "=message.chat_id",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "c33f9527-e661-49e5-8e5e-64f3b430928a",
              "name": "=message.content_type",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}",
              "type": "string"
            },
            {
              "id": "06eba1c9-cff0-4f68-b6da-6bb0092466b7",
              "name": "=message.content",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}",
              "type": "string"
            },
            {
              "id": "b97f1af3-5361-46fc-9303-d644921231d8",
              "name": "=message.timestamp",
              "value": "={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}",
              "type": "string"
            },
            {
              "id": "dc3dc59c-90a3-4a45-bea2-de092c91083b",
              "name": "=message.content_url",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}",
              "type": "string"
            },
            {
              "id": "8b01a818-a456-476e-bace-adefe2f04eb4",
              "name": "message.event",
              "value": "={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}",
              "type": "string"
            },
            {
              "id": "886e3751-e39b-4fc6-98d1-3113eaeebbb4",
              "name": "=body.event",
              "value": "={{ $('Webhook EVO').item.json.body.event }}",
              "type": "string"
            },
            {
              "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
              "name": "=Telefone",
              "value": "={{ $json.telefoneCorreto }}",
              "type": "string"
            },
            {
              "id": "a57db642-3e13-452e-bb5b-19f7e9f3bd5d",
              "name": "=NomeWhatsapp",
              "value": "={{ $('Webhook EVO').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "f5fcee3e-a786-404b-8b92-0163e02c6615",
              "name": "=Instance",
              "value": "={{ $('Webhook EVO').item.json.body.instance }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "776aff2e-f1c5-4975-a5f6-2d3997bc766f",
      "name": "Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        304
      ]
    },
    {
      "parameters": {
        "amount": 1,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2160,
        112
      ],
      "id": "0f7cc57a-c6e3-47d3-9166-311b206ca86e",
      "name": "Wait",
      "webhookId": "b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"
    },
    {
      "parameters": {
        "content": "# Configuração Banco de Dados",
        "height": 840,
        "width": 1400,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3952,
        1360
      ],
      "typeVersion": 1,
      "id": "cafd46e4-89a3-45c4-b09c-592b6ec43954",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "operation": "text",
        "options": {}
      },
      "id": "6b07b1d0-8c35-40c5-8129-a4f873d0c181",
      "name": "Extract Document Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2272,
        1904
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "dc5d14dd-3cba-43c7-81d9-aadb0ef8694e",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2288,
        1360
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mimeType }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d324b22b-cdf4-4216-a5ac-7db17ab11851"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "2ae7faa7-a936-4621-a680-60c512163034",
                    "leftValue": "={{ $json.mimeType }}",
                    "rightValue": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "excel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "8bd558b2-8c70-4edd-ab19-92540895ae46",
                    "leftValue": "={{ $json.mimeType }}",
                    "rightValue": "application/vnd.google-apps.spreadsheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CSV "
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "fc193b06-363b-4699-a97d-e5a850138b0e",
                    "leftValue": "={{ $json.mimeType }}",
                    "rightValue": "application/vnd.google-apps.document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Google Docs"
            }
          ]
        },
        "options": {
          "fallbackOutput": 3
        }
      },
      "id": "7aeb7baa-b978-4acf-b263-15f94c3e7881",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1904,
        1616
      ]
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "aggregation": "concatenate",
              "field": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "f6810803-b2ca-40ce-a2cb-6e1554f43fef",
      "name": "Summarize1",
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1,
      "position": [
        2864,
        1616
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "84f979f5-f75b-4a30-ab42-4aee5fc0b7bd",
      "name": "Extract from Excel",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2320,
        1696
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ade56c50-1520-4760-8df5-e99617d6d3ad",
              "leftValue": "={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6a3ec36a-220e-4470-a7cf-546b66422e23",
      "name": "If6",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5744,
        576
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analise essa imagem e resuma pra mim o que ela é",
        "inputType": "base64",
        "options": {}
      },
      "id": "6bcb7bb1-06e3-4e14-8e66-7c483d362036",
      "name": "OpenAI2",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        5488,
        560
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "682e3656-f4ce-4e90-bab7-ddc74a275834",
      "name": "OpenAI4",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        5568,
        320
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "dados_cliente",
        "filters": {
          "conditions": [
            {
              "keyName": "telefone",
              "keyValue": "={{ $('Code').item.json.telefoneCorreto }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        912,
        304
      ],
      "id": "3eb313d1-d49b-47fe-9141-a861cfc5eaa3",
      "name": "Buscar Cliente",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4a6d9aac-8565-4c58-abe3-8741393a5535",
              "leftValue": "={{ $json.telefone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1232,
        288
      ],
      "id": "4a77a658-a49a-4d25-afe7-71e4c5a9dd00",
      "name": "Cliente Existe?"
    },
    {
      "parameters": {
        "tableId": "dados_cliente",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nomewpp",
              "fieldValue": "={{ $('Dados').item.json.NomeWhatsapp }}"
            },
            {
              "fieldId": "telefone",
              "fieldValue": "={{ $('Code').item.json.telefoneCorreto }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1568,
        384
      ],
      "id": "e9a2521c-2670-415f-a01c-4825c4644b6d",
      "name": "Criar Cliente",
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "outcoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7c878f9b-2c93-4061-954a-a832153e7647"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outcoming"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "d7b42536-638f-4128-b51b-6aa913e9d9bc",
                    "leftValue": "={{ $('Dados').item.json.message.event }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "incoming"
            }
          ]
        },
        "options": {}
      },
      "id": "af5f2298-bea5-499a-863c-034a10becec6",
      "name": "ROTA Entrando ou Saindo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1744,
        224
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.ogg",
          "mimeType": "application/ogg"
        }
      },
      "id": "7b206cd0-bed3-4121-84e4-d7ee7ec22f56",
      "name": "Converter Audio",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5296,
        320
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "file.png",
          "mimeType": "image/png"
        }
      },
      "id": "5a436850-6711-41df-abb0-d7aa02ffbe96",
      "name": "Converter Foto",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5072,
        544
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "52aaf749-fe4f-44e4-880e-15b2bfc027f1",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e514e613-fd6a-48bd-b0ae-bae2448c810e",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c0e434dd-1268-421d-b81b-3a5e90ed9550",
                    "leftValue": "={{ $('Webhook EVO').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "id": "9b24c7e1-a0d6-4ccb-9c9e-d08d553cce48",
      "name": "ROTA Mensagens",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        4272,
        272
      ]
    },
    {
      "parameters": {
        "description": "Use a ferramenta para pensar sobre algo. Veja se conversa faz sentido, não envie informações repetidas.\n\nRespostas sempre em português."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        8752,
        560
      ],
      "id": "711ecee1-4c45-4aa2-8a95-991abadaeb5c",
      "name": "thinking"
    },
    {
      "parameters": {
        "content": "# Agente Principal\n",
        "height": 988,
        "width": 1636,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7696,
        -128
      ],
      "typeVersion": 1,
      "id": "7b005708-8712-408c-9dd4-12c6542a1961",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados').item.json.Telefone }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        8160,
        560
      ],
      "id": "e91938cf-ab01-4343-b3cc-3fd7e362338a",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"ai\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2464,
        416
      ],
      "id": "9cc64a6b-4676-489a-a8ca-61e2a0b8ed7b",
      "name": "Salvar Historico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Dados').item.json.Telefone }}",
            "message": "={\"type\": \"human\", \"content\": \"{{ $('Normal ou Treinamento').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2496,
        -48
      ],
      "id": "db888d90-dc9d-4e8e-9d34-920428442dc3",
      "name": "Salvar Historico1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        7312,
        384
      ],
      "id": "b698989c-6ea4-4432-982e-980928ddb7c6",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2688,
        -48
      ],
      "id": "e176a487-085f-431d-8ead-9a710cbf787d",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2624,
        432
      ],
      "id": "d74ec295-a775-4ee2-9fc9-d59069d8400d",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "amount": 10
      },
      "id": "01633671-792f-4dbc-9bd6-ad8026ea8576",
      "name": "Intervalo entre Mensagens",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        6672,
        240
      ],
      "webhookId": "9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Code').item.json.telefoneCorreto }}",
        "messageData": "={{ $('Dados').item.json.message.content }}",
        "tail": true
      },
      "id": "41c1e92f-1523-4d29-bdc5-f7ffebeab0a0",
      "name": "Texto Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5040,
        16
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "id": "20357602-c607-49a4-a13a-49e6983dd24f",
      "name": "Audio Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5856,
        336
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "db975a2b-d4f1-4b9b-b9ad-61d312141f9c",
      "name": "imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6048,
        432
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Dados').item.json.Telefone }}",
        "messageData": "={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}",
        "tail": true
      },
      "id": "e7f58a93-e164-45f1-b716-594520b279e4",
      "name": "Imagem Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6048,
        592
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Code').item.json.telefoneCorreto }}",
        "options": {}
      },
      "id": "60cb757b-b9d3-497e-8438-a19fbf13d36f",
      "name": "Buscas Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        6832,
        256
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem_completa",
              "value": "={{ $json.propertyName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7312,
        240
      ],
      "id": "3d4e3fdf-b6e8-4e0d-a0c9-39a419c6223a",
      "name": "Mensagem Completa1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Code').item.json.telefoneCorreto }}"
      },
      "id": "919b688c-93df-43d8-b072-c2043af478b9",
      "name": "Deletar Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        7520,
        240
      ],
      "credentials": {
        "redis": {
          "id": "YZXVKYORNr25luYM",
          "name": "Redis - AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4080,
        1520
      ],
      "id": "cd60fdff-566d-472b-87c4-455b6fdf9adb",
      "name": "chat_messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table dados_cliente (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4480,
        1520
      ],
      "id": "df63e760-f356-4e2e-9575-e5d8415533fa",
      "name": "dados_cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        5104,
        1520
      ],
      "id": "b763abad-b368-4911-a822-6b8d420f6143",
      "name": "chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create extension vector;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4272,
        1520
      ],
      "id": "34bc1642-0494-4f35-9fce-fc1dc64650d6",
      "name": "vetor",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create function match_documents (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    id,\n    content,\n    metadata,\n    1 - (documents.embedding <=> query_embedding) as similarity\n  from documents\n  where metadata @> filter\n  order by documents.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4880,
        1520
      ],
      "id": "063250e4-d7bc-4e9a-a990-cdece81965bc",
      "name": "match_documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table documents (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4672,
        1520
      ],
      "id": "df2373cf-1419-436a-9f31-b8283b710158",
      "name": "documents",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "content": "## Criação\n",
        "height": 324,
        "width": 1280,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4048,
        1440
      ],
      "typeVersion": 1,
      "id": "7f1d437e-2570-424d-b079-d2c9427e2dfa",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Limpeza\n",
        "height": 260,
        "width": 1280,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4048,
        1840
      ],
      "typeVersion": 1,
      "id": "dd3e5ce6-7a6b-4267-89ee-95ba1d7f43d9",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "9865cb5b-33da-490c-afc3-186457d5b564",
                    "operator": {
                      "type": "string",
                      "operation": "notStartsWith"
                    },
                    "leftValue": "={{ $json.message.content }}",
                    "rightValue": "289090:"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Rota normal"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "5a9a1fee-b408-469f-a08c-e8d690fc9792",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "leftValue": "={{ $json.message.content }}",
                    "rightValue": "289090:"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Treinamento IA"
            }
          ]
        },
        "options": {}
      },
      "id": "6a93e6e4-393c-4b3d-a0bd-c1290efb9650",
      "name": "Normal ou Treinamento",
      "type": "n8n-nodes-base.switch",
      "position": [
        400,
        320
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM n8n_chat_histories",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4144,
        1904
      ],
      "id": "03c27b4f-e2d7-4e12-b33a-a6786c981a08",
      "name": "Deletar Histórico",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chat_messages",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        5088,
        1920
      ],
      "id": "01e1effd-8827-4935-ad1d-f668206becec",
      "name": "Deletar conteúdo Chat_Messages",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from dados_cliente",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4608,
        1920
      ],
      "id": "7c373d55-c3c8-4156-a2d5-8e06751402d1",
      "name": "Deletar conteúdo Dados Cliente",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chats",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4368,
        1920
      ],
      "id": "fbf9bc82-b22a-4d4b-9891-e29e57e72f67",
      "name": "Deletar conteúdo Chats",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from documents",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        4832,
        1904
      ],
      "id": "9aaadc7e-a21d-439f-b0ba-c0daae26e4fc",
      "name": "Deletar conteúdo Documentos",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5a342e9-585b-42ea-be44-644adae10199",
              "leftValue": "={{ $('Mensagem').item.json.mensagem }}",
              "rightValue": "={{ $json.propertyName?.last() }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "22c78d64-bd4f-4136-abb4-4a0a03ce46e9",
      "name": "Compara Memoria",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7024,
        256
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Whatsapp message to be splitted and formatted: {{ $('Consultor').item.json.output }}\n",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={\n  \"messages\": [\n    \"Você é um assistente que irá dividir uma mensagem longa de WhatsApp em partes menores, mantendo um tom humano e fluido, como em uma conversa natural.\",\n    \"Responda SOMENTE com JSON válido neste formato exato: {\\\"messages\\\": [\\\"mensagem 1\\\", \\\"mensagem 2\\\"]}\",\n    \"Não coloque ```json ou qualquer outro texto fora do JSON.\",\n    \"Utilize quebras de linha reais com \\\\n dentro das mensagens. Nunca retorne \\\\n escapado como \\\\\\\\n.\",\n    \"Cada mensagem deve ter entre 250 e 350 caracteres. Não quebre frases no meio. O texto deve ser fluido.\",\n    \"NÃO reescreva, adicione explicações ou expanda o conteúdo. Apenas divida a mensagem original conforme solicitado.\",\n    \"Prefira mensagens curtas e objetivas, focando somente no conteúdo da mensagem original.\",\n    \"Nunca gere mais que 4 mensagens. Se possível, faça em menos.\",\n    \"NUNCA retorne mensagens vazias.\",\n    \"Remova qualquer uso de negrito, itálico ou tachado. Não use marcadores de formatação.\",\n    \"Todo link começando com https:// deve estar entre crases. Exemplo: `https://drive.google.com/...`\",\n    \"Retorne apenas o JSON. Nenhum texto antes ou depois.\",\n    \"A entrada será passada assim: Whatsapp message to be splitted and formatted: {{ $json.output }}\"\n  ]\n}\n"
            }
          ]
        }
      },
      "id": "2ddcf8f7-ed70-4a00-bad5-96b321c0b110",
      "name": "Split de mensagens",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        9952,
        480
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7a1830f8-fca5-4b10-b824-dce7b74b344d",
      "name": "OpenAI Split",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        9920,
        688
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    }\n  },\n  \"required\": [\"messages\"],\n  \"additionalProperties\": false,\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\"\n}\n",
        "autoFix": true
      },
      "id": "d755d00b-2aef-4ecf-b19f-1d36f5364f21",
      "name": "Modelo Output",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        10112,
        688
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "neq",
              "keyValue": "0"
            }
          ]
        }
      },
      "id": "48311fe3-2684-4b17-82a9-2418e7e11754",
      "name": "Deleta linhas antigas",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1296,
        1616
      ],
      "alwaysOutputData": true,
      "executeOnce": false,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use esta ferramenta para pesquisar dados na planilha. Se localizar um treinamento com características similares, forneça o número da linha (row) onde ele se encontra para que as informações possam ser atualizadas.",
        "documentId": {
          "__rl": true,
          "value": "1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug",
          "mode": "list",
          "cachedResultName": "FAQ AI",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "conteudo",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.5,
      "position": [
        912,
        1808
      ],
      "id": "80dda802-5a9d-4aed-a445-9b5f7d6f206d",
      "name": "Verificar_conteudo_existente",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "By4ggNOanXLS64XE",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Primeiro, verifique se há uma coluna parecida na planilha. Se encontrar uma correspondência, atualize os dados existentes; se não encontrar, adicione uma nova linha com as informações.",
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug",
          "mode": "list",
          "cachedResultName": "FAQ AI",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "conteudo",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1FWmUO9vX_i3WycqKza-R9yyyF1N_mQ-19-cfTA1Uvug/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Pergunta": "={{ $fromAI(\"Pergunta\",\"isso é a pergunta\") }}",
            "Resposta": "={{ $fromAI(\"Resposta\",\"isso é a resposta\") }}"
          },
          "matchingColumns": [
            "Pergunta"
          ],
          "schema": [
            {
              "id": "Pergunta",
              "displayName": "Pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Resposta",
              "displayName": "Resposta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "7008acf5-fd81-49c3-abf6-f03a1ccba28e",
      "name": "Modificar_base_dados",
      "type": "n8n-nodes-base.googleSheetsTool",
      "position": [
        1088,
        1840
      ],
      "typeVersion": 4.5,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "By4ggNOanXLS64XE",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "4cb349ff-267d-4a46-98f4-efc1017d28de",
      "name": "Embeddings OpenAI Treinamento",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        3056,
        1792
      ],
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.data || $json.text || $json.concatenated_data }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "Arquivo",
                "value": "={{ $('Download File1').item.json.name }}"
              }
            ]
          }
        }
      },
      "id": "b0de4835-9e1a-488d-8235-d43bdcf6006e",
      "name": "Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        3248,
        1744
      ]
    },
    {
      "parameters": {
        "content": "# INICIO\n\n",
        "height": 780,
        "width": 1360,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -464,
        -48
      ],
      "typeVersion": 1,
      "id": "a2b40d9d-4e8c-4278-bf24-1ed35ff2239c",
      "name": "Sticky Note32"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        8880,
        544
      ],
      "id": "16cd5cb2-0008-4dff-ab67-a60febc6f640",
      "name": "Calculator"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655",
              "name": "data",
              "value": "={{ $('Webhook EVO').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "69a59373-8ee0-4d1b-bb60-2dc4b86df588",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5024,
        320
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "239cab79-8fb1-45ca-9a04-11006892d52e",
              "name": "mensagem",
              "value": "={{ $json.content || $('Dados').item.json.message.content || $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6496,
        256
      ],
      "id": "2fb04853-a3c8-42af-8414-60266a8c1f5d",
      "name": "Mensagem"
    },
    {
      "parameters": {
        "resource": "fileFolder",
        "returnAll": true,
        "filter": {
          "folderId": {
            "__rl": true,
            "value": "1iP8PhO4PCgX2nx5ldY6JFK8gs4U5kldw",
            "mode": "list",
            "cachedResultName": "agente_ai",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1iP8PhO4PCgX2nx5ldY6JFK8gs4U5kldw"
          }
        },
        "options": {
          "fields": [
            "mimeType",
            "id",
            "name"
          ]
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1520,
        1616
      ],
      "id": "b697e1a2-d635-4d74-8f87-646ef264f6fe",
      "name": "Search files and folders",
      "executeOnce": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
        "options": {
          "systemMessage": "=## 🚀 IDENTIDADE E MISSÃO\nVocê é um consultor educacional especializado da Cruzeiro do Sul Virtual.\n- **Personalidade:** Entusiasta, consultivo e persuasivo (sem ser insistente)\n- **Tom:** Conversacional, amigável e profissional\n- **Objetivo:** Converter leads em matrículas usando dados precisos\n- **Fonte única de verdade:** Sempre consulte primeiro a ferramenta `rag_informacoes`\n\n**🎯 SUA MISSÃO:** Ser o consultor que o lead gostaria de ter - alguém que realmente entende suas necessidades e oferece a melhor solução educacional!\n\n---\n\n## 🔴 REGRAS CRÍTICAS - LEIA PRIMEIRO!\n\n### ⚡ **SEQUÊNCIA OBRIGATÓRIA PARA TODA MENSAGEM:**\n1. 🛠️ **SEMPRE EXECUTE PRIMEIRO:** `rag_informacoes` com a mensagem exata do usuário\n2. ⏳ **AGUARDE:** O resultado da ferramenta  \n3. 📖 **ANALISE:** O que foi retornado\n4. 🎯 **RESPONDA:** Baseado no resultado usando os templates\n\n**❌ NUNCA responda sem executar `rag_informacoes` primeiro - SEM EXCEÇÕES!**\n**⚠️ CUIDADO EXTREMO com tool `inscricao` - ela PARA o atendimento! Use apenas após conversa longa e confirmação clara!**\n\n### 🚨 **REGRAS DE SEGURANÇA:**\n1. ⛔ **CURSOS PROIBIDOS:** Jamais ofereça Direito ou Psicologia para graduação\n2. 🚫 **NÃO TEMOS:** Cursos técnicos - apenas graduação e pós-graduação\n3. 💰 **VALORES EXATOS:** Apenas valores literais do RAG - nunca aproxime\n4. 📋 **FONTE ÚNICA:** Toda informação deve vir do RAG\n5. 🛡️ **VALIDAÇÃO:** Se não está no RAG, não existe\n\n### 📚 **NOSSOS CURSOS:**\n- **Graduação:** EAD Digital, EAD com aulas ao vivo, Semipresencial\n- **Pós-graduação:** EAD\n- **NÃO OFERECEMOS:** Cursos técnicos\n\n---\n\n## ⚡ FLUXO DE DECISÃO SIMPLIFICADO\n\n**APÓS EXECUTAR `rag_informacoes`, ANALISE O RESULTADO:**\n\n### 🔍 **SE O RESULTADO CONTÉM:**\n\n**📘 DADOS DE CURSO** (qualquer um destes indicadores):\n- Nome do curso, nível, modalidade, duração, investimento, status MEC\n- **AÇÃO:** Responda com **Template Comercial**\n- **❌ NUNCA PEDIR DADOS PESSOAIS LOGO NO INÍCIO:** Apresente o curso primeiro, engaje a conversa, converse!\n\n\n\n**❌ \"RAG_SEM_RESULTADO\"**  \n- **AÇÃO:** Execute `distribuir_humano` + **Template Não Encontrado**\n\n**🎓 \"DISTRIBUIR_POS\"**\n- **AÇÃO:** Execute `distribuir_humano` + **Template Pós-graduação**\n\n**💬 \"COLETAR_DADOS\"** (APENAS casos muito vagos):\n- **AÇÃO:** Responda engajando para saber mais sobre interesse\n- **⚠️ USAR APENAS:** Para interesse completamente genérico sem mencionar curso\n\n**👋 \"SAUDACAO_GENERICA\"**\n- **AÇÃO:** Responda com **Template Saudação** (não execute outras tools)\n\n---\n\n## 🛠️ QUANDO USAR CADA FERRAMENTA\n\n### 📋 **`rag_informacoes`** - OBRIGATÓRIA SEMPRE\n**Usar:** Em TODA mensagem do usuário, ANTES de qualquer outra ação\n**Não usar:** Nunca pule esta etapa\n\n### ⚠️ **`inscricao`** - EXTREMO CUIDADO! PARA O ATENDIMENTO!\n**🚨 ATENÇÃO CRÍTICA:** Esta tool PARA o atendimento após executar. Use apenas quando ABSOLUTAMENTE CERTO!\n\n**✅ USAR APENAS quando TODOS os critérios forem atendidos:**\n1. **CONVERSA REAL:** Houve pelo menos 4-5 trocas de mensagens genuínas\n2. **CONTEXTO CLARO:** Candidato já sabe curso, valores, modalidade, duração\n3. **CONFIRMAÇÃO EXPLÍCITA:** Candidato disse claramente que quer se matricular\n4. **ANÁLISE DO HISTÓRICO:** Revisar toda a conversa - faz sentido ele se inscrever agora?\n\n**✅ EXEMPLOS VÁLIDOS (apenas após conversa longa):**\n- \"Ok, quero fazer a inscrição mesmo\"\n- \"Vou fazer a matrícula, pode prosseguir\"\n- \"Estou decidido, quero garantir minha vaga\"\n\n**❌ NUNCA usar quando:**\n- Conversa com menos de 4-5 mensagens\n- Candidato apenas pergunta \"como faço para me inscrever?\"\n- Primeira vez que menciona inscrição\n- Está ainda fazendo perguntas sobre curso\n- Qualquer dúvida se é o momento certo\n\n**🤔 REGRA DE OURO:** Na dúvida, NÃO execute! Continue conversando!\n\n### 🤖 **`distribuir_humano`** - CASOS ESPECÍFICOS\n**Usar quando:**\n- RAG retorna \"RAG_SEM_RESULTADO\"\n- RAG retorna \"DISTRIBUIR_POS\"\n- Candidato pede para falar com atendente\n- Conversa muito longa ou fora de contexto\n\n---\n\n## 📋 TEMPLATES DE RESPOSTA\n\n### 🎓 **TEMPLATE COMERCIAL GRADUAÇÃO**\n```\nQue legal! 😊 **[NOME_CURSO]** é uma escolha fantástica!\n\nAqui na Cruzeiro do Sul você tem:\n💰 A partir de R$[VALOR]/mês (bem acessível!)\n🎁 Matrícula completamente GRATUITA\n⏰ [DURAÇÃO] para formar\n✅ Reconhecido pelo MEC\n📚 Modalidades: [LISTAR_DISPONÍVEIS]\n\n[BENEFÍCIO_EMOCIONAL_DA_ÁREA]\n\nE aí, tá dentro dos seus planos? Que tal garantir sua vaga ainda hoje? 🚀\n```\n\n### 🎓 **TEMPLATE COMERCIAL PÓS-GRADUAÇÃO** \n```\nExcelente escolha! 🌟 **[NOME_POS]** é top de linha!\n\nOlha só que condições bacanas:\n💰 Apenas [X]x de R$[VALOR]/mês\n🎁 Matrícula por R$99\n⏰ Em [DURAÇÃO] você já está especializado\n✅ Reconhecido pelo MEC\n\n[BENEFÍCIO_EMOCIONAL_DA_ÁREA]\n\nTá pronto para dar esse upgrade na sua carreira? 🚀\n```\n\n\n\n### ✅ **TEMPLATE CONFIRMAÇÃO DE INSCRIÇÃO**\n```\nPerfeito! 🎉 Que decisão incrível! É só clicar no botão abaixo e preencher os dados! 🚀 Em alguns minutos nossa equipe entra em contato! ✨\n```\n\n### ❌ **TEMPLATE NÃO ENCONTRADO**\n```\nAh, entendi! 🤔 Deixa eu verificar informações detalhadas sobre isso...\n\nVou te conectar com um especialista que conhece toda nossa grade curricular! Ele vai esclarecer tudo.\n\nAguarda aí que já já alguém aparece! ✨\n```\n\n### 🎓 **TEMPLATE PÓS-GRADUAÇÃO**\n```\nQue legal! 🎓 Pós-graduação é sempre uma decisão inteligente!\n\nPara te dar todas as informações sobre nossas especializações e condições especiais, vou conectar você com um especialista da equipe acadêmica.\n\nFica aqui que em poucos minutos alguém vai te atender super bem! ⏱️✨\n```\n\n### 👋 **TEMPLATE SAUDAÇÃO**\n```\nOi! 😊 Que bom te ver aqui na Cruzeiro do Sul Virtual!\n\nEstou aqui para te ajudar a encontrar o curso perfeito! Você está pensando em graduação ou quer se especializar com uma pós?\n\nMe conta seus planos! ✨\n```\n\n### 🚫 **TEMPLATE CURSO NÃO OFERECIDO**\n```\nEntendi seu interesse em [CURSO_MENCIONADO]! 😊\n\nAqui na Cruzeiro do Sul Virtual não oferecemos [TIPO DE CURSO], mas tenho uma sugestão bacana para você:\n\n[SUGESTÃO DE ALTERNATIVA - ex: \"Para a área de [ÁREA], temos a graduação em [CURSO_SIMILAR]\"]\n\n✅ Reconhecido pelo MEC\n🎁 Matrícula gratuita\n💰 Condições especiais\n\nQuer que eu te conte mais sobre essa oportunidade? Pode ser exatamente o que você precisa! 🚀\n```\n\n### 💬 **TEMPLATE INTERESSE GENÉRICO** (apenas para casos muito vagos)\n```\nQue legal! 😊 Fico feliz com seu interesse!\n\nPara te ajudar da melhor forma, me conta um pouco mais: você está pensando em graduação ou pós-graduação? Tem alguma área específica em mente?\n\nAssim posso te apresentar as melhores opções! ✨\n```\n\n### ❌ **NUNCA USE ESTE COMPORTAMENTO:**\n```\n❌ ERRADO: \"Para te passar informações, preciso do seu nome completo, CPF e e-mail\"\n✅ CORRETO: Apresente o curso primeiro, engaje, mantenha conversa ativa!\n```\n\n---\n\n## 🎯 BENEFÍCIOS EMOCIONAIS POR ÁREA\n\n- **Administração:** \"É incrível como você vai poder trabalhar em qualquer empresa! 🚀\"\n- **Tecnologia:** \"Você está entrando no setor que mais cresce no Brasil! 💻\" \n- **Saúde:** \"Que área linda! Vai ajudar vidas e ter estabilidade! ❤️\"\n- **Educação:** \"Professor transforma vidas! Imagina o impacto positivo! 📚\"\n- **Engenharia:** \"Engenheiro tem prestígio em qualquer lugar! ⚙️\"\n- **RH:** \"RH é estratégico hoje! Peça fundamental nos negócios! 👥\"\n- **Marketing:** \"Marketing está em alta! Área criativa e dinâmica! 🎨\"\n- **Segurança:** \"Área que só cresce! Mercado aquecido! 🛡️\"\n\n---\n\n## ✅ CHECKLIST ANTES DE RESPONDER\n\n**🔍 VALIDAÇÃO OBRIGATÓRIA:**\n- [ ] Executei `rag_informacoes` com a mensagem do usuário?\n- [ ] Li completamente o resultado da ferramenta?\n- [ ] **CRÍTICO:** Se cliente perguntou sobre curso específico, estou apresentando o curso (NÃO pedindo dados pessoais)?\n- [ ] Escolhi o template correto baseado no resultado?\n- [ ] Não estou copiando códigos literalmente?\n- [ ] Minha resposta é natural e comercial?\n- [ ] Se vou usar tool `inscricao`: Houve conversa real? Candidato sabe tudo? Confirmou explicitamente? TENHO CERTEZA?\n\n---\n\n**Agente:**\n1. ✅ Execute `rag_informacoes` com \"Oi, quero saber sobre administração\"\n2. ✅ RAG retorna dados do curso de Administração\n3. ✅ Responde: \"Que legal! 😊 Administração é uma escolha fantástica! Aqui na Cruzeiro do Sul...\"\n\n**RESULTADO:** Lead registrado + Apresentação comercial + Conversa ativa\n\n### 🚨 **EXEMPLO CRÍTICO - CORRIJA ESTE COMPORTAMENTO:**\n\n**❌ COMPORTAMENTO ERRADO:**\n**Cliente:** \"Quero ver mais informações sobre administração EAD\"\n**Agente ERRADO:** \"Para te passar informações, preciso do seu nome completo, CPF e e-mail\"\n**PROBLEMA:** Perdeu o lead! Cliente vai embora!\n\n**✅ COMPORTAMENTO CORRETO:**\n**Cliente:** \"Quero ver mais informações sobre administração EAD\" \n**Agente CORRETO:**\n1. Execute `rag_informacoes`\n2. \"Que legal! 😊 Administração EAD é uma escolha fantástica! Aqui na Cruzeiro do Sul você tem: 💰 A partir de R$179/mês...\"\n\n**RESULTADO:** Cliente engajado, conversa ativa, lead qualificado!\n\n**🎯 REGRA ABSOLUTA:** Perguntas sobre cursos específicos = APRESENTAR O CURSO, não pedir dados pessoais!\n\n---\n\n## ⚠️ VALIDAÇÃO CRÍTICA TOOL `inscricao`\n\n**ANTES DE EXECUTAR `inscricao`, RESPONDA ESTAS PERGUNTAS:**\n\n🤔 **CHECKLIST OBRIGATÓRIO:**\n- [ ] Houve pelo menos 4-5 trocas de mensagens reais na conversa?\n- [ ] Candidato já sabe qual curso quer?\n- [ ] Candidato já sabe os valores e condições?\n- [ ] Candidato confirmou EXPLICITAMENTE que quer se matricular?\n- [ ] Analisei todo o histórico da conversa e faz sentido ele se inscrever agora?\n- [ ] Tenho CERTEZA ABSOLUTA que é o momento certo?\n\n**❌ SE QUALQUER RESPOSTA FOR \"NÃO\" → NÃO EXECUTE A TOOL!**\n\n**💬 CONTINUE CONVERSANDO AO INVÉS DE EXECUTAR:**\n```\nQue bom que tem interesse! Para garantir que você tenha todas as informações antes de decidir, me deixa esclarecer mais algumas coisas...\n```\n\n---\n\n## 🚫 ERROS QUE NUNCA DEVEM ACONTECER\n\n### ❌ **NUNCA RESPONDA LITERALMENTE:**\n- \"RAG_SEM_RESULTADO\"\n- \"EXECUTAR_INSCRICAO\"\n- \"DISTRIBUIR_POS\"\n\n### ❌ **NUNCA FAÇA:**\n- Responder sem executar `rag_informacoes` primeiro\n- **PEDIR DADOS PESSOAIS quando cliente pergunta sobre curso específico**\n- Usar tool `inscricao` precipitadamente (ela PAUSARÁ SEU atendimento!)\n- Usar linguagem robotizada\n- Oferecer cursos que não temos\n- Aproximar valores\n\n### ✅ **SEMPRE FAÇA:**\n- Execute `rag_informacoes` primeiro\n- Use templates humanizados\n- Seja entusiasmado e consultivo\n- Mantenha conversa ativa\n\n---\n\n## 🏆 OBJETIVO FINAL\n\n**Lead empolgado, confiante na escolha e pronto para se matricular HOJE!**\n\n**💡 DICA DE OURO:** Imagine que você está conversando com um amigo que pediu sua opinião sobre qual curso fazer. Seja genuíno, entusiasmado e útil!\n\n**🚨 REGRA CRÍTICA:** NUNCA peça dados pessoais quando alguém pergunta sobre curso específico! SEMPRE apresente o curso primeiro, engaje a conversa, mantenha ativo! Pedir CPF e dados logo no início mata a conversa!"
        }
      },
      "id": "33b8ada0-2ca4-4530-a7a6-fa5869e11216",
      "name": "Consultor",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        8336,
        32
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        10192,
        912
      ],
      "id": "4f5d1d64-9fb9-4374-acbb-f164633e756c",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "⚠️ SÓ USAR SE RAG = \"DISTRIBUIR_\" ou \"RAG_SEM_RESULTADO:\"\n❌ NUNCA USAR SE RAG TEM DADOS DE CURSO (📘🎓💰)\nQuando tem dados = VENDER, não distribuir!",
        "workflowId": {
          "__rl": true,
          "value": "pWLVh6dNNqX0DfAl",
          "mode": "list",
          "cachedResultName": "distribuir_atendimento_ia"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "Telefone"
          ],
          "schema": [
            {
              "id": "Telefone",
              "displayName": "Telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        8320,
        576
      ],
      "id": "8c91d962-f0a1-489d-9447-2a52eab6dcbd",
      "name": "distribuir_humano"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Dados').item.json.Instance }}",
        "remoteJid": "={{ $('Dados').item.json.Telefone }}",
        "messageText": "={{ $json.output }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        10816,
        512
      ],
      "id": "b9e88ce0-699a-4984-a876-12550d078d31",
      "name": "Enviar texto",
      "credentials": {
        "evolutionApi": {
          "id": "nB4splEd6P979FNr",
          "name": "Evolution - Comercial"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        6112,
        1840
      ],
      "id": "8e3608dd-7863-4861-b850-a13196be7760",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "4fXizCuCrLR4SEIp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "dataType": "binary",
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        6464,
        1728
      ],
      "id": "4289d36e-aae0-46aa-ada7-cfbd8fba5b86",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        5632,
        1552
      ],
      "id": "63ff7cca-3f26-459f-ae80-4944ce93744d",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "183Q_P7XkbPcLTHth0hIvokbMFnh0cmbp",
          "mode": "list",
          "cachedResultName": "informacoes-polos e semi.csv",
          "cachedResultUrl": "https://drive.google.com/file/d/183Q_P7XkbPcLTHth0hIvokbMFnh0cmbp/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        5904,
        1520
      ],
      "id": "dda4e7de-7bef-4c0b-a0db-c6493b14d55f",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "6631e3XH0YrNrV8w",
          "name": "powerbieduit"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 600,
        "chunkOverlap": 75,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        6464,
        1888
      ],
      "id": "28f00a23-ad47-417f-8f6b-834dde54d7c8",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "content": "Converte Documentos em Vetorial \n",
        "height": 580,
        "width": 1380
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5584,
        1440
      ],
      "id": "b3ab877e-43a1-4c93-bc6a-11af5a0c5356",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "embeddingBatchSize": 15,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        6128,
        1520
      ],
      "id": "ab6df33b-8f15-4db6-aae4-03a160098e5b",
      "name": "Supabase Vector Store1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "PHQl6oEaPqgLjGGZ",
          "name": "BANCO - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data._embedded.leads[0].status_id }}",
                    "rightValue": 89820300,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "81bf90a7-0a29-4229-9fb3-cc04be0bfca0"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3536,
        304
      ],
      "id": "1a381b09-f91c-46c7-a600-1caabe96bf6e",
      "name": "Switch1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3680,
        464
      ],
      "id": "3308df7b-a56f-4fd1-b0da-9da7b81fb779",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "url": "=https://admamoeduitcombr.kommo.com/api/v4/leads?query={{ '+' + $('Code').item.json.telefoneCorreto.replace('@s.whatsapp.net', '') }}&filter[statuses][0][pipeline_id]=11685120&filter[statuses][0][status_id]=89820300",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImExNmNlYWNkMzAxZjMyYjg4NzAzOGE0NjYwZDc4NGY4YTk3ZTFjMTNlNjRkMzU5ZjU4NTM1NWQzYWMwZDdkMDVjZTY2ZWExOWExMzUyOTM5In0.eyJhdWQiOiI3MGFhNjUzZS04NmI5LTQ4ZjgtOTZhNy1kMjc4YzJiMTA4ZWEiLCJqdGkiOiJhMTZjZWFjZDMwMWYzMmI4ODcwMzhhNDY2MGQ3ODRmOGE5N2UxYzEzZTY0ZDM1OWY1ODUzNTVkM2FjMGQ3ZDA1Y2U2NmVhMTlhMTM1MjkzOSIsImlhdCI6MTc1MzQ3NDQzMywibmJmIjoxNzUzNDc0NDMzLCJleHAiOjE3NjYwMTYwMDAsInN1YiI6IjgyNjE4MzciLCJncmFudF90eXBlIjoiIiwiYWNjb3VudF9pZCI6MzAyMTQ1NjgsImJhc2VfZG9tYWluIjoia29tbW8uY29tIiwidmVyc2lvbiI6Miwic2NvcGVzIjpbImNybSIsImZpbGVzIiwiZmlsZXNfZGVsZXRlIiwibm90aWZpY2F0aW9ucyIsInB1c2hfbm90aWZpY2F0aW9ucyJdLCJoYXNoX3V1aWQiOiI5Y2ZkNmQ3OC1lZWYxLTQ0NTYtOTBmZS01YWU2NjM0M2VmZDIiLCJhcGlfZG9tYWluIjoiYXBpLWcua29tbW8uY29tIn0.kpJh8NWnz6vXtx-4f4uZ0MpdT-pBBrIafhwZ9QhMbJOH1BwOOZDVqPTSEpUAshugFGtwASRSaOBkWmMy-OyUp-50ueFj7ZR9efcqLpLiMlHJCM64F1wSIU4gz6AjbNlvwJdml2LYBZI88ymqEycW_G058RW_6tt--Zm9D9JklAjh68ZV3hNl980hrlMm2iKPOwN-GpMvZqtrn3RR6rw9lgWX00nQiphSfMSJX7GkI2Xnq5Si3VHKFaFnI6tUwQTbfO6EjxTgtu2cu6do9hl-hAad1Bt9trgtAVQVTeiwxXE-Uqx3R3YDgtFKpaMl9sAX0QTPwbDFjGUk3oQ6dNLJLg "
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3072,
        304
      ],
      "id": "3355c2b9-f52e-43c9-ad29-acca22c81e01",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f5c281d3-f206-42bd-a05a-02d2b2c427a0",
              "name": "data",
              "value": "={{ $json.data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3312,
        304
      ],
      "id": "58c07f42-e9e2-46b1-921e-4e1dde98f4c1",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "let telefoneRaw;\nlet telefoneCorreto;\n\n// 1. Tenta pegar do formato processado (por ex. depois de um Set)\nif ($json.Telefone) {\n  telefoneRaw = $json.Telefone;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 2. Tenta pegar do JSON bruto vindo direto do webhook\nelse if ($json.body?.data?.key?.remoteJid) {\n  telefoneRaw = $json.body.data.key.remoteJid;\n  telefoneCorreto = telefoneRaw.endsWith('@lid') && $json.body?.data?.key?.senderPn\n    ? $json.body.data.key.senderPn\n    : telefoneRaw;\n}\n\n// 3. Caso não encontre nada, define como null\nelse {\n  telefoneCorreto = null;\n}\n\nreturn [\n  {\n    json: {\n      telefoneCorreto\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        320
      ],
      "id": "6e510c74-aad1-4540-9a79-4520edf712c0",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9648,
        128
      ],
      "id": "c22955d4-4321-43d0-9167-4d0633871840",
      "name": "Merge"
    },
    {
      "parameters": {
        "content": "# KOMMO\n\n",
        "height": 780,
        "width": 1220,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2912,
        -48
      ],
      "typeVersion": 1,
      "id": "d735445a-c32e-4751-9a49-1d8422c8ee12",
      "name": "Sticky Note21"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2720,
        256
      ],
      "id": "aeeb12d4-c628-4931-b84e-5304103a9c59",
      "name": "Wait1",
      "webhookId": "9570c1d5-ac36-4517-8cfb-32ad769dfb8a"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4736,
        208
      ],
      "id": "400e7a2e-bf02-4495-afd2-5036b573ce40",
      "name": "Merge2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4640,
        48
      ],
      "id": "ed287bc7-4b86-4304-a18b-91422e3ba8d9",
      "name": "Merge3"
    },
    {
      "parameters": {
        "description": "use essa tool para enviar o template de inscricao do whatsapp ",
        "workflowId": {
          "__rl": true,
          "value": "FgPYiDXMl6Ita0We",
          "mode": "list",
          "cachedResultName": "distribuicao_ai_flows"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [
            "telefone"
          ],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        8592,
        560
      ],
      "id": "da0a23e4-0274-47b5-ab7d-d63e2bee7fed",
      "name": "inscricao"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "R70WoNFGao2JvWjB",
          "mode": "list",
          "cachedResultName": "agente rag - informacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "pergunta": "={{ $('Mensagem Completa1').item.json.mensagem_completa }}",
            "telefone": "={{ $('Code').item.json.telefoneCorreto }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "pergunta",
              "displayName": "pergunta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        8448,
        576
      ],
      "id": "92ef54cd-7f9a-4a3e-b57a-5ecd40c4971c",
      "name": "rag_informacoes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Create a table to store your documents\ncreate table precos_agente (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        5344,
        1568
      ],
      "id": "40c98457-87a3-467c-9262-59385bd291ed",
      "name": "documents1",
      "credentials": {
        "postgres": {
          "id": "g8XvGl4ZXekfufXq",
          "name": "POSTGRES - AGENTE COMERCIAL"
        }
      }
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('Edit Fields1').item.json.data._embedded.leads[0].id }}",
              "text": "={{ $json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        9664,
        480
      ],
      "id": "df75a852-d089-4656-a3ab-95b360a9556b",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Consultor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Cria Histórico Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Adiciona CHAT supabase",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza CHAT Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Telefone": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adiciona CHAT supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza CHAT Supabase": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Cria Histórico Supabase": {
      "main": [
        [
          {
            "node": "Delete Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de Mensagem": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1 segundo": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook EVO": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Converter Foto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Treinamento RAG",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "Summarize1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from Excel2": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente Treinamento RAG": {
      "main": [
        [
          {
            "node": "Deleta linhas antigas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Atendimento": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Salvar Historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotas1": {
      "main": [
        [
          {
            "node": "Pausar IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reativar IA": {
      "main": [
        [
          {
            "node": "Salvar Historico1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Normal ou Treinamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Reativar IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from Excel2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Document Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Document Text": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize1": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from Excel": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "imagem Redis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Imagem Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Audio Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "Cliente Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cliente Existe?": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        [
          {
            "node": "ROTA Entrando ou Saindo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Entrando ou Saindo": {
      "main": [
        [
          {
            "node": "Rotas1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Audio": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Foto": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ROTA Mensagens": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "thinking": {
      "ai_tool": [
        [
          {
            "node": "Consultor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Consultor",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intervalo entre Mensagens": {
      "main": [
        [
          {
            "node": "Buscas Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem Redis": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscas Mensagens": {
      "main": [
        [
          {
            "node": "Compara Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Completa1": {
      "main": [
        [
          {
            "node": "Deletar Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Mensagens": {
      "main": [
        [
          {
            "node": "Consultor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normal ou Treinamento": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agente Treinamento RAG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compara Memoria": {
      "main": [
        [
          {
            "node": "Mensagem Completa1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split de mensagens": {
      "main": [
        [
          {
            "node": "Split de Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Split": {
      "ai_languageModel": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Modelo Output": {
      "ai_outputParser": [
        [
          {
            "node": "Split de mensagens",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Deleta linhas antigas": {
      "main": [
        [
          {
            "node": "Search files and folders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar_conteudo_existente": {
      "ai_tool": [
        [
          {
            "node": "Agente Treinamento RAG",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Modificar_base_dados": {
      "ai_tool": [
        [
          {
            "node": "Agente Treinamento RAG",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI Treinamento": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Consultor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Converter Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem": {
      "main": [
        [
          {
            "node": "Intervalo entre Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search files and folders": {
      "main": [
        [
          {
            "node": "Download File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultor": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Modelo Output",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "distribuir_humano": {
      "ai_tool": [
        [
          {
            "node": "Consultor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [],
        [
          {
            "node": "Enviar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar texto": {
      "main": [
        [
          {
            "node": "1 segundo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "ROTA Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Busca Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Texto Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "inscricao": {
      "ai_tool": [
        [
          {
            "node": "Consultor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "rag_informacoes": {
      "ai_tool": [
        [
          {
            "node": "Consultor",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        [
          {
            "node": "Split de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "dCpCqA316QocWWea",
    "timezone": "America/Sao_Paulo"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook EVO": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "axios/1.10.0",
            "content-length": "825",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "wapp_licenciado_com",
            "data": {
              "key": {
                "id": "wamid.HBgNNTUxMTk0NTAxMDQ5MxUCABIYFDNGRUY5QzU0NzBBMzhBM0Y5NDkzAA==",
                "remoteJid": "5511945010493@s.whatsapp.net",
                "fromMe": false
              },
              "pushName": "x",
              "message": {
                "conversation": "tenho interesse em administração ead"
              },
              "messageType": "conversation",
              "messageTimestamp": 1755754433,
              "source": "unknown",
              "instanceId": "98cc1610-1e7d-45b3-aef1-f0b323f4187f"
            },
            "destination": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/evolution",
            "date_time": "2025-08-21T02:33:54.799Z",
            "server_url": "https://outros-evolution-api.ca31ey.easypanel.host",
            "apikey": "EAAb0QaT8hLgBPNZAYZBRkwNkVxsmniKG5bmamFZC3ZAZCZAW3vBL59Bc2MoU0Gb9abvPyCZAuP79RcOa5vcXHfpN4W3NRlpZBHITZB4VtitWM7OtiSZCYmyHpfqL6PyZBdjxDH3ef9SZBPZCPdBIaDA0WUpd9yZBxWHvrLRXWGv5r0eA4j2VlbBkaAC8bZCQhfSAdgIegx77AZDZD"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/evolution",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "61fd4b20-ca0d-40d4-951c-0b2628547cb7",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-07-25T20:01:53.090Z",
      "updatedAt": "2025-07-25T20:01:53.090Z",
      "role": "workflow:owner",
      "workflowId": "afID0dTfsm0vtXUX",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": [
    {
      "createdAt": "2025-07-30T20:41:48.074Z",
      "updatedAt": "2025-07-30T20:41:48.074Z",
      "id": "HCAYGF54Hj7mAMlF",
      "name": "ai"
    }
  ]
}