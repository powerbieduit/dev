{
  "updatedAt": "2025-08-11T19:08:59.000Z",
  "createdAt": "2025-07-25T20:39:57.899Z",
  "id": "6axWxb3HoyhEsmgN",
  "name": "Siaa Kommo update",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1VOnTJWoQl-bbA0a5iUCWyI_TJbBhOpSp",
          "mode": "list",
          "cachedResultName": "Consolidated",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1VOnTJWoQl-bbA0a5iUCWyI_TJbBhOpSp"
        },
        "event": "fileCreated",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -928,
        -320
      ],
      "id": "b2c22659-9f77-4cd1-a773-6d234e824266",
      "name": "Google Drive Trigger",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "ei8DkqyZHlfNyEOk",
          "name": "MKT Eduit"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -480,
        -224
      ],
      "id": "643ebc5f-7da2-4a9e-918e-49e0b009d4ac",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -704,
        -224
      ],
      "id": "5711f5c5-9d2b-4c71-8a34-eba680ac9733",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "ei8DkqyZHlfNyEOk",
          "name": "MKT Eduit"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "=siaa_nova",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "cpf": "={{ $json.CPF }}",
            "nome_completo": "={{ $json['﻿Nome Completo'] }}",
            "primeiro_nome": "={{ $json['Primeiro Nome'] }}",
            "rgm": "={{ $json.RG }}",
            "rg": "={{ $json.RG }}",
            "sexo": "={{ $json.Sexo }}",
            "status_inscrito": "={{ $json['Status Inscrito'] }}",
            "inscricao": "={{ $json['Inscrição'] }}",
            "curso": "={{ $json.Curso }}",
            "polo": "={{ $json.Polo }}",
            "data_inscricao": "={{ $json['Data da Inscrição'] }}",
            "data_prova": "={{ $json['Data da Prova'] }}",
            "data_matricula": "={{ $json['Data da Matricula'] }}",
            "ddd_cel_e_fone_cel": "={{ $json['DDD cel e Fone Cel'] }}",
            "email": "={{ $json['e-mail'] }}",
            "email_ad": "={{ $json['e-mail AD'] }}",
            "situacao": "={{ $json['Situação'] }}",
            "status_final": "={{ $json['Status Final'] }}",
            "trimestre_ingresso": "={{ $json['Trimestre de Ingresso'] }}",
            "data_nascimento": "={{ $json['Data Nascimento'] }}",
            "idade": "={{ $json.Idade }}",
            "cep": "={{ $json.CEP }}",
            "endereco": "={{ $json['Endereço'] }}",
            "bairro": "={{ $json.Bairro }}",
            "cidade": "={{ $json.Cidade }}",
            "estado": "={{ $json.Estado }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nome_completo",
              "displayName": "nome_completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "primeiro_nome",
              "displayName": "primeiro_nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cpf",
              "displayName": "cpf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "rg",
              "displayName": "rg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "rgm",
              "displayName": "rgm",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "sexo",
              "displayName": "sexo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status_inscrito",
              "displayName": "status_inscrito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "inscricao",
              "displayName": "inscricao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "curso",
              "displayName": "curso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "polo",
              "displayName": "polo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "serie",
              "displayName": "serie",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "data_inscricao",
              "displayName": "data_inscricao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "data_prova",
              "displayName": "data_prova",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "data_matricula",
              "displayName": "data_matricula",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ddd_cel_e_fone_cel",
              "displayName": "ddd_cel_e_fone_cel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email_ad",
              "displayName": "email_ad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "situacao",
              "displayName": "situacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status_final",
              "displayName": "status_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "trimestre_ingresso",
              "displayName": "trimestre_ingresso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "data_nascimento",
              "displayName": "data_nascimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "idade",
              "displayName": "idade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cep",
              "displayName": "cep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "endereco",
              "displayName": "endereco",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "bairro",
              "displayName": "bairro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cidade",
              "displayName": "cidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -256,
        -224
      ],
      "id": "3adfa1b7-659c-4287-a1a2-7406ae22be3e",
      "name": "Insert in Nova",
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "gv4NhIdkBb2qLSqQ",
          "name": "Postgres CSV_comercial"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO siaa_antiga (\n    nome_completo,\n    primeiro_nome,\n    cpf,\n    rg,\n    rgm,\n    sexo,\n    status_inscrito,\n    inscricao,\n    curso,\n    polo,\n    serie,\n    data_inscricao,\n    data_prova,\n    data_matricula,\n    ddd_cel_e_fone_cel,\n    email,\n    email_ad,\n    situacao,\n    status_final,\n    trimestre_ingresso,\n    data_nascimento,\n    idade,\n    cep,\n    endereco,\n    bairro,\n    cidade,\n    estado\n)\nSELECT\n    nome_completo,\n    primeiro_nome,\n    cpf,\n    rg,\n    rgm,\n    sexo,\n    status_inscrito,\n    inscricao,\n    curso,\n    polo,\n    serie,\n    data_inscricao,\n    data_prova,\n    data_matricula,\n    ddd_cel_e_fone_cel,\n    email,\n    email_ad,\n    situacao,\n    status_final,\n    trimestre_ingresso,\n    data_nascimento,\n    idade,\n    cep,\n    endereco,\n    bairro,\n    cidade,\n    estado\nFROM siaa_nova;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -704,
        -640
      ],
      "id": "d55b018c-6e72-4287-abe8-758e16e0ee64",
      "name": "Backup para Antiga",
      "credentials": {
        "postgres": {
          "id": "gv4NhIdkBb2qLSqQ",
          "name": "Postgres CSV_comercial"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "siaa_antiga",
          "mode": "list",
          "cachedResultName": "siaa_antiga"
        },
        "deleteCommand": "delete",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -928,
        -640
      ],
      "id": "d7df0ab9-0e58-4982-8f62-b6f3a47c0b51",
      "name": "Delete Antiga",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "gv4NhIdkBb2qLSqQ",
          "name": "Postgres CSV_comercial"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "siaa_nova",
          "mode": "list",
          "cachedResultName": "siaa_nova"
        },
        "deleteCommand": "delete",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -704,
        -416
      ],
      "id": "5c52cb4a-b0ef-4e02-b6be-85b36d4c3b1d",
      "name": "Delete NOVA",
      "credentials": {
        "postgres": {
          "id": "gv4NhIdkBb2qLSqQ",
          "name": "Postgres CSV_comercial"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1056,
        736
      ],
      "id": "83cd3894-5725-4c65-affd-e6d24c0b058c",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "content": "## Resumo objetivo\ntransferido: inscrição vazia, status_final = 'Matriculado', CPF não existe na antiga\n\nmatriculado: nova inscrição (não existe na antiga), status_final = 'Matriculado'\n\ninsert: nova inscrição, status_final <> 'Matriculado'\n\nupdate_matricula: mesma inscrição, status_final virou 'Matriculado'\n\nupdate_situacao: mesma inscrição, mudou só situacao\n\nnão aparece: não se encaixa nas regras acima",
        "height": 540,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -976,
        -16
      ],
      "id": "8e9ad091-7bfe-484e-9f02-a574f0387869",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "// === DEBUG: Exibe tudo que chega ===\nconsole.log('===== DEBUG INICIAL =====');\nconsole.log(JSON.stringify($json, null, 2));\n\n// === 1. Normaliza status prioritário (kommo > situacao) ===\nconst statusRaw = $json.kommo || $json.situacao || '';\nconst status = statusRaw.toLowerCase().trim();\n\n// === 2. Número de inscrição do banco ===\nconst inscricaoAlvo = String($json.inscricao).trim();\n\n// === 3. Lista de leads retornados pelo Kommo ===\nconst leads = $json._embedded?.leads || [];\n\n// === 4. Função auxiliar: pega valor de campo personalizado ===\nfunction getValorCampo(lead, fieldId) {\n  return lead.custom_fields_values?.find(f => f.field_id === fieldId)?.values?.[0]?.value || '';\n}\n\n// === 5. Busca lead com inscrição igual à do banco ===\nconst leadEncontradoObj = leads.find(lead => {\n  const nroInscricao = getValorCampo(lead, 690889);\n  return String(nroInscricao).trim() === inscricaoAlvo;\n});\n\n// === 6. Define ID do lead (ou string vazia se não encontrar) ===\nconst leadExiste = !!leadEncontradoObj;\nconst leadId = leadExiste ? String(leadEncontradoObj.id) : '';\nconsole.log('Lead com inscrição encontrada:', leadId);\n\n// === 7. Chave de decisão para de/para ===\nconst chave = `${status}|${leadExiste ? 'Sim' : 'Não'}`;\nconsole.log('CHAVE DE DECISÃO:', chave);\n\n// === 8. Regras de decisão ===\nconst mapa = {\n  'matriculado|Sim': {\n    acao: 'atualizar_lead',\n    pipeline_id: 5481944,\n    status_id: 142,\n    origem_timestamp: '',\n    origem: ''\n  },\n  'matriculado|Não': {\n    acao: 'criar_lead',\n    pipeline_id: 5481944,\n    status_id: 142,\n    origem_timestamp: '',\n    origem: 'SIAA'\n  },\n  'transferido|Sim': {\n    acao: 'atualizar_lead',\n    pipeline_id: 5481944,\n    status_id: 142,\n    origem_timestamp: '',\n    origem: ''\n  },\n  'transferido|Não': {\n    acao: 'criar_lead',\n    pipeline_id: 5481944,\n    status_id: 142,\n    origem_timestamp: '',\n    origem: 'SIAA'\n  },\n  'insert|Não': {\n    acao: 'criar_lead',\n    pipeline_id: 5481944,\n    status_id: 48539246,\n    origem_timestamp: 'Recebido',\n    origem: 'SIAA / Salesforce'\n  },\n  'update_matricula|Sim': {\n    acao: 'atualizar_lead',\n    pipeline_id: 5481944,\n    status_id: 142,\n    origem_timestamp: '',\n    origem: ''\n  },\n  'update_situacao|Sim': {\n    acao: 'atualizar_lead',\n    pipeline_id: 5481944,\n    status_id: 48566201,\n    origem_timestamp: 'Recebido',\n    origem: ''\n  }\n};\n\n// === 9. Resultado da regra ou padrão ===\nconst resultado = mapa[chave] || {\n  acao: 'ignorar',\n  pipeline_id: '',\n  status_id: '',\n  origem_timestamp: '',\n  origem: ''\n};\n\n// === 10. Função que converte null/undefined em \"\" (recursiva) ===\nfunction limparValores(obj) {\n  if (Array.isArray(obj)) {\n    return obj.map(limparValores);\n  } else if (obj !== null && typeof obj === 'object') {\n    const novoObj = {};\n    for (const key in obj) {\n      novoObj[key] = limparValores(obj[key]);\n    }\n    return novoObj;\n  } else {\n    return obj === null || obj === undefined ? '' : obj;\n  }\n}\n\n// === 11. Monta e retorna o JSON final já tratado ===\nreturn [{\n  json: limparValores({\n    ...$json,\n    ...resultado,\n    lead_encontrado: leadId\n  })\n}];\n"
      },
      "id": "9193b988-3f05-40cf-a1d8-018c840bbc3d",
      "name": "Code - Junta & Decide",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        736
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.acao }}",
                    "rightValue": "criar_lead",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ab0554ba-d7c2-4bd9-ad33-648788a594be"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.acao }}",
                    "rightValue": "atualizar_lead",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "395e0753-31c8-4687-a616-a63eae73ccb5"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "20856b18-282c-4fa4-9a51-6cfb91602685",
                    "leftValue": "={{ $json.acao }}",
                    "rightValue": "ignorar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "49032bdc-31d6-45f0-9d60-4abe3137c44f",
      "name": "Switch - Criar ou Atualizar",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        240,
        720
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "atualizacao_comercial",
        "returnAll": true,
        "options": {}
      },
      "id": "c4fe0fe2-76f7-4332-8862-7f7bb2b6a2d8",
      "name": "Select atualizacao_comercial2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        -848,
        736
      ],
      "credentials": {
        "postgres": {
          "id": "gv4NhIdkBb2qLSqQ",
          "name": "Postgres CSV_comercial"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "filter": {
          "query": "={{ $json.inscricao }}"
        },
        "options": {}
      },
      "id": "ea9dc460-a689-4875-a0a9-eb97e5ae01c3",
      "name": "Get list of leads2",
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -368,
        640
      ],
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1056,
        944
      ],
      "id": "e47028f0-b04b-42f6-a0ed-a6ce5fa6df4e",
      "name": "Wait",
      "webhookId": "6b93bcc2-383e-4229-9e75-833481a76c60"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1408,
        544
      ],
      "id": "7d8e878a-c31f-4b75-97e4-e2b625894f2f",
      "name": "Wait1",
      "webhookId": "6b93bcc2-383e-4229-9e75-833481a76c60"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -640,
        736
      ],
      "id": "c059e328-d654-41d4-a448-9101a646b637",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -368,
        480
      ],
      "id": "ef8fd6cc-7c39-49a3-86ce-5edab6c37605",
      "name": "No Operation, do nothing",
      "alwaysOutputData": true,
      "executeOnce": true
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -384,
        848
      ],
      "id": "94a80305-b07d-43f3-9ef7-15e2bbb04f31",
      "name": "Wait2",
      "webhookId": "9bf41d09-6b05-4857-8b0c-fd2398faba91"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -160,
        736
      ],
      "id": "312608fe-b45c-478c-8522-9d41409c373c",
      "name": "Merge"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        432,
        544
      ],
      "id": "5406dfc9-bc1e-465e-afda-7619a6e70c30",
      "name": "Merge1"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $json.lead_encontrado }}",
              "pipeline_id": 5481944,
              "status_id": 142,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":304628,\"type\":\"text\"}",
                    "value": "={{ $json.nome_completo }}"
                  },
                  {
                    "data": "{\"id\":31774,\"type\":\"text\"}",
                    "value": "={{ $json.cpf }}"
                  },
                  {
                    "data": "{\"id\":689713,\"type\":\"numeric\"}",
                    "value": "={{ $json.rg }}"
                  },
                  {
                    "data": "{\"id\":31776,\"type\":\"text\"}",
                    "value": "={{ $json.rgm }}"
                  },
                  {
                    "data": "{\"id\":690889,\"type\":\"text\"}",
                    "value": "={{ $json.inscricao }}"
                  },
                  {
                    "data": "{\"id\":31782,\"type\":\"text\"}",
                    "value": "={{ $json.curso }}"
                  },
                  {
                    "data": "{\"id\":31780,\"type\":\"text\"}",
                    "value": "={{ $json.polo }}"
                  },
                  {
                    "data": "{\"id\":190582,\"type\":\"text\"}",
                    "value": "=+55{{ $json.ddd_cel_e_fone_cel }}"
                  },
                  {
                    "data": "{\"id\":689701,\"type\":\"text\"}",
                    "value": "={{ $json.email }}"
                  },
                  {
                    "data": "{\"id\":31766,\"type\":\"text\"}",
                    "value": "={{ $json.situacao }}"
                  },
                  {
                    "data": "{\"id\":31772,\"type\":\"date\"}",
                    "value": "={{ Math.floor((Number($json.data_matricula_unix_ms) + (3 * 3600 * 1000)) / 1000) }}\n"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        752,
        816
      ],
      "id": "c70c0fda-973c-4665-993a-15c9ffe40bdb",
      "name": "Update leads Matriculados",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "resource": "contacts",
        "operation": "createContacts",
        "collection": {
          "contact": [
            {
              "name": "={{ $json.nome_completo }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":15846,\"type\":\"multitext\"}",
                    "value": "=+55{{ $json.ddd_cel_e_fone_cel }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        912,
        432
      ],
      "id": "1e26f357-263c-43dc-a82a-80687b7f582a",
      "name": "Criar contato não matriculado",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "createLeads",
        "collection": {
          "lead": [
            {
              "name": "SIAA",
              "pipeline_id": 5481944,
              "status_id": 48539240,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":304628,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.nome_completo }}"
                  },
                  {
                    "data": "{\"id\":31774,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.cpf }}"
                  },
                  {
                    "data": "{\"id\":689713,\"type\":\"numeric\"}",
                    "value": "={{ $('Merge1').item.json.rg }}"
                  },
                  {
                    "data": "{\"id\":31782,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.curso }}"
                  },
                  {
                    "data": "{\"id\":31780,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.polo }}"
                  },
                  {
                    "data": "{\"id\":689701,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.email }}"
                  },
                  {
                    "data": "{\"id\":31766,\"type\":\"text\"}",
                    "value": "={{ $('Matriculado ou não').item.json.situacao }}"
                  },
                  {
                    "data": "{\"id\":31786,\"type\":\"text\"}",
                    "value": "\" \""
                  },
                  {
                    "data": "{\"id\":31764,\"type\":\"text\"}",
                    "value": "SIAA"
                  }
                ]
              },
              "_embedded": {
                "contacts": [
                  {
                    "id": {
                      "contact": [
                        {
                          "id": "={{ $json._embedded.contacts[0].id }}"
                        }
                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1152,
        432
      ],
      "id": "d419b4bb-e61c-43b6-b468-d69d13931f96",
      "name": "Criar lead não matriculado",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "createLeads",
        "collection": {
          "lead": [
            {
              "name": "SIAA",
              "pipeline_id": 5481944,
              "status_id": 142,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":304628,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.nome_completo }}"
                  },
                  {
                    "data": "{\"id\":31774,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.cpf }}"
                  },
                  {
                    "data": "{\"id\":689713,\"type\":\"numeric\"}",
                    "value": "={{ $('Merge1').item.json.rg }}"
                  },
                  {
                    "data": "{\"id\":31776,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.rgm }}"
                  },
                  {
                    "data": "{\"id\":31782,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.curso }}"
                  },
                  {
                    "data": "{\"id\":31780,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.polo }}"
                  },
                  {
                    "data": "{\"id\":689701,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.email }}"
                  },
                  {
                    "data": "{\"id\":666386,\"type\":\"text\"}",
                    "value": "={{ $('Merge1').item.json.email_ad }}"
                  },
                  {
                    "data": "{\"id\":31766,\"type\":\"text\"}",
                    "value": "={{ $('Matriculado ou não').item.json.situacao }}"
                  },
                  {
                    "data": "{\"id\":31772,\"type\":\"date\"}",
                    "value": "={{ Math.floor((Number($('Merge1').item.json.data_matricula_unix_ms) + (3 * 3600 * 1000)) / 1000) }}"
                  },
                  {
                    "data": "{\"id\":31764,\"type\":\"text\"}",
                    "value": "SIAA"
                  }
                ]
              },
              "_embedded": {
                "contacts": [
                  {
                    "id": {
                      "contact": [
                        {
                          "id": "={{ $json._embedded.contacts[0].id }}"
                        }
                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        1152,
        672
      ],
      "id": "f45c5443-7ba3-4d03-93ce-6fd29505c0d9",
      "name": "Criar lead matriculado",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "resource": "contacts",
        "operation": "createContacts",
        "collection": {
          "contact": [
            {
              "name": "={{ $json.nome_completo }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":15846,\"type\":\"multitext\"}",
                    "value": "=+55{{ $json.ddd_cel_e_fone_cel }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        912,
        672
      ],
      "id": "1ff00556-c6c6-4cbf-9eed-071a09d58c59",
      "name": "Criar contato matriculado",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $json.lead_encontrado }}",
              "pipeline_id": 5481944,
              "status_id": 48566201,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":304628,\"type\":\"text\"}",
                    "value": "={{ $json.nome_completo }}"
                  },
                  {
                    "data": "{\"id\":31774,\"type\":\"text\"}",
                    "value": "={{ $json.cpf }}"
                  },
                  {
                    "data": "{\"id\":689713,\"type\":\"numeric\"}",
                    "value": "={{ $json.rg }}"
                  },
                  {
                    "data": "{\"id\":690889,\"type\":\"text\"}",
                    "value": "={{ $json.inscricao }}"
                  },
                  {
                    "data": "{\"id\":31782,\"type\":\"text\"}",
                    "value": "={{ $json.curso }}"
                  },
                  {
                    "data": "{\"id\":31780,\"type\":\"text\"}",
                    "value": "={{ $json.polo }}"
                  },
                  {
                    "data": "{\"id\":190582,\"type\":\"text\"}",
                    "value": "=+55{{ $json.ddd_cel_e_fone_cel }}"
                  },
                  {
                    "data": "{\"id\":689701,\"type\":\"text\"}",
                    "value": "={{ $json.email }}"
                  },
                  {
                    "data": "{\"id\":31766,\"type\":\"text\"}",
                    "value": "={{ $json.situacao }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        752,
        1088
      ],
      "id": "f68f97c7-d98a-4152-a2cf-7ed7f9d2c493",
      "name": "Update leads Não Matriculados",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "nwQNgfBiNqLrzKlG",
          "name": "Kommo Comercial CSV"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.status_final }}",
                    "rightValue": "Não matriculado",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "741d5c9f-be23-4548-b828-2da096ad564a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "335027c2-53d5-41fe-91e7-ac400162a57f",
                    "leftValue": "={{ $json.status_final }}",
                    "rightValue": "Matriculado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        672,
        544
      ],
      "id": "3b8f43bc-8ba9-4126-be20-baa0011abd2b",
      "name": "Matriculado ou não"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.status_final }}",
                    "rightValue": "Matriculado",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "23176542-93be-4a67-8062-9ffcbab038a9"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "edf2c402-5c3e-4808-b7ac-c94384cabf33",
                    "leftValue": "={{ $json.status_final }}",
                    "rightValue": "Não matriculado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        448,
        928
      ],
      "id": "26a30679-13c6-47c3-b8d0-faef086ba5f1",
      "name": "Matriculado ou não2"
    }
  ],
  "connections": {
    "Google Drive Trigger": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete NOVA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Insert in Nova",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert in Nova": {
      "main": [
        []
      ]
    },
    "Delete Antiga": {
      "main": [
        [
          {
            "node": "Backup para Antiga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Select atualizacao_comercial2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Junta & Decide": {
      "main": [
        [
          {
            "node": "Switch - Criar ou Atualizar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select atualizacao_comercial2": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of leads2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - Criar ou Atualizar": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Matriculado ou não2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get list of leads2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "No Operation, do nothing": {
      "main": [
        []
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code - Junta & Decide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Matriculado ou não",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads Matriculados": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar contato não matriculado": {
      "main": [
        [
          {
            "node": "Criar lead não matriculado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar lead não matriculado": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar lead matriculado": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar contato matriculado": {
      "main": [
        [
          {
            "node": "Criar lead matriculado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads Não Matriculados": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Matriculado ou não": {
      "main": [
        [
          {
            "node": "Criar contato não matriculado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar contato matriculado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Matriculado ou não2": {
      "main": [
        [
          {
            "node": "Update leads Matriculados",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update leads Não Matriculados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "8eff41a1-f91d-42ec-9249-757a82d88b81",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-07-25T20:39:57.902Z",
      "createdAt": "2025-07-25T20:39:57.902Z",
      "role": "workflow:owner",
      "workflowId": "6axWxb3HoyhEsmgN",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "activeVersion": null,
  "tags": []
}