{
  "createdAt": "2025-08-12T19:00:00.578Z",
  "updatedAt": "2025-09-05T20:43:09.000Z",
  "id": "1jMKODbyXXgxral1",
  "name": "dashboard_disparos",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT \n    NULLIF('{{$json.query.data_inicio || \"\"}}','')::date AS data_inicio,\n    NULLIF('{{$json.query.data_fim   || \"\"}}','')::date AS data_fim\n),\n\n-- Ãšltimo retorno por RGM na janela\nult_retorno AS (\n  SELECT DISTINCT ON (r.rgm)\n         r.rgm,\n         COALESCE(NULLIF(btrim(r.retorno), ''), 'SEM RESPOSTA') AS retorno\n  FROM retorno_disparos r\n  CROSS JOIN params p\n  WHERE (p.data_inicio IS NULL OR r.data_registro::date >= p.data_inicio)\n    AND (p.data_fim    IS NULL OR r.data_registro::date <= p.data_fim)\n  ORDER BY r.rgm, r.data_registro DESC\n)\n\nSELECT json_build_object(\n  'ativacoes_por_dia',\n  COALESCE(\n    (\n      SELECT json_agg(row_to_json(a) ORDER BY a.dia)\n      FROM (\n        SELECT\n          t.data_ativacao::date AS dia,\n          COUNT(*) AS total\n        FROM disparos t\n        CROSS JOIN params p\n        WHERE (p.data_inicio IS NULL OR t.data_ativacao::date >= p.data_inicio)\n          AND (p.data_fim    IS NULL OR t.data_ativacao::date <= p.data_fim)\n        GROUP BY t.data_ativacao::date\n        ORDER BY t.data_ativacao::date\n      ) a\n    ),\n    '[]'::json\n  ),\n  'retornos_por_status',\n  COALESCE(\n    (\n      SELECT json_agg(row_to_json(b) ORDER BY b.quantidade DESC)\n      FROM (\n        SELECT\n          u.retorno,\n          COUNT(*) AS quantidade\n        FROM ult_retorno u\n        GROUP BY u.retorno\n        ORDER BY COUNT(*) DESC\n      ) b\n    ),\n    '[]'::json\n  )\n) AS payload;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "f0f77a31-dc6f-40d8-971e-8c8167c729e0",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "QDCGVsYyhaarkGj6",
          "name": "Disparos"
        }
      }
    },
    {
      "parameters": {
        "path": "dashboard",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "87f1a268-1224-403b-9aeb-4d8c3d324f2a",
      "name": "Webhook",
      "webhookId": "f99c13f4-da33-434d-8396-a771f7c8d5c3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        416,
        0
      ],
      "id": "6c96e82d-dc2f-47c6-8dcc-cc2716a5927c",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "pt-BR,pt;q=0.9,en;q=0.8",
            "origin": "https://painel.cruzeiroead.com.br",
            "priority": "u=1, i",
            "referer": "https://painel.cruzeiroead.com.br/",
            "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\", \"Chromium\";v=\"139\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "191.204.187.221",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "191.204.187.221"
          },
          "params": {},
          "query": {
            "data_inicio": "2025-08-26",
            "data_fim": "2025-08-27"
          },
          "body": {},
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/dashboard",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "1385c8fb-5157-40e5-85df-ba4c37f8210a",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-08-12T19:00:00.588Z",
      "updatedAt": "2025-08-12T19:00:00.588Z",
      "role": "workflow:owner",
      "workflowId": "1jMKODbyXXgxral1",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": []
}