{
  "createdAt": "2025-08-21T18:16:54.049Z",
  "updatedAt": "2025-09-08T17:38:45.000Z",
  "id": "15kmAHfNkXIOccRl",
  "name": "Mensagens_Acad",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "capturakommo",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -48,
        0
      ],
      "id": "f2211c78-4eba-42e8-8904-aa8641dc1dd1",
      "name": "Webhook",
      "webhookId": "673f269e-e1a5-4413-b381-a4d8190e7348"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "academico",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -48,
        -160
      ],
      "id": "c45242d5-a0ac-46ee-b108-17edafb2a89d",
      "name": "Webhook1",
      "webhookId": "d30b6fda-0a5d-48c8-9bc3-5982b8b6f4f2"
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node\n// Normaliza payloads diferentes num formato único\n\nfunction onlyDigits(s) {\n  if (s == null) return null;\n  const digits = String(s).replace(/\\D+/g, '');\n  return digits || null;\n}\n\nfunction isoDateOrNow(s) {\n  if (!s) return new Date().toISOString();\n  const d = new Date(s);\n  return isNaN(d.getTime()) ? new Date().toISOString() : d.toISOString();\n}\n\nfunction upperOrEmpty(s) {\n  return (s ?? '').toString().trim().toUpperCase();\n}\n\nfunction toIntOrNull(v) {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n}\n\nreturn items.map(({ json }) => {\n  const unifiedPhone = onlyDigits(json.phone ?? json.userPhone);\n\n  // direção normalizada (aceita variações, mas default OUT se vier inválido)\n  const dirRaw = upperOrEmpty(json.direction);\n  const direction =\n    dirRaw === 'IN' || dirRaw === 'OUT'\n      ? dirRaw\n      : (dirRaw.startsWith('IN') ? 'IN' : (dirRaw.startsWith('OUT') ? 'OUT' : 'OUT'));\n\n  const out = {\n    leadId: toIntOrNull(json.leadId),\n    phone: unifiedPhone,\n    text: (json.text ?? '').toString(),\n    agent: (json.agent ?? '').toString(),\n    direction,\n    timestamp: isoDateOrNow(json.timestamp),\n    tipo: (json.tipo ?? '').toString(),\n    meta: {\n      original: json,              // payload de entrada para auditoria\n      normalizedAt: new Date().toISOString()\n    }\n  };\n\n  // (Opcional) validações leves: marque erros sem quebrar o fluxo\n  out.meta.errors = [];\n  if (!out.leadId) out.meta.errors.push('leadId ausente/ inválido');\n  if (!out.phone) out.meta.errors.push('phone ausente/ inválido');\n\n  return { json: out };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ],
      "id": "a00ac74e-7454-4a63-ae27-3dc6d31e3f47",
      "name": "Code"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "crm_messages",
          "mode": "list",
          "cachedResultName": "crm_messages"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $json.meta.original.body.leadId }}",
            "message_ts": "={{ (() => {\n  const d = new Date($json.meta.original.body.timestamp);\n  d.setHours(d.getHours() - 3); // subtrai 3 horas\n  return d.toISOString();\n})() }}",
            "message_text": "={{ $json.meta.original.body.text }}",
            "whatsapp_to": "=+{{ $json.meta.original.body.phone || $json.meta.original.body.userPhone }}",
            "direction": "={{ $json.meta.original.body.direction }}",
            "agent_id": "={{ $json.meta.original.body.agent }}",
            "tipo_mensagem": "={{ $json.meta.original.body.tipo }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent_id",
              "displayName": "agent_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "direction",
              "displayName": "direction",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ts",
              "displayName": "message_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_text",
              "displayName": "message_text",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "whatsapp_to",
              "displayName": "whatsapp_to",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tipo_mensagem",
              "displayName": "tipo_mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        464,
        0
      ],
      "id": "29df3852-8124-40fd-afeb-cd939f51bcec",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "9HdbVgjDeNXGxrxq",
          "name": "Log_Conversa"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node (JavaScript)\n// Objetivo: Converter telefone para o formato +5511xxxxxxxxx (São Paulo)\n// Fonte principal: json.body.data.key.remoteJid (ex.: \"5511942537015@s.whatsapp.net\")\n\nreturn items.map((item) => {\n  const pick = (...paths) => {\n    for (const p of paths) {\n      try {\n        const v = p.split('.').reduce((acc, k) => (acc ? acc[k] : undefined), item.json);\n        if (typeof v === 'string' && v.trim()) return v;\n      } catch (e) {}\n    }\n    return '';\n  };\n\n  // 1) Tenta achar o telefone nas fontes mais comuns\n  const raw =\n    pick('body.data.key.remoteJid',\n         'data.key.remoteJid',\n         'remoteJid',\n         'body.phone',\n         'phone') || '';\n\n  // 2) Extrai somente dígitos\n  const digits = (raw.match(/\\d+/g) || []).join('');\n\n  // 3) Remove 55 e 11 iniciais, se já vierem presentes\n  let local = digits;\n  if (local.startsWith('55')) local = local.slice(2);\n  if (local.startsWith('11')) local = local.slice(2);\n\n  // 4) Mantém apenas os ÚLTIMOS 9 dígitos (padrão celular SP). \n  //    Se vier 8 dígitos (fixo antigo), mantém 8.\n  if (local.length >= 9) {\n    local = local.slice(-9);\n  } else if (local.length === 0) {\n    // Se não achou nada útil, deixa avisado\n    local = '';\n  }\n\n  const phone_formatted = local ? `+5511${local}` : '';\n\n  return {\n    json: {\n      ...item.json,\n      phone_raw: raw,           // Ex.: \"5511942537015@s.whatsapp.net\"\n      phone_digits: digits,     // Ex.: \"5511942537015\"\n      phone_formatted,          // Ex.: \"+5511942537015\"\n    },\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        -160
      ],
      "id": "e776608d-2680-40b1-90bc-d3e1afdde338",
      "name": "Code1"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "crm_messages",
          "mode": "list",
          "cachedResultName": "crm_messages"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "=evolution",
            "message_text": "={{ $json.body.data.message.conversation }}",
            "whatsapp_to": "={{ $json.phone_formatted }}",
            "direction": "=IN",
            "message_ts": "={{ $json.body.date_time }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent_id",
              "displayName": "agent_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "direction",
              "displayName": "direction",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ts",
              "displayName": "message_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "message_text",
              "displayName": "message_text",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "whatsapp_to",
              "displayName": "whatsapp_to",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        -160
      ],
      "id": "06a408b4-cffe-4184-a398-40ef37b6432e",
      "name": "Insert rows in a table1",
      "credentials": {
        "postgres": {
          "id": "9HdbVgjDeNXGxrxq",
          "name": "Log_Conversa"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Insert rows in a table1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook1": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "axios/1.10.0",
            "content-length": "927",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "eduit_academico_licenciado",
            "data": {
              "key": {
                "id": "wamid.HBgNNTUxMTk0MjUzNzAxNRUCABIYFDNBNjkzQ0UxRjk3QjEzODhFNDgwAA==",
                "remoteJid": "5511942537015@s.whatsapp.net",
                "fromMe": false
              },
              "pushName": "Karina",
              "message": {
                "conversation": "Oi, já sou formada.\nE gostaria de saber como ter acesso ao meu histórico de graduação"
              },
              "messageType": "conversation",
              "messageTimestamp": 1755962660,
              "source": "unknown",
              "instanceId": "4371512e-9207-4f86-943d-473bf4a31f7a"
            },
            "destination": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/academico",
            "date_time": "2025-08-23T12:24:22.630Z",
            "server_url": "https://outros-evolution-api.ca31ey.easypanel.host",
            "apikey": "EAASKh9bgZAEoBPMNJ11x9NX36CHW66GG26cdNenbCSnVcw3ifGZB4HOpC3xbEKHM3xYkLrSUcJSkbpilmWSSA14wZAWioyVV1PJ4UjYCVhd5re74zIEBSm71euHt3EJiuvAkQAqYvD8xZC03frwpAL7Bxl4gpX1tE5I4tpOuLABtIH50y5CwyaAwZBswIzTfslDTZBYXsp0X5Ux1zY7daHferS7SWt86FZBPHkM2w4LcbZCZBggZDZD"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/academico",
          "executionMode": "production"
        }
      }
    ],
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-new-n8n.ca31ey.easypanel.host",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36",
            "content-length": "154",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "pt-BR,pt;q=0.9,en;q=0.8",
            "content-type": "application/json",
            "origin": "https://csvatendimento.kommo.com",
            "priority": "u=1, i",
            "referer": "https://csvatendimento.kommo.com/",
            "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\", \"Chromium\";v=\"139\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "189.47.99.101",
            "x-forwarded-host": "n8n-new-n8n.ca31ey.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e73584281a1d",
            "x-real-ip": "189.47.99.101"
          },
          "params": {},
          "query": {},
          "body": {
            "leadId": "19262487",
            "phone": "5511945010493",
            "text": "oi",
            "agent": "Admin Sistema",
            "direction": "OUT",
            "timestamp": "2025-09-08T17:36:04.123Z",
            "tipo": "Manual"
          },
          "webhookUrl": "https://n8n-new-n8n.ca31ey.easypanel.host/webhook/capturakommo",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "068d9615-6133-480f-94db-2370352364b0",
  "triggerCount": 2,
  "shared": [
    {
      "createdAt": "2025-08-21T18:16:54.054Z",
      "updatedAt": "2025-08-21T18:16:54.054Z",
      "role": "workflow:owner",
      "workflowId": "15kmAHfNkXIOccRl",
      "projectId": "TjZRFTZS7ptjaNGj"
    }
  ],
  "tags": []
}